<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Spring Boot,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface 后端应用当中与DB交互也是必不可少的一部, 在Java中我们将交互部分抽象成了 ORM(Object Relational Mapping), 以下是数据源以及ORM相关…"><meta name=keywords content="Java,Spring Boot"><meta property=og:type content=article><meta property=og:title content="Spring Boot 之数据篇"><meta property=og:url content=http://yangbingdong.com/2019/spring-boot-learning-orm/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface 后端应用当中与DB交互也是必不可少的一部, 在Java中我们将交互部分抽象成了 ORM(Object Relational Mapping), 以下是数据源以及ORM相关…"><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-data-learning.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx03.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx04.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx05.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx05.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx06.png><meta property=og:updated_time content=2020-04-07T10:15:47.014Z><meta name=twitter:card content=summary><meta name=twitter:title content="Spring Boot 之数据篇"><meta name=twitter:description content="Preface 后端应用当中与DB交互也是必不可少的一部, 在Java中我们将交互部分抽象成了 ORM(Object Relational Mapping), 以下是数据源以及ORM相关…"><meta name=twitter:image content=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-data-learning.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2019/spring-boot-learning-orm/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Spring Boot 之数据篇 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2019/spring-boot-learning-orm/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Spring Boot 之数据篇</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2019-06-15T11:43:02+08:00>2019-06-15</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/Spring-Boot/ itemprop=url rel=index><span itemprop=name>Spring Boot</span></a></span></span>
<span id=/2019/spring-boot-learning-orm/ class=leancloud_visitors data-flag-title="Spring Boot 之数据篇"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>6,632字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>29分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-data-learning.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>后端应用当中与DB交互也是必不可少的一部, 在Java中我们将交互部分抽象成了 <strong>ORM</strong>(Object Relational Mapping), 以下是数据源以及ORM相关…</blockquote><a id=more></a><h1 id=数据源><a href=#数据源 class=headerlink title=数据源></a>数据源</h1><h2 id=配置数据源><a href=#配置数据源 class=headerlink title=配置数据源></a>配置数据源</h2><blockquote><p>更多请查看官方指导：<strong><em><a href=https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-configure-a-datasource rel="external nofollow noopener noreferrer" target=_blank>https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-configure-a-datasource</a></em></strong></blockquote><h3 id=MySQL><a href=#MySQL class=headerlink title=MySQL></a>MySQL</h3><p>pom.xml:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>mysql<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>mysql-connector-java<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>application.yml:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:mysql://192.168.6.113:3306/sync?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span> <span class=comment># 注意加上 useSSL=false</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>com.mysql.jdbc.Driver</span> <span class=comment># 这个可以不加，会智能感知</span></span><br></pre></table></figure><h3 id=H2><a href=#H2 class=headerlink title=H2></a>H2</h3><p><strong>注意：使用H2控制台不能使用WebFlux，否则控制台出不来</strong><p>pom.xml:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=comment>&lt;!-- h2 数据源连接驱动 --&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.h2database<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>h2<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>scope</span>&gt;</span>runtime<span class=tag>&lt;/<span class=name>scope</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>application.yml:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:h2:mem:test</span> <span class=comment># 使用内存存储</span></span><br><span class=line><span class=comment>#    url: jdbc:h2:file:~/test # 使用物理盘存储</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>sa</span></span><br><span class=line>    <span class=attr>password:</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>org.h2.Driver</span></span><br></pre></table></figure><p><strong>开启H2控制台</strong><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>h2:</span></span><br><span class=line>    <span class=attr>console:</span></span><br><span class=line>      <span class=comment># 开启控制台，默认为 false</span></span><br><span class=line>      <span class=attr>enabled:</span> <span class=literal>true</span></span><br><span class=line>      <span class=comment># 配置控制台路径，默认为 /h2-console</span></span><br><span class=line>      <span class=attr>path:</span> <span class=string>/console</span></span><br><span class=line>      <span class=attr>settings:</span></span><br><span class=line>        <span class=attr>trace:</span> <span class=literal>true</span></span><br><span class=line>        <span class=attr>web-allow-others:</span> <span class=literal>true</span> <span class=comment># 允许内网访问</span></span><br></pre></table></figure><h2 id=常用连接池配置><a href=#常用连接池配置 class=headerlink title=常用连接池配置></a>常用连接池配置</h2><blockquote><p>Spring Boot 2 默认使用 <a href=https://github.com/brettwooldridge/HikariCP rel="external nofollow noopener noreferrer" target=_blank><em>HikariCP</em></a> 作为连接池</blockquote><p>如果项目中已包含<code>spring-boot-starter-jdbc</code>或<code>spring-boot-starter-jpa</code>模块，那么连接池将<strong>自动激活</strong>！<p>在Spring Boot2中选择数据库链接池实现的判断逻辑：<ol><li>检查HikariCP是否可用，如可用，则启用。使用<code>spring.datasource.hikari.*</code>可以控制链接池的行为。<li>检查Tomcat的数据库链接池实现是否可用，如可用，则启用。使用<code>spring.datasource.tomcat.*</code>可以控制链接池的行为。<li>检查Commons DBCP2是否可用，如可用，则启用。使用<code>spring.datasource.dbcp2.*</code>可以控制链接池的行为。</ol><p>Spring Boot 2中已经使用Hikari作为默认连接池，如果需要指定其他使用<code>spring.datasource.type</code><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>spring:</span><br><span class=line>    hikari:</span><br><span class=line>      connection-timeout: 30000 #等待连接池分配连接的最大时长(毫秒)，超过这个时长还没可用的连接则发生SQLException， 缺省:30秒</span><br><span class=line>      idle-timeout: 600000 #一个连接idle状态的最大时长(毫秒)，超时则被释放(retired)，缺省:10分钟</span><br><span class=line>      max-lifetime: 1800000 #一个连接的生命时长(毫秒)，超时而且没被使用则被释放(retired)，缺省:30分钟，建议设置比数据库超时时长少30秒以上，参考MySQL wait_timeout参数(show variables like &apos;%timeout%&apos;;)</span><br><span class=line>      maximum-pool-size: 9 #连接池中允许的最大连接数。缺省值：10; 推荐的公式：((core_count * 2) + effective_spindle_count)</span><br></pre></table></figure><h3 id=HikariCP-连接池常用属性><a href=#HikariCP-连接池常用属性 class=headerlink title="HikariCP 连接池常用属性"></a>HikariCP 连接池常用属性</h3><table><thead><tr><th>属性<th>描述<th>默认值<tbody><tr><td>dataSourceClassName<td>JDBC 驱动程序提供的 DataSource 类的名称，如果使用了jdbcUrl则不需要此属性<td>-<tr><td>jdbcUrl<td>数据库连接地址<td>-<tr><td>username<td>数据库账户，如果使用了jdbcUrl则需要此属性<td>-<tr><td>password<td>数据库密码，如果使用了jdbcUrl则需要此属性<td>-<tr><td>autoCommit<td>是否自动提交事务<td>true<tr><td>connectionTimeout<td>连接超时时间(毫秒)，如果在没有连接可用的情况下等待超过此时间，则抛出 SQLException<td>30000(30秒)<tr><td>idleTimeout<td>空闲超时时间(毫秒)，只有在minimumIdle&lt;maximumPoolSize时生效，超时的连接可能被回收，数值 0 表示空闲连接永不从池中删除<td>600000(10分钟)<tr><td>maxLifetime<td>连接池中的连接的最长生命周期(毫秒)。数值 0 表示不限制<td>1800000(30分钟)<tr><td>connectionTestQuery<td>连接池每分配一条连接前执行的查询语句(如：SELECT 1)，以验证该连接是否是有效的。如果你的驱动程序支持 JDBC4，HikariCP 强烈建议我们不要设置此属性<td>-<tr><td>minimumIdle<td>最小空闲连接数，HikariCP 建议我们不要设置此值，而是充当固定大小的连接池<td>与maximumPoolSize数值相同<tr><td>maximumPoolSize<td>连接池中可同时连接的最大连接数，当池中没有空闲连接可用时，就会阻塞直到超出connectionTimeout设定的数值，推荐的公式：((core_count * 2) + effective_spindle_count)<td>10<tr><td>poolName<td>连接池名称，主要用于显示在日志记录和 JMX 管理控制台中<td>auto-generated</table><p><code>application.yml</code><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>      <span class=attr>url:</span> <span class=string>jdbc:mysql://127.0.0.1/spring_boot_testing_storage</span></span><br><span class=line>      <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>      <span class=attr>password:</span> <span class=string>root</span></span><br><span class=line>      <span class=attr>driver-class-name:</span> <span class=string>com.mysql.jdbc.Driver</span></span><br><span class=line><span class=comment>#     type: com.zaxxer.hikari.HikariDataSource #Spring Boot2.0默认使用HikariDataSource</span></span><br><span class=line>      <span class=attr>hikari:</span></span><br><span class=line>        <span class=attr>auto-commit:</span> <span class=literal>false</span></span><br><span class=line>        <span class=attr>maximum-pool-size:</span> <span class=number>9</span> <span class=comment>#连接池中允许的最大连接数。缺省值：10; 推荐的公式：((core_count * 2) + effective_spindle_count)</span></span><br></pre></table></figure><h3 id=Tomcat连接池常用的属性><a href=#Tomcat连接池常用的属性 class=headerlink title=Tomcat连接池常用的属性></a>Tomcat连接池常用的属性</h3><table><thead><tr><th>属性<th>描述<th>默认值<tbody><tr><td>defaultAutoCommit<td>连接池中创建的连接默认是否自动提交事务<td>驱动的缺省值<tr><td>defaultReadOnly<td>连接池中创建的连接默认是否为只读状态<td>-<tr><td>defaultCatalog<td>连接池中创建的连接默认的 catalog<td>-<tr><td>driverClassName<td>驱动类的名称<td>-<tr><td>username<td>数据库账户<td>-<tr><td>password<td>数据库密码<td>-<tr><td>maxActive<td>连接池同一时间可分配的最大活跃连接数<td>100<tr><td>maxIdle<td>始终保留在池中的最大连接数，如果启用，将定期检查限制连接，超出此属性设定的值且空闲时间超过minEvictableIdleTimeMillis的连接则释放<td>与maxActive设定的值相同<tr><td>minIdle<td>始终保留在池中的最小连接数，池中的连接数量若低于此值则创建新的连接，如果连接验证失败将缩小至此值<td>与initialSize设定的值相同<tr><td>initialSize<td>连接池启动时创建的初始连接数量<td>10<tr><td>maxWait<td>最大等待时间(毫秒)，如果在没有连接可用的情况下等待超过此时间，则抛出异常<td>30000(30秒)<tr><td>testOnBorrow<td>当从连接池中取出一个连接时是否进行验证，若验证失败则从池中删除该连接并尝试取出另一个连接<td>false<tr><td>testOnConnect<td>当一个连接首次被创建时是否进行验证，若验证失败则抛出 SQLException 异常<td>false<tr><td>testOnReturn<td>当一个连接使用完归还到连接池时是否进行验证<td>false<tr><td>testWhileIdle<td>对池中空闲的连接是否进行验证，验证失败则回收此连接<td>false<tr><td>validationQuery<td>在连接池返回连接给调用者前用来对连接进行验证的查询 SQL<td>null<tr><td>validationQueryTimeout<td>SQL 查询验证超时时间(秒)，小于或等于 0 的数值表示禁用<td>-1<tr><td>timeBetweenEvictionRunsMillis<td>在空闲连接回收器线程运行期间休眠时间(毫秒)， 该值不应该小于 1 秒，它决定线程多久验证空闲连接或丢弃连接的频率<td>5000(5秒)<tr><td>minEvictableIdleTimeMillis<td>连接在池中保持空闲而不被回收的最小时间(毫秒)<td>60000(60秒)<tr><td>removeAbandoned<td>标记是否删除泄露的连接，如果连接超出removeAbandonedTimeout的限制，且该属性设置为 true，则连接被认为是被泄露并且可以被删除<td>false<tr><td>removeAbandonedTimeout<td>泄露的连接可以被删除的超时时间(秒)，该值应设置为应用程序查询可能执行的最长时间<td>60</table><p><code>application.yml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:mysql://127.0.0.1/spring_boot_testing_storage</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>com.mysql.jdbc.Driver</span></span><br><span class=line>    <span class=attr>tomcat:</span></span><br><span class=line>      <span class=attr>default-auto-commit:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>initial-size:</span> <span class=number>30</span></span><br><span class=line>      <span class=attr>max-active:</span> <span class=number>120</span></span><br><span class=line>      <span class=attr>max-wait:</span> <span class=number>10000</span></span><br><span class=line>      <span class=attr>test-on-borrow:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>test-while-idle:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>validation-query:</span> <span class=string>'SELECT 1'</span></span><br><span class=line>      <span class=attr>validation-query-timeout:</span> <span class=number>3</span></span><br><span class=line>      <span class=attr>time-between-eviction-runs-millis:</span> <span class=number>10000</span></span><br><span class=line>      <span class=attr>min-evictable-idle-time-millis:</span> <span class=number>120000</span></span><br><span class=line>      <span class=attr>remove-abandoned:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>remove-abandoned-timeout:</span> <span class=number>120</span></span><br></pre></table></figure><h3 id=DBCP-连接池常用配置><a href=#DBCP-连接池常用配置 class=headerlink title="DBCP 连接池常用配置"></a>DBCP 连接池常用配置</h3><table><thead><tr><th>属性<th>描述<th>默认值<tbody><tr><td>url<td>数据库连接地址<td>-<tr><td>username<td>数据库账户<td>-<tr><td>password<td>数据库密码<td>-<tr><td>driverClassName<td>驱动类的名称<td>-<tr><td>defaultAutoCommit<td>连接池中创建的连接默认是否自动提交事务<td>驱动的缺省值<tr><td>defaultReadOnly<td>连接池中创建的连接默认是否为只读状态<td>驱动的缺省值<tr><td>defaultCatalog<td>连接池中创建的连接默认的 catalog<td>-<tr><td>initialSize<td>连接池启动时创建的初始连接数量<td>0<tr><td>maxTotal<td>连接池同一时间可分配的最大活跃连接数; 负数表示不限制<td>8<tr><td>maxIdle<td>可以在池中保持空闲的最大连接数，超出此值的空闲连接被释放，负数表示不限制<td>8<tr><td>minIdle<td>可以在池中保持空闲的最小连接数，低于此值将创建空闲连接，若设置为 0，则不创建<td>0<tr><td>maxWaitMillis<td>最大等待时间(毫秒)，如果在没有连接可用的情况下等待超过此时间，则抛出异常; -1 表示无限期等待，直到获取到连接为止<td>-<tr><td>validationQuery<td>在连接池返回连接给调用者前用来对连接进行验证的查询 SQL<td>-<tr><td>validationQueryTimeout<td>SQL 查询验证超时时间(秒)<td>-<tr><td>testOnCreate<td>连接在创建之后是否进行验证<td>false<tr><td>testOnBorrow<td>当从连接池中取出一个连接时是否进行验证，若验证失败则从池中删除该连接并尝试取出另一个连接<td>true<tr><td>testOnReturn<td>当一个连接使用完归还到连接池时是否进行验证<td>false<tr><td>testWhileIdle<td>对池中空闲的连接是否进行验证，验证失败则释放此连接<td>false<tr><td>timeBetweenEvictionRunsMillis<td>在空闲连接回收器线程运行期间休眠时间(毫秒)，如果设置为非正数，则不运行此线程<td>-1<tr><td>numTestsPerEvictionRun<td>空闲连接回收器线程运行期间检查连接的个数<td>3<tr><td>minEvictableIdleTimeMillis<td>连接在池中保持空闲而不被回收的最小时间(毫秒)<td>1800000(30分钟)<tr><td>removeAbandonedOnBorrow<td>标记是否删除泄露的连接，如果连接超出removeAbandonedTimeout的限制，且该属性设置为 true，则连接被认为是被泄露并且可以被删除<td>false<tr><td>removeAbandonedTimeout<td>泄露的连接可以被删除的超时时间(秒)，该值应设置为应用程序查询可能执行的最长时间<td>300(5分钟)<tr><td>poolPreparedStatements<td>设置该连接池的预处理语句池是否生效<td>false</table><p><code>application.yml</code><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>jmx:</span></span><br><span class=line>    <span class=attr>enabled:</span> <span class=literal>false</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:mysql://127.0.0.1/spring_boot_testing_storage</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>com.mysql.jdbc.Driver</span></span><br><span class=line>    <span class=attr>dbcp2:</span></span><br><span class=line>      <span class=attr>default-auto-commit:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>initial-size:</span> <span class=number>30</span></span><br><span class=line>      <span class=attr>max-total:</span> <span class=number>120</span></span><br><span class=line>      <span class=attr>max-idle:</span> <span class=number>120</span></span><br><span class=line>      <span class=attr>min-idle:</span> <span class=number>30</span></span><br><span class=line>      <span class=attr>max-wait-millis:</span> <span class=number>10000</span></span><br><span class=line>      <span class=attr>validation-query:</span> <span class=string>'SELECT 1'</span></span><br><span class=line>      <span class=attr>validation-query-timeout:</span> <span class=number>3</span></span><br><span class=line>      <span class=attr>test-on-borrow:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>test-while-idle:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>time-between-eviction-runs-millis:</span> <span class=number>10000</span></span><br><span class=line>      <span class=attr>num-tests-per-eviction-run:</span> <span class=number>10</span></span><br><span class=line>      <span class=attr>min-evictable-idle-time-millis:</span> <span class=number>120000</span></span><br><span class=line>      <span class=attr>remove-abandoned-on-borrow:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>remove-abandoned-timeout:</span> <span class=number>120</span></span><br><span class=line>      <span class=attr>pool-prepared-statements:</span> <span class=literal>true</span></span><br></pre></table></figure><p>Spring Boot Data Jpa 依赖声明：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>通过application.yml: spring.datasource.type=...配置</span><br><span class=line></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.commons<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>commons-dbcp2<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>2.2.0<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><h3 id=Druid连接池配置><a href=#Druid连接池配置 class=headerlink title=Druid连接池配置></a>Druid连接池配置</h3><p>参考：<strong><em><a href=https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter rel="external nofollow noopener noreferrer" target=_blank>https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></em></strong><h2 id=JTA分布式事务数据源><a href=#JTA分布式事务数据源 class=headerlink title=JTA分布式事务数据源></a>JTA分布式事务数据源</h2><p>Atomikos是一个非常流行的开源事务管理器，并且可以嵌入到Spring Boot应用中。可以使用 <code>spring-boot-starter-jta-atomikos</code> Starter去获取正确的Atomikos库。Spring Boot会自动配置Atomikos，并将合适的 <code>depends-on</code> 应用到Spring Beans上，确保它们以正确的顺序启动和关闭。<p>默认情况下，Atomikos事务日志将被记录在应用home目录(应用jar文件放置的目录)下的 <code>transaction-logs</code> 文件夹中。可以在 <code>application.properties</code> 文件中通过设置 <code>spring.jta.log-dir</code> 属性来定义该目录，以 <code>spring.jta.atomikos.properties</code> 开头的属性能用来定义Atomikos的 <code>UserTransactionServiceIml</code> 实现，具体参考<a href=http://docs.spring.io/spring-boot/docs/1.5.4.RELEASE/api/org/springframework/boot/jta/atomikos/AtomikosProperties.html rel="external nofollow noopener noreferrer" target=_blank>AtomikosProperties javadoc</a>。<blockquote><p>注 为了确保多个事务管理器能够安全地和相应的资源管理器配合，每个Atomikos实例必须设置一个唯一的ID。默认情况下，该ID是Atomikos实例运行的机器上的IP地址。为了确保生产环境中该ID的唯一性，需要为应用的每个实例设置不同的 <code>spring.jta.transaction-manager-id</code> 属性值。</blockquote><p>依赖：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-jta-atomikos<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>application.yml<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>application:</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>test-23</span></span><br><span class=line>  <span class=attr>jpa:</span></span><br><span class=line>    <span class=attr>show-sql:</span> <span class=literal>true</span></span><br><span class=line>  <span class=attr>jta:</span></span><br><span class=line>    <span class=attr>enabled:</span> <span class=literal>true</span></span><br><span class=line>    <span class=attr>atomikos:</span></span><br><span class=line>      <span class=attr>datasource:</span></span><br><span class=line>        <span class=attr>jta-user:</span></span><br><span class=line>          <span class=attr>xa-properties.url:</span> <span class=string>jdbc:mysql://localhost:3306/jta-user</span></span><br><span class=line>          <span class=attr>xa-properties.user:</span> <span class=string>root</span></span><br><span class=line>          <span class=attr>xa-properties.password:</span> <span class=string>root</span></span><br><span class=line>          <span class=attr>xa-data-source-class-name:</span> <span class=string>com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</span></span><br><span class=line>          <span class=attr>unique-resource-name:</span> <span class=string>jta-user</span></span><br><span class=line>          <span class=attr>max-pool-size:</span> <span class=number>25</span></span><br><span class=line>          <span class=attr>min-pool-size:</span> <span class=number>3</span></span><br><span class=line>          <span class=attr>max-lifetime:</span> <span class=number>20000</span></span><br><span class=line>          <span class=attr>borrow-connection-timeout:</span> <span class=number>10000</span></span><br><span class=line>        <span class=attr>jta-income:</span> </span><br><span class=line>          <span class=attr>xa-properties.url:</span> <span class=string>jdbc:mysql://localhost:3306/jta-income</span></span><br><span class=line>          <span class=attr>xa-properties.user:</span> <span class=string>root</span></span><br><span class=line>          <span class=attr>xa-properties.password:</span> <span class=string>root</span></span><br><span class=line>          <span class=attr>xa-data-source-class-name:</span> <span class=string>com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</span></span><br><span class=line>          <span class=attr>unique-resource-name:</span> <span class=string>jta-income</span></span><br><span class=line>          <span class=attr>max-pool-size:</span> <span class=number>25</span></span><br><span class=line>          <span class=attr>min-pool-size:</span> <span class=number>3</span></span><br><span class=line>          <span class=attr>max-lifetime:</span> <span class=number>20000</span></span><br><span class=line>          <span class=attr>borrow-connection-timeout:</span> <span class=number>10000</span></span><br></pre></table></figure><p>DataSourceJTAIncomeConfig.java:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@EnableConfigurationProperties</span></span><br><span class=line><span class=meta>@EnableAutoConfiguration</span></span><br><span class=line><span class=meta>@MapperScan</span>(basePackages = <span class=string>"com.freud.test.springboot.mapper.income"</span>, sqlSessionTemplateRef = <span class=string>"jtaIncomeSqlSessionTemplate"</span>)</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>DataSourceJTAIncomeConfig</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@ConfigurationProperties</span>(prefix = <span class=string>"spring.jta.atomikos.datasource.jta-income"</span>)</span><br><span class=line>    <span class=function><span class=keyword>public</span> DataSource <span class=title>dataSourceJTAIncome</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> AtomikosDataSourceBean();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> SqlSessionFactory <span class=title>jtaIncomeSqlSessionFactory</span><span class=params>(@Qualifier(<span class=string>"dataSourceJTAIncome"</span>)</span> DataSource dataSource)</span></span><br><span class=line><span class=function>            <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        SqlSessionFactoryBean bean = <span class=keyword>new</span> SqlSessionFactoryBean();</span><br><span class=line>        bean.setDataSource(dataSource);</span><br><span class=line>        bean.setMapperLocations(<span class=keyword>new</span> PathMatchingResourcePatternResolver().getResources(<span class=string>"classpath:mapper/*.xml"</span>));</span><br><span class=line>        bean.setTypeAliasesPackage(<span class=string>"com.freud.test.springboot.mapper.income"</span>);</span><br><span class=line>        <span class=keyword>return</span> bean.getObject();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> SqlSessionTemplate <span class=title>jtaIncomeSqlSessionTemplate</span><span class=params>(</span></span></span><br><span class=line><span class=function><span class=params>            @Qualifier(<span class=string>"jtaIncomeSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>DataSourceJTAUserConfig.java<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@EnableConfigurationProperties</span></span><br><span class=line><span class=meta>@EnableAutoConfiguration</span></span><br><span class=line><span class=meta>@MapperScan</span>(basePackages = <span class=string>"com.freud.test.springboot.mapper.user"</span>, sqlSessionTemplateRef = <span class=string>"jtaUserSqlSessionTemplate"</span>)</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>DataSourceJTAUserConfig</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@ConfigurationProperties</span>(prefix = <span class=string>"spring.jta.atomikos.datasource.jta-user"</span>)</span><br><span class=line>    <span class=meta>@Primary</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> DataSource <span class=title>dataSourceJTAUser</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> AtomikosDataSourceBean();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@Primary</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> SqlSessionFactory <span class=title>jtaUserSqlSessionFactory</span><span class=params>(@Qualifier(<span class=string>"dataSourceJTAUser"</span>)</span> DataSource dataSource)</span></span><br><span class=line><span class=function>            <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        SqlSessionFactoryBean bean = <span class=keyword>new</span> SqlSessionFactoryBean();</span><br><span class=line>        bean.setDataSource(dataSource);</span><br><span class=line>        bean.setMapperLocations(<span class=keyword>new</span> PathMatchingResourcePatternResolver().getResources(<span class=string>"classpath:mapper/*.xml"</span>));</span><br><span class=line>        bean.setTypeAliasesPackage(<span class=string>"com.freud.test.springboot.mapper.user"</span>);</span><br><span class=line>        <span class=keyword>return</span> bean.getObject();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@Primary</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> SqlSessionTemplate <span class=title>jtaUserSqlSessionTemplate</span><span class=params>(</span></span></span><br><span class=line><span class=function><span class=params>            @Qualifier(<span class=string>"jtaUserSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h1 id=表与数据初始化><a href=#表与数据初始化 class=headerlink title=表与数据初始化></a>表与数据初始化</h1><h2 id=使用-Hibernate-初始化><a href=#使用-Hibernate-初始化 class=headerlink title="使用 Hibernate 初始化"></a>使用 Hibernate 初始化</h2><p>可以显式设置 <code>spring.jpa.hibernate.ddl-auto</code> ，标准的Hibernate属性值有 <code>none</code> ， <code>validate</code> ， <code>update</code> ， <code>create</code> ， <code>create-drop</code> 。Spring Boot根据数据库是否为内嵌数据库来选择相应的默认值，如果是内嵌型的则默认值为 <code>create-drop</code> ，否则为 <code>none</code> 。通过查看 <code>Connection</code> 类型可以检查是否为内嵌型数据库，<code>hsqldb</code>，<code>h2</code>和<code>derby</code>是内嵌的，其他都不是。当从内存数据库迁移到一个真正的数据库时，需要当心，在新的平台中不能对数据库表和数据是否存在进行臆断，也需要显式设置 <code>ddl-auto</code> ，或使用其他机制初始化数据库。<blockquote><p>可以通过启用<code>org.hibernate.SQL</code> 来输出Schema的创建过程。当<a href=http://docs.spring.io/spring-boot/docs/1.5.4.RELEASE/reference/htmlsingle/#boot-features-logging-console-output rel="external nofollow noopener noreferrer" target=_blank>DEBUG MODE</a>被开启的时候，这个功能就已经被自动开启了。</blockquote><p>此外，启动时处于classpath根目录下的 <code>import.sql</code> 文件会被执行(前提是<code>ddl-auto</code>属性被设置为 <code>create</code> 或 <code>create-drop</code>)。这在demos或测试时很有用，但在生产环境中可能不期望这样。这是Hibernate的特性，和Spring没有一点关系。<h2 id=使用-Spring-JDBC-初始化><a href=#使用-Spring-JDBC-初始化 class=headerlink title="使用 Spring JDBC 初始化"></a>使用 Spring JDBC 初始化</h2><p>指定初始化脚本位置:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>org.h2.Driver</span></span><br><span class=line>    <span class=attr>schema:</span> <span class=string>classpath:db/schema-h2.sql</span></span><br><span class=line>    <span class=attr>data:</span> <span class=string>classpath:db/data-h2.sql</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:h2:mem:test</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>test</span></span><br><span class=line>    <span class=attr>initialization-mode:</span> <span class=string>always</span> <span class=comment># 默认为 embedded</span></span><br></pre></table></figure><p>不能与Hibernate的创建表功能一起开启, 否则会报错.<h1 id=运行时SQL监控><a href=#运行时SQL监控 class=headerlink title=运行时SQL监控></a>运行时SQL监控</h1><blockquote><p>虽然一些开源框架会自带SQL打印, 但都需要各自配置, 但我们可以通过第三方框架比如p6spy以及log4jdbc做到驱动级别拦截.</blockquote><h2 id=p6spy><a href=#p6spy class=headerlink title=p6spy></a>p6spy</h2><blockquote><p><strong><em><a href=https://p6spy.readthedocs.io rel="external nofollow noopener noreferrer" target=_blank>https://p6spy.readthedocs.io</a></em></strong></blockquote><p>添加依赖:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>p6spy<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>p6spy<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>3.7.0<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>应用<code>P6Spy</code>只需要<ul><li>1.替换你的<code>JDBC Driver</code>为<code>com.p6spy.engine.spy.P6SpyDriver</code><li>2.修改<code>JDBC Url</code>为<code>jdbc:p6spy:xxxx</code><li>3.配置<code>spy.properties</code></ul><p>修改<code>application.yml</code>文件,替换<code>jdbc driver</code>和<code>url</code><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=comment># 数据源</span></span><br><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:p6spy:mysql://127.0.0.1:3306/jpa_test?useSSL=false</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>com.p6spy.engine.spy.P6SpyDriver</span></span><br></pre></table></figure><p>配置<code>spy.properties</code><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>module.log=com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory</span><br><span class=line># 自定义日志打印</span><br><span class=line>logMessageFormat=com.yangbingdong.springbootdatajpa.util.sqlformat.PrettySqlMultiLineFormat</span><br><span class=line># 使用日志系统记录sql</span><br><span class=line>appender=com.p6spy.engine.spy.appender.Slf4JLogger</span><br><span class=line>## 配置记录Log例外</span><br><span class=line>excludecategories=info,debug,result,batc,resultset</span><br><span class=line># 设置使用p6spy driver来做代理</span><br><span class=line>deregisterdrivers=true</span><br><span class=line># 日期格式</span><br><span class=line>dateformat=yyyy-MM-dd HH:mm:ss</span><br><span class=line># 实际驱动</span><br><span class=line>driverlist=com.mysql.jdbc.Driver</span><br><span class=line># 是否开启慢SQL记录</span><br><span class=line>outagedetection=true</span><br><span class=line># 慢SQL记录标准 秒</span><br><span class=line>outagedetectioninterval=2</span><br></pre></table></figure><p>自定义日志打印 , 这里有两种方式<p>一、实现<code>MessageFormattingStrategy</code>接口<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>PrettySqlMultiLineFormat</span> <span class=keyword>implements</span> <span class=title>MessageFormattingStrategy</span> </span>&#123;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> Formatter FORMATTER = <span class=keyword>new</span> BasicFormatterImpl();</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> String <span class=title>formatMessage</span><span class=params>(<span class=keyword>int</span> connectionId, String now, <span class=keyword>long</span> elapsed, String category, String prepared, String sql)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=string>"#"</span> + now + <span class=string>" | took "</span> + elapsed + <span class=string>"ms | "</span> + category + <span class=string>" | connection "</span> + connectionId + <span class=string>" | "</span> + FORMATTER.format(sql) +<span class=string>";"</span>;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>二、在 <code>spy.properties</code> 中指定<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line># 自定义日志打印</span><br><span class=line>logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat</span><br><span class=line>customLogMessageFormat=%(currentTime) | SQL耗时： %(executionTime) ms | 连接信息： %(category)-%(connectionId) | 执行语句： %(sql)</span><br></pre></table></figure><p>附录: <code>spy.properties</code>详细说明<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br></pre><td class=code><pre><span class=line># 指定应用的日志拦截模块,默认为com.p6spy.engine.spy.P6SpyFactory </span><br><span class=line>#modulelist=com.p6spy.engine.spy.P6SpyFactory,com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory</span><br><span class=line></span><br><span class=line># 真实JDBC driver , 多个以 逗号 分割 默认为空</span><br><span class=line>#driverlist=</span><br><span class=line></span><br><span class=line># 是否自动刷新 默认 flase</span><br><span class=line>#autoflush=false</span><br><span class=line></span><br><span class=line># 配置SimpleDateFormat日期格式 默认为空</span><br><span class=line>#dateformat=</span><br><span class=line></span><br><span class=line># 打印堆栈跟踪信息 默认flase</span><br><span class=line>#stacktrace=false</span><br><span class=line></span><br><span class=line># 如果 stacktrace=true，则可以指定具体的类名来进行过滤。</span><br><span class=line>#stacktraceclass=</span><br><span class=line></span><br><span class=line># 监测属性配置文件是否进行重新加载</span><br><span class=line>#reloadproperties=false</span><br><span class=line></span><br><span class=line># 属性配置文件重新加载的时间间隔，单位:秒 默认60s</span><br><span class=line>#reloadpropertiesinterval=60</span><br><span class=line></span><br><span class=line># 指定 Log 的 appender，取值：</span><br><span class=line>#appender=com.p6spy.engine.spy.appender.Slf4JLogger</span><br><span class=line>#appender=com.p6spy.engine.spy.appender.StdoutLogger</span><br><span class=line>#appender=com.p6spy.engine.spy.appender.FileLogger</span><br><span class=line></span><br><span class=line># 指定 Log 的文件名 默认 spy.log</span><br><span class=line>#logfile=spy.log</span><br><span class=line></span><br><span class=line># 指定是否每次是增加 Log，设置为 false 则每次都会先进行清空 默认true</span><br><span class=line>#append=true</span><br><span class=line></span><br><span class=line># 指定日志输出样式  默认为com.p6spy.engine.spy.appender.SingleLineFormat , 单行输出 不格式化语句</span><br><span class=line>#logMessageFormat=com.p6spy.engine.spy.appender.SingleLineFormat</span><br><span class=line># 也可以采用  com.p6spy.engine.spy.appender.CustomLineFormat 来自定义输出样式, 默认值是%(currentTime)|%(executionTime)|%(category)|connection%(connectionId)|%(sqlSingleLine)</span><br><span class=line># 可用的变量为:</span><br><span class=line>#   %(connectionId)            connection id</span><br><span class=line>#   %(currentTime)             当前时间</span><br><span class=line>#   %(executionTime)           执行耗时</span><br><span class=line>#   %(category)                执行分组</span><br><span class=line>#   %(effectiveSql)            提交的SQL 换行</span><br><span class=line>#   %(effectiveSqlSingleLine)  提交的SQL 不换行显示</span><br><span class=line>#   %(sql)                     执行的真实SQL语句，已替换占位</span><br><span class=line>#   %(sqlSingleLine)           执行的真实SQL语句，已替换占位 不换行显示</span><br><span class=line>#customLogMessageFormat=%(currentTime)|%(executionTime)|%(category)|connection%(connectionId)|%(sqlSingleLine)</span><br><span class=line></span><br><span class=line># date类型字段记录日志时使用的日期格式 默认dd-MMM-yy</span><br><span class=line>#databaseDialectDateFormat=dd-MMM-yy</span><br><span class=line></span><br><span class=line># boolean类型字段记录日志时使用的日期格式 默认boolean 可选值numeric</span><br><span class=line>#databaseDialectBooleanFormat=boolean</span><br><span class=line></span><br><span class=line># 是否通过jmx暴露属性 默认true</span><br><span class=line>#jmx=true</span><br><span class=line></span><br><span class=line># 如果jmx设置为true 指定通过jmx暴露属性时的前缀 默认为空</span><br><span class=line># com.p6spy(.&lt;jmxPrefix&gt;)?:name=&lt;optionsClassName&gt;</span><br><span class=line>#jmxPrefix=</span><br><span class=line></span><br><span class=line># 是否显示纳秒 默认false</span><br><span class=line>#useNanoTime=false</span><br><span class=line></span><br><span class=line># 实际数据源 JNDI</span><br><span class=line>#realdatasource=/RealMySqlDS</span><br><span class=line># 实际数据源 datasource class</span><br><span class=line>#realdatasourceclass=com.mysql.jdbc.jdbc2.optional.MysqlDataSource</span><br><span class=line></span><br><span class=line># 实际数据源所携带的配置参数 以 k=v 方式指定 以 分号 分割</span><br><span class=line>#realdatasourceproperties=port;3306,serverName;myhost,databaseName;jbossdb,foo;bar</span><br><span class=line></span><br><span class=line># jndi数据源配置 </span><br><span class=line># 设置 JNDI 数据源的 NamingContextFactory。 </span><br><span class=line>#jndicontextfactory=org.jnp.interfaces.NamingContextFactory</span><br><span class=line># 设置 JNDI 数据源的提供者的 URL。 </span><br><span class=line>#jndicontextproviderurl=localhost:1099</span><br><span class=line># 设置 JNDI 数据源的一些定制信息，以分号分隔。 </span><br><span class=line>#jndicontextcustom=java.naming.factory.url.pkgs;org.jboss.naming:org.jnp.interfaces</span><br><span class=line></span><br><span class=line># 是否开启日志过滤 默认false， 这项配置是否生效前提是配置了 include/exclude/sqlexpression</span><br><span class=line>#filter=false</span><br><span class=line></span><br><span class=line># 过滤 Log 时所包含的表名列表，以逗号分隔 默认为空</span><br><span class=line>#include=</span><br><span class=line># 过滤 Log 时所排除的表名列表，以逗号分隔 默认为空</span><br><span class=line>#exclude=</span><br><span class=line></span><br><span class=line># 过滤 Log 时的 SQL 正则表达式名称  默认为空</span><br><span class=line>#sqlexpression=</span><br><span class=line></span><br><span class=line>#显示指定过滤 Log 时排队的分类列表，取值: error, info, batch, debug, statement,</span><br><span class=line>#commit, rollback, result and resultset are valid values</span><br><span class=line># (默认 info,debug,result,resultset,batch)</span><br><span class=line>#excludecategories=info,debug,result,resultset,batch</span><br><span class=line></span><br><span class=line># 是否过滤二进制字段</span><br><span class=line># (default is false)</span><br><span class=line>#excludebinary=false</span><br><span class=line></span><br><span class=line># P6Log 模块执行时间设置，整数值 (以毫秒为单位)，只有当超过这个时间才进行记录 Log。 默认为0</span><br><span class=line>#executionThreshold=</span><br><span class=line></span><br><span class=line># P6Outage 模块是否记录较长时间运行的语句 默认false</span><br><span class=line># outagedetection=true|false</span><br><span class=line># P6Outage 模块执行时间设置，整数值 （以秒为单位)），只有当超过这个时间才进行记录 Log。 默认30s</span><br><span class=line># outagedetectioninterval=integer time (seconds)</span><br></pre></table></figure><h2 id=log4jdbc><a href=#log4jdbc class=headerlink title=log4jdbc></a>log4jdbc</h2><p>添加依赖：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.googlecode.log4jdbc<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>log4jdbc<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>1.2<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>MySQL数据源配置换成：<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>datasource:</span></span><br><span class=line>    <span class=attr>url:</span> <span class=string>jdbc:log4jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>root</span></span><br><span class=line>    <span class=attr>driver-class-name:</span> <span class=string>net.sf.log4jdbc.DriverSpy</span></span><br></pre></table></figure><h1 id=Spring-事务监控><a href=#Spring-事务监控 class=headerlink title="Spring 事务监控"></a>Spring 事务监控</h1><p>某些特殊的场景下, 我们需要在事务开启时, 完成时做一些事情, 比如释放一些资源.<h2 id=方式一-TransactionSynchronization><a href=#方式一-TransactionSynchronization class=headerlink title="方式一: TransactionSynchronization"></a>方式一: TransactionSynchronization</h2><p>Spring事务的核心部分在 <code>TransactionInterceptor#invoke</code>, <code>TransactionInterceptor</code> 继承了 <code>TransactionAspectSupport</code>, <code>TransactionAspectSupport</code> 使用 <code>AbstractPlatformTransactionManager</code> 的实现类操作事务. <code>AbstractPlatformTransactionManager</code> 中的 <code>processCommit</code> 以及 <code>processRollback</code> 中的几个节点会调用到 <code>TransactionSynchronizationUtils</code> 中的一些方法:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx01.png alt><p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx02.png alt><p>这些被trigger的类就是 <code>TransactionSynchronization</code> 的实现类.<p><code>TransactionSynchronizationUtils</code> 通过 <code>TransactionSynchronizationManager#getSynchronizations</code> 来获取 <code>TransactionSynchronization</code> 列表, 而 <code>TransactionSynchronizationManager</code> 是通过 <code>ThreadLocal</code> 来管理这些类的:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx03.png alt><p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx04.png alt><p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx05.png alt><p>示例:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>TestTransactionSynchronization</span> <span class=keyword>extends</span> <span class=title>TransactionSynchronizationAdapter</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>int</span> <span class=title>getOrder</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=number>0</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>suspend</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### suspend"</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>resume</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### resume"</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>flush</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### flush"</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>beforeCommit</span><span class=params>(<span class=keyword>boolean</span> readOnly)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### beforeCommit"</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>beforeCompletion</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### beforeCompletion"</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCommit</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### afterCommit"</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCompletion</span><span class=params>(<span class=keyword>int</span> status)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### afterCompletion"</span>);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>那么这个类什么时候注册进 <code>TransactionSynchronizationManager</code> 呢? 答案是每次事务开启的时候, 因为这个是使用 <code>ThreadLocal</code> 保存的, 每次事务过后会被清空掉. 我们可以使用切面, 将打有 <code>@Transactional</code> 注解的方法增强一下:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Aspect</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>TestTransactionAspect</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Autowired</span></span><br><span class=line>	<span class=keyword>private</span> TestTransactionSynchronization testTransactionSynchronization;</span><br><span class=line></span><br><span class=line></span><br><span class=line>	<span class=meta>@Before</span>(value = <span class=string>"@annotation(tx)"</span>)</span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>doAfterReturning</span><span class=params>(Transactional tx)</span> </span>&#123;</span><br><span class=line>		TransactionSynchronizationManager.registerSynchronization(testTransactionSynchronization);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>这样就行了~<h2 id=方式二-继承DataSourceTransactionManager><a href=#方式二-继承DataSourceTransactionManager class=headerlink title="方式二: 继承DataSourceTransactionManager"></a>方式二: 继承DataSourceTransactionManager</h2><p>上面的方法有一个缺点, 不能在事务开启时做一些事情, 可以通过继承 <code>DataSourceTransactionManager</code> 来实现:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomTransactionManager</span> <span class=keyword>extends</span> <span class=title>DataSourceTransactionManager</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=keyword>long</span> serialVersionUID = -<span class=number>5831041749053502702L</span>;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=title>CustomTransactionManager</span><span class=params>(DataSource dataSource)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>super</span>(dataSource);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>doCleanupAfterCompletion</span><span class=params>(Object transaction)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### doCleanupAfterCompletion"</span>);</span><br><span class=line>		<span class=keyword>super</span>.doCleanupAfterCompletion(transaction);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>doBegin</span><span class=params>(Object transaction, TransactionDefinition definition)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"#################### doBegin"</span>);</span><br><span class=line>		<span class=keyword>super</span>.doBegin(transaction, definition);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>配置类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@ConditionalOnClass</span>(&#123;PlatformTransactionManager<span class=class>.<span class=keyword>class</span>&#125;)</span></span><br><span class=line><span class=class>@<span class=title>EnableConfigurationProperties</span>(<span class=title>DataSourceProperties</span>.<span class=title>class</span>)</span></span><br><span class=line><span class=class><span class=title>public</span> <span class=title>class</span> <span class=title>CustomDataSourceTransactionManagerAutoConfiguration</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> DataSourceTransactionManager <span class=title>transactionManager</span><span class=params>(DataSource dataSource,</span></span></span><br><span class=line><span class=function><span class=params>														   ObjectProvider&lt;TransactionManagerCustomizers&gt; transactionManagerCustomizers)</span> </span>&#123;</span><br><span class=line>		DataSourceTransactionManager transactionManager = <span class=keyword>new</span> CustomTransactionManager(dataSource);</span><br><span class=line>		transactionManagerCustomizers.ifAvailable(</span><br><span class=line>				(customizers) -&gt; customizers.customize(transactionManager));</span><br><span class=line>		<span class=keyword>return</span> transactionManager;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=方式三-TransactionalEventListener><a href=#方式三-TransactionalEventListener class=headerlink title="方式三: @TransactionalEventListener"></a>方式三: @TransactionalEventListener</h2><p>使用 <code>@TransactionalEventListener</code> 可以在事务的某些阶段处理 Event<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=meta>@Target</span>(&#123;ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)</span><br><span class=line><span class=meta>@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class=line><span class=meta>@Documented</span></span><br><span class=line><span class=meta>@EventListener</span></span><br><span class=line><span class=keyword>public</span> <span class=meta>@interface</span> TransactionalEventListener &#123;</span><br><span class=line></span><br><span class=line>    <span class=comment>// 指定当前标注方法处理事务的类型</span></span><br><span class=line>	<span class=function>TransactionPhase <span class=title>phase</span><span class=params>()</span> <span class=keyword>default</span> TransactionPhase.AFTER_COMMIT</span>;</span><br><span class=line></span><br><span class=line>    <span class=comment>// 用于指定当前方法如果没有事务，是否执行相应的事务事件监听器</span></span><br><span class=line>	<span class=function><span class=keyword>boolean</span> <span class=title>fallbackExecution</span><span class=params>()</span> <span class=keyword>default</span> <span class=keyword>false</span></span>;</span><br><span class=line></span><br><span class=line>    <span class=comment>// 与classes属性一样，指定了当前事件传入的参数类型，指定了这个参数之后就可以在监听方法上</span></span><br><span class=line>    <span class=comment>// 直接什么一个这个参数了</span></span><br><span class=line>	<span class=meta>@AliasFor</span>(annotation = EventListener<span class=class>.<span class=keyword>class</span>, <span class=title>attribute</span> </span>= <span class=string>"classes"</span>)</span><br><span class=line>	Class&lt;?&gt;[] value() <span class=keyword>default</span> &#123;&#125;;</span><br><span class=line></span><br><span class=line>    <span class=comment>// 作用于value属性一样，用于指定当前监听方法的参数类型</span></span><br><span class=line>	<span class=meta>@AliasFor</span>(annotation = EventListener<span class=class>.<span class=keyword>class</span>, <span class=title>attribute</span> </span>= <span class=string>"classes"</span>)</span><br><span class=line>	Class&lt;?&gt;[] classes() <span class=keyword>default</span> &#123;&#125;;</span><br><span class=line></span><br><span class=line>    <span class=comment>// 这个属性使用Spring Expression Language对目标类和方法进行匹配，对于不匹配的方法将会过滤掉</span></span><br><span class=line>	<span class=function>String <span class=title>condition</span><span class=params>()</span> <span class=keyword>default</span> ""</span>;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>enum</span> TransactionPhase &#123;</span><br><span class=line>    <span class=comment>// 指定目标方法在事务commit之前执行</span></span><br><span class=line>	BEFORE_COMMIT,</span><br><span class=line></span><br><span class=line>    <span class=comment>// 指定目标方法在事务commit之后执行</span></span><br><span class=line>	AFTER_COMMIT,</span><br><span class=line></span><br><span class=line>    <span class=comment>// 指定目标方法在事务rollback之后执行</span></span><br><span class=line>	AFTER_ROLLBACK,</span><br><span class=line>    </span><br><span class=line>    <span class=comment>// 指定目标方法在事务完成时执行，这里的完成是指无论事务是成功提交还是事务回滚了</span></span><br><span class=line>	AFTER_COMPLETION</span><br><span class=line>&#125;</span><br></pre></table></figure><p>示例:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>UserTransactionEventListener</span> </span>&#123;</span><br><span class=line></span><br><span class=line>  <span class=meta>@TransactionalEventListener</span>(phase = TransactionPhase.BEFORE_COMMIT)</span><br><span class=line>  <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>beforeCommit</span><span class=params>(PayloadApplicationEvent&lt;User&gt; event)</span> </span>&#123;</span><br><span class=line>    System.out.println(<span class=string>"before commit, id: "</span> + event.getPayload().getId());</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  <span class=meta>@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMMIT)</span><br><span class=line>  <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCommit</span><span class=params>(PayloadApplicationEvent&lt;User&gt; event)</span> </span>&#123;</span><br><span class=line>    System.out.println(<span class=string>"after commit, id: "</span> + event.getPayload().getId());</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  <span class=meta>@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMPLETION)</span><br><span class=line>  <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterCompletion</span><span class=params>(PayloadApplicationEvent&lt;User&gt; event)</span> </span>&#123;</span><br><span class=line>    System.out.println(<span class=string>"after completion, id: "</span> + event.getPayload().getId());</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  <span class=meta>@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_ROLLBACK)</span><br><span class=line>  <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterRollback</span><span class=params>(PayloadApplicationEvent&lt;User&gt; event)</span> </span>&#123;</span><br><span class=line>    System.out.println(<span class=string>"after rollback, id: "</span> + event.getPayload().getId());</span><br><span class=line>  &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li>它的原理也是利用了方式一中的 <code>TransactionSynchronization</code>.<li>贴上 <code>@TransactionalEventListener</code> 注解的方法会被 Spring 使用 <code>TransactionalEventListenerFactory</code> 包装成 <code>ApplicationListenerMethodTransactionalAdapter</code><li><code>ApplicationListenerMethodTransactionalAdapter</code> 中进一步将监听方法封装成 <code>TransactionSynchronizationEventAdapter</code>, 再通过 <code>TransactionSynchronizationManager.registerSynchronization</code> 进行注册</ul><h2 id=判断当前方法是否在事务环境中><a href=#判断当前方法是否在事务环境中 class=headerlink title=判断当前方法是否在事务环境中></a>判断当前方法是否在事务环境中</h2><p>通过上面的 <code>TransactionSynchronizationManager</code> 可以发现定义了很多 <code>ThreadLocal</code>:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx05.png alt><p>可以看到变量中有一个 <code>actualTransactionActive</code> 以及 <code>currentTransactionReadOnly</code>, 通过这两个变量可以判断当前是否在事务当中, Spring很多代码中也是通过这个来判断的, 比如 <code>RedisConnectionUtils#isActualNonReadonlyTransactionActive</code> :<p><img src=https://cdn.yangbingdong.com/img/spring-boot-orm/spring-tx06.png alt><h1 id=对象映射><a href=#对象映射 class=headerlink title=对象映射></a>对象映射</h1><blockquote><p><strong><em><a href=https://www.baeldung.com/java-performance-mapping-frameworks rel="external nofollow noopener noreferrer" target=_blank>https://www.baeldung.com/java-performance-mapping-frameworks</a></em></strong></blockquote><h1 id=ORM-对比><a href=#ORM-对比 class=headerlink title="ORM 对比"></a>ORM 对比</h1><ul><li>MyBatis：MyBatis 本是 Apache 的一个开源项目 iBatis，2010 年这个项目由 Apache Software Foundation 迁移到了 Google Code，并且改名为 MyBatis，其<strong>着力于 POJO 与 SQL 之间的映射关系</strong>，可以进行更为细致的 SQL，使用起来十分灵活、上手简单、容易掌握，所以深受开发者的喜欢，目前市场占有率最高，比较适合互联应用公司的 API 场景; 缺点就是工作量比较大，需要各种配置文件的配置和 SQL 语句。<li>Hibernate：Hibernate 是一个开放源代码的对象关系映射框架，它对 JDBC 进行了非常轻量级的对象封装，使得 Java 程序员可以随心所欲的使用对象编程思维来操纵数据库，并且对象有自己的生命周期，<strong>着力点对象与对象之间关系</strong>，有自己的 HQL 查询语言，所以数据库移植性很好。Hibernate 是完备的 ORM 框架，是符合 JPA 规范的，有自己的缓存机制，上手来说比较难，比较适合企业级的应用系统开发。<li>Spring Data JPA：可以理解为 JPA 规范的再次封装抽象，底层还是使用了 Hibernate 的 JPA 技术实现，引用 JPQL(Java Persistence Query Language)查询语言，属于 Spring 的整个生态体系的一部分。由于 Spring Boot 和 Spring Cloud 在市场上的流行，Spring Data JPA 也逐渐进入大家的视野，他们有机的整体，使用起来比较方便，加快了开发的效率，使开发者不需要关系和配置更多的东西，完全可以沉浸在 Spring 的完整生态标准的实现下，上手简单、开发效率高，又对对象的支持比较好，又有很大的灵活性，市场的认可度越来越高。</ul><h1 id=MyBatis><a href=#MyBatis class=headerlink title=MyBatis></a>MyBatis</h1><p>对于MyBatis, 现已有很优秀的二次封装框架, 比如 <strong><em><a href=https://github.com/abel533/Mapper rel="external nofollow noopener noreferrer" target=_blank>Mapper4</a></em></strong>, <strong><em><a href=https://github.com/baomidou/mybatis-plus rel="external nofollow noopener noreferrer" target=_blank>MtBatis-Plus</a></em></strong> 等.<h1 id=Spring-Data-JPA><a href=#Spring-Data-JPA class=headerlink title="Spring Data JPA"></a>Spring Data JPA</h1><blockquote><p>请看 <strong><em><a href=/2019/spring-boot-data-jpa-learning>Spring Data JPA 拾遗</a></em></strong></blockquote></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2019/spring-boot-learning-orm/ title="Spring Boot 之数据篇">http://yangbingdong.com/2019/spring-boot-learning-orm/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2019/localize-server-problem/ rel=next title=线上问题定位常用技巧><i class="fa fa-chevron-left"></i>线上问题定位常用技巧</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2019/spring-boot-data-jpa-learning/ rel=prev title="Spring Data JPA 拾遗">Spring Data JPA 拾遗 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2019/spring-boot-learning-orm/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2019/spring-boot-learning-orm/';this.page.identifier='2019/spring-boot-learning-orm/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>46</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>17</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>43</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#数据源><span class=nav-number>2.</span> <span class=nav-text>数据源</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#配置数据源><span class=nav-number>2.1.</span> <span class=nav-text>配置数据源</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#MySQL><span class=nav-number>2.1.1.</span> <span class=nav-text>MySQL</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#H2><span class=nav-number>2.1.2.</span> <span class=nav-text>H2</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#常用连接池配置><span class=nav-number>2.2.</span> <span class=nav-text>常用连接池配置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#HikariCP-连接池常用属性><span class=nav-number>2.2.1.</span> <span class=nav-text>HikariCP 连接池常用属性</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Tomcat连接池常用的属性><span class=nav-number>2.2.2.</span> <span class=nav-text>Tomcat连接池常用的属性</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#DBCP-连接池常用配置><span class=nav-number>2.2.3.</span> <span class=nav-text>DBCP 连接池常用配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Druid连接池配置><span class=nav-number>2.2.4.</span> <span class=nav-text>Druid连接池配置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#JTA分布式事务数据源><span class=nav-number>2.3.</span> <span class=nav-text>JTA分布式事务数据源</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#表与数据初始化><span class=nav-number>3.</span> <span class=nav-text>表与数据初始化</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#使用-Hibernate-初始化><span class=nav-number>3.1.</span> <span class=nav-text>使用 Hibernate 初始化</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#使用-Spring-JDBC-初始化><span class=nav-number>3.2.</span> <span class=nav-text>使用 Spring JDBC 初始化</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#运行时SQL监控><span class=nav-number>4.</span> <span class=nav-text>运行时SQL监控</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#p6spy><span class=nav-number>4.1.</span> <span class=nav-text>p6spy</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#log4jdbc><span class=nav-number>4.2.</span> <span class=nav-text>log4jdbc</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-事务监控><span class=nav-number>5.</span> <span class=nav-text>Spring 事务监控</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#方式一-TransactionSynchronization><span class=nav-number>5.1.</span> <span class=nav-text>方式一: TransactionSynchronization</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#方式二-继承DataSourceTransactionManager><span class=nav-number>5.2.</span> <span class=nav-text>方式二: 继承DataSourceTransactionManager</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#方式三-TransactionalEventListener><span class=nav-number>5.3.</span> <span class=nav-text>方式三: @TransactionalEventListener</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#判断当前方法是否在事务环境中><span class=nav-number>5.4.</span> <span class=nav-text>判断当前方法是否在事务环境中</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#对象映射><span class=nav-number>6.</span> <span class=nav-text>对象映射</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#ORM-对比><span class=nav-number>7.</span> <span class=nav-text>ORM 对比</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#MyBatis><span class=nav-number>8.</span> <span class=nav-text>MyBatis</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Data-JPA><span class=nav-number>9.</span> <span class=nav-text>Spring Data JPA</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共277.3k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2019/spring-boot-learning-orm/';var disqus_title="Spring Boot 之数据篇";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>