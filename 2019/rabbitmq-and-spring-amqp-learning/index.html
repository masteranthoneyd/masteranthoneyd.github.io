<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Spring Boot,Spring Cloud,RabbitMQ,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface MQ(Message Queue, 消息队列)是一种应用系统之间的通信方法. 是通过读写出入队列的消息来通信(RPC则是通过直接调用彼此来通信的).  AMQP, 即Advanced Message Queuing Protocol, 高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计. 消息中间件主要用于组件之间的解耦, 消息的发送者无需知道消息使用者的存"><meta name=keywords content="Java,Spring Boot,Spring Cloud,RabbitMQ"><meta property=og:type content=article><meta property=og:title content="Rabbit &amp; Spring AMQP 入门"><meta property=og:url content=http://yangbingdong.com/2019/rabbitmq-and-spring-amqp-learning/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface MQ(Message Queue, 消息队列)是一种应用系统之间的通信方法. 是通过读写出入队列的消息来通信(RPC则是通过直接调用彼此来通信的).  AMQP, 即Advanced Message Queuing Protocol, 高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计. 消息中间件主要用于组件之间的解耦, 消息的发送者无需知道消息使用者的存"><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/spring-rabbitmq-banner.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/basic-single-send-and-receive.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/queue-constructor01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/queue-constructor02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/exchange-constructor.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbit-error-dlq01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbit-error-dlq02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbit-error-dlq03.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbitmq-x-delay-plugin.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/stream-rabbit-delay01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/stream-rabbit-delay02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/x-dalay-admin01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/x-dalay-admin02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbitmq-exclusive.png><meta property=og:updated_time content=2020-04-23T10:04:19.385Z><meta name=twitter:card content=summary><meta name=twitter:title content="Rabbit &amp; Spring AMQP 入门"><meta name=twitter:description content="Preface MQ(Message Queue, 消息队列)是一种应用系统之间的通信方法. 是通过读写出入队列的消息来通信(RPC则是通过直接调用彼此来通信的).  AMQP, 即Advanced Message Queuing Protocol, 高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计. 消息中间件主要用于组件之间的解耦, 消息的发送者无需知道消息使用者的存"><meta name=twitter:image content=https://cdn.yangbingdong.com/img/rabbitmq-learning/spring-rabbitmq-banner.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2019/rabbitmq-and-spring-amqp-learning/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Rabbit & Spring AMQP 入门 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2019/rabbitmq-and-spring-amqp-learning/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Rabbit & Spring AMQP 入门</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2019-04-25T16:44:51+08:00>2019-04-25</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span></span>
<span id=/2019/rabbitmq-and-spring-amqp-learning/ class=leancloud_visitors data-flag-title="Rabbit & Spring AMQP 入门"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>5,001字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>23分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/spring-rabbitmq-banner.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>MQ(Message Queue, 消息队列)是一种应用系统之间的通信方法. 是通过读写出入队列的消息来通信(RPC则是通过直接调用彼此来通信的).<p>AMQP, 即Advanced Message Queuing Protocol, 高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计. 消息中间件主要用于组件之间的解耦, 消息的发送者无需知道消息使用者的存在, 反之亦然.<br>AMQP的主要特征是面向消息, 队列, 路由(包括点对点和发布/订阅), 可靠性, 安全.<p>RabbitMQ是一个开源的AMQP<strong>实现</strong>, 服务器端用Erlang语言编写.</blockquote><a id=more></a><h1 id=启动><a href=#启动 class=headerlink title=启动></a>启动</h1><p>这里使用Docker启动.<p>docker-compose:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=attr>version:</span> <span class=string>'3.7'</span></span><br><span class=line></span><br><span class=line><span class=attr>services:</span></span><br><span class=line>  <span class=attr>rabbitmq:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>my-rabbitmq:latest</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>ports:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"5672:5672"</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"15672:15672"</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>./data:/var/lib/rabbitmq</span></span><br><span class=line>    <span class=attr>environment:</span></span><br><span class=line>      <span class=attr>RABBITMQ_DEFAULT_USER:</span> <span class=string>rabbitmq</span></span><br><span class=line>      <span class=attr>RABBITMQ_DEFAULT_PASS:</span> <span class=string>rabbitmq</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=string>rabbitmq</span></span><br><span class=line></span><br><span class=line><span class=attr>networks:</span></span><br><span class=line>  <span class=attr>backend:</span></span><br><span class=line>    <span class=attr>external:</span> <span class=literal>true</span></span><br></pre></table></figure><h1 id=基本概念><a href=#基本概念 class=headerlink title=基本概念></a>基本概念</h1><h2 id=Hello-World><a href=#Hello-World class=headerlink title="Hello World"></a>Hello World</h2><p>先来利用原生的 RabbitMQ Java Client 来运行一个 Hello World 程序:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br></pre><td class=code><pre><span class=line><span class=keyword>package</span> com.yangbingdong.rabbitmq.basic;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.AMQP;</span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.Channel;</span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.Connection;</span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.Consumer;</span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.Envelope;</span><br><span class=line><span class=keyword>import</span> org.junit.Test;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.io.IOException;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> <span class=keyword>static</span> com.yangbingdong.rabbitmq.basic.ConnectionUtil.getConnection;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>BasicSingleSendAndReceive</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>final</span> <span class=keyword>static</span> String QUEUE_NAME = <span class=string>"hello0"</span>;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Test</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>basicSingleSendAndReceive</span><span class=params>()</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>		send();</span><br><span class=line>		receive();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>send</span><span class=params>()</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>		Connection connection = getConnection();</span><br><span class=line>		Channel channel = connection.createChannel();</span><br><span class=line>		channel.queueDeclare(QUEUE_NAME, <span class=keyword>false</span>, <span class=keyword>false</span>, <span class=keyword>false</span>, <span class=keyword>null</span>);</span><br><span class=line>		String message = <span class=string>"Hello World!"</span>;</span><br><span class=line>		channel.basicPublish(<span class=string>""</span>, QUEUE_NAME, <span class=keyword>null</span>, message.getBytes());</span><br><span class=line>		System.out.println(<span class=string>"Sent '"</span> + message + <span class=string>"'"</span>);</span><br><span class=line>		channel.close();</span><br><span class=line>		connection.close();</span><br><span class=line>		System.out.println();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>receive</span><span class=params>()</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>		Connection connection = getConnection();</span><br><span class=line>		Channel channel = connection.createChannel();</span><br><span class=line></span><br><span class=line>		<span class=comment>// 声明队列, 主要为了防止消息接收者先运行此程序, 队列还不存在时创建队列.</span></span><br><span class=line>		channel.queueDeclare(QUEUE_NAME, <span class=keyword>false</span>, <span class=keyword>false</span>, <span class=keyword>false</span>, <span class=keyword>null</span>);</span><br><span class=line>		Consumer consumer = <span class=keyword>new</span> DefaultConsumer(channel) &#123;</span><br><span class=line>			<span class=meta>@Override</span></span><br><span class=line>			<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>handleDelivery</span><span class=params>(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class=keyword>byte</span>[] body)</span> <span class=keyword>throws</span> IOException </span>&#123;</span><br><span class=line>				System.out.println(<span class=string>"consumerTag: "</span> + consumerTag);</span><br><span class=line>				System.out.println(<span class=string>"envelope: "</span> + envelope);</span><br><span class=line>				System.out.println(<span class=string>"properties: "</span> + properties);</span><br><span class=line>				System.out.println(<span class=string>"body: "</span> + <span class=keyword>new</span> String(body));</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;;</span><br><span class=line>		System.out.println(<span class=string>"Waiting for messages."</span>);</span><br><span class=line>		<span class=comment>// 指定消费队列</span></span><br><span class=line>		channel.basicConsume(QUEUE_NAME, <span class=keyword>true</span>, consumer);</span><br><span class=line>		Thread.sleep(<span class=number>100L</span>);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>工具类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=keyword>package</span> com.yangbingdong.rabbitmq.basic;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.Connection;</span><br><span class=line><span class=keyword>import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.io.IOException;</span><br><span class=line><span class=keyword>import</span> java.util.concurrent.TimeoutException;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>ConnectionUtil</span> </span>&#123;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String HOST = <span class=string>"127.0.0.1"</span>;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String NAME_PASS = <span class=string>"rabbitmq"</span>;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>static</span> Connection <span class=title>getConnection</span><span class=params>()</span> <span class=keyword>throws</span> IOException, TimeoutException </span>&#123;</span><br><span class=line>		ConnectionFactory factory = <span class=keyword>new</span> ConnectionFactory();</span><br><span class=line>		factory.setHost(HOST);</span><br><span class=line>		factory.setUsername(NAME_PASS);</span><br><span class=line>		factory.setPassword(NAME_PASS);</span><br><span class=line>		<span class=keyword>return</span> factory.newConnection();</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>运行结果:<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/basic-single-send-and-receive.png alt><h2 id=Connection><a href=#Connection class=headerlink title=Connection></a>Connection</h2><p><code>ConnectionFactory</code>, <code>Connection</code>, <code>Channel</code> 这三个都是RabbitMQ对外提供的API中最基本的对象, 不管是服务器端还是客户端都会首先创建这三类对象.<br><code>ConnectionFactory</code>为<code>Connection</code>的制造工厂.<br><code>Connection</code>是与RabbitMQ服务器的socket链接, 它封装了socket协议及身份验证相关部分逻辑.<br><code>Channel</code>是我们与RabbitMQ打交道的最重要的一个接口, 大部分的业务操作是在Channel这个接口中完成的, 包括定义Queue, 定义Exchange, 绑定Queue与Exchange, 发布消息等.<h2 id=Queue><a href=#Queue class=headerlink title=Queue></a>Queue</h2><p>Queue是RabbitMQ的内部对象, 用于存储消息, RabbitMQ中的消息都只能存储在Queue中, 生产者生产消息并最终投递到Queue中, 消费者可以从Queue中获取消息并消费. 队列是有Channel声明的, 而且这个操作是幂等的, 同名的队列多次声明也只会创建一次.<h2 id=Exchange><a href=#Exchange class=headerlink title=Exchange></a>Exchange</h2><blockquote><p>RabbitMQ消息模式的核心理念是: 生产者没有直接发送任何消费到队列. 实际上, 生产者都不知道这个消费是发送给哪个队列的.<p>相反, 生产者只能发送消息给转发器, 转发器是非常简单的. 一方面它接受生产者的消息, 另一方面向队列推送消息. 转发器必须清楚的知道如何处理接收到的消息. 附加一个特定的队列吗? 附加多个队列? 或者是否丢弃? 这些规则通过转发器的类型进行定义.<p>类型有: <code>Direct</code>, <code>Topic</code>, <code>Headers</code>和<code>Fanout</code></blockquote><h3 id=fanout-exchange><a href=#fanout-exchange class=headerlink title="fanout exchange"></a>fanout exchange</h3><p>发送到该交换器的所有消息, 会被路由到其绑定的所有队列. 该交换器不需要指定routingKey.<h3 id=direct-exchange><a href=#direct-exchange class=headerlink title="direct exchange"></a>direct exchange</h3><p>发送到该交换器的消息, 会通过路由键完全匹配, 匹配成功就会路由到指定队列.<p>发送到 <code>direct exchange</code> 的消息, 会通过消息的 <code>routing key</code> 路由:<ul><li>如果 <code>routing key</code> 值为 <code>queue.direct.key1</code>, 会路由到 <code>QUEUE-1</code><li>如果 <code>routing key</code> 值为 <code>queue.direct.key2</code>, 会路由到 <code>QUEUE-2</code><li>如果 <code>routing key</code> 值为其他, 不会路由到任何队列</ul><h3 id=topic-exchange><a href=#topic-exchange class=headerlink title="topic exchange"></a>topic exchange</h3><p>发送到该交换器的消息, 会通过路由键模糊匹配, 匹配成功就会路由到指定队列, 路由键通过 <code>.</code> 来划分为多个单词, <code>*</code> 匹配一个单词, <code>#</code> 匹配零个或多个单词.<p>发送到 <code>topic exchange</code> 的消息, 会通过消息的 <code>routing key</code> 模糊匹配再路由:<ul><li>如果 <code>routing key</code> 值为 <code>queue.topic.key1</code>, 会路由到 <code>QUEUE-1</code> 和 <code>QUEUE-2</code><li>如果 <code>routing key</code> 值为 <code>test.topic.key2</code>, 会路由到 <code>QUEUE-1</code><li>如果 <code>routing key</code> 值为 <code>queue</code>, 会路由到 <code>QUEUE-2</code><li>如果 <code>routing key</code> 值为 <code>queue.hello</code>, 会路由到 <code>QUEUE-2</code><li>如果 <code>routing key</code> 值为 <code>test.test.test</code>, 不会路由到任何队列</ul><h3 id=header-exchange><a href=#header-exchange class=headerlink title="header exchange"></a>header exchange</h3><p>发送到该交换器的消息, 会通过消息的 <code>header</code> 信息匹配, 匹配成功就会路由到指定队列.<p>消息的 <code>header</code> 信息是 <code>key-value</code> 的形式, 每条消息可以包含多条 <code>header</code> 信息, 路由规则是通过 <code>header</code> 信息的 <code>key</code> 来匹配的, Spring Boot 封装的匹配规则有三种:<ul><li><code>where(key).exists()</code> :匹配单个 <code>key</code><li><code>whereAll(keys).exist()</code> :同时匹配多个 <code>key</code><li><code>whereAny(keys).exist()</code> :匹配多个 <code>key</code> 中的一个或多个</ul><p>发送到 <code>headers exchange</code> 的消息, 会通过消息的 <code>header</code> 匹配:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function>Binding <span class=title>bindingHeadersQueue1</span><span class=params>(Queue headersQueue1, HeadersExchange headersExchange)</span> </span>&#123;</span><br><span class=line>	<span class=keyword>return</span> BindingBuilder.bind(headersQueue1).to(headersExchange).where(<span class=string>"one"</span>).exists();</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function>Binding <span class=title>bindingHeadersQueue2</span><span class=params>(Queue headersQueue1, HeadersExchange headersExchange)</span> </span>&#123;</span><br><span class=line>	<span class=keyword>return</span> BindingBuilder.bind(headersQueue1).to(headersExchange).whereAll(<span class=string>"all1"</span>, <span class=string>"all2"</span>).exist();</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function>Binding <span class=title>bindingHeadersQueue3</span><span class=params>(Queue headersQueue3, HeadersExchange headersExchange)</span> </span>&#123;</span><br><span class=line>	<span class=keyword>return</span> BindingBuilder.bind(headersQueue3).to(headersExchange).whereAny(<span class=string>"any1"</span>, <span class=string>"any2"</span>).exist();</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li>如果 <code>header</code> 信息存在 <code>one=XXXX</code>, 会路由到 <code>QUEUE-1</code><li>如果 <code>header</code> 信息存在 <code>all1=XXXX</code> 和 <code>all2=XXXX</code>, 会路由到 <code>QUEUE-2</code><li>如果 <code>header</code> 信息存在 <code>any1=XXXX</code> 或 <code>any2=XXXX</code>, 会路由到 <code>QUEUE-3</code></ul><blockquote><p><code>header</code> 不能以 <code>x-</code> 开头, 参考官方文档:<a href=https://www.rabbitmq.com/tutorials/amqp-concepts.html#exchange-headers rel="external nofollow noopener noreferrer" target=_blank>https://www.rabbitmq.com/tutorials/amqp-concepts.html#exchange-headers</a></blockquote><h1 id=Spring-AMQP的几个参数说明><a href=#Spring-AMQP的几个参数说明 class=headerlink title="Spring AMQP的几个参数说明"></a>Spring AMQP的几个参数说明</h1><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line>spring:</span><br><span class=line>  rabbitmq:</span><br><span class=line>    addresses: 127.0.0.1:5672</span><br><span class=line>    username: rabbitmq</span><br><span class=line>    password: rabbitmq</span><br><span class=line>    virtual-host: /</span><br><span class=line>    connection-timeout: 15000</span><br><span class=line></span><br><span class=line>    ## 生产者配置</span><br><span class=line>    # 消息到达 exchange ack</span><br><span class=line>    publisher-confirm-type: correlated</span><br><span class=line>    # 消息被路由到队列 ack</span><br><span class=line>    publisher-returns: true</span><br><span class=line>    template:</span><br><span class=line>      # 必须开启这个才会触发 return callback</span><br><span class=line>      mandatory: true</span><br><span class=line></span><br><span class=line>    ## 消费端配置</span><br><span class=line>    listener:</span><br><span class=line>      simple:</span><br><span class=line>        #消费并发消费数量, 默认为1</span><br><span class=line>        concurrency: 1</span><br><span class=line>        #最大消费端数</span><br><span class=line>        max-concurrency: 1</span><br><span class=line>        #自动签收auto  手动 manual</span><br><span class=line>        acknowledge-mode: manual</span><br><span class=line>        #限流（海量数据，同时只能过来一条）</span><br><span class=line>        prefetch: 1</span><br></pre></table></figure><h1 id=ListenerContainer线程池配置><a href=#ListenerContainer线程池配置 class=headerlink title=ListenerContainer线程池配置></a>ListenerContainer线程池配置</h1><p>默认一个消费者对应一个新的线程, 可配置共享线程池节约线程.<h2 id=Spring-AMQP><a href=#Spring-AMQP class=headerlink title="Spring AMQP"></a>Spring AMQP</h2><p>Spring Boot 的相关配置在 <code>RabbitAutoConfiguration</code> -&gt; <code>RabbitAnnotationDrivenConfiguration</code>.<p>ListernContainer的线程池可以配置在 <code>SimpleRabbitListenerContainerFactory</code> 中:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span>(name = <span class=string>"rabbitListenerContainerFactory"</span>)</span><br><span class=line><span class=function><span class=keyword>public</span> SimpleRabbitListenerContainerFactory <span class=title>simpleRabbitListenerContainerFactory</span><span class=params>(</span></span></span><br><span class=line><span class=function><span class=params>        SimpleRabbitListenerContainerFactoryConfigurer configurer,</span></span></span><br><span class=line><span class=function><span class=params>        ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class=line>    SimpleRabbitListenerContainerFactory factory = <span class=keyword>new</span> SimpleRabbitListenerContainerFactory();</span><br><span class=line>    ThreadPoolTaskExecutor taskExecutor = <span class=keyword>new</span> ThreadPoolTaskExecutor();</span><br><span class=line>    taskExecutor.setCorePoolSize(<span class=number>16</span>);</span><br><span class=line>    taskExecutor.setMaxPoolSize(<span class=number>16</span>);</span><br><span class=line>    taskExecutor.setQueueCapacity(<span class=number>500</span>);</span><br><span class=line>    taskExecutor.setKeepAliveSeconds(<span class=number>60</span>);</span><br><span class=line>    taskExecutor.setWaitForTasksToCompleteOnShutdown(<span class=keyword>true</span>);</span><br><span class=line>    taskExecutor.setThreadNamePrefix(<span class=string>"rabbitExecutor-"</span>);</span><br><span class=line>    taskExecutor.setRejectedExecutionHandler(<span class=keyword>new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class=line>    taskExecutor.initialize();</span><br><span class=line>    factory.setTaskExecutor(taskExecutor);</span><br><span class=line>    configurer.configure(factory, connectionFactory);</span><br><span class=line>    <span class=keyword>return</span> factory;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=Spring-Cloud-Stream><a href=#Spring-Cloud-Stream class=headerlink title="Spring Cloud Stream"></a>Spring Cloud Stream</h2><p>对于 Spring Cloud Stream, 可以实现 <code>ListenerContainerCustomizer</code> 接口定制化配置:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomListenerContainerCustomizer</span> <span class=keyword>implements</span> <span class=title>ListenerContainerCustomizer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(Object container, String destinationName, String group)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>if</span> (container <span class=keyword>instanceof</span> SimpleMessageListenerContainer) &#123;</span><br><span class=line>			<span class=keyword>if</span> (destinationName.equals(MEIYA_QUEUE_ANALIFEBANK_QUEUE)) &#123;</span><br><span class=line>				SimpleMessageListenerContainer simpleMessageListenerContainer = (SimpleMessageListenerContainer) container;</span><br><span class=line>                ThreadPoolTaskExecutor taskExecutor = <span class=keyword>new</span> ThreadPoolTaskExecutor();</span><br><span class=line>                taskExecutor.setCorePoolSize(<span class=number>16</span>);</span><br><span class=line>                taskExecutor.setMaxPoolSize(<span class=number>16</span>);</span><br><span class=line>                taskExecutor.setQueueCapacity(<span class=number>500</span>);</span><br><span class=line>                taskExecutor.setKeepAliveSeconds(<span class=number>60</span>);</span><br><span class=line>                taskExecutor.setWaitForTasksToCompleteOnShutdown(<span class=keyword>true</span>);</span><br><span class=line>                taskExecutor.setThreadNamePrefix(<span class=string>"rabbitExecutor-"</span>);</span><br><span class=line>                taskExecutor.setRejectedExecutionHandler(<span class=keyword>new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class=line>                taskExecutor.initialize();</span><br><span class=line>                simpleMessageListenerContainer.setTaskExecutor(taskExecutor);</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h1 id=持久化><a href=#持久化 class=headerlink title=持久化></a>持久化</h1><p>开启消息持久化可在RabbitMQ重启后不丢失消息.<blockquote><p>在Docker中, 数据存放在 <code>/var/lib/rabbitmq</code> .</blockquote><h2 id=Spring-AMQP-1><a href=#Spring-AMQP-1 class=headerlink title="Spring AMQP"></a>Spring AMQP</h2><p>在Spring AMQP中, 通过Queue构造器可指定持久化是否开启:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> Queue <span class=title>delayQueue</span><span class=params>()</span> </span>&#123;</span><br><span class=line>	<span class=keyword>return</span> <span class=keyword>new</span> Queue(DELAY_QUEUE, <span class=keyword>true</span>);</span><br><span class=line>&#125;</span><br></pre></table></figure><p>第二个参数指的是是否开启持久化:<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/queue-constructor01.png alt><p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/queue-constructor02.png alt><p>ExChange 指定持久化也一样:<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/exchange-constructor.png alt><h2 id=Spring-Cloud-Stream-1><a href=#Spring-Cloud-Stream-1 class=headerlink title="Spring Cloud Stream"></a>Spring Cloud Stream</h2><p>在Spring Cloud Stream中指定Queue与Exchange持久化只需要通过以下两个参数配置, 默认值都为 <code>true</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.durableSubscription=</span><br><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.exchangeDurable=</span><br></pre></table></figure><h1 id=手动ACK><a href=#手动ACK class=headerlink title=手动ACK></a>手动ACK</h1><p>在Spring AMQP中ACK是自动完成的, 如果报错了, 消息不会丢失, 但是会无限循环消费, 一直报错, 如果开启了错误日志很容易就把磁盘空间耗完.<p>在Spring Cloud Stream中默认情况下会自动重试3次, 再自动ACK. 可通过 <code>maxAttempts</code> 参数指定重试次数.<h2 id=配置><a href=#配置 class=headerlink title=配置></a>配置</h2><h3 id=Spring-Cloud-Stream-2><a href=#Spring-Cloud-Stream-2 class=headerlink title="Spring Cloud Stream"></a>Spring Cloud Stream</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.acknowledgeMode=MANUAL</span><br></pre></table></figure><h3 id=Spring-AMQP-2><a href=#Spring-AMQP-2 class=headerlink title="Spring AMQP"></a>Spring AMQP</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.rabbitmq.listener.simple.acknowledge-mode=MANUAL</span><br></pre></table></figure><h2 id=代码示例><a href=#代码示例 class=headerlink title=代码示例></a>代码示例</h2><h3 id=Spring-Cloud-Stream-3><a href=#Spring-Cloud-Stream-3 class=headerlink title="Spring Cloud Stream"></a>Spring Cloud Stream</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=meta>@EnableBinding</span>(AckTopic<span class=class>.<span class=keyword>class</span>)</span></span><br><span class=line><span class=class>@<span class=title>Component</span></span></span><br><span class=line><span class=class>@<span class=title>Slf4j</span></span></span><br><span class=line><span class=class><span class=title>public</span> <span class=title>class</span> <span class=title>AckTopicListener</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@StreamListener</span>(AckTopic.INPUT)</span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>receive</span><span class=params>(Message&lt;String&gt; message, @Header(AmqpHeaders.CHANNEL)</span> Channel channel,</span></span><br><span class=line><span class=function>						@<span class=title>Header</span><span class=params>(AmqpHeaders.DELIVERY_TAG)</span> Long deliveryTag) <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>		log.info(<span class=string>"Received: "</span> + message.getPayload());</span><br><span class=line>		channel.basicAck(deliveryTag, <span class=keyword>false</span>);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li>使用 <code>channel.basicAck(deliveryTag, false)</code> 进行ACK.<li><code>Channel</code> 也可以通过 <code>message.getHeaders().get(AmqpHeaders.CHANNEL, Channel.class)</code> 获取, <code>deliveryTag</code> 也一样.</ul><h3 id=Spring-AMQP-3><a href=#Spring-AMQP-3 class=headerlink title="Spring AMQP"></a>Spring AMQP</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RabbitConsumer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@RabbitListener</span>(queues = <span class=string>"ack_queue"</span>)</span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>handler</span><span class=params>(List&lt;Integer&gt; list, Message message, Channel channel)</span> <span class=keyword>throws</span> IOException </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            dosomething.....</span><br><span class=line>            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class=keyword>false</span>);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>            log.error(<span class=string>"============消费失败,尝试消息补发再次消费!=============="</span>);</span><br><span class=line>            log.error(e.getMessage());</span><br><span class=line>            <span class=comment>/**</span></span><br><span class=line><span class=comment>             * basicRecover方法是进行补发操作, </span></span><br><span class=line><span class=comment>             * 其中的参数如果为true是把消息退回到queue但是有可能被其它的consumer(集群)接收到, </span></span><br><span class=line><span class=comment>             * 设置为false是只补发给当前的consumer</span></span><br><span class=line><span class=comment>             */</span></span><br><span class=line>            channel.basicRecover(<span class=keyword>false</span>);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h1 id=Spring-Boot-中使用方式><a href=#Spring-Boot-中使用方式 class=headerlink title="Spring Boot 中使用方式"></a>Spring Boot 中使用方式</h1><h2 id=创建队列交换机><a href=#创建队列交换机 class=headerlink title=创建队列交换机></a>创建队列交换机</h2><h3 id=通过-RabbitListener创建><a href=#通过-RabbitListener创建 class=headerlink title=通过@RabbitListener创建></a>通过@RabbitListener创建</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=meta>@RabbitListener</span>(</span><br><span class=line>        bindings = <span class=meta>@QueueBinding</span>(</span><br><span class=line>                value = <span class=meta>@Queue</span>(value = <span class=string>"test-topic"</span>,durable = <span class=string>"true"</span>),</span><br><span class=line>                exchange = <span class=meta>@Exchange</span>(name = <span class=string>"test-topic"</span>),</span><br><span class=line>                key=<span class=string>"test-topic"</span></span><br><span class=line>        )</span><br><span class=line>)</span><br><span class=line><span class=meta>@RabbitHandler</span></span><br><span class=line><span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onMessage</span><span class=params>(@Payload TestMessage testMessage, @Headers Map&lt;String,Object&gt; headers, Channel channel)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>    <span class=keyword>try</span> &#123;</span><br><span class=line>        log.info(<span class=string>"收到消息, 当前线程: &#123;&#125;, 消息内容: &#123;&#125;"</span>, Thread.currentThread().getId(), testMessage);</span><br><span class=line>    &#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>        <span class=comment>// 更新为消费失败</span></span><br><span class=line>        log.error(<span class=string>"消费异常"</span>);</span><br><span class=line>    &#125; <span class=keyword>finally</span> &#123;</span><br><span class=line>        <span class=comment>// multiple 为 true 代表批量确认</span></span><br><span class=line>        channel.basicAck((Long) headers.get(AmqpHeaders.DELIVERY_TAG),<span class=keyword>false</span>);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=通过声明Bean创建><a href=#通过声明Bean创建 class=headerlink title=通过声明Bean创建></a>通过声明Bean创建</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> Queue <span class=title>delayQueue</span><span class=params>()</span> </span>&#123;</span><br><span class=line>    <span class=keyword>return</span> <span class=keyword>new</span> Queue(DELAY_QUEUE, <span class=keyword>true</span>, <span class=keyword>false</span>, <span class=keyword>false</span>);</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=通过RabbitAdmin动态注册><a href=#通过RabbitAdmin动态注册 class=headerlink title=通过RabbitAdmin动态注册></a>通过RabbitAdmin动态注册</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> RabbitAdmin <span class=title>rabbitAdmin</span><span class=params>(ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class=line>    <span class=keyword>return</span> <span class=keyword>new</span> RabbitAdmin(connectionFactory);</span><br><span class=line>&#125;</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@PropertySource</span>(factory = YamlPropertySourceFactory<span class=class>.<span class=keyword>class</span>, <span class=title>value</span> </span>= <span class=string>"classpath:MQ-CONF/topic.yml"</span>)</span><br><span class=line><span class=meta>@EnableConfigurationProperties</span>(MessagingProperty<span class=class>.<span class=keyword>class</span>)</span></span><br><span class=line><span class=class><span class=title>public</span> <span class=title>class</span> <span class=title>MessagingConfiguration</span> <span class=keyword>implements</span> <span class=title>InitializingBean</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> MessagingProperty messagingProperty;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> RabbitAdmin rabbitAdmin;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=title>MessagingConfiguration</span><span class=params>(MessagingProperty messagingProperty, RabbitAdmin rabbitAdmin)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.messagingProperty = messagingProperty;</span><br><span class=line>        <span class=keyword>this</span>.rabbitAdmin = rabbitAdmin;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterPropertiesSet</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        <span class=keyword>if</span> (MqType.RABBIT.equals(messagingProperty.getMqType())) &#123;</span><br><span class=line>            registryRabbit(messagingProperty);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>registryRabbit</span><span class=params>(MessagingProperty messagingProperty)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>for</span> (MessagingProperty.Topic topic : messagingProperty.getTopics()) &#123;</span><br><span class=line>            String topicName = topic.getName();</span><br><span class=line>            Queue queue = <span class=keyword>new</span> Queue(topicName, <span class=keyword>true</span>, <span class=keyword>false</span>, <span class=keyword>false</span>);</span><br><span class=line>            DirectExchange exchange = <span class=keyword>new</span> DirectExchange(topicName, <span class=keyword>true</span>, <span class=keyword>false</span>);</span><br><span class=line>            exchange.setDelayed(parseBoolean(topic.getProperties().getOrDefault(<span class=string>"delayed"</span>, <span class=string>"false"</span>)));</span><br><span class=line>            Binding binding = BindingBuilder.bind(queue).to(exchange).with(topicName);</span><br><span class=line>            rabbitAdmin.declareQueue(queue);</span><br><span class=line>            rabbitAdmin.declareExchange(exchange);</span><br><span class=line>            rabbitAdmin.declareBinding(binding);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><code>topic.yml</code>:<figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>messaging:</span></span><br><span class=line>  <span class=attr>mqType:</span> <span class=string>rabbit</span></span><br><span class=line>  <span class=attr>topics:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>test-topic</span></span><br><span class=line>      <span class=attr>properties:</span></span><br><span class=line>        <span class=attr>delayed:</span> <span class=literal>true</span></span><br></pre></table></figure><h2 id=监听><a href=#监听 class=headerlink title=监听></a>监听</h2><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RabbitMqConsumer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@RabbitListener</span>(queues = <span class=string>"test-topic"</span>)</span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onOrderMessage</span><span class=params>(@Payload TestMessage testMessage, @Headers Map&lt;String,Object&gt; headers, Channel channel)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            log.info(<span class=string>"收到消息, 当前线程: &#123;&#125;, 消息内容: &#123;&#125;"</span>, Thread.currentThread().getId(), testMessage);</span><br><span class=line>        &#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>            <span class=comment>// 更新为消费失败</span></span><br><span class=line>            log.error(<span class=string>"消费异常"</span>);</span><br><span class=line>        &#125; <span class=keyword>finally</span> &#123;</span><br><span class=line>            <span class=comment>// multiple 为 true 代表批量确认</span></span><br><span class=line>            channel.basicAck((Long) headers.get(AmqpHeaders.DELIVERY_TAG),<span class=keyword>false</span>);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><code>@RabbitListener</code>注解的消费者监听方法, 默认有几个可以自动注入的参数对象:<ul><li><code>org.springframework.amqp.core.Message</code> 消息原始对象<li><code>com.rabbitmq.client.Channel</code> 接收消息所所在的<code>channel</code><li><code>org.springframework.messaging.Message</code> amqp的原始消息对象转换为messaging后的消息对象, 该消息包含自定义消息头和标准的amqp消息头</ul><p>此外, 非以上参数, 自定义参数对象可以通过<code>@Header</code>/<code>@Headers</code>/<code>@Payload</code>标注为消息头或消息体接受对象.<h1 id=DLQ队列><a href=#DLQ队列 class=headerlink title=DLQ队列></a>DLQ队列</h1><p>通过下面参数开启DLQ转发:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.auto-bind-dlq=true</span><br></pre></table></figure><p>当消息消费失败后, 消息会原封不动地转发到 <code>error-topic.test.dlq</code> 这个死信队列中.<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbit-error-dlq01.png alt><p>点击进入死信队列, 可以使用 <code>Get Message</code> 查看消息, <code>Move message</code> 可以将消息移动到原先的队列中继续消费.<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbit-error-dlq02.png alt><p><strong>设置死信队列消息过期时间</strong>:<p>如果某些消息存在时效性, 可通过一下参数配置过期时间, 超过时间后, 消息会自动移除掉:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.dlq-ttl=10000</span><br></pre></table></figure><p>将异常信息放到消息header中:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.republish-to-dlq=true</span><br></pre></table></figure><p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbit-error-dlq03.png alt><h1 id=重新入队><a href=#重新入队 class=headerlink title=重新入队></a>重新入队</h1><p>重新入队是指消息消费失败了之后, 消息将不会被抛弃, 而是重新放入队列中.<p>可以通过以下参数开启:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.requeue-rejected=true</span><br></pre></table></figure><p>这样会导致一个问题就是, 业务代码的缺陷导致的异常, 无论消费多少次, 这个消息总是失败的. 那么会导致消息堆积越来越大, 那么可以通过配合DLQ来避免这个情况:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.cloud.stream.rabbit.bindings.&lt;channelName&gt;.consumer.auto-bind-dlq=true</span><br></pre></table></figure><p>然后到达一定重试次数之后抛出 <code>AmqpRejectAndDontRequeueException</code> 这个指定的异常, 消息就会被推到死信队列中了:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=meta>@StreamListener</span>(TestTopic.INPUT)</span><br><span class=line><span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>receive</span><span class=params>(String payload)</span> </span>&#123;</span><br><span class=line>    log.info(<span class=string>"Received payload : "</span> + payload + <span class=string>", "</span> + count);</span><br><span class=line>    <span class=keyword>if</span> (count == <span class=number>3</span>) &#123;</span><br><span class=line>        count = <span class=number>1</span>;</span><br><span class=line>        <span class=keyword>throw</span> <span class=keyword>new</span> AmqpRejectAndDontRequeueException(<span class=string>"tried 3 times failed, send to dlq!"</span>);</span><br><span class=line>    &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>        count ++;</span><br><span class=line>        <span class=keyword>throw</span> <span class=keyword>new</span> RuntimeException(<span class=string>"Message consumer failed!"</span>);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><strong>总结</strong>:<p>上面介绍了几种Spring Cloud Stream RabbitMQ中的重试策略, 个人认为比较适合实际业务场景的做法是, 失败后, 将消息持久化到数据库中, 后续再通过邮件或钉钉等方式通知开发人员进行处理. 因为一般场景下 , 绝大部分的异常消息都是由于业务代码的缺陷导致的, 所以怎么重试都会失败, 并且消费逻辑中一定要做好<strong>幂等</strong>校验.<h1 id=延迟队列><a href=#延迟队列 class=headerlink title=延迟队列></a>延迟队列</h1><h2 id=实现方式><a href=#实现方式 class=headerlink title=实现方式></a>实现方式</h2><p>RabbitMQ的延迟队列可以通过<strong>死信队列</strong>来实现, 但这种方式显得比较臃肿并且有致命的缺陷(设置了不同的过期时间, 队列并不会按照这些过期时间来顺序消费), 具体请参考: <strong><em><a href=https://blog.csdn.net/eumenides_/article/details/86025773 rel="external nofollow noopener noreferrer" target=_blank>springboot整合rabbitmq实现延时队列之TTL方式</a></em></strong><p>比较优雅的方式是通过 <code>rabbitmq_delayed_message_exchange</code> 插件来实现延迟队列. 插件介绍可查看官网: <strong><em><a href=https://www.rabbitmq.com/blog/2015/04/16/scheduling-messages-with-rabbitmq/ rel="external nofollow noopener noreferrer" target=_blank>https://www.rabbitmq.com/blog/2015/04/16/scheduling-messages-with-rabbitmq/</a></em></strong><p>流程大概是这样的:<p>1: 生产者将消息(msg)和路由键(routekey)发送指定的延时交换机(exchange)上<p>2: 延时交换机(exchange)存储消息等待消息到期根据路由键(routekey)找到绑定自己的队列(queue)并把消息给它<p>3: 队列(queue)再把消息发送给监听它的消费者(customer）<h2 id=插件安装><a href=#插件安装 class=headerlink title=插件安装></a>插件安装</h2><blockquote><p>只有RabbitMQ 3.6.x以上才支持</blockquote><p>这里使用Docker部署, <code>rabbitmq_delayed_message_exchange</code>插件需要到 <strong><em><a href=https://www.rabbitmq.com/community-plugins.html rel="external nofollow noopener noreferrer" target=_blank>官网下载</a></em></strong>.<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbitmq-x-delay-plugin.png alt><p>Dockerfile:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>FROM rabbitmq:3.7-management</span><br><span class=line>COPY --chown=rabbitmq:rabbitmq rabbitmq_delayed_message_exchange-20171201-3.7.x.ez /opt/rabbitmq/plugins/</span><br><span class=line>COPY --chown=rabbitmq:rabbitmq enabled_plugins /etc/rabbitmq/enabled_plugins</span><br></pre></table></figure><p>enable_plugins:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>[rabbitmq_delayed_message_exchange,rabbitmq_management].</span><br></pre></table></figure><blockquote><p><strong>注意</strong>: 插件需要解压放到Dockerfile根目录.</blockquote><p>或者这个Dockerfile也可以:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>FROM rabbitmq:3.7-management</span><br><span class=line>COPY --chown=rabbitmq:rabbitmq rabbitmq_delayed_message_exchange-20171201-3.7.x.ez /opt/rabbitmq/plugins/</span><br><span class=line>RUN rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></table></figure><p>构建:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker build -t my-rabbitmq .</span><br></pre></table></figure><h2 id=代码示例-1><a href=#代码示例-1 class=headerlink title=代码示例></a>代码示例</h2><h3 id=Spring-Cloud-Stream-4><a href=#Spring-Cloud-Stream-4 class=headerlink title="Spring Cloud Stream"></a>Spring Cloud Stream</h3><p><code>application.yml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>application:</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>rabbitmq-learning</span></span><br><span class=line>  <span class=attr>rabbitmq:</span></span><br><span class=line>    <span class=attr>host:</span> <span class=number>192.168</span><span class=number>.6</span><span class=number>.113</span></span><br><span class=line>    <span class=attr>port:</span> <span class=number>5672</span></span><br><span class=line>    <span class=attr>username:</span> <span class=string>rabbitmq</span></span><br><span class=line>    <span class=attr>password:</span> <span class=string>rabbitmq</span></span><br><span class=line>  <span class=attr>profiles:</span></span><br><span class=line>    <span class=attr>include:</span> <span class=string>stream-rabbitmq-delay</span></span><br></pre></table></figure><p><code>application-stream-rabbitmq-delay.yml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>stream:</span></span><br><span class=line>      <span class=attr>default:</span></span><br><span class=line>        <span class=attr>contentType:</span> <span class=string>application/json</span></span><br><span class=line>        <span class=attr>consumer:</span></span><br><span class=line>          <span class=attr>maxAttempts:</span> <span class=number>1</span></span><br><span class=line>      <span class=attr>bindings:</span></span><br><span class=line>        <span class=attr>delay-topic-output:</span></span><br><span class=line>          <span class=attr>destination:</span> <span class=string>delay-topic</span></span><br><span class=line>        <span class=attr>delay-topic-input:</span></span><br><span class=line>          <span class=attr>destination:</span> <span class=string>delay-topic</span></span><br><span class=line>          <span class=attr>group:</span> <span class=string>test</span></span><br><span class=line>      <span class=attr>rabbit:</span></span><br><span class=line>        <span class=attr>bindings:</span></span><br><span class=line>          <span class=attr>delay-topic-output:</span></span><br><span class=line>            <span class=attr>producer:</span></span><br><span class=line>              <span class=attr>delayedExchange:</span> <span class=literal>true</span></span><br><span class=line>          <span class=attr>delay-topic-input:</span></span><br><span class=line>            <span class=attr>consumer:</span></span><br><span class=line>              <span class=attr>delayedExchange:</span> <span class=literal>true</span></span><br></pre></table></figure><ul><li><code>delayedExchange</code> 设置为<code>true</code>表示将 <code>exchange</code> 声明为 <code>Delayed Message Exchange</code>. <strong>生产者以及消费者都需要配置</strong>这个, 否则会报以下错误:</ul><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>Channel shutdown: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg &apos;type&apos; for exchange &apos;delay-topic&apos; in vhost &apos;/&apos;: received &apos;topic&apos; but current is &apos;&apos;x-delayed-message&apos;&apos;, class-id=40, method-id=10)</span><br></pre></table></figure><p>代码:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>interface</span> <span class=title>DelayTopic</span> </span>&#123;</span><br><span class=line>	String OUTPUT = <span class=string>"delay-topic-output"</span>;</span><br><span class=line>	String INPUT = <span class=string>"delay-topic-input"</span>;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Output</span>(OUTPUT)</span><br><span class=line>	<span class=function>MessageChannel <span class=title>output</span><span class=params>()</span></span>;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Input</span>(INPUT)</span><br><span class=line>	<span class=function>SubscribableChannel <span class=title>input</span><span class=params>()</span></span>;</span><br><span class=line>&#125;</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line><span class=meta>@EnableBinding</span>(DelayTopic<span class=class>.<span class=keyword>class</span>)</span></span><br><span class=line><span class=class>@<span class=title>Component</span></span></span><br><span class=line><span class=class>@<span class=title>Slf4j</span></span></span><br><span class=line><span class=class><span class=title>public</span> <span class=title>class</span> <span class=title>DelayTopicListener</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@StreamListener</span>(DelayTopic.INPUT)</span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>receive</span><span class=params>(String payload)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"Received: "</span> + payload);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>发送延迟消息:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>XDelaySender</span> <span class=keyword>extends</span> <span class=title>SpringBootRabbitmqApplicationTests</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Autowired</span></span><br><span class=line>	<span class=keyword>private</span> DelayTopic delayTopic;</span><br><span class=line></span><br><span class=line></span><br><span class=line>	<span class=meta>@Test</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>sendDelay</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		delayTopic.output().send(MessageBuilder.withPayload(<span class=string>"Hello World "</span>).setHeader(<span class=string>"x-delay"</span>, <span class=number>5000</span>).build());</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>运行结果, 可以看到发送与接受之间差了5秒:<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/stream-rabbit-delay01.png alt><p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/stream-rabbit-delay02.png alt><h3 id=Spring-AMQP-4><a href=#Spring-AMQP-4 class=headerlink title="Spring AMQP"></a>Spring AMQP</h3><p>Configuration:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RabbitMqConfiguration</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> DirectExchange <span class=title>delayExchange</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        DirectExchange exchange = <span class=keyword>new</span> DirectExchange(topicName, <span class=keyword>true</span>, <span class=keyword>false</span>, <span class=keyword>false</span>);</span><br><span class=line>        exchange.setDelayed(<span class=keyword>true</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> Queue <span class=title>delayQueue</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>new</span> Queue(DELAY_QUEUE, <span class=keyword>true</span>, <span class=keyword>false</span>, <span class=keyword>false</span>);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> Binding <span class=title>delayBinging</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> BindingBuilder.bind(delayQueue()).to(delayExchange()).with(DELAY_ROUTING_KEY);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>常量类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=keyword>final</span> <span class=class><span class=keyword>class</span> <span class=title>MqConstant</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String DELAY_EXCHANGE = <span class=string>"delay_exchange"</span>;</span><br><span class=line></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String DELAY_QUEUE = <span class=string>"delay_queue.ybd"</span>;</span><br><span class=line></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String DELAY_ROUTING_KEY = <span class=string>"delay_routing_key"</span>;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><p>生产者:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RabbitProduct</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Autowired</span></span><br><span class=line>	<span class=keyword>private</span> RabbitTemplate rabbitTemplate;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>sendDelayMessage</span><span class=params>(User user, Integer delay)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"发送时间:&#123;&#125;,发送内容:&#123;&#125;"</span>, LocalDateTime.now(), user);</span><br><span class=line>		rabbitTemplate.convertAndSend(</span><br><span class=line>				DELAY_EXCHANGE,</span><br><span class=line>				DELAY_ROUTING_KEY,</span><br><span class=line>				user,</span><br><span class=line>				message -&gt; &#123;</span><br><span class=line>					message.getMessageProperties().setDelay(delay);</span><br><span class=line>					<span class=keyword>return</span> message;</span><br><span class=line>				&#125;</span><br><span class=line>		);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>消费者:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RabbitConsumer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@RabbitListener</span>(queues = MqConstant.DELAY_QUEUE)</span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>delayQueueListener</span><span class=params>(User user, Message message, Channel channel)</span> <span class=keyword>throws</span> IOException </span>&#123;</span><br><span class=line>		log.info(<span class=string>"接收时间:&#123;&#125;,接受内容:&#123;&#125;"</span>, LocalDateTime.now(), user);</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>			System.out.println(<span class=string>"处理业务逻辑中"</span>);</span><br><span class=line>		&#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=查看延迟消息数量><a href=#查看延迟消息数量 class=headerlink title=查看延迟消息数量></a>查看延迟消息数量</h2><p>这个可以通过RabbitMQ的管理页面查看:<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/x-dalay-admin01.png alt><p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/x-dalay-admin02.png alt><h1 id=独占队列><a href=#独占队列 class=headerlink title=独占队列></a>独占队列</h1><p>某些场景下, 我们对消息的处理具有<strong>严格的顺序</strong>依赖性, 比如下一个消息的处理需要基于上一个消息的处理结果.<p>这时候, 一般比较暴力的做法就是只部署一台消费者. 还有另外一种做法便是独占队列.<p>以RabbitMQ为例, 使用注解的话只需要多加一个 <code>exclusive = true</code> 的参数:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=meta>@RabbitListener</span>(queues = <span class=string>"$&#123;items.updated.queue&#125;"</span>, exclusive = <span class=keyword>true</span>)</span><br></pre></table></figure><p>Spring Cloud Stream 配置:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span>  </span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>stream:</span></span><br><span class=line>      <span class=attr>default:</span></span><br><span class=line>        <span class=attr>contentType:</span> <span class=string>application/json</span></span><br><span class=line>        <span class=attr>consumer:</span></span><br><span class=line>          <span class=attr>max-attempts:</span> <span class=number>1</span></span><br><span class=line>      <span class=attr>bindings:</span></span><br><span class=line>        <span class=attr>input:</span></span><br><span class=line>          <span class=attr>binder:</span> <span class=string>rabbit</span></span><br><span class=line>          <span class=attr>destination:</span> <span class=string>test_queue</span></span><br><span class=line>          <span class=attr>group:</span> <span class=string>test_group</span></span><br><span class=line>        <span class=attr>output :</span></span><br><span class=line>          <span class=attr>binder:</span> <span class=string>rabbit</span></span><br><span class=line>          <span class=attr>destination:</span> <span class=string>test_queue</span></span><br><span class=line>      <span class=attr>rabbit:</span></span><br><span class=line>        <span class=attr>bindings:</span></span><br><span class=line>          <span class=attr>input:</span></span><br><span class=line>            <span class=attr>consumer:</span></span><br><span class=line>              <span class=comment># 消费者启用独占模式</span></span><br><span class=line>              <span class=attr>exclusive:</span> <span class=literal>true</span></span><br><span class=line>              <span class=comment># 如果多个消费者则只有一个成功, 其他的消费者会不断地进行重试, 默认间隔为 5000ms</span></span><br><span class=line>              <span class=attr>recoveryInterval:</span> <span class=number>600000</span></span><br></pre></table></figure><ul><li><code>recoveryInterval</code>: 由于RabbitMq的独占队列只有一个消费者能成功订阅, 后面的消费者都会失败并不断地重试, 我们可以将重试时间调大一点(默认为5000ms).</ul><p>并且会有一个 WARN 级别的日志打印出来, 我们可以自己实现 <code>ConditionalExceptionLogger</code> 接口将日志改为 INFO 级别:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomConditionalExceptionLogger</span> <span class=keyword>implements</span> <span class=title>ConditionalExceptionLogger</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>log</span><span class=params>(Log logger, String message, Throwable t)</span> </span>&#123;</span><br><span class=line>		logger.info(<span class=string>"Exclusive fail"</span>);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>注入到 <code>SimpleMessageListenerContainer</code>:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomListenerContainerCustomizer</span> <span class=keyword>implements</span> <span class=title>ListenerContainerCustomizer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(Object container, String destinationName, String group)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>if</span> (container <span class=keyword>instanceof</span> SimpleMessageListenerContainer) &#123;</span><br><span class=line>			<span class=keyword>if</span> (destinationName.equals(TEST_QUEUE)) &#123;</span><br><span class=line>				SimpleMessageListenerContainer simpleMessageListenerContainer = (SimpleMessageListenerContainer) container;</span><br><span class=line>				simpleMessageListenerContainer.setExclusiveConsumerExceptionLogger(<span class=keyword>new</span> CustomConditionalExceptionLogger());</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>注册到Spring容器:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function><span class=keyword>public</span> ListenerContainerCustomizer <span class=title>customListenerContainerCustomizer</span><span class=params>()</span> </span>&#123;</span><br><span class=line>	<span class=keyword>return</span> <span class=keyword>new</span> CustomListenerContainerCustomizer();</span><br><span class=line>&#125;</span><br></pre></table></figure><p>启用了独占模式的队列中, 可以看到这个:<p><img src=https://cdn.yangbingdong.com/img/rabbitmq-learning/rabbitmq-exclusive.png alt><h1 id=附录><a href=#附录 class=headerlink title=附录></a>附录</h1><h2 id=多Binder配置><a href=#多Binder配置 class=headerlink title=多Binder配置></a>多Binder配置</h2><p><code>spring.cloud.stream.bindings.{channel-name}.binder</code>:设定指定通道binder名称，完全自定义；<br><code>spring.cloud.stream.binders.{binder-name}.type</code>：对自定义的binder设定其类型，rabbit或者kafka；<br><code>spring.cloud.stream.binders.{binder-name}.environment.{*}</code>：对自定义的binder设定其配置项，如host等；<br><code>spring.cloud.stream.default-binder</code>：除了特殊的通道需要设定binder，其他的channel需要从所有自定义的binder选择一个作为默认binder，即所有非指定binder的通道均采用此<code>default-binder</code><h1 id=Finally><a href=#Finally class=headerlink title=Finally></a>Finally</h1><blockquote><p>参考:<p><strong><em><a href=https://www.kancloud.cn/longxuan/rabbitmq-arron rel="external nofollow noopener noreferrer" target=_blank>https://www.kancloud.cn/longxuan/rabbitmq-arron</a></em></strong><p><strong><em><a href=http://blog.didispace.com/spring-cloud-starter-finchley-7-7/ rel="external nofollow noopener noreferrer" target=_blank>http://blog.didispace.com/spring-cloud-starter-finchley-7-7/</a></em></strong><p><strong><em><a href=https://blog.csdn.net/eumenides_/article/details/86025773 rel="external nofollow noopener noreferrer" target=_blank>https://blog.csdn.net/eumenides_/article/details/86025773</a></em></strong><p><strong><em><a href=https://blog.csdn.net/songhaifengshuaige/article/details/79266444 rel="external nofollow noopener noreferrer" target=_blank>https://blog.csdn.net/songhaifengshuaige/article/details/79266444</a></em></strong></blockquote></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2019/rabbitmq-and-spring-amqp-learning/ title="Rabbit & Spring AMQP 入门">http://yangbingdong.com/2019/rabbitmq-and-spring-amqp-learning/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a>
<a href=/tags/Spring-Cloud/ rel=tag><i class="fa fa-tag"></i>Spring Cloud</a>
<a href=/tags/RabbitMQ/ rel=tag><i class="fa fa-tag"></i>RabbitMQ</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2019/use-caddy-to-deploy-static-blog-with-https/ rel=next title=使用Caddy部署Https静态博客站点><i class="fa fa-chevron-left"></i>使用Caddy部署Https静态博客站点</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2019/localize-server-problem/ rel=prev title=线上问题定位常用技巧>线上问题定位常用技巧 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2019/rabbitmq-and-spring-amqp-learning/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2019/rabbitmq-and-spring-amqp-learning/';this.page.identifier='2019/rabbitmq-and-spring-amqp-learning/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>47</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>18</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>44</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#启动><span class=nav-number>2.</span> <span class=nav-text>启动</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#基本概念><span class=nav-number>3.</span> <span class=nav-text>基本概念</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Hello-World><span class=nav-number>3.1.</span> <span class=nav-text>Hello World</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Connection><span class=nav-number>3.2.</span> <span class=nav-text>Connection</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Queue><span class=nav-number>3.3.</span> <span class=nav-text>Queue</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Exchange><span class=nav-number>3.4.</span> <span class=nav-text>Exchange</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#fanout-exchange><span class=nav-number>3.4.1.</span> <span class=nav-text>fanout exchange</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#direct-exchange><span class=nav-number>3.4.2.</span> <span class=nav-text>direct exchange</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#topic-exchange><span class=nav-number>3.4.3.</span> <span class=nav-text>topic exchange</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#header-exchange><span class=nav-number>3.4.4.</span> <span class=nav-text>header exchange</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-AMQP的几个参数说明><span class=nav-number>4.</span> <span class=nav-text>Spring AMQP的几个参数说明</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#ListenerContainer线程池配置><span class=nav-number>5.</span> <span class=nav-text>ListenerContainer线程池配置</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-AMQP><span class=nav-number>5.1.</span> <span class=nav-text>Spring AMQP</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-Cloud-Stream><span class=nav-number>5.2.</span> <span class=nav-text>Spring Cloud Stream</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#持久化><span class=nav-number>6.</span> <span class=nav-text>持久化</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-AMQP-1><span class=nav-number>6.1.</span> <span class=nav-text>Spring AMQP</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-Cloud-Stream-1><span class=nav-number>6.2.</span> <span class=nav-text>Spring Cloud Stream</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#手动ACK><span class=nav-number>7.</span> <span class=nav-text>手动ACK</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#配置><span class=nav-number>7.1.</span> <span class=nav-text>配置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Cloud-Stream-2><span class=nav-number>7.1.1.</span> <span class=nav-text>Spring Cloud Stream</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-AMQP-2><span class=nav-number>7.1.2.</span> <span class=nav-text>Spring AMQP</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#代码示例><span class=nav-number>7.2.</span> <span class=nav-text>代码示例</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Cloud-Stream-3><span class=nav-number>7.2.1.</span> <span class=nav-text>Spring Cloud Stream</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-AMQP-3><span class=nav-number>7.2.2.</span> <span class=nav-text>Spring AMQP</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Boot-中使用方式><span class=nav-number>8.</span> <span class=nav-text>Spring Boot 中使用方式</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#创建队列交换机><span class=nav-number>8.1.</span> <span class=nav-text>创建队列交换机</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#通过-RabbitListener创建><span class=nav-number>8.1.1.</span> <span class=nav-text>通过@RabbitListener创建</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#通过声明Bean创建><span class=nav-number>8.1.2.</span> <span class=nav-text>通过声明Bean创建</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#通过RabbitAdmin动态注册><span class=nav-number>8.1.3.</span> <span class=nav-text>通过RabbitAdmin动态注册</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#监听><span class=nav-number>8.2.</span> <span class=nav-text>监听</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#DLQ队列><span class=nav-number>9.</span> <span class=nav-text>DLQ队列</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#重新入队><span class=nav-number>10.</span> <span class=nav-text>重新入队</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#延迟队列><span class=nav-number>11.</span> <span class=nav-text>延迟队列</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#实现方式><span class=nav-number>11.1.</span> <span class=nav-text>实现方式</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#插件安装><span class=nav-number>11.2.</span> <span class=nav-text>插件安装</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#代码示例-1><span class=nav-number>11.3.</span> <span class=nav-text>代码示例</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-Cloud-Stream-4><span class=nav-number>11.3.1.</span> <span class=nav-text>Spring Cloud Stream</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Spring-AMQP-4><span class=nav-number>11.3.2.</span> <span class=nav-text>Spring AMQP</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#查看延迟消息数量><span class=nav-number>11.4.</span> <span class=nav-text>查看延迟消息数量</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#独占队列><span class=nav-number>12.</span> <span class=nav-text>独占队列</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#附录><span class=nav-number>13.</span> <span class=nav-text>附录</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#多Binder配置><span class=nav-number>13.1.</span> <span class=nav-text>多Binder配置</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Finally><span class=nav-number>14.</span> <span class=nav-text>Finally</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共280.0k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2019/rabbitmq-and-spring-amqp-learning/';var disqus_title="Rabbit & Spring AMQP 入门";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>