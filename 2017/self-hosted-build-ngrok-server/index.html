<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content=VPS,Ngrok,><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="前言 Ngrok可以干嘛？我们经常会有 “把本机开发中的 web 项目给朋友看一下” 或 “测试一下支付宝、微信的支付功能” 这种临时需求, 为此专门购买个域名然后在 VPS或云主机 上部署一遍就有点太浪费了. 那么这时候, Ngrok就是个很好的东西, 它可以实现我们的这种需求. 而且 Ngrok 官网本身还提供了公共服务, 只需要注册一个帐号, 运行它的客户端, 就可以快速把内网映射出去."><meta name=keywords content=VPS,Ngrok><meta property=og:type content=article><meta property=og:title content=VPS自搭建Ngrok内网穿透服务><meta property=og:url content=http://yangbingdong.com/2017/self-hosted-build-ngrok-server/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="前言 Ngrok可以干嘛？我们经常会有 “把本机开发中的 web 项目给朋友看一下” 或 “测试一下支付宝、微信的支付功能” 这种临时需求, 为此专门购买个域名然后在 VPS或云主机 上部署一遍就有点太浪费了. 那么这时候, Ngrok就是个很好的东西, 它可以实现我们的这种需求. 而且 Ngrok 官网本身还提供了公共服务, 只需要注册一个帐号, 运行它的客户端, 就可以快速把内网映射出去."><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/ngrok.png><meta property=og:image content=https://cdn.yangbingdong.com/DNSPod.png><meta property=og:image content=https://cdn.yangbingdong.com/ngrok-server-startup.png><meta property=og:image content=https://cdn.yangbingdong.com/ngrok-client-startup01.png><meta property=og:updated_time content=2020-04-07T10:15:47.014Z><meta name=twitter:card content=summary><meta name=twitter:title content=VPS自搭建Ngrok内网穿透服务><meta name=twitter:description content="前言 Ngrok可以干嘛？我们经常会有 “把本机开发中的 web 项目给朋友看一下” 或 “测试一下支付宝、微信的支付功能” 这种临时需求, 为此专门购买个域名然后在 VPS或云主机 上部署一遍就有点太浪费了. 那么这时候, Ngrok就是个很好的东西, 它可以实现我们的这种需求. 而且 Ngrok 官网本身还提供了公共服务, 只需要注册一个帐号, 运行它的客户端, 就可以快速把内网映射出去."><meta name=twitter:image content=https://cdn.yangbingdong.com/ngrok.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2017/self-hosted-build-ngrok-server/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>VPS自搭建Ngrok内网穿透服务 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2017/self-hosted-build-ngrok-server/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">VPS自搭建Ngrok内网穿透服务</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2017-04-26T18:44:20+08:00>2017-04-26</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/VPS/ itemprop=url rel=index><span itemprop=name>VPS</span></a></span></span>
<span id=/2017/self-hosted-build-ngrok-server/ class=leancloud_visitors data-flag-title=VPS自搭建Ngrok内网穿透服务><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>1,994字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>9分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/ngrok.png alt><h1 id=前言><a href=#前言 class=headerlink title=前言></a>前言</h1><blockquote><p>Ngrok可以干嘛？我们经常会有 “把本机开发中的 web 项目给朋友看一下” 或 “测试一下支付宝、微信的支付功能” 这种临时需求, 为此<strong>专门</strong>购买个域名然后在 VPS或云主机 上<strong>部署一遍</strong>就有点太<strong>浪费</strong>了. 那么这时候, <strong>Ngrok</strong>就是个很好的东西, 它可以实现我们的这种需求. 而且 Ngrok 官网本身还提供了公共服务, 只需要注册一个帐号, 运行它的客户端, 就可以快速把内网映射出去. 不过这么好的服务, 没多久就被<strong>墙</strong>了~幸好Ngrok是<strong>开源</strong>的, 那么我们可以自己搭建一个Ngrok！</blockquote><a id=more></a><h1 id=域名泛解析><a href=#域名泛解析 class=headerlink title=域名泛解析></a>域名泛解析</h1><p>因为内网穿透需要用到多级域名, 这里, 博主的这个域名是在<strong><em><a href=https://www.namesilo.com/ rel="external nofollow noopener noreferrer" target=_blank>Namesilo</a></em></strong>购买的, 然后转到DNSPod解析:<br><img src=https://cdn.yangbingdong.com/DNSPod.png alt><br>如图所示, 我搞买的域名是<code>yangbingdong.com</code>,将<code>ngrok.yangbingdong.com</code>通过<code>A</code>记录解析导VPS的ip地址, 再将<code>*.ngrok.yangbingdong.com</code>通过<code>CNAME</code>解析导<code>ngrok.yangbingdong.com</code>, 完成泛解析.<h1 id=服务端安装><a href=#服务端安装 class=headerlink title=服务端安装></a>服务端安装</h1><h2 id=安装GO环境><a href=#安装GO环境 class=headerlink title=安装GO环境></a>安装GO环境</h2><blockquote><p>这里博主选择通过下载最新版解压安装.</blockquote><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>apt-get update</span><br><span class=line>apt-get -y install build-essential mercurial git</span><br><span class=line>wget https://storage.googleapis.com/golang/go1.8.1.linux-amd64.tar.gz</span><br><span class=line>tar -C /usr/local -xzf go1.8.1.linux-amd64.tar.gz</span><br><span class=line>mkdir $HOME/go</span><br><span class=line>echo 'export GOROOT=/usr/local/go' &gt;&gt; /etc/profile.d/go.sh</span><br><span class=line>echo 'export GOPATH=$HOME/go' &gt;&gt; /etc/profile.d/go.sh</span><br><span class=line>echo 'export PATH=$PATH:$GOROOT/bin:$GOPATH/bin' &gt;&gt; /etc/profile.d/go.sh</span><br><span class=line>source /etc/profile.d/go.sh</span><br></pre></table></figure><h2 id=安装Ngrok><a href=#安装Ngrok class=headerlink title=安装Ngrok></a>安装Ngrok</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>cd /usr/local/src/</span><br><span class=line>git clone https://github.com/tutumcloud/ngrok.git ngrok</span><br><span class=line>export GOPATH=/usr/local/src/ngrok/</span><br></pre></table></figure><p>生成自签名SSL证书, ngrok为ssl加密连接:<br><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>cd ngrok</span><br><span class=line>NGROK_DOMAIN="ngrok.yangbingdong.com"</span><br><span class=line>openssl genrsa -out rootCA.key 2048</span><br><span class=line>openssl req -x509 -new -nodes -key rootCA.key -subj "/CN=$NGROK_DOMAIN" -days 5000 -out rootCA.pem</span><br><span class=line>openssl genrsa -out device.key 2048</span><br><span class=line>openssl req -new -key device.key -subj "/CN=$NGROK_DOMAIN" -out device.csr</span><br><span class=line>openssl x509 -req -in device.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out device.crt -days 5000</span><br><span class=line>cp rootCA.pem assets/client/tls/ngrokroot.crt</span><br><span class=line>cp device.crt assets/server/tls/snakeoil.crt </span><br><span class=line>cp device.key assets/server/tls/snakeoil.key</span><br><span class=line>GOOS=linux GOARCH=amd64</span><br><span class=line>make clean</span><br><span class=line>make release-server release-client</span><br></pre></table></figure><p>注意: <strong>上面的<code>ngrok.yangbingdong.com</code>换成自己的域名</strong>.<ul><li>如果是32位系统,<code>GOARCH=386</code>; 如果是64为系统, <code>GOARCH=amd64</code><li>如果要编译linux,<code>GOOS=linux</code>;如果要编译window,<code>GOOS=windows</code></ul><h2 id=启动server><a href=#启动server class=headerlink title=启动server></a>启动server</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cd /usr/local/src/ngrok/bin &amp;&amp; ./ngrokd -domain="ngrok.yangbingdong.com" -httpAddr=":8002" -httpsAddr=":8003" -tunnelAddr=":4000"</span><br></pre></table></figure><p><strong><code>ngrok.yangbingdong.com</code>换成自己的域名</strong>. 其他端口可自己配置.<br>顺利的话, 可以正常编译, 在<code>bin</code>下面可以看到「ngrokd」和「ngrok」, 其中「ngrokd」是服务端执行程序, 「ngrok」是客户端执行程序<br><img src=https://cdn.yangbingdong.com/ngrok-server-startup.png alt><h2 id=后台运行><a href=#后台运行 class=headerlink title=后台运行:></a>后台运行:</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>cd /usr/local/src/ngrok/bin &amp;&amp; nohup ./ngrokd -domain="ngrok.yangbingdong.com" -httpAddr=":8002" -httpsAddr=":8003" -tunnelAddr=":4000"  &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></table></figure><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>apt-get install screen</span><br><span class=line>screen -S 任意名字（例如: keepngork）</span><br><span class=line>然后运行ngrok启动命令</span><br><span class=line>最后按快捷键</span><br><span class=line>ctrl+A+D</span><br><span class=line>既可以保持ngrok后台运行</span><br></pre></table></figure><h2 id=设置开机启动><a href=#设置开机启动 class=headerlink title=设置开机启动></a>设置开机启动</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>vim /etc/init.d/ngrok_start:</span><br><span class=line>cd /usr/local/src/ngrok/bin</span><br><span class=line>./ngrokd -domain="ngrok.yangbingdong.com" -httpAddr=":8002" -httpsAddr=":8003" -tunnelAddr=":4000"</span><br><span class=line></span><br><span class=line>chmod 755 /etc/init.d/ngrok_start</span><br></pre></table></figure><h1 id=客户端使用><a href=#客户端使用 class=headerlink title=客户端使用></a>客户端使用</h1><h2 id=下载客户端><a href=#下载客户端 class=headerlink title=下载客户端></a>下载客户端</h2><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>scp -P 26850 root@12.34.56.78:/usr/local/src/ngrok/bin/ngrok ~/</span><br></pre></table></figure><p><strong>将<code>12.34.56.78</code>换成自己的VPS ip</strong>.<h2 id=启动客户端><a href=#启动客户端 class=headerlink title=启动客户端></a>启动客户端</h2><p>写一个简单的配置文件, 随意命名如 ngrok.cfg:<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>server_addr: ngrok.yangbingdong.com:4000</span><br><span class=line>trust_host_root_certs: false</span><br></pre></table></figure><p>然后启动:<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>./ngrok -subdomain ybd -config=ngrok.cfg 8080</span><br></pre></table></figure><p>其中<code>ybd</code>是自定义的域名前缀, <code>ngrok.cfg</code>是上面创建的配置文件, <code>8080</code>是本地需要映射到外网的端口.<br>没有意外的话访问<code>ybd.ngrok.yangbingdong.com:8002</code>就会映射到本机的<code>8080</code>端口了.<br><img src=https://cdn.yangbingdong.com/ngrok-client-startup01.png alt><p>控制台:<p>就是上图的<code>Web Interface</code>, 通过这个界面可以看到远端转发过来的 http 详情, 包括完整的 request/response 信息, 相当于附带了一个抓包工具.<p>另外, Ngrok支持多种协议, 启动的时候可以指定通过<code>-proto</code>指定协议, 例如:<p><strong>http协议</strong>:<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>./ngrok -subdomain ybd -config=ngrok.cfg -proto=http 8080</span><br></pre></table></figure><p><strong>tcp协议</strong>:<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>./ngrok -subdomain ybd -config=ngrok.cfg -proto=tcp 8080</span><br></pre></table></figure><p>应该会看到:<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>ngrok                                               (Ctrl+C to quit)</span><br><span class=line></span><br><span class=line>Tunnel Status                 online</span><br><span class=line>Version                       1.7/1.7</span><br><span class=line>Forwarding                    tcp://ybd.ngrok.yangbingdong.com:8002-&gt; 127.0.0.1:8080</span><br><span class=line>Web Interface                 127.0.0.1:4040</span><br><span class=line><span class=meta>#</span><span class=bash> Conn                        0</span></span><br><span class=line>Avg Conn Time                 0.00ms</span><br></pre></table></figure><h1 id=Nginx添加server><a href=#Nginx添加server class=headerlink title=Nginx添加server></a>Nginx添加server</h1><p>虽然可以访问, 但是带着端口就让人不舒服, 80端口又被Nginx占用, 那么可以用过Nginx反向代理Ngrok.<br>Nginx的配置一般在<code>/etc/nginx/conf.d</code>或者<code>/usr/local/nginx/conf.d</code>里面:<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>#ngrok.yangbingdong.com.conf</span><br><span class=line>upstream ngrok &#123;</span><br><span class=line>    server 127.0.0.1:8002;</span><br><span class=line>    keepalive 64;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line>server &#123;</span><br><span class=line>    listen 80;</span><br><span class=line>    server_name *.ngrok.yangbingdong.com;</span><br><span class=line>    access_log /var/log/nginx/ngrok_access.log;</span><br><span class=line>    proxy_set_header &quot;Host&quot; $host:8002;</span><br><span class=line>    location / &#123;</span><br><span class=line>		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=line>        proxy_set_header Host $host:8002;</span><br><span class=line>        proxy_pass_header Server;</span><br><span class=line>        proxy_redirect off;</span><br><span class=line>        proxy_pass  http://ngrok;</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line>    access_log off;</span><br><span class=line>    log_not_found off;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>重启Nginx:<br><figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>nginx -s reload</span><br></pre></table></figure><h1 id=维护脚本><a href=#维护脚本 class=headerlink title=维护脚本></a>维护脚本</h1><p>在网上看到的某大神写的维护脚本:<figure class="highlight shell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>wget https://gist.githubusercontent.com/IvanChou/1be8b15b1b41bf0ce2e9d939866bbfec/raw/1a2445599fe7fd706505a6e103a9dc60b4d3a0ed/ngrokd -O ngrokd</span><br><span class=line></span><br><span class=line><span class=meta>#</span><span class=bash><span class=comment>#修改 脚本中的配置</span></span></span><br><span class=line>vi ngrokd</span><br><span class=line></span><br><span class=line>chomd +x ngrokd</span><br><span class=line>sudo mv ngrokd /etc/init.d/ngrokd</span><br></pre></table></figure><h1 id=常见错误><a href=#常见错误 class=headerlink title=常见错误></a>常见错误</h1><p>在ngrok目录下执行如下命令, 编译ngrokd<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>$ make release-server</span><br><span class=line></span><br><span class=line>出现如下错误: </span><br><span class=line>GOOS=&quot;&quot; GOARCH=&quot;&quot; go get github.com/jteeuwen/go-bindata/go-bindata</span><br><span class=line>bin/go-bindata -nomemcopy -pkg=assets -tags=release \</span><br><span class=line>        -debug=false \</span><br><span class=line>        -o=src/ngrok/client/assets/assets_release.go \</span><br><span class=line>        assets/client/…</span><br><span class=line>make: bin/go-bindata: Command not found</span><br><span class=line>make: *** [client-assets] Error 127</span><br><span class=line>go-bindata被安装到了$GOBIN下了, go编译器找不到了. 修正方法是将$GOBIN/go-bindata拷贝到当前ngrok/bin下. </span><br><span class=line></span><br><span class=line>$cp /home/ubuntu/.bin/go14/bin/go-bindata ./bin</span><br></pre></table></figure><h1 id=遇到的问题-source与><a href=#遇到的问题-source与 class=headerlink title="遇到的问题: source与./"></a>遇到的问题: source与./</h1><p>写了一个Ngrok的<strong><em><a href=https://github.com/masteranthoneyd/about-shell/blob/master/ngrok-installation.sh rel="external nofollow noopener noreferrer" target=_blank>安装脚本</a></em></strong>, 然后<code>chmod +x ngrok-installation.sh</code>赋权, 再<code>./ngrok-installation.sh</code>执行.<br>但是遇到了一个奇怪的问题: 在脚本里面设置了环境变量并source让其生效, 然而出现的结果是由于<strong>没有加载</strong>到环境变量导致找不到命令, 百思不得解, Google了一把, 发现了原因:<blockquote><p><code>source</code>命令与<code>shell scripts</code>的区别是:<br>我们在test.sh设置了AA环境变量, 它只在fork出来的这个子shell中生效, 子shell只能继承父shell的环境变量, 而不能修改父shell的环境变量, 所以test.sh结束后, 父进程的环境就覆盖回去.<br>source在当前bash环境下执行命令, 而scripts是启动一个子shell来执行命令. 这样如果把设置环境变量（或alias等等）的命令写进scripts中, 就只会影响子shell,无法改变当前的BASH,所以通过文件（命令列）设置环境变量时, 要用source 命令.</blockquote><p>然后直接<code>source ngrok-installation.sh</code>, 安装成功！<h1 id=Docker搭建Ngrok><a href=#Docker搭建Ngrok class=headerlink title=Docker搭建Ngrok></a>Docker搭建Ngrok</h1><blockquote><p>安装Docker请看<strong><em><a href=/2017/docker-learning/>这里</a></em></strong></blockquote><h2 id=构建镜像><a href=#构建镜像 class=headerlink title=构建镜像></a>构建镜像</h2><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>git clone https://github.com/hteen/docker-ngrok.git</span><br><span class=line>cd docker-ngrok</span><br><span class=line>docker build -t hteen/ngrok .</span><br></pre></table></figure><h2 id=运行镜像><a href=#运行镜像 class=headerlink title=运行镜像></a>运行镜像</h2><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>docker run -idt --name ngrok-server \</span><br><span class=line>-p 8082:80 -p 4432:443 -p 4443:4443 \</span><br><span class=line>-v /root/docker/ngrok/data:/myfiles \</span><br><span class=line>-e DOMAIN=&apos;ngrok.yangbingdong.com&apos; hteen/ngrok /bin/sh /server.sh</span><br></pre></table></figure><ul><li><code>-p</code>: 80端口为http端口, 433端口为https端口, 4443端口为tunnel端口<li><code>-v</code>: 生成的各种配置文件和客户端都在里面<li><code>-e</code>: 泛化的域名</ul><p>稍等片刻, 会在挂在的目录（<code>/root/docker/ngrok/data</code>）下面生成对应的配置文件以及客户端<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>bin/ngrokd                  服务端</span><br><span class=line>bin/ngrok                   linux客户端</span><br><span class=line>bin/darwin_amd64/ngrok      osx客户端</span><br><span class=line>bin/windows_amd64/ngrok.exe windows客户端</span><br></pre></table></figure><h2 id=Nginx-Conf><a href=#Nginx-Conf class=headerlink title="Nginx Conf"></a>Nginx Conf</h2><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>server &#123;</span><br><span class=line>     listen       80;</span><br><span class=line>     server_name  *.ngrok.yangbingdong.com;</span><br><span class=line>     location / &#123;</span><br><span class=line>             proxy_redirect off;</span><br><span class=line>             proxy_set_header Host $host;</span><br><span class=line>             proxy_set_header X-Real-IP $remote_addr;</span><br><span class=line>             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=line>             proxy_pass http://172.17.0.1:8082;</span><br><span class=line>     &#125;</span><br><span class=line> &#125;</span><br><span class=line> server &#123;</span><br><span class=line>     listen       443;</span><br><span class=line>     server_name  *.ngrok.yangbingdong.com;</span><br><span class=line>     location / &#123;</span><br><span class=line>             proxy_redirect off;</span><br><span class=line>             proxy_set_header Host $host;</span><br><span class=line>             proxy_set_header X-Real-IP $remote_addr;</span><br><span class=line>             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=line>             proxy_pass http://172.17.0.1:4432;</span><br><span class=line>     &#125;</span><br><span class=line> &#125;</span><br></pre></table></figure><ul><li><code>172.17.0.1</code>为内网ip</ul><p><strong>注意</strong>: 大概每个星期会产生100M的日志文件.<br>查年docker日志文件位置<code>docker inspect &lt;id&gt; | grep LogPath</code><br>查看大小<code>ls -lh /var/lib/docker/containers/&lt;id&gt;/&lt;id&gt;-json.log</code><h1 id=Finally><a href=#Finally class=headerlink title=Finally></a>Finally</h1><p>另外一个内网穿透工具: <strong><em><a href=https://github.com/fatedier/frp rel="external nofollow noopener noreferrer" target=_blank>frp</a></em></strong></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2017/self-hosted-build-ngrok-server/ title=VPS自搭建Ngrok内网穿透服务>http://yangbingdong.com/2017/self-hosted-build-ngrok-server/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/VPS/ rel=tag><i class="fa fa-tag"></i>VPS</a>
<a href=/tags/Ngrok/ rel=tag><i class="fa fa-tag"></i>Ngrok</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2017/nginx-noob-guide/ rel=next title=NGINX初学指南(安装与简单配置)><i class="fa fa-chevron-left"></i>NGINX初学指南(安装与简单配置)</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2017/java-8-tutorial/ rel=prev title="Java8 Noob Tutorial">Java8 Noob Tutorial <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2017/self-hosted-build-ngrok-server/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2017/self-hosted-build-ngrok-server/';this.page.identifier='2017/self-hosted-build-ngrok-server/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>46</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>17</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>43</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#前言><span class=nav-number>1.</span> <span class=nav-text>前言</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#域名泛解析><span class=nav-number>2.</span> <span class=nav-text>域名泛解析</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#服务端安装><span class=nav-number>3.</span> <span class=nav-text>服务端安装</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#安装GO环境><span class=nav-number>3.1.</span> <span class=nav-text>安装GO环境</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#安装Ngrok><span class=nav-number>3.2.</span> <span class=nav-text>安装Ngrok</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#启动server><span class=nav-number>3.3.</span> <span class=nav-text>启动server</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#后台运行><span class=nav-number>3.4.</span> <span class=nav-text>后台运行:</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#设置开机启动><span class=nav-number>3.5.</span> <span class=nav-text>设置开机启动</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#客户端使用><span class=nav-number>4.</span> <span class=nav-text>客户端使用</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#下载客户端><span class=nav-number>4.1.</span> <span class=nav-text>下载客户端</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#启动客户端><span class=nav-number>4.2.</span> <span class=nav-text>启动客户端</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Nginx添加server><span class=nav-number>5.</span> <span class=nav-text>Nginx添加server</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#维护脚本><span class=nav-number>6.</span> <span class=nav-text>维护脚本</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#常见错误><span class=nav-number>7.</span> <span class=nav-text>常见错误</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#遇到的问题-source与><span class=nav-number>8.</span> <span class=nav-text>遇到的问题: source与./</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Docker搭建Ngrok><span class=nav-number>9.</span> <span class=nav-text>Docker搭建Ngrok</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#构建镜像><span class=nav-number>9.1.</span> <span class=nav-text>构建镜像</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#运行镜像><span class=nav-number>9.2.</span> <span class=nav-text>运行镜像</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Nginx-Conf><span class=nav-number>9.3.</span> <span class=nav-text>Nginx Conf</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Finally><span class=nav-number>10.</span> <span class=nav-text>Finally</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共277.3k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2017/self-hosted-build-ngrok-server/';var disqus_title="VPS自搭建Ngrok内网穿透服务";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>