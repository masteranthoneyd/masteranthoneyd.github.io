<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Spring Boot,Spring,Spring Security,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface 本篇总结分别基于 Spring Security 与 Spring MVC HandlerInterceptor 实现认证鉴权."><meta name=keywords content="Java,Spring Boot,Spring,Spring Security"><meta property=og:type content=article><meta property=og:title content="Spring Security 与 HandlerInterceptor 的认证鉴权"><meta property=og:url content=http://yangbingdong.com/2020/spring-security-mvc-interceptor/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface 本篇总结分别基于 Spring Security 与 Spring MVC HandlerInterceptor 实现认证鉴权."><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/spring-authentication-banner.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/security-filters.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/filter-comparator.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/core-service-Sequence.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/username-password-authentication-filter.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/provider-manager.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/spring%20security%20architecture.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-security/dao-authentication-password-check.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-auth/auth-design.jpg><meta property=og:updated_time content=2020-07-20T03:52:03.971Z><meta name=twitter:card content=summary><meta name=twitter:title content="Spring Security 与 HandlerInterceptor 的认证鉴权"><meta name=twitter:description content="Preface 本篇总结分别基于 Spring Security 与 Spring MVC HandlerInterceptor 实现认证鉴权."><meta name=twitter:image content=https://cdn.yangbingdong.com/img/spring-boot-security/spring-authentication-banner.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2020/spring-security-mvc-interceptor/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Spring Security 与 HandlerInterceptor 的认证鉴权 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2020/spring-security-mvc-interceptor/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Spring Security 与 HandlerInterceptor 的认证鉴权</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2020-05-26T16:30:58+08:00>2020-05-26</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/Spring-Boot/ itemprop=url rel=index><span itemprop=name>Spring Boot</span></a></span></span>
<span id=/2020/spring-security-mvc-interceptor/ class=leancloud_visitors data-flag-title="Spring Security 与 HandlerInterceptor 的认证鉴权"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>2,197字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>10分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/spring-authentication-banner.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>本篇总结分别基于 Spring Security 与 Spring MVC HandlerInterceptor 实现认证鉴权.</blockquote><a id=more></a><h1 id=Spring-Security><a href=#Spring-Security class=headerlink title="Spring Security"></a>Spring Security</h1><p>Spring Security 是基于嵌套 <code>Filter</code>(委派 Filter) 实现的, 在 <code>DispatcherServlet</code> 之前触发. 普通的 Filter 称之为 Web Filter, 而 Spring Security 的 Filter 称之为 Security Filter:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/security-filters.png alt><p>默认有哪些 Filter 可以看 <code>FilterComparator</code> 中的源码:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/filter-comparator.png alt><h2 id=认证流程><a href=#认证流程 class=headerlink title=认证流程></a>认证流程</h2><p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/core-service-Sequence.png alt><h3 id=登录拦截><a href=#登录拦截 class=headerlink title=登录拦截></a>登录拦截</h3><p>在 <code>FilterComparator</code> 中有一个 <code>UsernamePasswordAuthenticationFilter</code>, 继承了 <code>AbstractAuthenticationProcessingFilter</code>, 它就是我们登录时用到的 Filter:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/username-password-authentication-filter.png alt><ul><li>可以看到, <strong>默认情况下拦截 <code>/login</code> 端点的 POST 请求</strong>, 当然, 可以通过配置改变这个 url.<li>这里还有一个关键, 在 <code>attempAuthentication</code> 中, 用户名以及密码的参数是 <code>username</code> 以及 <code>password</code>, 并且是从 http parameter 中获取的, 如果要<strong>支持 Json 格式的登录, 那就要重写这里</strong>.<li>将登录请求信息封装成 <code>Authentication</code> 的实现类, 这里是 <code>UsernamePasswordAuthenticationToken</code>, <strong>然后交给 <code>AuthenticationManager</code> 进行下一步的认证</strong>.</ul><blockquote><p><strong>这一步相当与登录信息的提取以及封装</strong>.</blockquote><h3 id=认证><a href=#认证 class=headerlink title=认证></a>认证</h3><p>认证通过 <code>AuthenticationManager</code> 进行的, 这是一个接口, 默认的实现类为 <code>ProviderManager</code>:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/provider-manager.png alt><p>可以看到实现类 <code>ProviderManager</code> 中维护了一个 <code>List&lt;AuthenticationProvider&gt;</code> 的列表, 存放多种认证方式, 实际上这是委托者模式的应用(Delegate)<blockquote><p>核心的认证入口始终只有一个: <code>AuthenticationManager</code>, 不同的认证方式: 用户名 + 密码(<code>UsernamePasswordAuthenticationToken</code>), 邮箱 + 密码, 手机号码 + 密码登录则对应了三个 <code>AuthenticationProvider</code>. 在默认策略下, 只需要通过一个 <code>AuthenticationProvider</code> 的认证, 即可被认为是登录成功.</blockquote><p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/spring%20security%20architecture.png alt><p>一个最常用到的 <code>AuthenticationProvider</code> 实现类就是 <code>DaoAuthenticationProvider</code>, 里面比较重要的一个环节就是 <code>additionalAuthenticationChecks</code> (密码校验):<ul><li>通过 <code>UserDetailsService</code> 的实现类(需要用户自己实现)拿到 <code>UserDetails</code><li>将其中的 <code>password</code> 与 <code>UsernamePasswordAuthenticationToken</code> 中的 <code>credentials</code> 进行对比</ul><p><img src=https://cdn.yangbingdong.com/img/spring-boot-security/dao-authentication-password-check.png alt><p>登录成功后会执行 <code>AbstractAuthenticationProcessingFilter#successfulAuthentication</code> 将 <code>Authentication</code> 存到 <code>SecurityContextHolder</code> 中.<p>到此, 认证的核心就是这样了.<h2 id=权限校验流程><a href=#权限校验流程 class=headerlink title=权限校验流程></a>权限校验流程</h2><p><code>FilterSecurityInterceptor</code> 是整个Security filter链中的最后一个, 也是最重要的一个, 它的主要功能就是判断认证成功的用户是否有权限访问接口, 其最主要的处理方法就是 调用父类（<code>AbstractSecurityInterceptor</code>）的 <code>super.beforeInvocation(fi)</code>, 我们来梳理下这个方法的处理流程：<blockquote><ul><li>通过 <code>obtainSecurityMetadataSource().getAttributes()</code> 获取 当前访问地址所需权限信息<li>通过 <code>authenticateIfRequired()</code> 获取当前访问用户的权限信息<li>通过 <code>accessDecisionManager.decide()</code> 使用 投票机制判权, 判权失败直接抛出 <code>AccessDeniedException</code> 异常</ul></blockquote><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre><td class=code><pre><span class=line><span class=function><span class=keyword>protected</span> InterceptorStatusToken <span class=title>beforeInvocation</span><span class=params>(Object object)</span> </span>&#123;</span><br><span class=line>	       </span><br><span class=line>	    ......</span><br><span class=line>	    </span><br><span class=line>	    <span class=comment>// 1 获取访问地址的权限信息 </span></span><br><span class=line>		Collection&lt;ConfigAttribute&gt; attributes = <span class=keyword>this</span>.obtainSecurityMetadataSource()</span><br><span class=line>				.getAttributes(object);</span><br><span class=line></span><br><span class=line>		<span class=keyword>if</span> (attributes == <span class=keyword>null</span> || attributes.isEmpty()) &#123;</span><br><span class=line>		</span><br><span class=line>		    ......</span><br><span class=line>		    </span><br><span class=line>			<span class=keyword>return</span> <span class=keyword>null</span>;</span><br><span class=line>		&#125;</span><br><span class=line></span><br><span class=line>        ......</span><br><span class=line></span><br><span class=line>        <span class=comment>// 2 获取当前访问用户权限信息</span></span><br><span class=line>		Authentication authenticated = authenticateIfRequired();</span><br><span class=line></span><br><span class=line>	</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>		    <span class=comment>// 3  默认调用AffirmativeBased.decide() 方法, 其内部 使用 AccessDecisionVoter 对象 进行投票机制判权, 判权失败直接抛出 AccessDeniedException 异常 </span></span><br><span class=line>			<span class=keyword>this</span>.accessDecisionManager.decide(authenticated, object, attributes);</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>catch</span> (AccessDeniedException accessDeniedException) &#123;</span><br><span class=line>			publishEvent(<span class=keyword>new</span> AuthorizationFailureEvent(object, attributes, authenticated,</span><br><span class=line>					accessDeniedException));</span><br><span class=line></span><br><span class=line>			<span class=keyword>throw</span> accessDeniedException;</span><br><span class=line>		&#125;</span><br><span class=line></span><br><span class=line>        ......</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> InterceptorStatusToken(SecurityContextHolder.getContext(), <span class=keyword>false</span>,</span><br><span class=line>					attributes, object);</span><br><span class=line>	&#125;</span><br></pre></table></figure><p>因此如果要<strong>动态鉴权</strong>, 可以从两方面入手:<ul><li>自定义<code>SecurityMetadataSource</code>, 实现从数据库加载 <code>ConfigAttribute</code><li>另外就是可以自定义 <code>accessDecisionManager</code>, 官方的 <code>UnanimousBased</code> 其实足够使用, 并且他是基于 <code>AccessDecisionVoter</code> 来实现权限认证的, 因此我们只需要自定义一个 <code>AccessDecisionVoter</code> 就可以了</ul><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SecurityConfig</span> <span class=keyword>extends</span> <span class=title>WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(HttpSecurity http)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        http.authorizeRequests()</span><br><span class=line>                .withObjectPostProcessor(<span class=keyword>new</span> ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class=line>                    <span class=meta>@Override</span></span><br><span class=line>                    <span class=keyword>public</span> &lt;O extends FilterSecurityInterceptor&gt; <span class=function>O <span class=title>postProcess</span><span class=params>(O object)</span> </span>&#123;</span><br><span class=line>                        object.setAccessDecisionManager(customUrlDecisionManager);</span><br><span class=line>                        object.setSecurityMetadataSource(customFilterInvocationSecurityMetadataSource);</span><br><span class=line>                        <span class=keyword>return</span> object;</span><br><span class=line>                    &#125;</span><br><span class=line>                &#125;)</span><br><span class=line>                .and()</span><br><span class=line>                ...</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=核心配置><a href=#核心配置 class=headerlink title=核心配置></a>核心配置</h2><p>下面贴一个核心配置<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@RequiredArgsConstructor</span></span><br><span class=line><span class=meta>@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class=keyword>true</span>)</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SecurityConfig</span> <span class=keyword>extends</span> <span class=title>WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义登录逻辑验证器</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserAuthenticationProvider userAuthenticationProvider;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义未登录的处理器</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserAuthenticationEntryPoint userAuthenticationEntryPoint;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义登录成功处理器</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserLoginSuccessHandler userLoginSuccessHandler;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义登录失败处理器</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserLoginFailHandler userLoginFailHandler;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义注销成功处理器</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserLogoutSuccessHandler userLogoutSuccessHandler;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义暂无权限处理器</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserAccessDeniedHandler userAccessDeniedHandler;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义权限解析</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>final</span> UserPermissionEvaluator permissionEvaluator;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 配置登录验证逻辑</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(AuthenticationManagerBuilder auth)</span> </span>&#123;</span><br><span class=line>        auth.authenticationProvider(userAuthenticationProvider);</span><br><span class=line>    &#125;</span><br><span class=line>    </span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 静态资源不需要走过滤链</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(WebSecurity web)</span> </span>&#123;</span><br><span class=line>        web.ignoring()</span><br><span class=line>           .requestMatchers(PathRequest.toStaticResources().atCommonLocations());</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(HttpSecurity http)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        http.authorizeRequests()</span><br><span class=line>                <span class=comment>// 不需要认证的 url</span></span><br><span class=line>                .antMatchers(<span class=string>"/hello/**"</span>).permitAll()</span><br><span class=line>                <span class=comment>// 其他的请求需要认证</span></span><br><span class=line>                .anyRequest()</span><br><span class=line>                .authenticated()</span><br><span class=line>            .and()</span><br><span class=line>                <span class=comment>// 关闭默认的登录配置 (UsernamePasswordAuthenticationFilter), 在下面配置自定义的登录 Filter(支持 json 登录)</span></span><br><span class=line>                .formLogin()</span><br><span class=line>            .disable()</span><br><span class=line>                .logout()</span><br><span class=line>                <span class=comment>// 配置注销地址</span></span><br><span class=line>                .logoutUrl(<span class=string>"/user/logout"</span>)</span><br><span class=line>                <span class=comment>// 配置注销成功处理器</span></span><br><span class=line>                .logoutSuccessHandler(userLogoutSuccessHandler)</span><br><span class=line>            .and()</span><br><span class=line>                .exceptionHandling()</span><br><span class=line>                <span class=comment>// 配置没有权限自定义处理类</span></span><br><span class=line>                .accessDeniedHandler(userAccessDeniedHandler)</span><br><span class=line>                .authenticationEntryPoint(userAuthenticationEntryPoint)</span><br><span class=line>            .and()</span><br><span class=line>                <span class=comment>// 开启跨域</span></span><br><span class=line>                .cors()</span><br><span class=line>                .configurationSource(corsConfigurationSource())</span><br><span class=line>            .and()</span><br><span class=line>                <span class=comment>// 取消跨站请求伪造防护</span></span><br><span class=line>                .csrf()</span><br><span class=line>            .disable()</span><br><span class=line>                <span class=comment>// jwt 无状态不需要 session</span></span><br><span class=line>                .sessionManagement()</span><br><span class=line>                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class=line>            .and()</span><br><span class=line>                .headers()</span><br><span class=line>                .cacheControl()</span><br><span class=line>                .disable()</span><br><span class=line>            .and()</span><br><span class=line>                .rememberMe()</span><br><span class=line>            .disable()</span><br><span class=line>            <span class=comment>// 自定义 Jwt 登录认证 Filter</span></span><br><span class=line>            .addFilterAt(jsonUsernamePasswordAuthenticationFilter(), UsernamePasswordAuthenticationFilter<span class=class>.<span class=keyword>class</span>)</span></span><br><span class=line><span class=class>            // 自定义 <span class=title>Jwt</span> 过滤器</span></span><br><span class=line><span class=class>            .<span class=title>addFilterBefore</span>(<span class=title>new</span> <span class=title>JwtAuthenticationFilter</span>(<span class=title>authenticationManagerBean</span>()), <span class=title>JsonUsernamePasswordAuthenticationFilter</span>.<span class=title>class</span>)</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 加密方式</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> BCryptPasswordEncoder <span class=title>bCryptPasswordEncoder</span><span class=params>()</span></span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> BCryptPasswordEncoder();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 自定义登录拦截器, 接收 json 登录信息</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> JsonUsernamePasswordAuthenticationFilter <span class=title>jsonUsernamePasswordAuthenticationFilter</span><span class=params>()</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        JsonUsernamePasswordAuthenticationFilter filter = <span class=keyword>new</span> JsonUsernamePasswordAuthenticationFilter();</span><br><span class=line>        filter.setFilterProcessesUrl(<span class=string>"/user/login"</span>);</span><br><span class=line>        filter.setAuthenticationSuccessHandler(userLoginSuccessHandler);</span><br><span class=line>        filter.setAuthenticationFailureHandler(userLoginFailHandler);</span><br><span class=line>        filter.setAuthenticationManager(authenticationManagerBean());</span><br><span class=line>        <span class=keyword>return</span> filter;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 注入自定义 PermissionEvaluator</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> DefaultWebSecurityExpressionHandler <span class=title>userSecurityExpressionHandler</span><span class=params>()</span></span>&#123;</span><br><span class=line>        DefaultWebSecurityExpressionHandler handler = <span class=keyword>new</span> DefaultWebSecurityExpressionHandler();</span><br><span class=line>        handler.setPermissionEvaluator(permissionEvaluator);</span><br><span class=line>        <span class=keyword>return</span> handler;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 跨域配置</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> CorsConfigurationSource <span class=title>corsConfigurationSource</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        UrlBasedCorsConfigurationSource source = <span class=keyword>new</span> UrlBasedCorsConfigurationSource();</span><br><span class=line>        CorsConfiguration configuration = <span class=keyword>new</span> CorsConfiguration();</span><br><span class=line>        configuration.setAllowCredentials(<span class=keyword>true</span>);</span><br><span class=line>        configuration.setAllowedOrigins(singletonList(<span class=string>"*"</span>));</span><br><span class=line>        configuration.setAllowedMethods(singletonList(<span class=string>"*"</span>));</span><br><span class=line>        configuration.setAllowedHeaders(singletonList(<span class=string>"*"</span>));</span><br><span class=line>        configuration.setMaxAge(Duration.ofHours(<span class=number>1</span>));</span><br><span class=line>        source.registerCorsConfiguration(<span class=string>"/**"</span>,configuration);</span><br><span class=line>        <span class=keyword>return</span> source;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * 共享 AuthenticationManager</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> AuthenticationManager <span class=title>authenticationManagerBean</span><span class=params>()</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>super</span>.authenticationManagerBean();</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>更多源码查看: <strong><em><a href=https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-security rel="external nofollow noopener noreferrer" target=_blank>https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-security</a></em></strong><h2 id=其他配置说明><a href=#其他配置说明 class=headerlink title=其他配置说明></a>其他配置说明</h2><h3 id=session><a href=#session class=headerlink title=session></a>session</h3><blockquote><p>上面的配置是基于 jwt 无状态的, 所以不需要 session, 如果使用, 可以通过下面配置实现一些额外的功能</blockquote><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>http.sessionManagement()</span><br><span class=line>     <span class=comment>// 登陆后使用新的 sessionId, 防止固定会话攻击</span></span><br><span class=line> .sessionFixation().changeSessionId()</span><br><span class=line>  <span class=comment>// 同时在线最大数量</span></span><br><span class=line> .maximumSessions(<span class=number>1</span>)</span><br><span class=line>  <span class=comment>// 是否禁止新的登录</span></span><br><span class=line> .maxSessionsPreventsLogin(<span class=keyword>false</span>)</span><br></pre></table></figure><blockquote><p>如果是自定义的用户, <strong>需要重写 <code>equals</code> 以及 <code>hashcode</code> 方法</strong>, 因为底层是通过一个 Map 存放 session 相关信息, 而 key 则是 principal 对象.<p>如果是覆盖了 <code>UsernamePasswordAuthenticationFilter</code>, 这些 session 配置需要在自定义的 Filter 重新配置.</blockquote><p>同时启用 session 提供一个 bean(因为 Spring security 的通过监听事件实现 session 销毁的):<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=meta>@Bean</span></span><br><span class=line><span class=function>HttpSessionEventPublisher <span class=title>httpSessionEventPublisher</span><span class=params>()</span> </span>&#123;</span><br><span class=line>    <span class=keyword>return</span> <span class=keyword>new</span> HttpSessionEventPublisher();</span><br><span class=line>&#125;</span><br></pre></table></figure><p>session 集群共享:<p>第一步, 引入 redis:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.session<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-session-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>第二部, 配置 SessionRegistry:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SecurityConfig</span> <span class=keyword>extends</span> <span class=title>WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class=line>    <span class=meta>@Autowired</span></span><br><span class=line>    FindByIndexNameSessionRepository sessionRepository;</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>configure</span><span class=params>(HttpSecurity http)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>        http.authorizeRequests().anyRequest()</span><br><span class=line>                ...</span><br><span class=line>                .sessionManagement()</span><br><span class=line>                .maximumSessions(<span class=number>1</span>)</span><br><span class=line>                .maxSessionsPreventsLogin(<span class=keyword>true</span>)</span><br><span class=line>                .sessionRegistry(sessionRegistry());</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=meta>@Bean</span></span><br><span class=line>    <span class=function>SpringSessionBackedSessionRegistry <span class=title>sessionRegistry</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> SpringSessionBackedSessionRegistry(sessionRepository);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=总结><a href=#总结 class=headerlink title=总结></a>总结</h2><p>上面提到的只是一个大致的核心流程, 但大概可以看出来, Spring Security 功能不仅齐全, 而且留了很多的扩展点, 可以很灵活的定制自己的权限业务.<p>但正是因为其极其丰富的扩展, 使得这框架变得”很重”, 对新手来说可能不太友好, 需要一定的学习成本.<h1 id=Spring-MVC-HandlerInterceptor><a href=#Spring-MVC-HandlerInterceptor class=headerlink title="Spring MVC HandlerInterceptor"></a>Spring MVC HandlerInterceptor</h1><p>对于一般简单的登录校验而言, 使用 Spring Security 可能稍显笨重, 这时候可以基于 Spring MVC 的 HandlerInterceptor 实现简单的校验逻辑:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>AuthorizationInterceptor</span> <span class=keyword>extends</span> <span class=title>HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> AuthorizationPreHandler authorizationPreHandler;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=title>AuthorizationInterceptor</span><span class=params>(AuthorizationPreHandler authorizationPreHandler)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>this</span>.authorizationPreHandler = authorizationPreHandler;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>boolean</span> <span class=title>preHandle</span><span class=params>(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>if</span> (handler <span class=keyword>instanceof</span> HandlerMethod) &#123;</span><br><span class=line>			Method method = ((HandlerMethod) handler).getMethod();</span><br><span class=line>			<span class=keyword>if</span> (method.isAnnotationPresent(IgnoreAuth<span class=class>.<span class=keyword>class</span>)) </span>&#123;</span><br><span class=line>				<span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>			&#125;</span><br><span class=line>			authorizationPreHandler.preHandleAuth(request, response, method);</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>true</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><p>将拦截器添加到 MVC 中:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=meta>@ConditionalOnBean</span>(AuthorizationPreHandler<span class=class>.<span class=keyword>class</span>)</span></span><br><span class=line><span class=class><span class=title>public</span> <span class=title>class</span> <span class=title>AuthorizationInterceptorConfiguration</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> AuthorizationInterceptor <span class=title>authorizationInterceptor</span><span class=params>(</span></span></span><br><span class=line><span class=function><span class=params>			ObjectProvider&lt;AuthorizationPreHandler&gt; authorizationHandlerObjectProvider)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>new</span> AuthorizationInterceptor(authorizationHandlerObjectProvider.getIfAvailable());</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Order</span>(<span class=number>1</span>)</span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> AuthorizationMvcConfigure <span class=title>authorizationMvcConfigure</span><span class=params>(</span></span></span><br><span class=line><span class=function><span class=params>			ObjectProvider&lt;AuthorizationInterceptor&gt; authorizationInterceptorObjectProvider)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>new</span> AuthorizationMvcConfigure(authorizationInterceptorObjectProvider.getIfAvailable());</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=meta>@RequiredArgsConstructor</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>AuthorizationMvcConfigure</span> <span class=keyword>implements</span> <span class=title>WebMvcConfigurer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>final</span> AuthorizationInterceptor authorizationInterceptor;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>addInterceptors</span><span class=params>(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>if</span> (Objects.nonNull(authorizationInterceptor)) &#123;</span><br><span class=line>			registry.addInterceptor(authorizationInterceptor);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><code>authorizationPreHandler</code> 中简单校验是否存在 token 即可.<p>完整代码请看: <strong><em><a href=https://github.com/masteranthoneyd/alchemist/tree/master/auth rel="external nofollow noopener noreferrer" target=_blank>https://github.com/masteranthoneyd/alchemist/tree/master/auth</a></em></strong><h1 id=RBAC-权限设计><a href=#RBAC-权限设计 class=headerlink title="RBAC 权限设计"></a>RBAC 权限设计</h1><p>主要核心逻辑还是 <code>用户-角色-权限</code>.<p>在这基础上拓展出 <code>用户-用户组-角色</code> 以及 <code>权限-类型-具体权限</code>.<p><img src=https://cdn.yangbingdong.com/img/spring-auth/auth-design.jpg alt></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2020/spring-security-mvc-interceptor/ title="Spring Security 与 HandlerInterceptor 的认证鉴权">http://yangbingdong.com/2020/spring-security-mvc-interceptor/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a>
<a href=/tags/Spring/ rel=tag><i class="fa fa-tag"></i>Spring</a>
<a href=/tags/Spring-Security/ rel=tag><i class="fa fa-tag"></i>Spring Security</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2019/java-concurrent-part5/ rel=next title=并发设计模式><i class="fa fa-chevron-left"></i>并发设计模式</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2020/spring-security-mvc-interceptor/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2020/spring-security-mvc-interceptor/';this.page.identifier='2020/spring-security-mvc-interceptor/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>46</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>17</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>43</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Security><span class=nav-number>2.</span> <span class=nav-text>Spring Security</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#认证流程><span class=nav-number>2.1.</span> <span class=nav-text>认证流程</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#登录拦截><span class=nav-number>2.1.1.</span> <span class=nav-text>登录拦截</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#认证><span class=nav-number>2.1.2.</span> <span class=nav-text>认证</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#权限校验流程><span class=nav-number>2.2.</span> <span class=nav-text>权限校验流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#核心配置><span class=nav-number>2.3.</span> <span class=nav-text>核心配置</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#其他配置说明><span class=nav-number>2.4.</span> <span class=nav-text>其他配置说明</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#session><span class=nav-number>2.4.1.</span> <span class=nav-text>session</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#总结><span class=nav-number>2.5.</span> <span class=nav-text>总结</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-MVC-HandlerInterceptor><span class=nav-number>3.</span> <span class=nav-text>Spring MVC HandlerInterceptor</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#RBAC-权限设计><span class=nav-number>4.</span> <span class=nav-text>RBAC 权限设计</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共279.3k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2020/spring-security-mvc-interceptor/';var disqus_title="Spring Security 与 HandlerInterceptor 的认证鉴权";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>