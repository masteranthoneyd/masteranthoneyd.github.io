<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content=Docker,Kubernetes,K8S,><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface K8S(Kubernetes) 现在来说也不是什么新鲜的词了, 或许小公司玩得比较少, 自己也一直没有实操的机会. 幸会近来公司也开始使用 K8S, 有机会将学习过的东西在生产上实践一遍."><meta name=keywords content=Docker,Kubernetes,K8S><meta property=og:type content=article><meta property=og:title content="Kuberbetes 常用概念及操作"><meta property=og:url content=http://yangbingdong.com/2020/kubernetes-guide/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface K8S(Kubernetes) 现在来说也不是什么新鲜的词了, 或许小公司玩得比较少, 自己也一直没有实操的机会. 幸会近来公司也开始使用 K8S, 有机会将学习过的东西在生产上实践一遍."><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/k8s-learning/kubernetes-learning-banner.png><meta property=og:updated_time content=2020-10-09T03:15:28.951Z><meta name=twitter:card content=summary><meta name=twitter:title content="Kuberbetes 常用概念及操作"><meta name=twitter:description content="Preface K8S(Kubernetes) 现在来说也不是什么新鲜的词了, 或许小公司玩得比较少, 自己也一直没有实操的机会. 幸会近来公司也开始使用 K8S, 有机会将学习过的东西在生产上实践一遍."><meta name=twitter:image content=https://cdn.yangbingdong.com/img/k8s-learning/kubernetes-learning-banner.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2020/kubernetes-guide/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Kuberbetes 常用概念及操作 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2020/kubernetes-guide/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Kuberbetes 常用概念及操作</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2020-07-19T14:54:13+08:00>2020-07-19</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Docker/ itemprop=url rel=index><span itemprop=name>Docker</span></a></span></span>
<span id=/2020/kubernetes-guide/ class=leancloud_visitors data-flag-title="Kuberbetes 常用概念及操作"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>6,052字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>28分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/k8s-learning/kubernetes-learning-banner.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>K8S(Kubernetes) 现在来说也不是什么新鲜的词了, 或许小公司玩得比较少, 自己也一直没有实操的机会. 幸会近来公司也开始使用 K8S, 有机会将学习过的东西在生产上实践一遍.</blockquote><a id=more></a><h1 id=Kubernetes-常用资源><a href=#Kubernetes-常用资源 class=headerlink title="Kubernetes 常用资源"></a>Kubernetes 常用资源</h1><p>通过 <code>kubectl api-resources</code> 命令可以列举出所有的资源并且可以看到它们的简写.<p>常用的资源有:<ul><li><code>Pod</code>(po): 最小的调度单位, 一般一个 <code>Pod</code> 对应一个或两个(<strong>Sidecar 模式</strong>) Container. 一般不直接管理, 而是通过下面的 <code>Deployment</code> 管理.<li><code>ReplicationController</code>(rc) / <code>ReplicationSet</code>(rs): 用来部署, 升级 Pod.<li><code>Deployment</code>(deploy): 可以看做升级版的 RC, 在 RC 级基础上增加了事件和状态查看, 回滚, 版本记录, 暂停和启动等功能.<li><code>DaemonSet</code>(ds): <code>DaemonSet</code> 会在每个 Kubernetes 节点都启动一个 <code>Pod</code>, 可以理解为节点的守护进程, 适用于日志收集, 监控 Agent 等.<li><code>StatefulSet</code>(sts): <code>StatefulSet</code> 表示有状态的服务, Pod 的名称的形式为<code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>, 可参考 Nacos 的部署.<li><code>Service</code>(svc): 提供一组 <code>Pod</code> 的访问, 服务间的访问一般就是通过 <code>Service</code> 来实现的, 类型有4种<ul><li><code>ClusterIP</code>(默认): 仅仅使用一个集群内部的地址, 这也是默认值, 使用该类型, 意味着, Service 只能在集群内部被访问. <code>clusterIP</code> 参数设置为 <code>None</code> 就是一个 Headless Service 了.<li><code>NodePort</code>: 在集群内部的每个节点上, 都开放这个服务. 可以在任意的 NodePort 地址上访问到这个服务<li><code>LoadBalancer</code>: 这是当 Kubernetes 部署到公有云上时才会使用到的选项, 是向云提供商申请一个负载均衡器, 将流量转发到已经以 NodePort 形式开放的 Service 上.<li><code>ExternalName</code>: <code>ExternalName</code>实际上是将 Service 导向一个外部的服务, 这个外部的服务有自己的域名, 只是在 Kubernetes 内部为其创建一个内部域名, 并 cname 至这个外部的域名.</ul><li><code>Ingress</code>(ing): 对集群中服务的外部访问进行管理, 典型的访问方式是 HTTP, 可以提供负载均衡, SSL 终结和基于名称的虚拟托管.<li><code>ConfigMap</code>(cm) / <code>Secret</code>: 配置存储, 后者提供加密功能.<li><code>Job</code> / <code>CronJob</code>(cj): 任务, 前者为执行一次, 后者加上了时间调度.<li><code>PersistentVolume</code>(pv) / <code>PersistentVolumeClaim</code>(pvc): pv 是对共享存储的一种抽象, pvc 则是对 pv 的一种消耗.<li><code>StrorgeClass</code>(sc): 动态创建 pv.<li><code>HorizontalPodAutoscaler</code>(hpa): 自动横向扩容.<li><code>Endpoints</code>: 配合 <code>Service -&gt; NodePort</code> 可用于映射外部服务.<li><code>ServiceAccount</code>(sa) / <code>ClusterRole</code> / <code>ClusterRoleBinding</code>: RBAC 权限相关资源</ul><h1 id=服务发现><a href=#服务发现 class=headerlink title=服务发现></a>服务发现</h1><p>Service 默认生成 ClusterIP(VIP) 来访问 Pod, 实际应用中通过写死 ClusterIP 显然不科学, 所以 Kubernetes 提供了 DNS 服务插件, 使得我们可以通过 Service Name 来发现 ClusterIP.<p>域名格式:<ul><li>普通的 Service: 会生成 <code>serviceName.namespace.svc.cluster.local</code> 的域名, 会解析到 Service 对应的 ClusterIP 上, 在 Pod 之间的调用可以简写成 <code>serviceName.namespace</code>, 如果处于同一个命名空间下面, 甚至可以只写成 <code>serviceName</code> 即可访问.<li><strong>Headless Service</strong>: 无头服务, 就是把 ClusterIP 设置为 None 的, 会被解析为指定 Pod 的 IP 列表, 同样还可以通过 <code>podname.servicename.namespace.svc.cluster.local</code> 访问到具体的某一个 Pod.</ul><h1 id=服务映射><a href=#服务映射 class=headerlink title=服务映射></a>服务映射</h1><h2 id=外部服务映射到内部><a href=#外部服务映射到内部 class=headerlink title=外部服务映射到内部></a>外部服务映射到内部</h2><p>如果外部服务是个域名, 可以直接通过 <code>Service -&gt; ExternalName</code> 实现:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>mysql</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>externalName:</span> <span class=string>mysql.example.com</span></span><br><span class=line>  <span class=attr>type:</span> <span class=string>ExternalName</span></span><br></pre></table></figure><p>如果是 IP, 推荐使用 EndPoint:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line> <span class=attr>name:</span> <span class=string>mysql</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line> <span class=attr>type:</span> <span class=string>ClusterIP</span></span><br><span class=line> <span class=attr>ports:</span></span><br><span class=line> <span class=bullet>-</span> <span class=attr>port:</span> <span class=number>3306</span></span><br><span class=line>   <span class=attr>targetPort:</span> <span class=number>3307</span></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Endpoints</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line> <span class=attr>name:</span> <span class=string>mysql</span></span><br><span class=line><span class=attr>subsets:</span></span><br><span class=line> <span class=bullet>-</span> <span class=attr>addresses:</span></span><br><span class=line>     <span class=bullet>-</span> <span class=attr>ip:</span> <span class=number>192.168</span><span class=number>.1</span><span class=number>.10</span></span><br><span class=line>   <span class=attr>ports:</span></span><br><span class=line>     <span class=bullet>-</span> <span class=attr>port:</span> <span class=number>3307</span></span><br></pre></table></figure><blockquote><p><strong>Service 不需要指定 selector</strong></blockquote><h2 id=暴露服务><a href=#暴露服务 class=headerlink title=暴露服务></a>暴露服务</h2><p>暴露服务有多种方式: <code>NodePort</code>, <code>Ingress</code>, <code>LoadBalance</code>, <code>port-forward</code> 等, 这里介绍前两种<h3 id=NodePort-方式><a href=#NodePort-方式 class=headerlink title="NodePort 方式"></a>NodePort 方式</h3><p>NodePort 顾名思义, 就是占用了节点端口暴露内部服务, 优点就是少量服务时配置简单. 缺点也很明显, 大量服务时端口不好管理, 而且节点可能也没有那么多端口使用.<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-nodeport</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>test</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>type:</span> <span class=string>NodePort</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>port:</span> <span class=number>80</span></span><br><span class=line>    <span class=attr>targetPort:</span> <span class=number>80</span></span><br><span class=line>    <span class=attr>nodePort:</span> <span class=number>32180</span> </span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>nginx-pod</span></span><br></pre></table></figure><blockquote><p><code>port</code> 指服务端口, <code>targetPort</code> 指 Pod 端口, <code>nodePort</code> 节点端口.</blockquote><h3 id=Ingress><a href=#Ingress class=headerlink title=Ingress></a>Ingress</h3><p>推荐使用这种方式暴露服务, Ingress 其实就是从 kuberenets 集群外部访问集群的一个入口, 将外部的请求转发到集群内不同的 Service 上, 跟 Nginx 反向代理类似.<p>使用 Ingress 前需要部署 Ingress Controller, 实现有 <em><a href=https://github.com/kubernetes/ingress-nginx rel="external nofollow noopener noreferrer" target=_blank>Ingress NGINX</a></em> / <em><a href=https://clouddocs.f5.com/products/connectors/k8s-bigip-ctlr/v1.5/ rel="external nofollow noopener noreferrer" target=_blank>F5 BIG-IP Controller</a></em> / <em><a href=https://konghq.com/blog/kubernetes-ingress-controller-for-kong/ rel="external nofollow noopener noreferrer" target=_blank>Ingress Kong</a></em> / <em><a href=https://github.com/containous/traefik rel="external nofollow noopener noreferrer" target=_blank>Traefik</a></em> / <em><a href=https://github.com/appscode/voyager rel="external nofollow noopener noreferrer" target=_blank>Voyager</a></em> 等, 部署过程省略… 部署了 Ingress Controller 后, 就可以开始使用 Ingress 了:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>extensions/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Ingress</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>annotations:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-ingress</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>test</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>rules:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>host:</span> <span class=string>a.yangbingdong.com</span></span><br><span class=line>      <span class=attr>http:</span></span><br><span class=line>        <span class=attr>paths:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>backend:</span></span><br><span class=line>              <span class=attr>serviceName:</span> <span class=string>nginx</span></span><br><span class=line>              <span class=attr>servicePort:</span> <span class=number>80</span></span><br><span class=line>            <span class=attr>path:</span> <span class=string>/</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>host:</span> <span class=string>b.yangbingdong.com</span></span><br><span class=line>      <span class=attr>http:</span></span><br><span class=line>        <span class=attr>paths:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>backend:</span></span><br><span class=line>              <span class=attr>serviceName:</span> <span class=string>nginx</span></span><br><span class=line>              <span class=attr>servicePort:</span> <span class=number>80</span></span><br><span class=line>            <span class=attr>path:</span> <span class=string>/</span></span><br></pre></table></figure><h1 id=调度选择><a href=#调度选择 class=headerlink title=调度选择></a>调度选择</h1><blockquote><p>更多参考官方文档: <strong><em><a href=https://kubernetes.io/zh/docs/concepts/scheduling-eviction/ rel="external nofollow noopener noreferrer" target=_blank>https://kubernetes.io/zh/docs/concepts/scheduling-eviction/</a></em></strong></blockquote><h2 id=nodeSelector><a href=#nodeSelector class=headerlink title=nodeSelector></a>nodeSelector</h2><p>将 Pod 部署到 label 中包含 <code>{KEY}={VALUE}</code> 的 node, 如果不满足, 则 Pod 会一直处于 Pending 状态.<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>busybox-pod</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>test</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>command:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>sleep</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>"3600"</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>busybox</span></span><br><span class=line>    <span class=attr>imagePullPolicy:</span> <span class=string>Always</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>test-busybox</span></span><br><span class=line>  <span class=attr>nodeSelector:</span></span><br><span class=line>    <span class=attr>kubernetes.io/hostname:</span> <span class=string>node-a</span></span><br></pre></table></figure><h2 id=亲和性和反亲和性调度><a href=#亲和性和反亲和性调度 class=headerlink title=亲和性和反亲和性调度></a>亲和性和反亲和性调度</h2><p>亲和性和反亲和性调度都有硬策略以及软策略.<blockquote><p>软策略和硬策略的区分是有用处的, 硬策略适用于 pod 必须运行在某种节点, 否则会出现问题的情况, 比如集群中节点的架构不同, 而运行的服务必须依赖某种架构提供的功能; 软策略不同, 它适用于满不满足条件都能工作, 但是满足条件更好的情况, 比如服务最好运行在某个区域, 减少网络传输等. 这种区分是用户的具体需求决定的, 并没有绝对的技术依赖.</blockquote><h3 id=Node-Affinity><a href=#Node-Affinity class=headerlink title="Node Affinity"></a>Node Affinity</h3><p>硬策略:<ul><li><code>requiredDuringSchedulingIgnoredDuringExecution</code><li><code>requiredDuringSchedulingRequiredDuringExecution</code></ul><p>软策略:<ul><li><code>preferredDuringSchedulingIgnoredDuringExecution</code><li><code>preferredDuringSchedulingRequiredDuringExecution</code></ul><p>其中 <code>IgnoredDuringExecution</code> 表示如果节点标签发生了变化, 不再满足pod指定的条件, pod也会继续运行, 而 <code>RequiredDuringExecution</code> 表示如果节点标签发生了变化, 不再满足pod指定的条件, 则重新选择符合要求的节点.<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>with-node-affinity</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>affinity:</span></span><br><span class=line>    <span class=attr>nodeAffinity:</span></span><br><span class=line>      <span class=attr>requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>        <span class=attr>nodeSelectorTerms:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>matchExpressions:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>kubernetes.io/e2e-az-name</span></span><br><span class=line>            <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>            <span class=attr>values:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>e2e-az1</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>e2e-az2</span></span><br><span class=line>      <span class=attr>preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>weight:</span> <span class=number>1</span></span><br><span class=line>        <span class=attr>preference:</span></span><br><span class=line>          <span class=attr>matchExpressions:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>another-node-label-key</span></span><br><span class=line>            <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>            <span class=attr>values:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>another-node-label-value</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>with-node-affinity</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>k8s.gcr.io/pause:2.0</span></span><br></pre></table></figure><h3 id=Pod-Affinity><a href=#Pod-Affinity class=headerlink title="Pod Affinity"></a>Pod Affinity</h3><p>与上面的 Node Affinity 类似, 只不过选择 pod 的纬度是 pod 之间的关系. 比如需要将3个 Nacos 实例部署到3个不同的节点, 也就是节点中有一个 Nacos pod, 就不分配到这个节点了.<p>和 node affinity 相似, pod affinity 也有 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code>.<p>亲和性调度:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>pod-affinity</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>affinity:</span></span><br><span class=line>    <span class=attr>podAffinity:</span></span><br><span class=line>      <span class=attr>requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>labelSelector:</span></span><br><span class=line>          <span class=attr>matchExpressions:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>security</span></span><br><span class=line>            <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>            <span class=attr>values:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>S1</span></span><br><span class=line>        <span class=attr>topologyKey:</span> <span class=string>kubernetes.io/hostname</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>with-pod-affinity</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>gcr.io/google_containers/pause:2.0</span></span><br></pre></table></figure><p>反亲和性调度:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>with-pod-affinity</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>affinity:</span></span><br><span class=line>    <span class=attr>podAffinity:</span></span><br><span class=line>      <span class=attr>requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>labelSelector:</span></span><br><span class=line>          <span class=attr>matchExpressions:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>security</span></span><br><span class=line>            <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>            <span class=attr>values:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=string>S1</span></span><br><span class=line>        <span class=attr>topologyKey:</span> <span class=string>"failure-domain.beta.kubernetes.io/zone"</span></span><br><span class=line>    <span class=attr>podAntiAffinity:</span></span><br><span class=line>      <span class=attr>preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>weight:</span> <span class=number>100</span></span><br><span class=line>        <span class=attr>podAffinityTerm:</span></span><br><span class=line>          <span class=attr>labelSelector:</span></span><br><span class=line>            <span class=attr>matchExpressions:</span></span><br><span class=line>            <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>security</span></span><br><span class=line>              <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>              <span class=attr>values:</span></span><br><span class=line>              <span class=bullet>-</span> <span class=string>S2</span></span><br><span class=line>          <span class=attr>topologyKey:</span> <span class=string>kubernetes.io/hostname</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>with-pod-affinity</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>gcr.io/google_containers/pause:2.0</span></span><br></pre></table></figure><h2 id=污点和容忍-Taints和Tolerations><a href=#污点和容忍-Taints和Tolerations class=headerlink title=污点和容忍(Taints和Tolerations)></a>污点和容忍(Taints和Tolerations)</h2><p>与 NodeAffinity 相反, Taint 让 Node 拒绝 Pod 的运行. Taint 需要与 Toleration 配合使用, 让 Pod 避开那些不合适的 Node.<p>想设置标签一样, 需要先设置 taint:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>kubectl taint node [node] key=value[effect]</span><br><span class=line>其中[effect] 可取值:  [ NoSchedule | PreferNoSchedule | NoExecute ]</span><br><span class=line>NoSchedule : 一定不能被调度</span><br><span class=line>PreferNoSchedule: 尽量不要调度</span><br><span class=line>NoExecute: 不仅不会调度, 还会驱逐Node上已有的Pod</span><br><span class=line></span><br><span class=line>ex:</span><br><span class=line>kubectl taint node 10.3.1.16 test=16:NoSchedule</span><br></pre></table></figure><p>在 Node上设置一个或多个 Taint 后, 除非 Pod 明确声明能够容忍这些”污点”, 否则无法在这些 Node 上运行.<p>Toleration 设置为可以容忍具有该 Taint 的 Node, 使得 Pod 能够被调度到 node1 上:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>pod-taints</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>tolerations:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>"key"</span></span><br><span class=line>    <span class=attr>operator:</span> <span class=string>"Equal"</span></span><br><span class=line>    <span class=attr>value:</span> <span class=string>"value"</span></span><br><span class=line>    <span class=attr>effect:</span> <span class=string>"NoSchedule"</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>pod-taints</span></span><br><span class=line>      <span class=attr>image:</span> <span class=string>busybox:latest</span></span><br></pre></table></figure><blockquote><p>更多参考这里: <strong><em><a href=https://www.cnblogs.com/breezey/p/9101677.html rel="external nofollow noopener noreferrer" target=_blank>https://www.cnblogs.com/breezey/p/9101677.html</a></em></strong></blockquote><h1 id=ConfigMap-amp-Secret><a href=#ConfigMap-amp-Secret class=headerlink title="ConfigMap &amp; Secret"></a>ConfigMap &amp; Secret</h1><p>通常一个应用多多少少都会有一些配置, 而对于不同环境的配置是不一样的, 这时候就需要将配置与应用隔离.<p>Kubernetes 提供了 ConfigMap 以及 Secret 这样的方案提供给我们. Secret 相当于加密版的 ConfigMap, 存储的是 Base64 编码后的值.<h2 id=创建><a href=#创建 class=headerlink title=创建></a>创建</h2><p>推荐使用 yaml 文件创建 ConfigMap:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=attr>kind:</span> <span class=string>ConfigMap</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>cm-demo</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>default</span></span><br><span class=line><span class=attr>data:</span></span><br><span class=line>  <span class=attr>data.1:</span> <span class=string>hello</span></span><br><span class=line>  <span class=attr>data.2:</span> <span class=string>world</span></span><br><span class=line>  <span class=attr>config:</span> <span class=string>|</span></span><br><span class=line>    <span class=string>property.1=value-1</span></span><br><span class=line>    <span class=string>property.2=value-2</span></span><br><span class=line>    <span class=string>property.3=value-3</span></span><br></pre></table></figure><p>Secret:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Secret</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>mysecret</span></span><br><span class=line><span class=attr>type:</span> <span class=string>Opaque</span></span><br><span class=line><span class=attr>data:</span></span><br><span class=line>  <span class=attr>username:</span> <span class=string>YWRtaW4=</span></span><br><span class=line>  <span class=attr>password:</span> <span class=string>YWRtaW4zMjE=</span></span><br></pre></table></figure><blockquote><p>username 与 password 是经过 Base64 处理后的字符串</blockquote><h2 id=使用><a href=#使用 class=headerlink title=使用></a>使用</h2><p>通过环境变量方式:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>testcm1-pod</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>testcm1</span></span><br><span class=line>      <span class=attr>image:</span> <span class=string>busybox</span></span><br><span class=line>      <span class=attr>command:</span> <span class=string>[</span> <span class=string>"/bin/sh"</span><span class=string>,</span> <span class=string>"-c"</span><span class=string>,</span> <span class=string>"echo $(DB_HOST) $(DB_PORT)"</span> <span class=string>]</span></span><br><span class=line>      <span class=attr>env:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>DB_HOST</span></span><br><span class=line>          <span class=attr>valueFrom:</span></span><br><span class=line>            <span class=attr>configMapKeyRef:</span></span><br><span class=line>              <span class=attr>name:</span> <span class=string>cm-demo3</span></span><br><span class=line>              <span class=attr>key:</span> <span class=string>db.host</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>DB_PORT</span></span><br><span class=line>          <span class=attr>valueFrom:</span></span><br><span class=line>            <span class=attr>configMapKeyRef:</span></span><br><span class=line>              <span class=attr>name:</span> <span class=string>cm-demo3</span></span><br><span class=line>              <span class=attr>key:</span> <span class=string>db.port</span></span><br><span class=line>      <span class=attr>envFrom:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>configMapRef:</span></span><br><span class=line>            <span class=attr>name:</span> <span class=string>cm-demo1</span></span><br></pre></table></figure><p>通过挂载方式(ConfigMap 中的 key 为文件名, value 为文件内容):<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>data:</span></span><br><span class=line>  <span class=attr>redis.conf:</span> <span class=string>|</span></span><br><span class=line>    <span class=string>host=127.0.0.1</span></span><br><span class=line>    <span class=string>port=6379</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>ConfigMap</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>cm-demo2</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>default</span></span><br><span class=line><span class=meta>---</span></span><br><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>testcm3-pod</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>testcm3</span></span><br><span class=line>      <span class=attr>image:</span> <span class=string>busybox</span></span><br><span class=line>      <span class=attr>command:</span> <span class=string>[</span> <span class=string>"/bin/sh"</span><span class=string>,</span> <span class=string>"-c"</span><span class=string>,</span> <span class=string>"cat /etc/config/redis.conf"</span> <span class=string>]</span></span><br><span class=line>      <span class=attr>volumeMounts:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>config-volume</span></span><br><span class=line>        <span class=attr>mountPath:</span> <span class=string>/etc/config</span></span><br><span class=line>  <span class=attr>volumes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>config-volume</span></span><br><span class=line>      <span class=attr>configMap:</span></span><br><span class=line>        <span class=attr>name:</span> <span class=string>cm-demo2</span></span><br></pre></table></figure><p>也可以指定挂载某一个 key:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>testcm3-pod</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>testcm3</span></span><br><span class=line>      <span class=attr>image:</span> <span class=string>busybox</span></span><br><span class=line>      <span class=attr>command:</span> <span class=string>[</span> <span class=string>"/bin/sh"</span><span class=string>,</span> <span class=string>"-c"</span><span class=string>,</span> <span class=string>"cat /etc/config/path/to/redis.conf"</span> <span class=string>]</span></span><br><span class=line>      <span class=attr>volumeMounts:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>config-volume</span></span><br><span class=line>        <span class=attr>mountPath:</span> <span class=string>/etc/config</span></span><br><span class=line>  <span class=attr>volumes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>config-volume</span></span><br><span class=line>      <span class=attr>configMap:</span></span><br><span class=line>        <span class=attr>name:</span> <span class=string>cm-demo2</span></span><br><span class=line>        <span class=attr>items:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>redis.conf</span></span><br><span class=line>          <span class=attr>path:</span> <span class=string>path/to/redis.conf</span></span><br></pre></table></figure><p>Secret 用法类似, 只需要将 <code>configMapKeyRef</code> 替换成 <code>secretKeyRef</code>.<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>secret1-pod</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>secret1</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>busybox</span></span><br><span class=line>    <span class=attr>command:</span> <span class=string>[</span> <span class=string>"/bin/sh"</span><span class=string>,</span> <span class=string>"-c"</span><span class=string>,</span> <span class=string>"env"</span> <span class=string>]</span></span><br><span class=line>    <span class=attr>env:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>USERNAME</span></span><br><span class=line>      <span class=attr>valueFrom:</span></span><br><span class=line>        <span class=attr>secretKeyRef:</span></span><br><span class=line>          <span class=attr>name:</span> <span class=string>mysecret</span></span><br><span class=line>          <span class=attr>key:</span> <span class=string>username</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>PASSWORD</span></span><br><span class=line>      <span class=attr>valueFrom:</span></span><br><span class=line>        <span class=attr>secretKeyRef:</span></span><br><span class=line>          <span class=attr>name:</span> <span class=string>mysecret</span></span><br><span class=line>          <span class=attr>key:</span> <span class=string>password</span></span><br></pre></table></figure><h2 id=差异与注意点><a href=#差异与注意点 class=headerlink title=差异与注意点></a>差异与注意点</h2><p>相同点:<ul><li>key/value 的形式<li>属于某个特定的 namespace<li>可以导出到环境变量<li>可以通过目录/文件形式挂载<li>通过 volume 挂载的配置信息均可热更新</ul><p>不同点:<ul><li>Secret 可以被 ServerAccount 关联<li>Secret 可以存储 docker register 的鉴权信息, 用在 ImagePullSecret 参数中, 用于拉取私有仓库的镜像<li>Secret 支持 Base64 加密<li>Secret 分为 <code>kubernetes.io/service-account-token</code>, <code>kubernetes.io/dockerconfigjson</code>, <code>Opaque</code> 三种类型而 Configmap 不区分类型</ul><p>ConfigMap需要注意:<ul><li>ConfigMap 必须在 Pod 之前创建<li>只有与当前 ConfigMap 在同一个 namespace 内的 pod 才能使用这个 ConfigMap, 换句话说, ConfigMap 不能跨命名空间调用</ul><h1 id=数据挂载><a href=#数据挂载 class=headerlink title=数据挂载></a>数据挂载</h1><p>Kubernetes 提供了众多 Volume 类型, 包括 <code>emptyDir</code> / <code>hostPath</code> / <code>nfs</code> / <code>glusterfs</code> / <code>cephfs</code> / <code>ceph rbd</code> 等。具体可以参考<a href=https://kubernetes.io/docs/concepts/storage/volumes/ rel="external nofollow noopener noreferrer" target=_blank><strong><em>官方文档</em></strong></a>, 这里列举常用的几种.<h2 id=emptyDir><a href=#emptyDir class=headerlink title=emptyDir></a>emptyDir</h2><p>这是一个临时文件夹, Pod 销毁就删除:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>test-pod</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>image:</span> <span class=string>test-webserver</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>test-container</span></span><br><span class=line>    <span class=attr>volumeMounts:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>cache-volume</span></span><br><span class=line>      <span class=attr>mountPath:</span> <span class=string>/cache</span></span><br><span class=line>  <span class=attr>volumes:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>cache-volume</span></span><br><span class=line>    <span class=attr>emptyDir:</span> <span class=string>&#123;&#125;</span></span><br></pre></table></figure><h2 id=hostPath><a href=#hostPath class=headerlink title=hostPath></a>hostPath</h2><p>在 Pod 运行节点创建的文件夹, 缺点是, Pod 是动态的, 而 <code>hostPath</code> 是静态的(跟着 node 走):<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>test-pod</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>image:</span> <span class=string>test-webserver</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>test-container</span></span><br><span class=line>    <span class=attr>volumeMounts:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>test-volume</span></span><br><span class=line>      <span class=attr>mountPath:</span> <span class=string>/www</span></span><br><span class=line>  <span class=attr>volumes:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>test-volume</span></span><br><span class=line>    <span class=attr>hostPath:</span></span><br><span class=line>      <span class=attr>path:</span> <span class=string>/data</span></span><br></pre></table></figure><h2 id=PV-amp-PVC><a href=#PV-amp-PVC class=headerlink title="PV &amp; PVC"></a>PV &amp; PVC</h2><p>PV: 是对共享存储资源的一种抽象, 实现方式常见的有 <code>Ceph</code>, <code>GlusterFS</code>, <code>NFS</code> 等.<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>PersistentVolume</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span>  <span class=string>pv1</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>nfs</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>capacity:</span> </span><br><span class=line>    <span class=attr>storage:</span> <span class=string>1Gi</span> <span class=comment># 存储空间设置</span></span><br><span class=line>  <span class=attr>accessModes:</span> <span class=comment># 访问模式, 其他还有 ReadOnlyMany(只读权限, 可以被多个节点挂载), ReadWriteMany(读写权限, 可以被多个节点挂载)</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>ReadWriteOnce</span> <span class=comment># 读写权限, 但是只能被单个节点挂载</span></span><br><span class=line>  <span class=attr>persistentVolumeReclaimPolicy:</span> <span class=string>Recycle</span> <span class=comment># 回收策略, Retain(保留, 需要人工删除), Recycle(回收), Delete</span></span><br><span class=line>  <span class=attr>nfs:</span></span><br><span class=line>    <span class=attr>path:</span> <span class=string>/data/k8s</span></span><br><span class=line>    <span class=attr>server:</span> <span class=number>10.151</span><span class=number>.30</span><span class=number>.57</span></span><br></pre></table></figure><p>PVC: 则是用户存储的一种消耗 PV 的声明, 用户不需要关心具体的存储实现, 只需要直接使用 PVC 就行.<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>PersistentVolumeClaim</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>pvc1</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>accessModes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>ReadWriteOnce</span></span><br><span class=line>  <span class=attr>resources:</span></span><br><span class=line>    <span class=attr>requests:</span></span><br><span class=line>      <span class=attr>storage:</span> <span class=string>2Gi</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app:</span> <span class=string>nfs</span></span><br></pre></table></figure><h2 id=StorageClass><a href=#StorageClass class=headerlink title=StorageClass></a>StorageClass</h2><p><code>StorageClass</code> 可以自动帮我们创建 PV, 我们只需要声明 PVC. 创建的 PV 以 <code>${namespace}-${pvcName}-${pvName}</code> 的形式存在 NFS 的共享目录中.<p>要使用 <code>StorageClass</code>, 我们需要先创建自动配置程序, 又叫 <code>Provisioner</code>, 怎么创建可以参考 <strong><em><a href=https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client rel="external nofollow noopener noreferrer" target=_blank>https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client</a></em></strong>.<p>创建 <code>StorageClass</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>storage.k8s.io/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>StorageClass</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>test</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>course-nfs-storage</span></span><br><span class=line><span class=attr>provisioner:</span> <span class=string>fuseim.pri/ifs</span>  <span class=comment># 对应 Provisioner 中的 PROVISIONER_NAME 参数</span></span><br></pre></table></figure><p>使用 <code>StorageClass</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>PersistentVolumeClaim</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>test-pvc</span></span><br><span class=line>  <span class=attr>annotations:</span></span><br><span class=line>    <span class=attr>volume.beta.kubernetes.io/storage-class:</span> <span class=string>"course-nfs-storage"</span> <span class=comment># 对应上面声明的 name</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>accessModes:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=string>ReadWriteMany</span></span><br><span class=line>  <span class=attr>resources:</span></span><br><span class=line>    <span class=attr>requests:</span></span><br><span class=line>      <span class=attr>storage:</span> <span class=string>1Mi</span></span><br></pre></table></figure><p>或者通过 Pod PVC 模板自动创建 PVC:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>StatefulSet</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nfs-web</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>serviceName:</span> <span class=string>"nginx"</span></span><br><span class=line>  <span class=attr>replicas:</span> <span class=number>3</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app:</span> <span class=string>nfs-web</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>app:</span> <span class=string>nfs-web</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>terminationGracePeriodSeconds:</span> <span class=number>10</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>nginx</span></span><br><span class=line>        <span class=attr>image:</span> <span class=string>nginx:1.7.9</span></span><br><span class=line>        <span class=attr>ports:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>containerPort:</span> <span class=number>80</span></span><br><span class=line>          <span class=attr>name:</span> <span class=string>web</span></span><br><span class=line>        <span class=attr>volumeMounts:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>www</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>/usr/share/nginx/html</span></span><br><span class=line>  <span class=attr>volumeClaimTemplates:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>name:</span> <span class=string>www</span></span><br><span class=line>      <span class=attr>annotations:</span></span><br><span class=line>        <span class=attr>volume.beta.kubernetes.io/storage-class:</span> <span class=string>course-nfs-storage</span></span><br><span class=line>    <span class=attr>spec:</span></span><br><span class=line>      <span class=attr>accessModes:</span> <span class=string>[</span> <span class=string>"ReadWriteOnce"</span> <span class=string>]</span></span><br><span class=line>      <span class=attr>resources:</span></span><br><span class=line>        <span class=attr>requests:</span></span><br><span class=line>          <span class=attr>storage:</span> <span class=string>1Gi</span></span><br></pre></table></figure><h1 id=Kubernetes-常用命令><a href=#Kubernetes-常用命令 class=headerlink title="Kubernetes 常用命令"></a>Kubernetes 常用命令</h1><p><strong>查看资源以及资源简写</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl api-resources</span><br></pre></table></figure><p><strong>应用资源</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl apply -f &lt;RESOURCE_YAML&gt;</span><br></pre></table></figure><p><strong>删除资源</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl delete -f &lt;RESOURCE_YAML&gt;</span><br></pre></table></figure><p><strong>资源列表</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl -n &lt;NANESPACE&gt; get &lt;API_RESOURCES&gt;</span><br></pre></table></figure><ul><li><p>需要查看全部命名空间的资源, 将 <code>-n &lt;NANESPACE&gt;</code> 换成最后追加 <code>--all-namespaces</code>.<li><p>输出更多信息(ip/节点名等)追加参数 <code>-o wide</code><li>输出标签信息追加 参数 <code>--show-labels</code></ul><p><strong>输出资源 yaml</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>kubectl -n &lt;NANESPACE&gt; get &lt;API_RESOURCES&gt; &lt;RESOURCE_NAME&gt; -o yaml</span><br><span class=line></span><br><span class=line>例如:</span><br><span class=line>kubectl -n kube-system get deploy nginx-ingress-controller -o yaml</span><br></pre></table></figure><blockquote><p>输出 json 格式只需要将 yaml 改成 json 即可</blockquote><p><strong>查看资源详情</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl -n &lt;NANESPACE&gt; describe &lt;API_RESOURCE&gt; &lt;RESOURCE_NAME&gt;</span><br></pre></table></figure><p><strong>滚动更新相关</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line># 查看滚动更新状态</span><br><span class=line>kubectl -n &lt;NANESPACE&gt; rollout status deployment &lt;DEPLOYMENT_NAME&gt;</span><br><span class=line></span><br><span class=line># 查看历史</span><br><span class=line>kubectl -n &lt;NANESPACE&gt; rollout history deployment &lt;DEPLOYMENT_NAME&gt;</span><br><span class=line></span><br><span class=line># 回退</span><br><span class=line>kubectl -n &lt;NANESPACE&gt; rollout undo deployment &lt;DEPLOYMENT_NAME&gt;</span><br><span class=line></span><br><span class=line># 回退到指定版本</span><br><span class=line>kubectl -n &lt;NANESPACE&gt; rollout undo deployment &lt;DEPLOYMENT_NAME&gt; --to-revision=2</span><br></pre></table></figure><p><strong>弹性伸缩</strong>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>kubectl autoscale deployment &lt;DEPLOYMENT_NAME&gt; --cpu-percent=50 --min=1 --max=10</span><br></pre></table></figure><h1 id=YAML-声明示例><a href=#YAML-声明示例 class=headerlink title="YAML 声明示例"></a>YAML 声明示例</h1><h2 id=Pod><a href=#Pod class=headerlink title=Pod></a>Pod</h2><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Pod</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>&lt;APP_NAME&gt;</span></span><br><span class=line>  <span class=attr>labels:</span> <span class=comment># 标签</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>&lt;APP_NAME&gt;</span></span><br><span class=line>  <span class=attr>annotations:</span> <span class=comment># 注解</span></span><br><span class=line>    <span class=attr>armsPilotAutoEnable:</span> <span class=string>"on"</span></span><br><span class=line>    <span class=attr>armsPilotCreateAppName:</span> <span class=string>&lt;APP_NAME&gt;</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>affinity:</span> <span class=comment># 亲和性调度</span></span><br><span class=line>    <span class=attr>podAntiAffinity:</span> <span class=comment># 反亲和性, 一个节点上运行了某个 pod, 那么我们的 pod 则希望被调度到其他节点上去</span></span><br><span class=line>      <span class=attr>requiredDuringSchedulingIgnoredDuringExecution:</span> <span class=comment># 硬策略, 必须满足, 与之对应是preferredDuringSchedulingIgnoredDuringExecution</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>labelSelector:</span> <span class=comment>#  标签选择, 下面的意思是如果 pod 中有标签为 app=busybox-pod 的实例, 就不在本节点创建了</span></span><br><span class=line>            <span class=attr>matchExpressions:</span></span><br><span class=line>              <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>"app"</span></span><br><span class=line>                <span class=attr>operator:</span> <span class=string>In</span></span><br><span class=line>                <span class=attr>values:</span></span><br><span class=line>                  <span class=bullet>-</span> <span class=string>busybox-pod</span></span><br><span class=line>          <span class=attr>topologyKey:</span> <span class=string>kubernetes.io/hostname</span></span><br><span class=line>  <span class=attr>tolerations:</span> <span class=comment># 容忍度</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>"key"</span></span><br><span class=line>      <span class=attr>operator:</span> <span class=string>"Equal"</span></span><br><span class=line>      <span class=attr>value:</span> <span class=string>"value"</span></span><br><span class=line>      <span class=attr>effect:</span> <span class=string>"NoSchedule"</span></span><br><span class=line>  <span class=attr>restartPolicy:</span> <span class=string>Always</span>  <span class=comment>#表明该容器一直运行, 默认k8s的策略, 在此容器退出后, 会立即创建一个相同的容器</span></span><br><span class=line>  <span class=attr>nodeSelector:</span> <span class=comment>#节点选择, 先给主机打标签kubectl label nodes kube-node1 zone=node1</span></span><br><span class=line>    <span class=attr>zone:</span> <span class=string>node1</span></span><br><span class=line>    <span class=attr>kubernetes.io/hostname:</span> <span class=string>dev-a</span></span><br><span class=line>  <span class=attr>terminationGracePeriodSeconds:</span> <span class=number>30</span>  <span class=comment># 优雅终止宽限期, 默认30秒</span></span><br><span class=line>  <span class=attr>initContainers:</span> <span class=comment># 初始化容器, 执行完初始化容器才会启动下面的 containers</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>init-myservice</span></span><br><span class=line>      <span class=attr>image:</span> <span class=string>busybox</span></span><br><span class=line>      <span class=attr>command:</span> <span class=string>[</span> <span class=string>'sh'</span><span class=string>,</span> <span class=string>'-c'</span><span class=string>,</span> <span class=string>'until nslookup myservice; do echo waiting for myservice; sleep 2; done;'</span> <span class=string>]</span></span><br><span class=line>  <span class=attr>containers:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>&lt;APP_NAME&gt;</span>  <span class=comment># 容器名称</span></span><br><span class=line>      <span class=attr>image:</span> <span class=string>&lt;IMAGE&gt;</span>  <span class=comment># 镜像</span></span><br><span class=line>      <span class=attr>imagePullPolicy:</span> <span class=string>Always</span>  <span class=comment># 每次启动时检查和更新（从registery）images的策略, 三个选择Always()/Never/IfNotPresent</span></span><br><span class=line>      <span class=attr>ports:</span> <span class=comment># 端口配置</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>http</span> <span class=comment># 端口配置名称, 在 Service -&gt; target port 可以指定端口或者使用该名称</span></span><br><span class=line>          <span class=attr>containerPort:</span> <span class=number>8080</span>  <span class=comment>#容器开发对外的端口</span></span><br><span class=line>          <span class=attr>protocol:</span> <span class=string>TCP</span>  <span class=comment>#端口协议, 支持TCP和UDP, 默认TCP</span></span><br><span class=line>      <span class=attr>lifecycle:</span> <span class=comment># 生命周期管理</span></span><br><span class=line>        <span class=attr>postStart:</span> <span class=comment># 容器创建后立即执行</span></span><br><span class=line>          <span class=attr>exec:</span></span><br><span class=line>            <span class=attr>command:</span> <span class=string>[</span> <span class=string>"/bin/sh"</span><span class=string>,</span> <span class=string>"-c"</span><span class=string>,</span> <span class=string>"echo Hello from the postStart handler &gt; /usr/share/message"</span> <span class=string>]</span></span><br><span class=line>        <span class=attr>preStop:</span> <span class=comment># 容器终止之前立即被调用</span></span><br><span class=line>          <span class=attr>exec:</span></span><br><span class=line>            <span class=attr>command:</span> <span class=string>[</span> <span class=string>"/usr/bin/curl"</span><span class=string>,"-X","POST",</span> <span class=string>"http://localhost:8081/actuator/shutdown"</span> <span class=string>]</span></span><br><span class=line>      <span class=attr>livenessProbe:</span> <span class=comment># pod存活检查, 失败的pod将从k8s中终止并启动新的pod</span></span><br><span class=line>        <span class=attr>httpGet:</span> <span class=comment># 通过httpget检查健康, 返回200-399之间, 则认为容器正常</span></span><br><span class=line>          <span class=attr>path:</span> <span class=string>/actuator/health</span></span><br><span class=line>          <span class=attr>port:</span> <span class=number>8081</span></span><br><span class=line>          <span class=attr>scheme:</span> <span class=string>HTTP</span></span><br><span class=line>        <span class=attr>initialDelaySeconds:</span> <span class=number>60</span>  <span class=comment>#表明第一次检测在容器启动后多长时间后开始, 默认0秒</span></span><br><span class=line>        <span class=attr>timeoutSeconds:</span> <span class=number>10</span>  <span class=comment>#检测的超时时间, 默认1秒</span></span><br><span class=line>        <span class=attr>periodSeconds:</span> <span class=number>15</span>  <span class=comment>#检查间隔时间, 默认10秒</span></span><br><span class=line>      <span class=attr>readinessProbe:</span> <span class=comment># pod就绪探测, 当pod中所有容器就绪后, 流量才会进来, 否则将从 service 中移除</span></span><br><span class=line>        <span class=attr>httpGet:</span></span><br><span class=line>          <span class=attr>path:</span> <span class=string>/actuator/health</span></span><br><span class=line>          <span class=attr>port:</span> <span class=number>8081</span></span><br><span class=line>          <span class=attr>scheme:</span> <span class=string>HTTP</span></span><br><span class=line>        <span class=attr>initialDelaySeconds:</span> <span class=number>60</span></span><br><span class=line>        <span class=attr>timeoutSeconds:</span> <span class=number>10</span></span><br><span class=line>        <span class=attr>periodSeconds:</span> <span class=number>15</span></span><br><span class=line>      <span class=attr>resources:</span> <span class=comment># 资源限制管理</span></span><br><span class=line>        <span class=attr>requests:</span> <span class=comment># 容器运行时, 最低资源需求, 也就是说最少需要多少资源容器才能正常运行</span></span><br><span class=line>          <span class=attr>cpu:</span> <span class=string>100m</span>  <span class=comment># CPU资源(核数), 两种方式, 浮点数或者是整数+m, 0.1=100m, 最少值为0.001核(1m)</span></span><br><span class=line>          <span class=attr>memory:</span> <span class=string>1536Mi</span>  <span class=comment># 内存使用量</span></span><br><span class=line>        <span class=attr>limits:</span> <span class=comment>#资源限制</span></span><br><span class=line>          <span class=attr>cpu:</span> <span class=string>100m</span></span><br><span class=line>          <span class=attr>memory:</span> <span class=string>2000Mi</span></span><br><span class=line>      <span class=attr>env:</span> <span class=comment>#指定容器中的环境变量</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>JAVA_OPTS</span></span><br><span class=line>          <span class=attr>value:</span> <span class=string>"-Xmx1g -Xms1g"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>SPRING_PROFILES_ACTIVE</span></span><br><span class=line>          <span class=attr>value:</span> <span class=string>"test"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>SERVER_PORT</span></span><br><span class=line>          <span class=attr>value:</span> <span class=string>"8080"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>MANAGEMENT_SERVER_PORT</span></span><br><span class=line>          <span class=attr>value:</span> <span class=string>"8081"</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>DB_HOST</span></span><br><span class=line>          <span class=attr>valueFrom:</span> <span class=comment># 从 configMap 中读取变量</span></span><br><span class=line>            <span class=attr>configMapKeyRef:</span></span><br><span class=line>              <span class=attr>name:</span> <span class=string>cm-demo3</span></span><br><span class=line>              <span class=attr>key:</span> <span class=string>db.host</span></span><br><span class=line>      <span class=attr>command:</span> <span class=string>[</span> <span class=string>'sh'</span> <span class=string>]</span>  <span class=comment>#启动容器的运行命令 将覆盖容器中的Entrypoint, 对应Dockefile中的ENTRYPOINT</span></span><br><span class=line>      <span class=attr>args:</span> <span class=comment>#启动容器的命令参数, 对应Dockerfile中CMD参数</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--spring.devtools.add-properties=false</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--management.endpoints.web.exposure.include=*</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--management.endpoint.shutdown.enabled=true</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--management.endpoint.configprops.enabled=true</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--management.endpoint.health.enabled=true</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--management.endpoint.info.enabled=true</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--management.endpoint.metrics.enabled=true</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--spring.cloud.nacos.config.enabled=true</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--spring.cloud.nacos.server-addr=nacos-headless.infra.svc.cluster.local:8848</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--spring.cloud.nacos.config.file-extension=yaml</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>--spring.cloud.nacos.config.namespace=test</span></span><br><span class=line>      <span class=attr>volumeMounts:</span> <span class=comment>#挂载持久存储卷</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>volume</span>  <span class=comment>#挂载设备的名字, 与volumes[*].name 需要对应</span></span><br><span class=line>          <span class=attr>mountPath:</span> <span class=string>/etc/config</span>  <span class=comment>#挂载到容器的某个路径下</span></span><br><span class=line>          <span class=attr>subPath:</span> <span class=string>special.html</span>  <span class=comment># 指定所引用的卷内的子路径, 而不是其根路径</span></span><br><span class=line>          <span class=attr>readOnly:</span> <span class=literal>false</span>  <span class=comment># 是否只读, 默认为 false</span></span><br><span class=line>  <span class=attr>volumes:</span> <span class=comment># 定义一组挂载设备</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>nginx-pvc</span></span><br><span class=line>      <span class=attr>persistentVolumeClaim:</span></span><br><span class=line>        <span class=attr>claimName:</span> <span class=string>nginx-pvc</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>host-volume</span></span><br><span class=line>      <span class=attr>hostPath:</span></span><br><span class=line>        <span class=attr>path:</span> <span class=string>/opt</span>  <span class=comment># 挂载设备类型为hostPath, 路径为宿主机下的/opt,这里设备类型支持很多种</span></span><br><span class=line>        <span class=attr>type:</span> <span class=string>DirectoryOrCreate</span></span><br><span class=line>    <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>configMap-volume</span></span><br><span class=line>      <span class=attr>configMap:</span> <span class=comment># 类型为configMap的存储卷, 挂载预定义的configMap对象到容器内部</span></span><br><span class=line>        <span class=attr>name:</span> <span class=string>nginx-cm</span></span><br><span class=line>        <span class=attr>items:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=attr>key:</span> <span class=string>a.conf</span></span><br><span class=line>            <span class=attr>path:</span> <span class=string>a.conf</span></span><br></pre></table></figure><h2 id=Deloyment><a href=#Deloyment class=headerlink title=Deloyment></a>Deloyment</h2><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>apps/v1</span>  <span class=comment>#指定api版本, 此值必须在kubectl apiversion中</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Deployment</span>  <span class=comment># 资源类型, Deployment/Job/Ingress/Service等</span></span><br><span class=line><span class=attr>metadata:</span>  <span class=comment># 资源元数据/属性</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>&lt;DEPLOYMENT_VERSION&gt;</span>  <span class=comment>#资源的名字, 在同一个namespace中必须唯一   </span></span><br><span class=line>  <span class=attr>labels:</span>  <span class=comment>#设定资源的标签</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>&lt;APP_NAME&gt;</span></span><br><span class=line>    <span class=attr>version:</span> <span class=string>v1.0</span></span><br><span class=line>  <span class=attr>annotations:</span>  <span class=comment>#注解列表</span></span><br><span class=line>    <span class=attr>pod.alpha.kubernetes.io/initialized:</span> <span class=string>"true"</span></span><br><span class=line><span class=attr>spec:</span>  <span class=comment>#specification of the resource content 指定该资源的内容</span></span><br><span class=line>  <span class=attr>replicas:</span> <span class=number>1</span>  <span class=comment># 容器数量</span></span><br><span class=line>  <span class=attr>revisionHistoryLimit:</span> <span class=number>10</span>  <span class=comment># ReplicaSet 保留数量, 默认为 10, 如果设置为0将导致清空所有历史记录, 将无法回滚</span></span><br><span class=line>  <span class=attr>selector:</span>  <span class=comment># 选择器, 选择哪些容器进行管理</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=attr>app:</span> <span class=string>&lt;APP_NAME&gt;</span></span><br><span class=line>      <span class=attr>version:</span> <span class=string>v1.0</span></span><br><span class=line>  <span class=attr>minReadySeconds:</span> <span class=number>3</span>  <span class=comment># 指定新创建的 Pod 在没有任意容器崩溃情况下的最小就绪时间, 默认值为 0(Pod 在准备就绪后立即将被视为可用)</span></span><br><span class=line>  <span class=attr>strategy:</span>  <span class=string>新</span> <span class=string>Pods</span> <span class=string>替换旧</span> <span class=string>Pods</span> <span class=string>的策略</span></span><br><span class=line>    <span class=attr>type:</span> <span class=string>RollingUpdate</span>  <span class=comment># 可选的还有 Recreate, 默认值是 RollingUpdate </span></span><br><span class=line>    <span class=attr>rollingUpdate:</span>  <span class=comment># 下面两个配置可填数字或者百分比, 例如1或者25%, 默认值都是25%</span></span><br><span class=line>      <span class=attr>maxSurge:</span> <span class=number>1</span>  <span class=comment># 升级过程中最多可以比原先设置多出的POD数量, 例如: maxSurage=1, replicas=5, 则表示Kubernetes会先启动1一个新的Pod后才删掉一个旧的POD, 整个升级过程中最多会有5+1个POD</span></span><br><span class=line>      <span class=attr>maxUnavailable:</span> <span class=number>1</span>  <span class=comment># 升级过程中最多有多少个POD处于无法提供服务的状态</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=attr>metadata:</span></span><br><span class=line>      <span class=attr>labels:</span></span><br><span class=line>        <span class=attr>app:</span> <span class=string>&lt;APP_NAME&gt;</span></span><br><span class=line>    <span class=attr>spec:</span> <span class=comment># 下面配置参考 Pod</span></span><br><span class=line>      <span class=string>...</span></span><br><span class=line>      <span class=attr>containers:</span></span><br><span class=line>      <span class=string>...</span></span><br></pre></table></figure><h2 id=Service><a href=#Service class=headerlink title=Service></a>Service</h2><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>Service</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>nginx-service</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>nginx</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>ports:</span></span><br><span class=line>  <span class=bullet>-</span> <span class=attr>port:</span> <span class=number>88</span>  <span class=comment># 服务暴露的端口</span></span><br><span class=line>    <span class=attr>targetPort:</span> <span class=number>80</span>  <span class=comment># 容器暴露的端口</span></span><br><span class=line>  <span class=attr>selector:</span>  <span class=comment># 标签选择器 </span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>nginx</span></span><br></pre></table></figure><h2 id=HPA><a href=#HPA class=headerlink title=HPA></a>HPA</h2><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>autoscaling/v1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>HorizontalPodAutoscaler</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>php-apache</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>default</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>maxReplicas:</span> <span class=number>10</span>  <span class=comment># 最大扩容数</span></span><br><span class=line>  <span class=attr>minReplicas:</span> <span class=number>4</span>  <span class=comment># 最小扩容数</span></span><br><span class=line>  <span class=attr>scaleTargetRef:</span></span><br><span class=line>    <span class=attr>kind:</span> <span class=string>Deployment</span></span><br><span class=line>    <span class=attr>name:</span> <span class=string>nginx-demo</span></span><br><span class=line>  <span class=attr>targetCPUUtilizationPercentage:</span> <span class=number>90</span>  <span class=comment># 目标 Pod 所有副本自身的 CPU 利用率的平均值超过90%后触发扩容</span></span><br></pre></table></figure><h2 id=Daemonset><a href=#Daemonset class=headerlink title=Daemonset></a>Daemonset</h2><p><code>template</code> 语法与 <code>Deployment</code> 类似, 不同在于滚动升级策略, <code>.spec.updateStrategy.type</code> 指定:<ul><li><code>OnDelete</code>: 更新配置后, 只有手动删除 DaemonSet Pod 才会创建新的.<li><code>RollingUpdate</code>: 更新后自动删除并创建 Pod.</ul><p>其他设置:<ul><li><code>.spec.updateStrategy.rollingUpdate.maxUnavailable</code>: 默认值为1.<li><code>.spec.minReadySeconds</code>: 默认为0, 用于指定认为 DaemoSet Pod 启动可用所需的最小的秒数.</ul><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=attr>apiVersion:</span> <span class=string>extensions/v1beta1</span></span><br><span class=line><span class=attr>kind:</span> <span class=string>DaemonSet</span></span><br><span class=line><span class=attr>metadata:</span></span><br><span class=line>  <span class=attr>name:</span> <span class=string>test-ds</span></span><br><span class=line>  <span class=attr>namespace:</span> <span class=string>kube-system</span></span><br><span class=line>  <span class=attr>labels:</span></span><br><span class=line>    <span class=attr>tier:</span> <span class=string>node</span></span><br><span class=line>    <span class=attr>app:</span> <span class=string>test</span></span><br><span class=line><span class=attr>spec:</span></span><br><span class=line>  <span class=attr>updateStrategy:</span></span><br><span class=line>    <span class=attr>type:</span> <span class=string>RollingUpdate</span></span><br><span class=line>  <span class=attr>selector:</span></span><br><span class=line>    <span class=attr>matchLabels:</span></span><br><span class=line>      <span class=string>...</span></span><br><span class=line>  <span class=attr>template:</span></span><br><span class=line>    <span class=string>...</span></span><br></pre></table></figure><h1 id=阿里云-K8S><a href=#阿里云-K8S class=headerlink title="阿里云 K8S"></a>阿里云 K8S</h1><h2 id=创建集群><a href=#创建集群 class=headerlink title=创建集群></a>创建集群</h2><h3 id=准备工作><a href=#准备工作 class=headerlink title=准备工作></a>准备工作</h3><p>购买一台2核4G的最低配置的CentOS(可选偏远地区有优惠, 比如华北3), 安装 <strong>docker</strong><h4 id=安装-kubectl><a href=#安装-kubectl class=headerlink title="安装 kubectl"></a>安装 kubectl</h4><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=line>[kubernetes]</span><br><span class=line>name=Kubernetes</span><br><span class=line>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class=line>enabled=1</span><br><span class=line>gpgcheck=1</span><br><span class=line>repo_gpgcheck=1</span><br><span class=line>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=line>EOF</span><br><span class=line></span><br><span class=line>yum install -y kubectl</span><br></pre></table></figure><p>其他系统安装(Ubuntu):<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl</span><br><span class=line>chmod +x ./kubectl</span><br><span class=line>sudo mv ./kubectl /usr/local/bin/kubectl</span><br></pre></table></figure><h5 id=命令补全><a href=#命令补全 class=headerlink title=命令补全></a>命令补全</h5><p><strong>Zsh</strong>:<p>在<code>~/.zshrc</code>添加以下代码:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>if [ $commands[kubectl] ]; then</span><br><span class=line>  source &lt;(kubectl completion zsh)</span><br><span class=line>fi</span><br></pre></table></figure><p><strong>Oh-My-Zsh</strong>:<p>如果是使用<code>Oh-My-Zsh</code>, 在<code>~/.zshrc</code>中, 找到<code>source $ZSH/oh-my-zsh.sh</code>这一行, 在这行<strong>下面</strong>添加(否则不生效):<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>source &lt;(kubectl completion zsh)</span><br></pre></table></figure><h3 id=创建集群-1><a href=#创建集群-1 class=headerlink title=创建集群></a>创建集群</h3><p>在容器服务K8S版中创建集群, 选择<strong>托管版</strong>, <strong>按量付费</strong>, 工作节点可选 ecs.t6-c1m2.large, 最低要求两台. 创建大概需要10分钟.<p>配置 KubeConfig: 创建完成之后在集群信息中找到<strong>连接信息</strong>, 里面有教程.<p>配置安全组: 在 ECS 中将两个 Worker 的安全组配置成与准备工作中买的那台一样.<h2 id=镜像服务配置><a href=#镜像服务配置 class=headerlink title=镜像服务配置></a>镜像服务配置</h2><p>在<strong>容器镜像服务</strong>中开通, 注意创建的仓库所在<strong>地区</strong>要与K8S配置的一致(华北3), 并且在<strong>访问凭证</strong>中创建密码.<p>在仓库详情中会有两个地址, 一个公网, 一个内网, <strong>内网需要在同一个地区才能访问</strong>.<h2 id=停止设置><a href=#停止设置 class=headerlink title=停止设置></a>停止设置</h2><h3 id=停止实例><a href=#停止实例 class=headerlink title=停止实例></a>停止实例</h3><p>在 ECS 服务中停止实例时选<strong>停机不收费</strong>的那项即可.<h3 id=停止负载均衡><a href=#停止负载均衡 class=headerlink title=停止负载均衡></a>停止负载均衡</h3><p>负载均衡在负载均衡控制台中停止.<h3 id=完全释放资源><a href=#完全释放资源 class=headerlink title=完全释放资源></a>完全释放资源</h3><p>实例释放设置前要先取消<strong>实例释放保护</strong>.<h2 id=NAS><a href=#NAS class=headerlink title=NAS></a>NAS</h2><p>购买, 按量付费, 注意地区.<p>挂载前先安装依赖:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>yum install nfs-utils</span><br></pre></table></figure><p>挂载后查看:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>df -h | grep aliyun</span><br></pre></table></figure><p>取消挂载:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>umount /mnt</span><br></pre></table></figure><h1 id=Kubernetes-学习环境><a href=#Kubernetes-学习环境 class=headerlink title="Kubernetes 学习环境"></a>Kubernetes 学习环境</h1><ul><li>Minikube<li>k3s<li>Kind<li>Docker Desktop Kubernetes</ul><h1 id=Helm><a href=#Helm class=headerlink title=Helm></a>Helm</h1><p>语法参考:<p><strong><em><a href=https://chenyongjun.vip/articles/136 rel="external nofollow noopener noreferrer" target=_blank>Helm 之 Chart 模板</a></em></strong><p><strong><em><a href=https://www.cnblogs.com/klvchen/p/13606311.html rel="external nofollow noopener noreferrer" target=_blank>Helm templates 中的语法</a></em></strong><h1 id=实战><a href=#实战 class=headerlink title=实战></a>实战</h1><p>实战项目: <strong><em><a href=https://github.com/callicoder/spring-security-react-ant-design-polls-app rel="external nofollow noopener noreferrer" target=_blank>spring-security-react-ant-design-polls-app</a></em></strong><h1 id=其他><a href=#其他 class=headerlink title=其他></a>其他</h1><h2 id=别名><a href=#别名 class=headerlink title=别名></a>别名</h2><p><strong><em><a href=https://github.com/ahmetb/kubectl-aliases rel="external nofollow noopener noreferrer" target=_blank>https://github.com/ahmetb/kubectl-aliases</a></em></strong><h2 id=Context-以及-Namespaces-切换工具><a href=#Context-以及-Namespaces-切换工具 class=headerlink title="Context 以及 Namespaces 切换工具"></a>Context 以及 Namespaces 切换工具</h2><p><strong><em><a href=https://github.com/ahmetb/kubectx rel="external nofollow noopener noreferrer" target=_blank>https://github.com/ahmetb/kubectx</a></em></strong><h1 id=参考><a href=#参考 class=headerlink title=参考></a>参考</h1><p><strong><em><a href=https://www.qikqiak.com/k8s-book/ rel="external nofollow noopener noreferrer" target=_blank>https://www.qikqiak.com/k8s-book/</a></em></strong><p><strong><em><a href=https://www.cnblogs.com/breezey/p/9101666.html rel="external nofollow noopener noreferrer" target=_blank>https://www.cnblogs.com/breezey/p/9101666.html</a></em></strong></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2020/kubernetes-guide/ title="Kuberbetes 常用概念及操作">http://yangbingdong.com/2020/kubernetes-guide/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Docker/ rel=tag><i class="fa fa-tag"></i>Docker</a>
<a href=/tags/Kubernetes/ rel=tag><i class="fa fa-tag"></i>Kubernetes</a>
<a href=/tags/K8S/ rel=tag><i class="fa fa-tag"></i>K8S</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2020/spring-security-mvc-interceptor/ rel=next title="Spring Security 与 HandlerInterceptor 的认证鉴权"><i class="fa fa-chevron-left"></i>Spring Security 与 HandlerInterceptor 的认证鉴权</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2020/weixin-mp-dev/ rel=prev title=微信公众号开发>微信公众号开发 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2020/kubernetes-guide/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2020/kubernetes-guide/';this.page.identifier='2020/kubernetes-guide/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>50</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>19</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>48</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Kubernetes-常用资源><span class=nav-number>2.</span> <span class=nav-text>Kubernetes 常用资源</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#服务发现><span class=nav-number>3.</span> <span class=nav-text>服务发现</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#服务映射><span class=nav-number>4.</span> <span class=nav-text>服务映射</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#外部服务映射到内部><span class=nav-number>4.1.</span> <span class=nav-text>外部服务映射到内部</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#暴露服务><span class=nav-number>4.2.</span> <span class=nav-text>暴露服务</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#NodePort-方式><span class=nav-number>4.2.1.</span> <span class=nav-text>NodePort 方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Ingress><span class=nav-number>4.2.2.</span> <span class=nav-text>Ingress</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#调度选择><span class=nav-number>5.</span> <span class=nav-text>调度选择</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#nodeSelector><span class=nav-number>5.1.</span> <span class=nav-text>nodeSelector</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#亲和性和反亲和性调度><span class=nav-number>5.2.</span> <span class=nav-text>亲和性和反亲和性调度</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Node-Affinity><span class=nav-number>5.2.1.</span> <span class=nav-text>Node Affinity</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Pod-Affinity><span class=nav-number>5.2.2.</span> <span class=nav-text>Pod Affinity</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#污点和容忍-Taints和Tolerations><span class=nav-number>5.3.</span> <span class=nav-text>污点和容忍(Taints和Tolerations)</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#ConfigMap-amp-Secret><span class=nav-number>6.</span> <span class=nav-text>ConfigMap &amp; Secret</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#创建><span class=nav-number>6.1.</span> <span class=nav-text>创建</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#使用><span class=nav-number>6.2.</span> <span class=nav-text>使用</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#差异与注意点><span class=nav-number>6.3.</span> <span class=nav-text>差异与注意点</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#数据挂载><span class=nav-number>7.</span> <span class=nav-text>数据挂载</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#emptyDir><span class=nav-number>7.1.</span> <span class=nav-text>emptyDir</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#hostPath><span class=nav-number>7.2.</span> <span class=nav-text>hostPath</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#PV-amp-PVC><span class=nav-number>7.3.</span> <span class=nav-text>PV &amp; PVC</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#StorageClass><span class=nav-number>7.4.</span> <span class=nav-text>StorageClass</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Kubernetes-常用命令><span class=nav-number>8.</span> <span class=nav-text>Kubernetes 常用命令</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#YAML-声明示例><span class=nav-number>9.</span> <span class=nav-text>YAML 声明示例</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Pod><span class=nav-number>9.1.</span> <span class=nav-text>Pod</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Deloyment><span class=nav-number>9.2.</span> <span class=nav-text>Deloyment</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Service><span class=nav-number>9.3.</span> <span class=nav-text>Service</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#HPA><span class=nav-number>9.4.</span> <span class=nav-text>HPA</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Daemonset><span class=nav-number>9.5.</span> <span class=nav-text>Daemonset</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#阿里云-K8S><span class=nav-number>10.</span> <span class=nav-text>阿里云 K8S</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#创建集群><span class=nav-number>10.1.</span> <span class=nav-text>创建集群</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#准备工作><span class=nav-number>10.1.1.</span> <span class=nav-text>准备工作</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#安装-kubectl><span class=nav-number>10.1.1.1.</span> <span class=nav-text>安装 kubectl</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#命令补全><span class=nav-number>10.1.1.1.1.</span> <span class=nav-text>命令补全</span></a></ol></ol><li class="nav-item nav-level-3"><a class=nav-link href=#创建集群-1><span class=nav-number>10.1.2.</span> <span class=nav-text>创建集群</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#镜像服务配置><span class=nav-number>10.2.</span> <span class=nav-text>镜像服务配置</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#停止设置><span class=nav-number>10.3.</span> <span class=nav-text>停止设置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#停止实例><span class=nav-number>10.3.1.</span> <span class=nav-text>停止实例</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#停止负载均衡><span class=nav-number>10.3.2.</span> <span class=nav-text>停止负载均衡</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#完全释放资源><span class=nav-number>10.3.3.</span> <span class=nav-text>完全释放资源</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#NAS><span class=nav-number>10.4.</span> <span class=nav-text>NAS</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Kubernetes-学习环境><span class=nav-number>11.</span> <span class=nav-text>Kubernetes 学习环境</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Helm><span class=nav-number>12.</span> <span class=nav-text>Helm</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#实战><span class=nav-number>13.</span> <span class=nav-text>实战</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#其他><span class=nav-number>14.</span> <span class=nav-text>其他</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#别名><span class=nav-number>14.1.</span> <span class=nav-text>别名</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Context-以及-Namespaces-切换工具><span class=nav-number>14.2.</span> <span class=nav-text>Context 以及 Namespaces 切换工具</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#参考><span class=nav-number>15.</span> <span class=nav-text>参考</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共290.0k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2020/kubernetes-guide/';var disqus_title="Kuberbetes 常用概念及操作";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>