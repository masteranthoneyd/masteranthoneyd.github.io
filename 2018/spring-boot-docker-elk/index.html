<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Spring Boot,Spring,Docker,Elasticsearch,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface 微服务架构下, 微服务在带来良好的设计和架构理念的同时, 也带来了运维上的额外复杂性, 尤其是在服务部署和服务监控上. 单体应用是集中式的, 就一个单体跑在一起, 部署和管理的时候非常简单, 而微服务是一个网状分布的, 有很多服务需要维护和管理, 对它进行部署和维护的时候则比较复杂. 集成Docker之后, 我们可以很方便地部署以及编排服务, ELK的集中式日志管理可以让我们很方"><meta name=keywords content="Java,Spring Boot,Spring,Docker,Elasticsearch"><meta property=og:type content=article><meta property=og:title content="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><meta property=og:url content=http://yangbingdong.com/2018/spring-boot-docker-elk/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface 微服务架构下, 微服务在带来良好的设计和架构理念的同时, 也带来了运维上的额外复杂性, 尤其是在服务部署和服务监控上. 单体应用是集中式的, 就一个单体跑在一起, 部署和管理的时候非常简单, 而微服务是一个网状分布的, 有很多服务需要维护和管理, 对它进行部署和维护的时候则比较复杂. 集成Docker之后, 我们可以很方便地部署以及编排服务, ELK的集中式日志管理可以让我们很方"><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/java-docker.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-learning/log4j2-performance.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/portainer.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/harbor.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/duplicate01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/duplicate02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/elk-arch1.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/luyten.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/jar-archive.png><meta property=og:image content=https://cdn.yangbingdong.com/kibana-license.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-full-plugin-button.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-admin-setting.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-page-size.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-timezone.png><meta property=og:image content=https://cdn.yangbingdong.com/img/docker-logs-collect/apm.png><meta property=og:updated_time content=2020-07-20T05:42:01.746Z><meta name=twitter:card content=summary><meta name=twitter:title content="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><meta name=twitter:description content="Preface 微服务架构下, 微服务在带来良好的设计和架构理念的同时, 也带来了运维上的额外复杂性, 尤其是在服务部署和服务监控上. 单体应用是集中式的, 就一个单体跑在一起, 部署和管理的时候非常简单, 而微服务是一个网状分布的, 有很多服务需要维护和管理, 对它进行部署和维护的时候则比较复杂. 集成Docker之后, 我们可以很方便地部署以及编排服务, ELK的集中式日志管理可以让我们很方"><meta name=twitter:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/java-docker.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2018/spring-boot-docker-elk/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2018/spring-boot-docker-elk/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2018-04-02T13:00:19+08:00>2018-04-02</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/Spring-Boot/ itemprop=url rel=index><span itemprop=name>Spring Boot</span></a></span></span>
<span id=/2018/spring-boot-docker-elk/ class=leancloud_visitors data-flag-title="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>10,054字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>51分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/java-docker.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>微服务架构下, 微服务在带来良好的设计和架构理念的同时, 也带来了运维上的额外复杂性, 尤其是在服务部署和服务监控上. 单体应用是集中式的, 就一个单体跑在一起, 部署和管理的时候非常简单, 而微服务是一个网状分布的, 有很多服务需要维护和管理, 对它进行部署和维护的时候则比较复杂. 集成Docker之后, 我们可以很方便地部署以及编排服务, ELK的集中式日志管理可以让我们很方便地聚合Docker日志.</blockquote><a id=more></a><h1 id=Log4j2-Related><a href=#Log4j2-Related class=headerlink title="Log4j2 Related"></a>Log4j2 Related</h1><h2 id=使用Log4j2><a href=#使用Log4j2 class=headerlink title=使用Log4j2></a>使用Log4j2</h2><p>下面是 Log4j2 官方性能测试结果:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-learning/log4j2-performance.png alt><h3 id=Maven配置><a href=#Maven配置 class=headerlink title=Maven配置></a>Maven配置</h3><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre><td class=code><pre><span class=line><span class=comment>&lt;!-- Spring Boot 依赖--&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- 去除 logback 依赖 --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>exclusions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-logging<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>exclusions</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-web<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=comment>&lt;!-- 日志 Log4j2 --&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=comment>&lt;!-- Log4j2 异步支持 --&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.lmax<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>disruptor<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>3.3.8<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p><strong>注意</strong>:<ul><li>需要单独把<code>spring-boot-starter</code>里面的<code>logging</code>去除再引入<code>spring-boot-starter-web</code>, 否则后面引入的<code>starter</code>模块带有的<code>logging</code>不会自动去除<li><code>Disruptor</code>需要<strong>3.3.8</strong>以及以上版本</ul><h3 id=开启全局异步以及Disruptor参数设置><a href=#开启全局异步以及Disruptor参数设置 class=headerlink title=开启全局异步以及Disruptor参数设置></a>开启全局异步以及Disruptor参数设置</h3><blockquote><p>官方说明: <strong><em><a href=https://logging.apache.org/log4j/2.x/manual/async.html#AllAsync rel="external nofollow noopener noreferrer" target=_blank>https://logging.apache.org/log4j/2.x/manual/async.html#AllAsync</a></em></strong></blockquote><p>添加<code>Disruptor</code>依赖后只需要添加启动参数:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>-Dlog4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</span><br></pre></table></figure><p>也可以在程序启动时添加系统参数.<blockquote><p>若想知道Disruptor是否生效, 可以在<code>AsyncLogger#logMessage</code>中断点</blockquote><p>加大队列参数:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>-DAsyncLogger.RingBufferSize=262144</span><br><span class=line>-DAsyncLoggerConfig.RingBufferSize=262144</span><br></pre></table></figure><p>设置队列满了时的处理策略: 丢弃, 否则默认blocking, 异步就与同步无异了:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>-Dlog4j2.AsyncQueueFullPolicy=Discard</span><br></pre></table></figure><h3 id=系统时钟参数><a href=#系统时钟参数 class=headerlink title=系统时钟参数></a>系统时钟参数</h3><p>通过 <code>log4j2.clock</code> 指定, 默认使用 <code>SystemClock</code>, 我们可以使用 <code>org.apache.logging.log4j.core.util.CachedClock</code>. 其他选项看接口实现类, 也可以自己实现 <code>Clock</code> 接口.<h3 id=Log4j-环境变量配置文件><a href=#Log4j-环境变量配置文件 class=headerlink title="Log4j 环境变量配置文件"></a>Log4j 环境变量配置文件</h3><p>上面的全局异步以及系统始终参数配置都是通过系统环境变量来设置的, 下面方式可以通过配置文件的方式来设置.<p>在 <code>resource</code> 下定义 <code>log4j2.component.properties</code> 配置文件:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>Log4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</span><br><span class=line>log4j2.clock=com.xxx.CustomLog4jClock</span><br></pre></table></figure><h3 id=application-yml简单配置><a href=#application-yml简单配置 class=headerlink title=application.yml简单配置></a>application.yml简单配置</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>logging:</span><br><span class=line>  config: classpath:log4j2.xml # 指定log4j2配置文件的路径, 默认就是这个</span><br><span class=line>  pattern:</span><br><span class=line>    console: &quot;%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx&quot; # 控制台日志输出格式</span><br></pre></table></figure><h3 id=log4j2-xml-详细配置><a href=#log4j2-xml-详细配置 class=headerlink title="log4j2.xml 详细配置"></a>log4j2.xml 详细配置</h3><p>先来看一下常用的输出格式:<ul><li><code>%d{yyyy-MM-dd HH:mm:ss.SSS}</code>: 输出时间，精确度为毫秒.<li><code>%-5level</code> | <code>%-5p</code>: 输出日志级别, -5表示左对齐并且固定占5个字符宽度, 如果不足用空格补齐.<li><code>%t</code> | <code>%thread</code>: 线程名称<li><code>%c{precision}</code> | <code>logger{precision}</code>: 输出的Logger名字, <code>{precision}</code> 表示保留的名字长度, 比如 <code>%c{1}</code> 是这样的 <code>Foo</code>, <code>%c{3}</code> 是这样的 <code>apache.commons.Foo</code><li><code>%C{precision}</code> | <code>%class{precision}</code>: 实际上输出log的类名, 如果一个类有子类(<code>Son extend Father</code>), 在 <code>Father</code> 中调用 <code>log.info</code>, 那么<code>%C{1}</code> 输出的是 <code>Father</code>.<li><code>M</code> | <code>method</code>: 输出log所在的方法名.<li><code>L</code> | <code>line</code>: 输出log所在的行数.<li><code>%msg{nolookups}</code>: 输出的log日志, <code>{nolookups}</code> 表示忽略掉一些内置函数比如 <code>logger.info(&quot;Try ${date:YYYY-MM-dd}&quot;)</code>, 如果不加 <code>{nolookups}</code> 那么输出的日志会是这样的 <code>Try 2019-05-28</code>.<li><code>%n</code>: 换行, 一般跟在 <code>%msg</code> 后面.<li><code>%xEx</code> | <code>%xwEx</code>: 输出异常, 后者会在异常信息的开始与结束append空的一行, 与 <code>%ex</code> 的区别在于在每一行异常信息后面会追加jar包的信息.<li><code>%clr</code>: 配置颜色, 比如 <code>%clr{字段}{颜色}</code><ul><li><code>blue</code>: 蓝色<li><code>cyan</code>: 青色<li><code>faint</code>: 不知道什么颜色, 输出来是黑色<li><code>green</code>: 绿色<li><code>magenta</code>: 粉色<li><code>red</code>: 红色<li><code>yellow</code>: 黄色</ul></ul><p>所以我们的pattern是这样的: <code>%d{yyyy-MM-dd HH:mm:ss.SSS} | %-5level | ${server_name} | %X{IP} | %logger{1} | %thread -&gt; %class{1}#%method:%line | %msg{nolookups}%n%xwEx</code>.<p>使用 <code>|</code> 作为分隔符是因为后面输出到Logstash时用于字段分割.<h4 id=输出到-Kafka><a href=#输出到-Kafka class=headerlink title="输出到 Kafka"></a>输出到 Kafka</h4><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br></pre><td class=code><pre><span class=line><span class=meta>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>configuration</span> <span class=attr>status</span>=<span class=string>"OFF"</span> <span class=attr>monitorInterval</span>=<span class=string>"30"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>properties</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"UNKNOWN"</span> <span class=attr>value</span>=<span class=string>"????"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"KAFKA_SERVERS"</span> <span class=attr>value</span>=<span class=string>"$&#123;spring:ybd.kafka.bootstrap&#125;"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"server_name"</span> <span class=attr>value</span>=<span class=string>"$&#123;spring:spring.application.name&#125;"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"LOG_PATTERN"</span> <span class=attr>value</span>=<span class=string>"%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; | %-5level | $&#123;server_name&#125; | %X&#123;IP&#125; | %logger&#123;1&#125; | %thread -&gt; %class&#123;1&#125;#%method:%line | %msg&#123;nolookups&#125;%n%xwEx"</span>/&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>properties</span>&gt;</span></span><br><span class=line></span><br><span class=line>    <span class=tag>&lt;<span class=name>Appenders</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Console</span> <span class=attr>name</span>=<span class=string>"console"</span> <span class=attr>target</span>=<span class=string>"SYSTEM_OUT"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"info"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;LOG_PATTERN&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>Console</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>Kafka</span> <span class=attr>name</span>=<span class=string>"kafka"</span> <span class=attr>topic</span>=<span class=string>"log-collect"</span> <span class=attr>ignoreExceptions</span>=<span class=string>"false"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"INFO"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;LOG_PATTERN&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"bootstrap.servers"</span>&gt;</span>$&#123;KAFKA_SERVERS&#125;<span class=tag>&lt;/<span class=name>Property</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"request.timeout.ms"</span>&gt;</span>5000<span class=tag>&lt;/<span class=name>Property</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"transaction.timeout.ms"</span>&gt;</span>5000<span class=tag>&lt;/<span class=name>Property</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Property</span> <span class=attr>name</span>=<span class=string>"max.block.ms"</span>&gt;</span>3000<span class=tag>&lt;/<span class=name>Property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>Kafka</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>RollingFile</span> <span class=attr>name</span>=<span class=string>"failoverKafkaLog"</span> <span class=attr>fileName</span>=<span class=string>"./failoverKafka/$&#123;SERVER_NAME&#125;.log"</span></span></span><br><span class=line><span class=tag>                     <span class=attr>filePattern</span>=<span class=string>"./failoverKafka/$&#123;SERVER_NAME&#125;.%d&#123;yyyy-MM-dd&#125;.log"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"INFO"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>Pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class=tag>&lt;/<span class=name>Pattern</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>PatternLayout</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Policies</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>TimeBasedTriggeringPolicy</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>Policies</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>RollingFile</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>Failover</span> <span class=attr>name</span>=<span class=string>"failover"</span> <span class=attr>primary</span>=<span class=string>"kafka"</span> <span class=attr>retryIntervalSeconds</span>=<span class=string>"300"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Failovers</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"failoverKafkaLog"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>Failovers</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>Failover</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>Appenders</span>&gt;</span></span><br><span class=line></span><br><span class=line>    <span class=tag>&lt;<span class=name>Loggers</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Root</span> <span class=attr>level</span>=<span class=string>"INFO"</span> <span class=attr>includeLocation</span>=<span class=string>"true"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"failover"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"console"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>Root</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>Loggers</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br></pre></table></figure><ul><li><code>bootstrap.servers</code>是kafka的地址, 接入Docker network之后可以配置成<code>kafka:9092</code><li><code>topic</code>要与Logstash中配置的一致<li>启用了全局异步需要将<code>includeLocation</code>设为<code>true</code>才能打印路径之类的信息<li>Kafka地址通过<code>${spring:ybd.kafka.bootstrap}</code>读取配置文件获取, 这个需要自己拓展Log4j, 具体请看下面的获取Application配置<li><code>LOG_PATTERN</code>中的<code>%X{IP}</code>、<code>%X{UA}</code>, 通过<code>MDC.put(key, value)</code>放进去, 同时在<code>&lt;Root&gt;</code>中设置<code>includeLocation=&quot;true&quot;</code>才能获取<code>%t</code>、<code>%c</code>等信息<li><code>KafkaAppender</code>结合<code>FailoverAppender</code>确保当Kafka Crash时, 日志触发Failover, 写到文件中, 不阻塞程序, 进而保证了吞吐. <code>retryIntervalSeconds</code>的默认值是1分钟, 是通过异常来切换的, 所以可以适量加大间隔.<li><code>KafkaAppender</code> <code>ignoreExceptions</code> 必须设置为<code>false</code>, 否则无法触发Failover<li><code>KafkaAppender</code> <code>max.block.ms</code>默认是1分钟, 当Kafka宕机时, 尝试写Kafka需要1分钟才能返回Exception, 之后才会触发Failover, 当请求量大时, log4j2 队列很快就会打满, 之后写日志就Blocking, 严重影响到主服务响应<li>日志的格式采用<code>&quot; | &quot;</code>作为分割符方便后面Logstash进行切分字段</ul><h4 id=输出到文件><a href=#输出到文件 class=headerlink title=输出到文件></a>输出到文件</h4><blockquote><p>这种方式可以用于存档, 同是使用 Filebeat 抓取文件日志输出到 Logstash.</blockquote><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br></pre><td class=code><pre><span class=line><span class=meta>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class=line><span class=comment>&lt;!--日志级别以及优先级排序: OFF &gt; FATAL &gt; ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE &gt; ALL --&gt;</span></span><br><span class=line><span class=comment>&lt;!--Configuration后面的status,这个用于设置log4j2自身内部的信息输出,可以不设置,当设置成trace时,你会看到log4j2内部各种详细输出 --&gt;</span></span><br><span class=line><span class=comment>&lt;!--monitorInterval：Log4j能够自动检测修改配置 文件和重新配置本身,设置间隔秒数 --&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>configuration</span> <span class=attr>status</span>=<span class=string>"WARN"</span> <span class=attr>monitorInterval</span>=<span class=string>"1800"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>properties</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"UNKNOWN"</span> <span class=attr>value</span>=<span class=string>"????"</span>/&gt;</span></span><br><span class=line>        </span><br><span class=line>        <span class=comment>&lt;!-- 应用的名字, 需要自己写spring的拓展 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"server_name"</span> <span class=attr>value</span>=<span class=string>"$&#123;spring:spring.application.name&#125;"</span>/&gt;</span></span><br><span class=line>        </span><br><span class=line>        <span class=comment>&lt;!-- 控制台输出的格式 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"log_pattern"</span> <span class=attr>value</span>=<span class=string>"%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; | %-5level | $&#123;server_name&#125; | %X&#123;IP&#125; | %logger&#123;1&#125; | %thread -&gt; %class&#123;1&#125;#%method:%line | %msg&#123;nolookups&#125;%n%xwEx"</span>/&gt;</span></span><br><span class=line>		</span><br><span class=line>        <span class=comment>&lt;!-- 日志默认存放的位置,这里设置为项目根路径下,也可指定绝对路径 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"basePath"</span>&gt;</span>./log4j2Logs/$&#123;server_name&#125;<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 日志默认切割的最小单位 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"every_file_size"</span>&gt;</span>20MB<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 日志默认输出级别 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"output_log_level"</span>&gt;</span>INFO<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=comment>&lt;!-- 日志默认存放路径(所有级别日志) --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"rolling_fileName"</span>&gt;</span>$&#123;basePath&#125;/all.log<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 日志默认压缩路径,将超过指定文件大小的日志,自动存入按"年月"建立的文件夹下面并进行压缩,作为存档 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"rolling_filePattern"</span>&gt;</span>$&#123;basePath&#125;/%d&#123;yyyy-MM&#125;/all-%d&#123;yyyy-MM-dd&#125;-%i.log.gz<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 日志默认同类型日志,同一文件夹下可以存放的数量,不设置此属性则默认为7个 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"rolling_max"</span>&gt;</span>20<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"info_fileName"</span>&gt;</span>$&#123;basePath&#125;/info.log<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"info_filePattern"</span>&gt;</span>$&#123;basePath&#125;/%d&#123;yyyy-MM&#125;/info-%d&#123;yyyy-MM-dd&#125;-%i.log.gz<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"info_max"</span>&gt;</span>10<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"warn_fileName"</span>&gt;</span>$&#123;basePath&#125;/warn.log<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"warn_filePattern"</span>&gt;</span>$&#123;basePath&#125;/%d&#123;yyyy-MM&#125;/warn-%d&#123;yyyy-MM-dd&#125;-%i.log.gz<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"warn_max"</span>&gt;</span>10<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"error_fileName"</span>&gt;</span>$&#123;basePath&#125;/error.log<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"error_filePattern"</span>&gt;</span>$&#123;basePath&#125;/%d&#123;yyyy-MM&#125;/error-%d&#123;yyyy-MM-dd&#125;-%i.log.gz<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"error_max"</span>&gt;</span>10<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=comment>&lt;!-- 控制台显示的日志最低级别 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"console_print_level"</span>&gt;</span>INFO<span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>properties</span>&gt;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>&lt;!--定义appender --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>Appenders</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 用来定义输出到控制台的配置 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Console</span> <span class=attr>name</span>=<span class=string>"Console"</span> <span class=attr>target</span>=<span class=string>"SYSTEM_OUT"</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 设置控制台只输出level及以上级别的信息(onMatch),其他的直接拒绝(onMismatch) --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"$&#123;console_print_level&#125;"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;log_pattern&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>Console</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=comment>&lt;!-- 打印root中指定的level级别以上的日志到文件 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>RollingFile</span> <span class=attr>name</span>=<span class=string>"RollingFile"</span> <span class=attr>fileName</span>=<span class=string>"$&#123;rolling_fileName&#125;"</span> <span class=attr>filePattern</span>=<span class=string>"$&#123;rolling_filePattern&#125;"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;log_pattern&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 设置同类型日志,同一文件夹下可以存放的数量,如果不设置此属性则默认存放7个文件 --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>SizeBasedTriggeringPolicy</span> <span class=attr>size</span>=<span class=string>"$&#123;every_file_size&#125;"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>DefaultRolloverStrategy</span> <span class=attr>max</span>=<span class=string>"$&#123;rolling_max&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 匹配INFO以及以上级别 --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Filters</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"INFO"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>Filters</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>RollingFile</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>RollingFile</span> <span class=attr>name</span>=<span class=string>"InfoFile"</span> <span class=attr>fileName</span>=<span class=string>"$&#123;info_fileName&#125;"</span> <span class=attr>filePattern</span>=<span class=string>"$&#123;info_filePattern&#125;"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;log_pattern&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>SizeBasedTriggeringPolicy</span> <span class=attr>size</span>=<span class=string>"$&#123;every_file_size&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>DefaultRolloverStrategy</span> <span class=attr>max</span>=<span class=string>"$&#123;info_max&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Filters</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"WARN"</span> <span class=attr>onMatch</span>=<span class=string>"DENY"</span> <span class=attr>onMismatch</span>=<span class=string>"NEUTRAL"</span>/&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"INFO"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>Filters</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>RollingFile</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>RollingFile</span> <span class=attr>name</span>=<span class=string>"WarnFile"</span> <span class=attr>fileName</span>=<span class=string>"$&#123;warn_fileName&#125;"</span> <span class=attr>filePattern</span>=<span class=string>"$&#123;warn_filePattern&#125;"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;log_pattern&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>SizeBasedTriggeringPolicy</span> <span class=attr>size</span>=<span class=string>"$&#123;every_file_size&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>DefaultRolloverStrategy</span> <span class=attr>max</span>=<span class=string>"$&#123;warn_max&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Filters</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"ERROR"</span> <span class=attr>onMatch</span>=<span class=string>"DENY"</span> <span class=attr>onMismatch</span>=<span class=string>"NEUTRAL"</span>/&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"WARN"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>Filters</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>RollingFile</span>&gt;</span></span><br><span class=line></span><br><span class=line>        <span class=tag>&lt;<span class=name>RollingFile</span> <span class=attr>name</span>=<span class=string>"ErrorFile"</span> <span class=attr>fileName</span>=<span class=string>"$&#123;error_fileName&#125;"</span> <span class=attr>filePattern</span>=<span class=string>"$&#123;error_filePattern&#125;"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>PatternLayout</span> <span class=attr>pattern</span>=<span class=string>"$&#123;log_pattern&#125;"</span> <span class=attr>charset</span>=<span class=string>"UTF-8"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>SizeBasedTriggeringPolicy</span> <span class=attr>size</span>=<span class=string>"$&#123;every_file_size&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>DefaultRolloverStrategy</span> <span class=attr>max</span>=<span class=string>"$&#123;error_max&#125;"</span> /&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>Filters</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"FATAL"</span> <span class=attr>onMatch</span>=<span class=string>"DENY"</span> <span class=attr>onMismatch</span>=<span class=string>"NEUTRAL"</span>/&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>ThresholdFilter</span> <span class=attr>level</span>=<span class=string>"ERROR"</span> <span class=attr>onMatch</span>=<span class=string>"ACCEPT"</span> <span class=attr>onMismatch</span>=<span class=string>"DENY"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>Filters</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>RollingFile</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>Appenders</span>&gt;</span></span><br><span class=line></span><br><span class=line>    <span class=comment>&lt;!--然后定义logger,只有定义了logger并引入的appender,appender才会生效 --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>Loggers</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!--建立一个默认的root的logger --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>Root</span> <span class=attr>level</span>=<span class=string>"&#123;output_log_level&#125;"</span> <span class=attr>includeLocation</span>=<span class=string>"true"</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"Console"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"RollingFile"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"InfoFile"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"WarnFile"</span>/&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>AppenderRef</span> <span class=attr>ref</span>=<span class=string>"ErrorFile"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>Root</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>Loggers</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br></pre></table></figure><h3 id=也可以使用log4j2-yml><a href=#也可以使用log4j2-yml class=headerlink title=也可以使用log4j2.yml></a>也可以使用log4j2.yml</h3><p>需要引入依赖以识别:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=comment>&lt;!-- 加上这个才能辨认到log4j2.yml文件 --&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>jackson-dataformat-yaml<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p><code>log4j2.yml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=attr>Configuration:</span></span><br><span class=line>  <span class=attr>status:</span> <span class=string>"OFF"</span></span><br><span class=line>  <span class=attr>monitorInterval:</span> <span class=number>10</span></span><br><span class=line></span><br><span class=line>  <span class=attr>Properties:</span></span><br><span class=line>    <span class=attr>Property:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>log.level.console</span></span><br><span class=line>        <span class=attr>value:</span> <span class=string>debug</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>PID</span></span><br><span class=line>        <span class=attr>value:</span> <span class=string>????</span></span><br><span class=line>      <span class=bullet>-</span> <span class=attr>name:</span> <span class=string>LOG_PATTERN</span></span><br><span class=line>        <span class=attr>value:</span> <span class=string>"%clr&#123;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;&#123;faint&#125; | %clr&#123;%5p&#125; | %clr&#123;$&#123;sys:PID&#125;&#125;&#123;magenta&#125; | %clr&#123;%15.15t&#125;&#123;faint&#125; | %clr&#123;%-50.50c&#123;1.&#125;&#125;&#123;cyan&#125; | %5L | %clr&#123;%M&#125;&#123;magenta&#125; | %msg%n%xwEx"</span></span><br><span class=line></span><br><span class=line>  <span class=attr>Appenders:</span></span><br><span class=line>    <span class=attr>Console:</span>  <span class=comment>#输出到控制台</span></span><br><span class=line>      <span class=attr>name:</span> <span class=string>CONSOLE</span></span><br><span class=line>      <span class=attr>target:</span> <span class=string>SYSTEM_OUT</span></span><br><span class=line>      <span class=attr>ThresholdFilter:</span></span><br><span class=line>        <span class=attr>level:</span> <span class=string>$&#123;sys:log.level.console&#125;</span> <span class=comment># “sys:”表示: 如果VM参数中没指定这个变量值, 则使用本文件中定义的缺省全局变量值</span></span><br><span class=line>        <span class=attr>onMatch:</span> <span class=string>ACCEPT</span></span><br><span class=line>        <span class=attr>onMismatch:</span> <span class=string>DENY</span></span><br><span class=line>      <span class=attr>PatternLayout:</span></span><br><span class=line>        <span class=attr>pattern:</span> <span class=string>$&#123;LOG_PATTERN&#125;</span></span><br><span class=line>        <span class=attr>charset:</span> <span class=string>UTF-8</span></span><br><span class=line>  <span class=attr>Loggers:</span></span><br><span class=line>    <span class=attr>Root:</span></span><br><span class=line>      <span class=attr>level:</span> <span class=string>info</span></span><br><span class=line>      <span class=attr>includeLocation:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>AppenderRef:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>ref:</span> <span class=string>CONSOLE</span></span><br><span class=line>    <span class=attr>AsyncRoot:</span></span><br><span class=line>      <span class=attr>level:</span> <span class=string>info</span></span><br><span class=line>      <span class=attr>includeLocation:</span> <span class=literal>true</span></span><br><span class=line>      <span class=attr>AppenderRef:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=attr>ref:</span> <span class=string>CONSOLE</span></span><br></pre></table></figure><p>更多配置请参照: <em><a href=http://logging.apache.org/log4j/2.x/manual/layouts.html rel="external nofollow noopener noreferrer" target=_blank>http://logging.apache.org/log4j/2.x/manual/layouts.html</a></em><h2 id=日志配置文件中获取Application配置><a href=#日志配置文件中获取Application配置 class=headerlink title=日志配置文件中获取Application配置></a>日志配置文件中获取Application配置</h2><h3 id=Logback><a href=#Logback class=headerlink title=Logback></a>Logback</h3><p>方法1: 使用<code>logback-spring.xml</code>, 因为<code>logback.xml</code>加载早于<code>application.properties</code>, 所以如果你在<code>logback.xml</code>使用了变量时, 而恰好这个变量是写在<code>application.properties</code>时, 那么就会获取不到, 只要改成<code>logback-spring.xml</code>就可以解决.<p>方法2: 使用<code>&lt;springProperty&gt;</code>标签, 例如:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>&lt;springProperty scope=&quot;context&quot; name=&quot;LOG_HOME&quot; source=&quot;logback.file&quot;/&gt;</span><br></pre></table></figure><h3 id=Log4j2><a href=#Log4j2 class=headerlink title=Log4j2></a>Log4j2</h3><p>只能写一个Lookup:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-5-11</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@Plugin</span>(name = LOOK_UP_PREFIX, category = StrLookup.CATEGORY)</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SpringEnvironmentLookup</span> <span class=keyword>extends</span> <span class=title>AbstractLookup</span> </span>&#123;</span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> String LOOK_UP_PREFIX = <span class=string>"spring"</span>;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> LinkedHashMap profileYmlData;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> LinkedHashMap metaYmlData;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>boolean</span> profileExist;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> Map&lt;String, String&gt; map = <span class=keyword>new</span> HashMap&lt;&gt;(<span class=number>16</span>);</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String PROFILE_PREFIX = <span class=string>"application"</span>;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String PROFILE_SUFFIX = <span class=string>".yml"</span>;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String META_PROFILE = PROFILE_PREFIX + PROFILE_SUFFIX;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> String SPRING_PROFILES_ACTIVE = <span class=string>"spring.profiles.active"</span>;</span><br><span class=line></span><br><span class=line>	<span class=keyword>static</span> &#123;</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>			metaYmlData = <span class=keyword>new</span> Yaml().loadAs(<span class=keyword>new</span> ClassPathResource(META_PROFILE).getInputStream(), LinkedHashMap<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line>			Properties properties = System.getProperties();</span><br><span class=line>			String active = properties.getProperty(SPRING_PROFILES_ACTIVE);</span><br><span class=line>			<span class=keyword>if</span> (isBlank(active)) &#123;</span><br><span class=line>				active = getValueFromData(SPRING_PROFILES_ACTIVE, metaYmlData);</span><br><span class=line>			&#125;</span><br><span class=line>			<span class=keyword>if</span> (isNotBlank(active)) &#123;</span><br><span class=line>				String configName = PROFILE_PREFIX + <span class=string>"-"</span> + active + PROFILE_SUFFIX;</span><br><span class=line>				ClassPathResource classPathResource = <span class=keyword>new</span> ClassPathResource(configName);</span><br><span class=line>				profileExist = classPathResource.exists();</span><br><span class=line>				<span class=keyword>if</span> (profileExist) &#123;</span><br><span class=line>					profileYmlData = <span class=keyword>new</span> Yaml().loadAs(classPathResource.getInputStream(), LinkedHashMap<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line>				&#125;</span><br><span class=line>			&#125;</span><br><span class=line>		&#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>			e.printStackTrace();</span><br><span class=line>			<span class=keyword>throw</span> <span class=keyword>new</span> RuntimeException(<span class=string>"SpringEnvironmentLookup initialize fail"</span>);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> String <span class=title>lookup</span><span class=params>(LogEvent event, String key)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> map.computeIfAbsent(key, SpringEnvironmentLookup::resolveYmlMapByKey);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> <span class=keyword>static</span> String <span class=title>resolveYmlMapByKey</span><span class=params>(String key)</span> </span>&#123;</span><br><span class=line>		Assert.isTrue(isNotBlank(key), <span class=string>"key can not be blank!"</span>);</span><br><span class=line>		String[] keyChain = key.split(<span class=string>"\\."</span>);</span><br><span class=line>		String value = <span class=keyword>null</span>;</span><br><span class=line>		<span class=keyword>if</span> (profileExist) &#123;</span><br><span class=line>			value = getValueFromData(key, profileYmlData);</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>if</span> (isBlank(value)) &#123;</span><br><span class=line>			value = getValueFromData(key, metaYmlData);</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>return</span> value;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> <span class=keyword>static</span> String <span class=title>getValueFromData</span><span class=params>(String key, LinkedHashMap dataMap)</span> </span>&#123;</span><br><span class=line>		String[] keyChain = key.split(<span class=string>"\\."</span>);</span><br><span class=line>		<span class=keyword>int</span> length = keyChain.length;</span><br><span class=line>		<span class=keyword>if</span> (length == <span class=number>1</span>) &#123;</span><br><span class=line>			<span class=keyword>return</span> getFinalValue(key, dataMap);</span><br><span class=line>		&#125;</span><br><span class=line>		String k;</span><br><span class=line>		LinkedHashMap[] mapChain = <span class=keyword>new</span> LinkedHashMap[length];</span><br><span class=line>		mapChain[<span class=number>0</span>] = dataMap;</span><br><span class=line>		<span class=keyword>for</span> (<span class=keyword>int</span> i = <span class=number>0</span>; i &lt; length; i++) &#123;</span><br><span class=line>			<span class=keyword>if</span> (i == length - <span class=number>1</span>) &#123;</span><br><span class=line>				<span class=keyword>return</span> getFinalValue(keyChain[i], mapChain[i]);</span><br><span class=line>			&#125;</span><br><span class=line>			k = keyChain[i];</span><br><span class=line>			Object o = mapChain[i].get(k);</span><br><span class=line>			<span class=keyword>if</span> (Objects.isNull(o)) &#123;</span><br><span class=line>				<span class=keyword>return</span> <span class=string>""</span>;</span><br><span class=line>			&#125;</span><br><span class=line>			<span class=keyword>if</span> (o <span class=keyword>instanceof</span> LinkedHashMap) &#123;</span><br><span class=line>				mapChain[i + <span class=number>1</span>] = (LinkedHashMap) o;</span><br><span class=line>			&#125; <span class=keyword>else</span> &#123;</span><br><span class=line>				<span class=keyword>throw</span> <span class=keyword>new</span> IllegalArgumentException();</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>return</span> <span class=string>""</span>;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> <span class=keyword>static</span> String <span class=title>getFinalValue</span><span class=params>(String k, LinkedHashMap ymlData)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> defaultIfNull((String) ymlData.get(k), <span class=string>""</span>);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>然后在<code>log4j2.xml</code>中这样使用 <code>${spring:spring.application.name}</code><h2 id=自定义字段><a href=#自定义字段 class=headerlink title=自定义字段></a>自定义字段</h2><p>可以利用<code>MDC</code>实现当前线程自定义字段<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>MDC.put(&quot;IP&quot;, IpUtil.getIpAddr(request));</span><br></pre></table></figure><p><code>log4j2.xml</code>中这样获取<code>%X{IP}</code><h1 id=Spring-Boot-Docker-Integration><a href=#Spring-Boot-Docker-Integration class=headerlink title="Spring Boot Docker Integration"></a>Spring Boot Docker Integration</h1><h2 id=准备工作><a href=#准备工作 class=headerlink title=准备工作></a>准备工作</h2><ul><li>Docker<li>IDE（使用IDEA）<li>Maven环境<li>Docker私有仓库, 可以使用Harbor(<strong><em><a href=/2018/docker-visual-management-and-orchestrate-tools/#Harbor>Ubuntu中安装Harbor</a></em></strong>)</ul><p>集成Docker需要的插件<code>docker-maven-plugin</code>: <em><a href=https://github.com/spotify/docker-maven-plugin rel="external nofollow noopener noreferrer" target=_blank>https://github.com/spotify/docker-maven-plugin</a></em><h2 id=安全认证配置><a href=#安全认证配置 class=headerlink title=安全认证配置></a>安全认证配置</h2><blockquote><p>当我们 push 镜像到 Docker 仓库中时, 不管是共有还是私有, 经常会需要安全认证, 登录完成之后才可以进行操作. 当然, 我们可以通过命令行 <code>docker login -u user_name -p password docker_registry_host</code> 登录, 但是对于自动化流程来说, 就不是很方便了. 使用 docker-maven-plugin 插件我们可以很容易实现安全认证.</blockquote><h3 id=普通配置><a href=#普通配置 class=headerlink title=普通配置></a>普通配置</h3><p><code>settings.xml</code>:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>server</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>id</span>&gt;</span>docker-registry<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>username</span>&gt;</span>admin<span class=tag>&lt;/<span class=name>username</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>password</span>&gt;</span>12345678<span class=tag>&lt;/<span class=name>password</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>email</span>&gt;</span>yangbingdong1994@gmail.com<span class=tag>&lt;/<span class=name>email</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>server</span>&gt;</span></span><br></pre></table></figure><h3 id=Maven-密码加密配置><a href=#Maven-密码加密配置 class=headerlink title="Maven 密码加密配置"></a>Maven 密码加密配置</h3><p><code>settings.xml</code>配置私有库的访问:<p>首先使用你的私有仓库访问密码生成主密码:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mvn --encrypt-master-password &lt;password&gt;</span><br></pre></table></figure><p>其次在<code>settings.xml</code>文件的同级目录创建<code>settings-security.xml</code>文件, 将主密码写入:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=line>&lt;settingsSecurity&gt;</span><br><span class=line>  &lt;master&gt;&#123;Ns0JM49fW9gHMTZ44n*****************=&#125;&lt;/master&gt;</span><br><span class=line>&lt;/settingsSecurity&gt;</span><br></pre></table></figure><p>最后使用你的私有仓库访问密码生成服务密码, 将生成的密码写入到<code>settings.xml</code>的<code>&lt;services&gt;</code>中（可能会提示目录不存在, 解决方法是创建一个<code>.m2</code>目录并把<code>settings-security.xml</code>复制进去）<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>mvn --encrypt-password &lt;password&gt;</span><br><span class=line>&#123;D9YIyWYvtYsHayLjIenj***********=&#125;</span><br></pre></table></figure><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>&lt;server&gt;</span><br><span class=line>    &lt;id&gt;docker-registry&lt;/id&gt;</span><br><span class=line>    &lt;username&gt;admin&lt;/username&gt;</span><br><span class=line>    &lt;password&gt;&#123;gKLNhblk/SQHBMooM******************=&#125;&lt;/password&gt;</span><br><span class=line>    &lt;configuration&gt;</span><br><span class=line>        &lt;email&gt;yangbingdong1994@gmail.com&lt;/email&gt;</span><br><span class=line>    &lt;/configuration&gt;</span><br><span class=line>&lt;/server&gt;</span><br></pre></table></figure><h2 id=构建基础镜像><a href=#构建基础镜像 class=headerlink title=构建基础镜像></a>构建基础镜像</h2><p>Dockerfile:<figure class="highlight dockerfile"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=keyword>FROM</span> frolvlad/alpine-oraclejdk8:slim</span><br><span class=line><span class=keyword>MAINTAINER</span> ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class=line><span class=keyword>ARG</span> TZ </span><br><span class=line><span class=keyword>ARG</span> HTTP_PROXY</span><br><span class=line><span class=keyword>ENV</span> TZ=$&#123;TZ:-<span class=string>"Asia/Shanghai"</span>&#125; http_proxy=$&#123;HTTP_PROXY&#125; https_proxy=$&#123;HTTP_PROXY&#125;</span><br><span class=line><span class=keyword>RUN</span><span class=bash> apk update &amp;&amp; \</span></span><br><span class=line><span class=bash>    apk add --no-cache &amp;&amp; \</span></span><br><span class=line><span class=bash>    apk add curl bash tree tzdata &amp;&amp; \</span></span><br><span class=line><span class=bash>    ln -snf /usr/share/zoneinfo/<span class=variable>$TZ</span> /etc/localtime &amp;&amp; \</span></span><br><span class=line><span class=bash>    <span class=built_in>echo</span> <span class=variable>$TZ</span> &gt; /etc/timezone </span></span><br><span class=line><span class=keyword>ENV</span> http_proxy=</span><br><span class=line><span class=keyword>ENV</span> https_proxy=</span><br></pre></table></figure><p>构建:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker build --build-arg HTTP_PROXY=192.168.6.113:8118 -t yangbingdong/docker-oraclejdk8 .</span><br></pre></table></figure><p>其中<code>HTTP_PROXY</code>是http代理, 通过<code>--build-arg</code>参数传入, 注意<strong>不能</strong>是<code>127.0.0.1</code>或<code>localhost</code>.<h2 id=开始集成><a href=#开始集成 class=headerlink title=开始集成></a>开始集成</h2><h3 id=编写Dockerfile><a href=#编写Dockerfile class=headerlink title=编写Dockerfile></a>编写Dockerfile</h3><p>在<code>src/main</code>下面新建<code>docker</code>文件夹, 并创建<code>Dockerfile</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>FROM yangbingdong/docker-oraclejdk8:latest</span><br><span class=line>MAINTAINER yangbingdong &lt;yangbingdong1994@gmail.com&gt;</span><br><span class=line>ENV PROJECT_NAME=&quot;@project.build.finalName@.@project.packaging@&quot; JAVA_OPTS=&quot;&quot;</span><br><span class=line>ADD $PROJECT_NAME /app.jar</span><br><span class=line>ENTRYPOINT exec java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector -Dspring.profiles.active=$&#123;ACTIVE:-docker&#125; -jar /app.jar</span><br></pre></table></figure><ul><li>通过<code>@@</code>动态获取打包后的项目名（需要插件, 下面会介绍）<li><code>Dspring.profiles.active=${ACTIVE:-docker}</code>可以通过docker启动命令<code>-e ACTIVE=docker</code>参数修改配置</ul><h4 id=注意PID><a href=#注意PID class=headerlink title=注意PID></a>注意PID</h4><p>如果需要Java程序监听到<code>sigterm</code>信号, 那么Java程序的<code>PID</code>必须是1, 可以使用<code>ENTRYPOINT exec java -jar ...</code>这种方式实现.<h3 id=pom文件添加构建Docker镜像的相关插件><a href=#pom文件添加构建Docker镜像的相关插件 class=headerlink title=pom文件添加构建Docker镜像的相关插件></a>pom文件添加构建Docker镜像的相关插件</h3><blockquote><p>继承<code>spring-boot-starter-parent</code>, 除了<code>docker-maven-plugin</code>, 下面的3个插件都不用填写版本号, 因为parent中已经定义版本号</blockquote><h4 id=spring-boot-maven-plugin><a href=#spring-boot-maven-plugin class=headerlink title=spring-boot-maven-plugin></a>spring-boot-maven-plugin</h4><p>这个不用多介绍了, 打包Spring Boot Jar包的<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>&lt;plugin&gt;</span><br><span class=line>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class=line>    &lt;executions&gt;</span><br><span class=line>        &lt;execution&gt;</span><br><span class=line>            &lt;goals&gt;</span><br><span class=line>                &lt;goal&gt;repackage&lt;/goal&gt;</span><br><span class=line>            &lt;/goals&gt;</span><br><span class=line>        &lt;/execution&gt;</span><br><span class=line>    &lt;/executions&gt;</span><br><span class=line>&lt;/plugin&gt;</span><br></pre></table></figure><h4 id=maven-resources-plugin><a href=#maven-resources-plugin class=headerlink title=maven-resources-plugin></a>maven-resources-plugin</h4><p>resources插件, 使用<code>@变量@</code>形式获取Maven变量到Dockerfile中（同时拷贝构建的Jar包到Dockerfile同一目录中, 这种方式是方便手动构建镜像）<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>plugin</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.maven.plugins<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>maven-resources-plugin<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>executions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>id</span>&gt;</span>prepare-dockerfile<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>phase</span>&gt;</span>validate<span class=tag>&lt;/<span class=name>phase</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>goal</span>&gt;</span>copy-resources<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 编译后Dockerfile的输出位置 --&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>outputDirectory</span>&gt;</span>$&#123;dockerfile.compiled.position&#125;<span class=tag>&lt;/<span class=name>outputDirectory</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>resources</span>&gt;</span></span><br><span class=line>                	<span class=comment>&lt;!-- Dockerfile位置 --&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>resource</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>directory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/docker<span class=tag>&lt;/<span class=name>directory</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>filtering</span>&gt;</span>true<span class=tag>&lt;/<span class=name>filtering</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;/<span class=name>resource</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;/<span class=name>resources</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 将Jar复制到target的docker目录中, 因为真正的Dockerfile也是在里面, 方便使用docker build命令构建Docker镜像 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>id</span>&gt;</span>copy-jar<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>phase</span>&gt;</span>package<span class=tag>&lt;/<span class=name>phase</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>goal</span>&gt;</span>copy-resources<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>outputDirectory</span>&gt;</span>$&#123;dockerfile.compiled.position&#125;<span class=tag>&lt;/<span class=name>outputDirectory</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>resources</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>resource</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class=tag>&lt;/<span class=name>directory</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>includes</span>&gt;</span></span><br><span class=line>                            <span class=tag>&lt;<span class=name>include</span>&gt;</span>*.jar<span class=tag>&lt;/<span class=name>include</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;/<span class=name>includes</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;/<span class=name>resource</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;/<span class=name>resources</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>executions</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>plugin</span>&gt;</span></span><br></pre></table></figure><h4 id=build-helper-maven-plugin><a href=#build-helper-maven-plugin class=headerlink title=build-helper-maven-plugin></a>build-helper-maven-plugin</h4><p>这个是为了给镜像添加基于时间戳的版本号, maven也有自带的获取时间戳的变量<code>maven.build.timestamp.format</code> + <code>maven.build.timestamp</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>&lt;maven.build.timestamp.format&gt;yyyy-MM-dd_HH-mm-ss&lt;maven.build.timestamp.format&gt;</span><br><span class=line></span><br><span class=line># 获取时间戳</span><br><span class=line>$&#123;maven.build.timestamp&#125;</span><br></pre></table></figure><p>但是这个时区是<code>UTC</code>, 接近于格林尼治标准时间, 所以出来的时间会比但前的时间慢8个小时.<p>如果要使用<code>GMT+8</code>, 就需要<code>build-helper-maven-plugin</code>插件, 当然也有其他的实现方式, 这里不做展开.<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>build</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>plugins</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>plugin</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.codehaus.mojo<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>build-helper-maven-plugin<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>executions</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>id</span>&gt;</span>timestamp-property<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>goal</span>&gt;</span>timestamp-property<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>                    	<span class=comment>&lt;!-- 其他地方可通过$&#123;timestamp&#125;获取时间戳 --&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>name</span>&gt;</span>timestamp<span class=tag>&lt;/<span class=name>name</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>pattern</span>&gt;</span>yyyyMMddHHmm<span class=tag>&lt;/<span class=name>pattern</span>&gt;</span></span><br><span class=line>                        <span class=tag>&lt;<span class=name>timeZone</span>&gt;</span>GMT+8<span class=tag>&lt;/<span class=name>timeZone</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>executions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>plugin</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>plugins</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>build</span>&gt;</span></span><br></pre></table></figure><p>然后可以在pom中使用<code>${timestamp}</code>获取时间戳.<p>当然, 也可以使用<strong>另外一种方式实现</strong>, 打包前<code>export</code>一个格式化日期的环境变量, <code>pom.xml</code>中获取这个变量:<ul><li><code>export DOCKER_IMAGE_TAGE_DATE=yyyy-MM-dd_HH-mm</code><li><code>mvn help:system</code>可查看所有环境变量<li>所有的环境变量都可以用以<code>env.</code>开头的Maven属性引用: <code>${env.DOCKER_IMAGE_TAGE_DATE}</code></ul><h4 id=docker-maven-plugin><a href=#docker-maven-plugin class=headerlink title=docker-maven-plugin></a>docker-maven-plugin</h4><p>这也是集成并构建Docker镜像的关键<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>plugin</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.spotify<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>docker-maven-plugin<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;docker-maven-plugin.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!--  --&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- 绑定打包阶段执行Docker镜像操作 --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>executions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 打包阶段构建镜像 --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>phase</span>&gt;</span>package<span class=tag>&lt;/<span class=name>phase</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>goal</span>&gt;</span>build<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 部署阶段Push镜像 --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>id</span>&gt;</span>push-image<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>phase</span>&gt;</span>deploy<span class=tag>&lt;/<span class=name>phase</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>goal</span>&gt;</span>push<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- Push指定镜像 --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>                <span class=comment>&lt;!--&lt;imageName&gt;$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;/$&#123;project.artifactId&#125;:$&#123;docker-latest-tag&#125;&lt;/imageName&gt;--&gt;</span></span><br><span class=line>                <span class=comment>&lt;!--suppress UnresolvedMavenProperty --&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>imageName</span>&gt;</span>$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;/$&#123;project.artifactId&#125;:$&#123;timestamp&#125;<span class=tag>&lt;/<span class=name>imageName</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>executions</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 是否跳过所有构建Docker镜像阶段 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>skipDocker</span>&gt;</span>$&#123;docker.skip.build&#125;<span class=tag>&lt;/<span class=name>skipDocker</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 是否跳过Push阶段 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>skipDockerPush</span>&gt;</span>$&#123;docker.skip.push&#125;<span class=tag>&lt;/<span class=name>skipDockerPush</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>forceTags</span>&gt;</span>true<span class=tag>&lt;/<span class=name>forceTags</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 最大重试次数 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>retryPushCount</span>&gt;</span>2<span class=tag>&lt;/<span class=name>retryPushCount</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>imageTags</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 使用时间戳版本号 --&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--suppress UnresolvedMavenProperty --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>imageTag</span>&gt;</span>$&#123;timestamp&#125;<span class=tag>&lt;/<span class=name>imageTag</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>imageTags</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 配置镜像名称, 遵循Docker的命名规范: springio/image --&gt;</span><span class=tag>&lt;<span class=name>imageName</span>&gt;</span>$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;/$&#123;project.artifactId&#125;<span class=tag>&lt;/<span class=name>imageName</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- Dockerfile位置, 由于配置了编译时动态获取Maven变量, 真正的Dockerfile位于位于编译后位置 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>dockerDirectory</span>&gt;</span>$&#123;dockerfile.compiled.position&#125;<span class=tag>&lt;/<span class=name>dockerDirectory</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>resources</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>resource</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>targetPath</span>&gt;</span>/<span class=tag>&lt;/<span class=name>targetPath</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class=tag>&lt;/<span class=name>directory</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class=tag>&lt;/<span class=name>include</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>resource</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>resources</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!-- 被推送服务器的配置ID, 与setting中的一直 --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>serverId</span>&gt;</span>docker-registry<span class=tag>&lt;/<span class=name>serverId</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!--&lt;registryUrl&gt;$&#123;docker.registry.url&#125;&lt;/registryUrl&gt;--&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>plugin</span>&gt;</span></span><br></pre></table></figure><p>主要<code>properties</code>:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>properties</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- ########## Docker 相关变量 ########## --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>docker-maven-plugin.version</span>&gt;</span>1.0.0<span class=tag>&lt;/<span class=name>docker-maven-plugin.version</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- resource插件编译Dockerfile后的位置--&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>dockerfile.compiled.position</span>&gt;</span>$&#123;project.build.directory&#125;/docker<span class=tag>&lt;/<span class=name>dockerfile.compiled.position</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>docker.skip.build</span>&gt;</span>false<span class=tag>&lt;/<span class=name>docker.skip.build</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>docker.skip.push</span>&gt;</span>false<span class=tag>&lt;/<span class=name>docker.push.image</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>docker.registry.url</span>&gt;</span>192.168.0.202:8080<span class=tag>&lt;/<span class=name>docker.registry.url</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>docker.registry.name</span>&gt;</span>dev-images<span class=tag>&lt;/<span class=name>docker.registry.name</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>docker-latest-tag</span>&gt;</span>latest<span class=tag>&lt;/<span class=name>docker-latest-tag</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>properties</span>&gt;</span></span><br></pre></table></figure><p><strong>说明</strong>:<ul><li>这里的<code>serverId</code>要与maven <code>setting.xml</code>里面的一样</ul><ul><li>Dockerfile构建文件在<code>src/main/docker</code>中<li>如果Dockerfile文件需要maven构建参数（比如需要构建后的打包文件名等）, 则使用<code>@@</code>占位符（如<a href="mailto:`@project.build.finalName" rel="external nofollow noopener noreferrer" target=_blank>`@project.build.finalName</a>@<code>）原因是Sping Boot 的pom将resource插件的占位符由</code>${}<code>改为</code>@@<code>, 非继承Spring Boot 的pom文件, 则使用</code>${}`占位符<li>如果不需要动态生成Dockerfile文件, 则可以将Dockerfile资源拷贝部分放入<code>docker-maven-plugin</code>插件的<code>&lt;resources&gt;</code>配置里<li><strong><code>spring-boot-maven-plugin</code>插件一定要在其他构建插件之上, 否则打包文件会有问题.</strong></ul><p><code>docker-maven-plugin</code> 插件还提供了很多很实用的配置, 稍微列举几个参数吧.<table><thead><tr><th>参数<th>说明<th>默认值<tbody><tr><td><code>&lt;forceTags&gt;true&lt;/forceTags&gt;</code><td>build 时强制覆盖 tag, 配合 imageTags 使用<td>false<tr><td><code>&lt;noCache&gt;true&lt;/noCache&gt;</code><td>build 时, 指定 –no-cache 不使用缓存<td>false<tr><td><code>&lt;pullOnBuild&gt;true&lt;/pullOnBuild&gt;</code><td>build 时, 指定 –pull=true 每次都重新拉取基础镜像<td>false<tr><td><code>&lt;pushImage&gt;true&lt;/pushImage&gt;</code><td>build 完成后 push 镜像<td>false<tr><td><code>&lt;pushImageTag&gt;true&lt;/pushImageTag&gt;</code><td>build 完成后, push 指定 tag 的镜像, 配合 imageTags 使用<td>false<tr><td><code>&lt;retryPushCount&gt;5&lt;/retryPushCount&gt;</code><td>push 镜像失败, 重试次数<td>5<tr><td><code>&lt;retryPushTimeout&gt;10&lt;/retryPushTimeout&gt;</code><td>push 镜像失败, 重试时间<td>10s<tr><td><code>&lt;rm&gt;true&lt;/rm&gt;</code><td>build 时, 指定 –rm=true 即 build 完成后删除中间容器<td>false<tr><td><code>&lt;useGitCommitId&gt;true&lt;/useGitCommitId&gt;</code><td>build 时, 使用最近的 git commit id 前7位作为tag, 例如: image:b50b604, 前提是不配置 newName<td>false</table><p>更多参数可查看插件中的定义.<h3 id=命令构建><a href=#命令构建 class=headerlink title=命令构建></a>命令构建</h3><p>如果<code>&lt;skipDockerPush&gt;false&lt;/skipDockerPush&gt;</code>则install阶段将不提交Docker镜像, 只有maven的<code>deploy</code>阶段才提交.<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>mvn clean install</span><br><span class=line></span><br><span class=line># 如果由外部传入 TAG, pom.xml 中通过 $&#123;env.DOCKER_TAG_DATE&#125; 获取</span><br><span class=line>export DOCKER_TAG_DATE=`date &apos;+%Y-%m-%d_%H-%M&apos;` &amp;&amp; mvn clean install</span><br></pre></table></figure><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br></pre><td class=code><pre><span class=line>[INFO] --- spring-boot-maven-plugin:1.5.9.RELEASE:repackage (default) @ eureka-center-server ---</span><br><span class=line>[INFO] </span><br><span class=line>[INFO] --- docker-maven-plugin:1.0.0:build (default) @ eureka-center-server ---</span><br><span class=line>[INFO] Using authentication suppliers: [ConfigFileRegistryAuthSupplier, NoOpRegistryAuthSupplier]</span><br><span class=line>[WARNING] Ignoring run because dockerDirectory is set</span><br><span class=line>[INFO] Copying /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/eureka-center-server-0.0.1-SNAPSHOT.jar -&gt; /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/eureka-center-server-0.0.1-SNAPSHOT.jar</span><br><span class=line>[INFO] Copying /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/eureka-center-server-0.0.1-SNAPSHOT.jar -&gt; /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/eureka-center-server-0.0.1-SNAPSHOT.jar</span><br><span class=line>[INFO] Copying /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/Dockerfile -&gt; /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/docker/Dockerfile</span><br><span class=line>[INFO] Building image 192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class=line>Step 1/7 : FROM frolvlad/alpine-oraclejdk8:slim</span><br><span class=line></span><br><span class=line> ---&gt; 491f45037124</span><br><span class=line>Step 2/7 : MAINTAINER ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class=line></span><br><span class=line> ---&gt; Using cache</span><br><span class=line> ---&gt; 016c2033bd32</span><br><span class=line>Step 3/7 : VOLUME /tmp</span><br><span class=line></span><br><span class=line> ---&gt; Using cache</span><br><span class=line> ---&gt; d2a287b6ed52</span><br><span class=line>Step 4/7 : ENV PROJECT_NAME=&quot;eureka-center-server-0.0.1-SNAPSHOT.jar&quot; JAVA_OPTS=&quot;&quot;</span><br><span class=line></span><br><span class=line> ---&gt; Using cache</span><br><span class=line> ---&gt; 34565a7de714</span><br><span class=line>Step 5/7 : ADD $PROJECT_NAME app.jar</span><br><span class=line></span><br><span class=line> ---&gt; 64d9055ce969</span><br><span class=line>Step 6/7 : RUN sh -c &apos;touch /app.jar&apos;</span><br><span class=line></span><br><span class=line> ---&gt; Running in 66f4eb550a57</span><br><span class=line>Removing intermediate container 66f4eb550a57</span><br><span class=line> ---&gt; 93486965cad9</span><br><span class=line>Step 7/7 : CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -Dspring.profiles.active=$&#123;ACTIVE:-docker&#125;  -jar /app.jar&quot;]</span><br><span class=line></span><br><span class=line> ---&gt; Running in 8b42c471791f</span><br><span class=line>Removing intermediate container 8b42c471791f</span><br><span class=line> ---&gt; 2eb3dbbab6c5</span><br><span class=line>ProgressMessage&#123;id=null, status=null, stream=null, error=null, progress=null, progressDetail=null&#125;</span><br><span class=line>Successfully built 2eb3dbbab6c5</span><br><span class=line>Successfully tagged 192.168.6.113:8888/discover-server/eureka-center-server:latest</span><br><span class=line>[INFO] Built 192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class=line>[INFO] Tagging 192.168.6.113:8888/discover-server/eureka-center-server with 0.0.1-SNAPSHOT</span><br><span class=line>[INFO] Tagging 192.168.6.113:8888/discover-server/eureka-center-server with latest</span><br><span class=line>[INFO] Pushing 192.168.6.113:8888/discover-server/eureka-center-server</span><br><span class=line>The push refers to repository [192.168.6.113:8888/discover-server/eureka-center-server]</span><br><span class=line>40566d372b69: Pushed </span><br><span class=line>40566d372b69: Layer already exists </span><br><span class=line>4fd38f0d6712: Layer already exists </span><br><span class=line>d7cd646c41bd: Layer already exists </span><br><span class=line>ced237d13962: Layer already exists </span><br><span class=line>2aebd096e0e2: Layer already exists </span><br><span class=line>null: null </span><br><span class=line>null: null </span><br><span class=line>[INFO] </span><br><span class=line>[INFO] --- maven-install-plugin:2.4:install (default-install) @ eureka-center-server ---</span><br><span class=line>[INFO] Installing /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/target/eureka-center-server-0.0.1-SNAPSHOT.jar to /home/ybd/data/application/maven/maven-repo/com/iba/server/eureka-center-server/0.0.1-SNAPSHOT/eureka-center-server-0.0.1-SNAPSHOT.jar</span><br><span class=line>[INFO] Installing /home/ybd/data/git-repo/bitbucket/ms-iba/eureka-center-server/pom.xml to /home/ybd/data/application/maven/maven-repo/com/iba/server/eureka-center-server/0.0.1-SNAPSHOT/eureka-center-server-0.0.1-SNAPSHOT.pom</span><br><span class=line>[INFO] ------------------------------------------------------------------------</span><br><span class=line>[INFO] BUILD SUCCESS</span><br><span class=line>[INFO] ------------------------------------------------------------------------</span><br><span class=line>[INFO] Total time: 15.962 s</span><br><span class=line>[INFO] Finished at: 2017-12-25T13:33:39+08:00</span><br><span class=line>[INFO] Final Memory: 55M/591M</span><br><span class=line>[INFO] ------------------------------------------------------------------------</span><br></pre></table></figure><p>可以看到本地以及私有仓库都多了一个镜像:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/portainer.png alt><p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/harbor.png alt><p><strong>此处有个疑问</strong>, 很明显看得出来这里上传了两个一样大小的包, 不知道是不是同一个jar包, 但id又不一样:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/duplicate01.png alt><p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/duplicate02.png alt><h3 id=运行Docker><a href=#运行Docker class=headerlink title=运行Docker></a>运行Docker</h3><h4 id=普通运行><a href=#普通运行 class=headerlink title=普通运行></a>普通运行</h4><p>运行程序<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker run --name some-server -e ACTIVE=docker -p 8080:8080 -d [IMAGE]</span><br></pre></table></figure><h4 id=Docker-Swarm-运行><a href=#Docker-Swarm-运行 class=headerlink title="Docker Swarm 运行"></a>Docker Swarm 运行</h4><p><code>docker-compose.yml</code> 中的 <code>image</code> 通过 <code>.env</code> 配置, 但 通过 <code>docker stack</code> 启动并不会读取到 <code>.env</code> 的镜像变量, 但可以通过以下命令解决:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>export $(cat .env) &amp;&amp; docker stack deploy -c docker-compose.yml demo-stack</span><br></pre></table></figure><h3 id=添加运行时JVM参数><a href=#添加运行时JVM参数 class=headerlink title=添加运行时JVM参数></a>添加运行时JVM参数</h3><p>只需要在Docker启动命令中加上<code>-e &quot;JAVA_OPTS=-Xmx128m&quot;</code>即可<h3 id=其他的Docker构建工具><a href=#其他的Docker构建工具 class=headerlink title=其他的Docker构建工具></a>其他的Docker构建工具</h3><h4 id=Jib><a href=#Jib class=headerlink title=Jib></a>Jib</h4><blockquote><p>Jib 是 Google 开源的另外一款Docker打包工具.<p>jib-maven-plugin: <strong><em><a href=https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin rel="external nofollow noopener noreferrer" target=_blank>https://github.com/GoogleContainerTools/jib/tree/master/jib-maven-plugin</a></em></strong></blockquote><p>pom配置:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>plugin</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.google.cloud.tools<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>jib-maven-plugin<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>1.6.1<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!--from节点用来设置镜像的基础镜像，相当于Docerkfile中的FROM关键字--&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>from</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--使用openjdk官方镜像，tag是8-jdk-stretch，表示镜像的操作系统是debian9,装好了jdk8--&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--&lt;image&gt;gcr.io/distroless/java:8&lt;/image&gt;--&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>image</span>&gt;</span>yangbingdong/docker-oraclejdk8:latest<span class=tag>&lt;/<span class=name>image</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>from</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>to</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--镜像名称和tag，使用了mvn内置变量$&#123;project.version&#125;，表示当前工程的version--&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--suppress MavenModelInspection, MybatisMapperXmlInspection --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>image</span>&gt;</span>$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;/$&#123;project.artifactId&#125;:$&#123;env.DOCKER_TAG_DATE&#125;<span class=tag>&lt;/<span class=name>image</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>auth</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>username</span>&gt;</span>admin<span class=tag>&lt;/<span class=name>username</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>password</span>&gt;</span>Harbor12345<span class=tag>&lt;/<span class=name>password</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>auth</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>to</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!--容器相关的属性--&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>container</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--jvm内存参数--&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>jvmFlags</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>jvmFlag</span>&gt;</span>-Xmx1g<span class=tag>&lt;/<span class=name>jvmFlag</span>&gt;</span></span><br><span class=line>                <span class=comment>&lt;!--suppress MavenModelInspection, MybatisMapperXmlInspection --&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>jvmFlag</span>&gt;</span>-Dspring.profiles.active=$&#123;ACTIVE:-docker&#125;<span class=tag>&lt;/<span class=name>jvmFlag</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>jvmFlags</span>&gt;</span></span><br><span class=line>            <span class=comment>&lt;!--要暴露的端口--&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>ports</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>port</span>&gt;</span>8080<span class=tag>&lt;/<span class=name>port</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>ports</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class=tag>&lt;/<span class=name>creationTime</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>format</span>&gt;</span>OCI<span class=tag>&lt;/<span class=name>format</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>container</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>allowInsecureRegistries</span>&gt;</span>true<span class=tag>&lt;/<span class=name>allowInsecureRegistries</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>executions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>phase</span>&gt;</span>compile<span class=tag>&lt;/<span class=name>phase</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                <span class=comment>&lt;!--suppress MybatisMapperXmlInspection --&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>goal</span>&gt;</span>dockerBuild<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>                <span class=comment>&lt;!--&lt;goal&gt;build&lt;/goal&gt;--&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>executions</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>plugin</span>&gt;</span></span><br></pre></table></figure><p>更多配置请看官方文档.<h4 id=Dockerfile-Maven><a href=#Dockerfile-Maven class=headerlink title="Dockerfile Maven"></a>Dockerfile Maven</h4><p>这是 spotify 在 开源 <code>docker-maven-plugin</code> 之后的又一款插件, 用法大概如下:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>plugin</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.spotify<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>dockerfile-maven-plugin<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>1.4.12<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>executions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>execution</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>id</span>&gt;</span>default<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>phase</span>&gt;</span>package<span class=tag>&lt;/<span class=name>phase</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>goals</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>goal</span>&gt;</span>build<span class=tag>&lt;/<span class=name>goal</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>goals</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>execution</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>executions</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>configuration</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>repository</span>&gt;</span>$&#123;docker.registry.url&#125;/$&#123;docker.registry.name&#125;<span class=tag>&lt;/<span class=name>repository</span>&gt;</span></span><br><span class=line>        <span class=comment>&lt;!--suppress MavenModelInspection --&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>tag</span>&gt;</span>$&#123;env.DOCKER_TAG_DATE&#125;<span class=tag>&lt;/<span class=name>tag</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>contextDirectory</span>&gt;</span>$&#123;dockerfile.compiled.position&#125;<span class=tag>&lt;/<span class=name>contextDirectory</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>dockerfile</span>&gt;</span>$&#123;dockerfile.compiled.position&#125;/Dockerfile<span class=tag>&lt;/<span class=name>dockerfile</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>configuration</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>plugin</span>&gt;</span></span><br></pre></table></figure><p>感觉灵活性没有 <code>docker-maven-plugin</code> 好.<h2 id=Docker-Swarm环境下获取ClientIp><a href=#Docker-Swarm环境下获取ClientIp class=headerlink title="Docker Swarm环境下获取ClientIp"></a>Docker Swarm环境下获取ClientIp</h2><p>在Docker Swarm环境中, 服务中获取到的ClientIp永远是<code>10.255.0.X</code>这样的Ip, 搜索了一大圈, 最终的解决方安是通过Nginx转发中添加参数, 后端再获取.<p>在<code>location</code>中添加<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>proxy_set_header    X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br></pre></table></figure><p>后端获取第一个Ip.<h2 id=服务注册IP问题><a href=#服务注册IP问题 class=headerlink title=服务注册IP问题></a>服务注册IP问题</h2><p>一般安装了 Docker 会出现多网卡的情况, 在服务注册的时候会出现获取到的ip不准确的问题, 可以通过以下几种方式解决(可以混合使用)<p>方式一, 忽略指定名称的网卡<figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>inetutils:</span></span><br><span class=line>      <span class=attr>ignored-interfaces:</span> </span><br><span class=line>        <span class=bullet>-</span> <span class=string>docker0</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>veth.*</span></span><br></pre></table></figure><p>方式二, 使用正则表达式, 指定使用的网络地址<figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>inetutils:</span></span><br><span class=line>      <span class=attr>preferred-networks:</span> </span><br><span class=line>        <span class=bullet>-</span> <span class=number>192.168</span></span><br><span class=line>        <span class=bullet>-</span> <span class=number>10.0</span></span><br></pre></table></figure><p>方式三, 只使用站点本地地址<figure class="highlight yml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line></span><br><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>cloud:</span></span><br><span class=line>    <span class=attr>inetutils:</span></span><br><span class=line>      <span class=attr>use-only-site-local-interfaces:</span> <span class=literal>true</span></span><br></pre></table></figure><h2 id=Demo地址><a href=#Demo地址 class=headerlink title=Demo地址></a>Demo地址</h2><p><strong><em><a href=https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-docker rel="external nofollow noopener noreferrer" target=_blank>https://github.com/masteranthoneyd/spring-boot-learning/tree/master/spring-boot-docker</a></em></strong><h1 id=Kafka、ELK-collect-logs><a href=#Kafka、ELK-collect-logs class=headerlink title="Kafka、ELK collect logs"></a>Kafka、ELK collect logs</h1><p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/elk-arch1.png alt><p>传统的应用可以将日志存到日志中, 但集成Docker之后, 日志怎么处理？放到容器的某个目录然后挂在出来？这样也可以, 但这样就相当于给容器与外界绑定了一个状态, 弹性伸缩怎么办？个人还是觉得通过队列与ELK管理Docker日志比较合理, 而且Log4j2<strong>原生支持Kafka的Appender</strong>.<h2 id=镜像准备><a href=#镜像准备 class=headerlink title=镜像准备></a>镜像准备</h2><p>Docker Hub中的ELK镜像并不是最新版本的, 我们需要到官方的网站获取最新的镜像: <strong><em><a href=https://www.docker.elastic.co rel="external nofollow noopener noreferrer" target=_blank>https://www.docker.elastic.co</a></em></strong><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>docker pull zookeeper</span><br><span class=line>docker pull wurstmeister/kafka:1.1.0</span><br><span class=line>docker pull docker.elastic.co/elasticsearch/elasticsearch:6.3.0</span><br><span class=line>docker pull docker.elastic.co/kibana/kibana:6.3.0</span><br><span class=line>docker pull docker.elastic.co/logstash/logstash:6.3.0</span><br></pre></table></figure><p>注意ELK版本最好保持一致<h2 id=启动Kafka与Zookeeper><a href=#启动Kafka与Zookeeper class=headerlink title=启动Kafka与Zookeeper></a>启动Kafka与Zookeeper</h2><p>这里直接使用docker-compose（需要先创建外部网络）:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line><span class=attr>version:</span> <span class=string>'3.4'</span></span><br><span class=line><span class=attr>services:</span></span><br><span class=line>  <span class=attr>zoo:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>zookeeper:latest</span></span><br><span class=line>    <span class=attr>ports:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>"2181:2181"</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>zoo</span></span><br><span class=line></span><br><span class=line>  <span class=attr>kafka:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>wurstmeister/kafka:1.1.0</span></span><br><span class=line>    <span class=attr>ports:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>"9092:9092"</span></span><br><span class=line>    <span class=attr>environment:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>KAFKA_PORT=9092</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>KAFKA_ADVERTISED_HOST_NAME=192.168.6.113</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>KAFKA_ZOOKEEPER_CONNECT=zoo:2181</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>KAFKA_ADVERTISED_PORT=9092</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class=line>    <span class=attr>depends_on:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>zoo</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>kafka</span></span><br><span class=line></span><br><span class=line><span class=attr>networks:</span></span><br><span class=line>  <span class=attr>backend:</span></span><br><span class=line>    <span class=attr>external:</span></span><br><span class=line>      <span class=attr>name:</span> <span class=string>backend</span></span><br></pre></table></figure><ul><li><code>KAFKA_ADVERTISED_HOST_NAME</code>是内网IP, 本地调试用, Docker环境下换成<code>kafka</code>（与别名<code>aliases的值保持一致</code>）, 其他Docker应用可通过<code>kafka:9092</code>这个域名访问到Kafka.</ul><h2 id=ELK配置以及启动><a href=#ELK配置以及启动 class=headerlink title=ELK配置以及启动></a>ELK配置以及启动</h2><h3 id=X-Pack-破解><a href=#X-Pack-破解 class=headerlink title="X-Pack 破解"></a>X-Pack 破解</h3><h4 id=复制Jar包><a href=#复制Jar包 class=headerlink title=复制Jar包></a>复制Jar包</h4><p>先启动一个Elasticsearch的容器, 将Jar包copy出来:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>export CONTAINER_NAME=elk_elk-elasticsearch_1</span><br><span class=line>docker cp $&#123;CONTAINER_NAME&#125;:/usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.4.0.jar ./</span><br><span class=line>docker cp $&#123;CONTAINER_NAME&#125;:/usr/share/elasticsearch/lib ./lib</span><br></pre></table></figure><h4 id=反编译并修改源码><a href=#反编译并修改源码 class=headerlink title=反编译并修改源码></a>反编译并修改源码</h4><p>找到下面两个类:<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>org.elasticsearch.license.LicenseVerifier.class org.elasticsearch.xpack.core.XPackBuild.class</span><br></pre></table></figure><p>使用 <strong><em><a href=https://github.com/deathmarine/Luyten rel="external nofollow noopener noreferrer" target=_blank>Luyten</a></em></strong> 进行反编译<p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/luyten.png alt><p>将两个类复制IDEA（<strong>需要引入上面copy出来的lib以及<code>x-pack-core-6.4.0.jar</code>本身</strong>）, 修改为如下样子:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>package org.elasticsearch.license;</span><br><span class=line></span><br><span class=line>public class LicenseVerifier</span><br><span class=line>&#123;</span><br><span class=line>	public static boolean verifyLicense(final License license, final byte[] publicKeyData) &#123;</span><br><span class=line>		return true;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	public static boolean verifyLicense(final License license) &#123;</span><br><span class=line>		return true;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br></pre><td class=code><pre><span class=line><span class=keyword>package</span> org.elasticsearch.xpack.core;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> org.elasticsearch.common.SuppressForbidden;</span><br><span class=line><span class=keyword>import</span> org.elasticsearch.common.io.PathUtils;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.net.URISyntaxException;</span><br><span class=line><span class=keyword>import</span> java.net.URL;</span><br><span class=line><span class=keyword>import</span> java.nio.file.Path;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>XPackBuild</span></span></span><br><span class=line><span class=class></span>&#123;</span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> XPackBuild CURRENT;</span><br><span class=line>	<span class=keyword>private</span> String shortHash;</span><br><span class=line>	<span class=keyword>private</span> String date;</span><br><span class=line></span><br><span class=line>	<span class=meta>@SuppressForbidden</span>(reason = <span class=string>"looks up path of xpack.jar directly"</span>)</span><br><span class=line>	<span class=function><span class=keyword>static</span> Path <span class=title>getElasticsearchCodebase</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>final</span> URL url = XPackBuild<span class=class>.<span class=keyword>class</span>.<span class=title>getProtectionDomain</span>().<span class=title>getCodeSource</span>().<span class=title>getLocation</span>()</span>;</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>			<span class=keyword>return</span> PathUtils.get(url.toURI());</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>catch</span> (URISyntaxException bogus) &#123;</span><br><span class=line>			<span class=keyword>throw</span> <span class=keyword>new</span> RuntimeException(bogus);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	XPackBuild(<span class=keyword>final</span> String shortHash, <span class=keyword>final</span> String date) &#123;</span><br><span class=line>		<span class=keyword>this</span>.shortHash = shortHash;</span><br><span class=line>		<span class=keyword>this</span>.date = date;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> String <span class=title>shortHash</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>this</span>.shortHash;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> String <span class=title>date</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>this</span>.date;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=keyword>static</span> &#123;</span><br><span class=line>		<span class=keyword>final</span> Path path = getElasticsearchCodebase();</span><br><span class=line>		String shortHash = <span class=keyword>null</span>;</span><br><span class=line>		String date = <span class=keyword>null</span>;</span><br><span class=line>		Label_0157: &#123;  <span class=comment>// 将try-catch去掉</span></span><br><span class=line>			shortHash = <span class=string>"Unknown"</span>;</span><br><span class=line>			date = <span class=string>"Unknown"</span>;</span><br><span class=line>		&#125;</span><br><span class=line>		CURRENT = <span class=keyword>new</span> XPackBuild(shortHash, date);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>再编译放回jar包中:<p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/jar-archive.png alt><h3 id=配置文件><a href=#配置文件 class=headerlink title=配置文件></a>配置文件</h3><h4 id=Elasticsearch><a href=#Elasticsearch class=headerlink title=Elasticsearch></a>Elasticsearch</h4><p><code>elasticsearch.yml</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>cluster.name: &quot;docker-cluster&quot;</span><br><span class=line>network.host: 0.0.0.0</span><br><span class=line>discovery.zen.minimum_master_nodes: 1</span><br><span class=line>xpack.security.enabled: false # 不启用密码登陆</span><br><span class=line>xpack.monitoring.collection.enabled: true</span><br></pre></table></figure><h4 id=Logstash><a href=#Logstash class=headerlink title=Logstash></a>Logstash</h4><h5 id=Kafka-Input><a href=#Kafka-Input class=headerlink title="Kafka Input"></a>Kafka Input</h5><p><code>logstash.conf</code> 配置文件(<strong>注意下面的topics要与上面log4j2.xml中的一样</strong>):<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br></pre><td class=code><pre><span class=line>input &#123;</span><br><span class=line>    kafka &#123;</span><br><span class=line>        bootstrap_servers =&gt; [&quot;kafka:9092&quot;]</span><br><span class=line>        auto_offset_reset =&gt; &quot;latest&quot;</span><br><span class=line>        consumer_threads =&gt; 3 # 3个消费线程, 默认是1个</span><br><span class=line>        topics =&gt; [&quot;log-collect&quot;]</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br><span class=line>filter &#123;</span><br><span class=line>  mutate&#123;  # 切分日志信息并添加相应字段</span><br><span class=line>    split =&gt; [ &quot;message&quot;,&quot; | &quot; ]</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;timestamp&quot; =&gt; &quot;%&#123;[message][0]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;level&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;server_name&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;ip&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;device&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;thread_class_method&quot; =&gt; &quot;%&#123;[message][5]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;content&quot; =&gt; &quot;%&#123;[message][6]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    remove_field =&gt; [ &quot;message&quot; ]</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  date &#123;  # 将上面得到的日期信息, 也就是日志打印的时间作为时间戳</span><br><span class=line>    match =&gt; [ &quot;timestamp&quot;, &quot;yyyy-MM-dd HH:mm:ss.SSS&quot; ]</span><br><span class=line>    locale =&gt; &quot;en&quot;</span><br><span class=line>    target =&gt; [ &quot;@timestamp&quot; ]</span><br><span class=line>    timezone =&gt; &quot;Asia/Shanghai&quot; # 这里如果不设置时区, 在Kibana中展示的时候会多了8个小时</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  geoip &#123; # 分析ip</span><br><span class=line>    source =&gt; &quot;ip&quot;</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  useragent &#123; # 分析User-Agent</span><br><span class=line>    source =&gt; &quot;device&quot;</span><br><span class=line>    target =&gt; &quot;userDevice&quot;</span><br><span class=line>    remove_field =&gt; [ &quot;device&quot; ]</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br><span class=line>output &#123;</span><br><span class=line>    stdout&#123; codec =&gt; rubydebug &#125; # 输出到控制台</span><br><span class=line>    elasticsearch &#123; # 输出到 Elasticsearch</span><br><span class=line>        action =&gt; &quot;index&quot;</span><br><span class=line>        hosts  =&gt; [&quot;elk-elasticsearch:9200&quot;]</span><br><span class=line>        index  =&gt; &quot;logstash-%&#123;server_name&#125;-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class=line>        document_type =&gt; &quot;%&#123;server_name&#125;&quot;</span><br><span class=line>        # user =&gt; &quot;elastic&quot; # 如果选择开启xpack security需要输入帐号密码</span><br><span class=line>        # password =&gt; &quot;changeme&quot;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h5 id=Filebeat-Input><a href=#Filebeat-Input class=headerlink title="Filebeat Input"></a>Filebeat Input</h5><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br></pre><td class=code><pre><span class=line>input &#123;</span><br><span class=line>  beats &#123;</span><br><span class=line>#    host =&gt; filebeat</span><br><span class=line>    port =&gt; 5044</span><br><span class=line>  &#125;</span><br><span class=line>&#125;</span><br><span class=line>filter &#123;</span><br><span class=line></span><br><span class=line>  mutate&#123;  # 切分日志信息并添加相应字段</span><br><span class=line></span><br><span class=line>    split =&gt; [ &quot;message&quot;,&quot; | &quot; ]</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;timestamp&quot; =&gt; &quot;%&#123;[message][0]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;level&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;server_name&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;ip&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class=line></span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;logger&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;thread_class_method&quot; =&gt; &quot;%&#123;[message][5]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;content&quot; =&gt; &quot;%&#123;[message][6]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  date &#123;  # 将上面得到的日期信息, 也就是日志打印的时间作为时间戳</span><br><span class=line>    match =&gt; [ &quot;timestamp&quot;, &quot;yyyy-MM-dd HH:mm:ss.SSS&quot; ]</span><br><span class=line>    locale =&gt; &quot;en&quot;</span><br><span class=line>    target =&gt; &quot;@timestamp&quot; </span><br><span class=line>    timezone =&gt; &quot;Asia/Shanghai&quot; # 这里如果不设置时区, 在Kibana中展示的时候会多了8个小时</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  geoip &#123; # 分析ip</span><br><span class=line>    source =&gt; &quot;ip&quot;</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>  mutate&#123;</span><br><span class=line>    # 定义去除的字段</span><br><span class=line>    remove_field =&gt; [&quot;agent&quot;, &quot;source&quot;, &quot;input&quot;, &quot;@version&quot;, &quot;log&quot;, &quot;ecs&quot;, &quot;_score&quot;, &quot;beat&quot;, &quot;offset&quot;,&quot;prospector&quot;, &quot;host.name&quot;, &quot;message&quot;]</span><br><span class=line>  &#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br><span class=line>output &#123;</span><br><span class=line>    # 输出到控制台</span><br><span class=line>    stdout&#123; codec =&gt; rubydebug &#125;</span><br><span class=line></span><br><span class=line>    # 输出到 Elasticsearch</span><br><span class=line>    elasticsearch &#123;</span><br><span class=line>        hosts  =&gt; [&quot;elk-elasticsearch:9200&quot;]</span><br><span class=line>        index  =&gt; &quot;logstash-%&#123;server_name&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class=line></span><br><span class=line>        # manage_template =&gt; false # 关闭logstash默认索引模板</span><br><span class=line>        # template_name =&gt; &quot;crawl&quot; #映射模板的名字</span><br><span class=line>        # template_overwrite =&gt; true</span><br><span class=line>        # user =&gt; &quot;elastic&quot; # 如果选择开启xpack security需要输入帐号密码</span><br><span class=line>        # password =&gt; &quot;changeme&quot;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><code>logstash.yml</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>http.host: &quot;0.0.0.0&quot;</span><br><span class=line>xpack.monitoring.elasticsearch.url: http://elk-elasticsearch:9200 # Docker版的Logstash此配置的默认地址是http://elasticsearch:9200</span><br><span class=line></span><br><span class=line># xpack.monitoring.elasticsearch.username: &quot;elastic&quot; # 如果选择开启xpack security需要输入帐号密码</span><br><span class=line># xpack.monitoring.elasticsearch.password: &quot;changeme&quot;</span><br></pre></table></figure><p>User-Agent 分析配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line># 将 UA 输出到日志当中, 在 mutate 中添加:</span><br><span class=line>    add_field =&gt; &#123;</span><br><span class=line>      &quot;device&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line># 在 filter 中添加</span><br><span class=line>  useragent &#123; # 分析User-Agent</span><br><span class=line>    source =&gt; &quot;device&quot;</span><br><span class=line>    target =&gt; &quot;userDevice&quot;</span><br><span class=line>    remove_field =&gt; [ &quot;device&quot; ]</span><br><span class=line>  &#125;</span><br></pre></table></figure><h4 id=Kibana><a href=#Kibana class=headerlink title=Kibana></a>Kibana</h4><p><code>kibana.yml</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>server.name: kibana</span><br><span class=line>server.host: &quot;0&quot;</span><br><span class=line>elasticsearch.url: http://elk-elasticsearch:9200</span><br><span class=line>xpack.monitoring.ui.container.elasticsearch.enabled: true</span><br><span class=line>#elasticsearch.username: &quot;elastic&quot;</span><br><span class=line>#elasticsearch.password: &quot;changeme&quot;</span><br></pre></table></figure><h4 id=Filebeat><a href=#Filebeat class=headerlink title=Filebeat></a>Filebeat</h4><p>这是另外一种基于文件的日志收集.<p>filebeat.yml:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=attr>filebeat.inputs:</span></span><br><span class=line><span class=bullet>-</span> <span class=attr>type:</span> <span class=string>log</span></span><br><span class=line>  <span class=attr>enabled:</span> <span class=literal>true</span></span><br><span class=line>  <span class=attr>paths:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>/log4j2Logs/example/all.log</span></span><br><span class=line>  <span class=attr>multiline:</span></span><br><span class=line>    <span class=attr>pattern:</span> <span class=string>^\d&#123;4&#125;</span> <span class=comment># 多行处理，正则表示如果前面几个数字不是4个数字开头，那么就会合并到一行</span></span><br><span class=line>    <span class=attr>negate:</span> <span class=literal>true</span> <span class=comment># 正则是否开启，默认false不开启</span></span><br><span class=line>    <span class=attr>match:</span> <span class=string>after</span> <span class=comment># 不匹配的正则的行是放在上面一行的前面还是后面</span></span><br><span class=line>  <span class=attr>fields:</span>      <span class=comment># 在采集的信息中添加一个自定义字段 service</span></span><br><span class=line>    <span class=attr>service:</span> <span class=string>example</span></span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=attr>output.logstash:</span></span><br><span class=line>  <span class=attr>hosts:</span> <span class=string>["logstash:5044"]</span></span><br><span class=line><span class=comment>#output.console:</span></span><br><span class=line><span class=comment>#  pretty: true</span></span><br></pre></table></figure><h3 id=申请License><a href=#申请License class=headerlink title=申请License></a>申请License</h3><p>转到 <strong><em><a href=https://license.elastic.co/registration rel="external nofollow noopener noreferrer" target=_blank>License申请地址</a></em></strong> , 下载之后然后修改license中的<code>type</code>、<code>max_nodes</code>、<code>expiry_date_in_millis</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>&#123;</span><br><span class=line>  &quot;license&quot;: &#123;</span><br><span class=line>    &quot;uid&quot;: &quot;fe8c9a81-6651-4327-89a3-c9a33bfd8e3f&quot;,</span><br><span class=line>    &quot;type&quot;: &quot;platinum&quot;,  // 这个类型是白金会员</span><br><span class=line>    &quot;issue_date_in_millis&quot;: 1536883200000,</span><br><span class=line>    &quot;expiry_date_in_millis&quot;: 2855980923000, // 过期时间</span><br><span class=line>    &quot;max_nodes&quot;: 100,  // 集群节点数量</span><br><span class=line>    &quot;issued_to&quot;: &quot;xxxx&quot;,</span><br><span class=line>    &quot;issuer&quot;: &quot;Web Form&quot;,</span><br><span class=line>    &quot;signature&quot;: &quot;AAAAAwAAAA0imCa5T/HVBQyiUbSBAAABmC9ZN0hjZDBGYnVyRXpCOW5Bb3FjZDAxOWpSbTVoMVZwUzRxVk1PSmkxaktJRVl5MUYvUWh3bHZVUTllbXNPbzBUemtnbWpBbmlWRmRZb25KNFlBR2x0TXc2K2p1Y1VtMG1UQU9TRGZVSGRwaEJGUjE3bXd3LzRqZ05iLzRteWFNekdxRGpIYlFwYkJiNUs0U1hTVlJKNVlXekMrSlVUdFIvV0FNeWdOYnlESDc3MWhlY3hSQmdKSjJ2ZTcvYlBFOHhPQlV3ZHdDQ0tHcG5uOElCaDJ4K1hob29xSG85N0kvTWV3THhlQk9NL01VMFRjNDZpZEVXeUtUMXIyMlIveFpJUkk2WUdveEZaME9XWitGUi9WNTZVQW1FMG1DenhZU0ZmeXlZakVEMjZFT2NvOWxpZGlqVmlHNC8rWVVUYzMwRGVySHpIdURzKzFiRDl4TmM1TUp2VTBOUlJZUlAyV0ZVL2kvVk10L0NsbXNFYVZwT3NSU082dFNNa2prQ0ZsclZ4NTltbU1CVE5lR09Bck93V2J1Y3c9PQAAAQAWq5AoReLA+uTiRhQ8M0qYERXNidAAsVw0LeN5H7qRXFBAvB+rId4vZNj2DN5W5GuaxuiUhiytvV6maf4ArTsROCMUKGyO9RH24bYgnRbbf6MwB8EBHjSZ6+D8ysCVgfyqAAEKURGSMWszi2mR9R+DINtaeFJnb4B1GeAppbwl7qGGetAQm0vbF7ncyojIfjFthmMUomwo3vs0his5e3UPumItGc57LEk2s5gx95NNP8aFsJXSSFHgWDWwJs18XSl3NZItnEWNfy9lEJeAkR+LWISfizZIfViOTlcDBVGKR7w8u8D5QXFUVdsTi2XU5qfIWFb78BOtpCHIlU+AjB6m&quot;,</span><br><span class=line>    &quot;start_date_in_millis&quot;: 1536883200000</span><br><span class=line>  &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=启动ELK><a href=#启动ELK class=headerlink title=启动ELK></a>启动ELK</h3><p>在此之前, 官方提到了<code>vm.max_map_count</code>的值在生产环境最少要设置成262144, 设置的方式有两种:<ol><li><p>永久性的修改, 在<code>/etc/sysctl.conf</code>文件中添加一行:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>grep vm.max_map_count /etc/sysctl.conf # 查找当前的值。</span><br><span class=line></span><br><span class=line>vm.max_map_count=262144 # 修改或者新增</span><br></pre></table></figure><li><p>正在运行的机器:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>sysctl -w vm.max_map_count=262144</span><br></pre></table></figure></ol><p><code>docker-compose.yml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br></pre><td class=code><pre><span class=line><span class=attr>version:</span> <span class=string>'3'</span></span><br><span class=line><span class=attr>services:</span></span><br><span class=line>  <span class=attr>elk-elasticsearch:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>docker.elastic.co/elasticsearch/elasticsearch:6.4.0</span></span><br><span class=line><span class=comment>#    ports:</span></span><br><span class=line><span class=comment>#      - "9200:9200"</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>environment:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>discovery.type=single-node</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>ES_JAVA_OPTS=-Xms512m</span> <span class=string>-Xmx512m</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>./crack/x-pack-core-6.4.0.jar:/usr/share/elasticsearch/modules/x-pack-core/x-pack-core-6.4.0.jar</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>./config/license.json:/usr/share/elasticsearch/license.json</span></span><br><span class=line>    <span class=attr>deploy:</span></span><br><span class=line>      <span class=attr>placement:</span></span><br><span class=line>        <span class=attr>constraints:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>node.role</span> <span class=string>==</span> <span class=string>manager</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=string>elk-elasticsearch</span></span><br><span class=line></span><br><span class=line>  <span class=attr>kibana:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>docker.elastic.co/kibana/kibana:6.4.0</span></span><br><span class=line>    <span class=attr>ports:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"5601:5601"</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>deploy:</span></span><br><span class=line>      <span class=attr>placement:</span></span><br><span class=line>        <span class=attr>constraints:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>node.role</span> <span class=string>==</span> <span class=string>manager</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=string>kibana</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>./config/kibana.yml:/usr/share/kibana/config/kibana.yml</span></span><br><span class=line>    <span class=attr>depends_on:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>elk-elasticsearch</span></span><br><span class=line></span><br><span class=line>  <span class=attr>logstash:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>docker.elastic.co/logstash/logstash:6.4.0</span></span><br><span class=line><span class=comment>#    ports:</span></span><br><span class=line><span class=comment>#      - "4560:4560"</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>environment:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>LS_JAVA_OPTS=-Xmx512m</span> <span class=string>-Xms512m</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>./config/logstash.conf:/etc/logstash.conf</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>./config/logstash.yml:/usr/share/logstash/config/logstash.yml</span></span><br><span class=line>    <span class=attr>deploy:</span></span><br><span class=line>      <span class=attr>placement:</span></span><br><span class=line>        <span class=attr>constraints:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>node.role</span> <span class=string>==</span> <span class=string>manager</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=string>logstash</span></span><br><span class=line>    <span class=attr>depends_on:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>elk-elasticsearch</span></span><br><span class=line>    <span class=attr>entrypoint:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>logstash</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>-f</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>/etc/logstash.conf</span></span><br><span class=line>      </span><br><span class=line><span class=comment>#  filebeat:</span></span><br><span class=line><span class=comment>#    image: docker.elastic.co/beats/filebeat:7.1.1</span></span><br><span class=line><span class=comment>#    restart: always</span></span><br><span class=line><span class=comment>#    volumes:</span></span><br><span class=line><span class=comment>#      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro</span></span><br><span class=line><span class=comment>#      - /home/ybd/data/git-repo/bitbucket/central-city/cc-component/log4j2Logs:/log4j2Logs</span></span><br><span class=line><span class=comment>#    deploy:</span></span><br><span class=line><span class=comment>#      placement:</span></span><br><span class=line><span class=comment>#        constraints:</span></span><br><span class=line><span class=comment>#          - node.role == manager</span></span><br><span class=line><span class=comment>#    networks:</span></span><br><span class=line><span class=comment>#      backend:</span></span><br><span class=line><span class=comment>#        aliases:</span></span><br><span class=line><span class=comment>#          - filebeat</span></span><br><span class=line></span><br><span class=line><span class=comment># docker network create -d=overlay --attachable backend</span></span><br><span class=line><span class=comment># docker network create --opt encrypted -d=overlay --attachable --subnet 10.10.0.0/16 backend</span></span><br><span class=line><span class=attr>networks:</span></span><br><span class=line>  <span class=attr>backend:</span></span><br><span class=line>    <span class=attr>external:</span></span><br><span class=line>      <span class=attr>name:</span> <span class=string>backend</span></span><br></pre></table></figure><p>启动后需要手动请求更新License:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>docker-compose up -d</span><br><span class=line>docker exec $&#123;CONTAINER_NAME&#125; curl -XPUT &apos;http://0.0.0.0:9200/_xpack/license&apos; -H &quot;Content-Type: application/json&quot; -d @license.json</span><br></pre></table></figure><p>大概是下面这个样子:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line># ybd @ ybd-PC in ~/data/git-repo/bitbucket/ms-base/docker-compose/elk on git:master x [20:52:51] </span><br><span class=line>$ docker-compose up -d                                                   </span><br><span class=line></span><br><span class=line>Creating elk_elk-elasticsearch_1 ... done</span><br><span class=line></span><br><span class=line>Creating elk_elk-elasticsearch_1 ... </span><br><span class=line>Creating elk_logstash_1          ... done</span><br><span class=line>Creating elk_kibana_1            ... done</span><br><span class=line></span><br><span class=line># ybd @ ybd-PC in ~/data/git-repo/bitbucket/ms-base/docker-compose/elk on git:master x [20:53:58] </span><br><span class=line>$ docker exec elk_elk-elasticsearch_1 curl -XPUT &apos;http://0.0.0.0:9200/_xpack/license&apos; -H &quot;Content-Type: application/json&quot; -d @license.json</span><br><span class=line>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class=line>                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class=line>100  1278  100    46  100  1232    328   8786 --:--:-- --:--:-- --:--:--  8800</span><br><span class=line>&#123;&quot;acknowledged&quot;:true,&quot;license_status&quot;:&quot;valid&quot;&#125;</span><br></pre></table></figure><p><img src=https://cdn.yangbingdong.com/kibana-license.png alt><p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana02.png alt><h3 id=动态模板><a href=#动态模板 class=headerlink title=动态模板></a>动态模板</h3><p>我们可以自定义Logstash输出到ElasticSearch的Mapping.<p>logstash.conf 的 output 配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>output &#123;</span><br><span class=line>    # 输出到控制台</span><br><span class=line>    stdout&#123; codec =&gt; rubydebug &#125;</span><br><span class=line></span><br><span class=line>    # 输出到 Elasticsearch</span><br><span class=line>    elasticsearch &#123;</span><br><span class=line>        hosts  =&gt; [&quot;elk-elasticsearch:9200&quot;]</span><br><span class=line>        index  =&gt; &quot;logstash-%&#123;server_name&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class=line></span><br><span class=line>        template =&gt; &quot;/usr/share/logstash/config/logstash-template.json&quot;</span><br><span class=line>        template_name =&gt; &quot;logstash&quot; #映射模板的名字</span><br><span class=line>        template_overwrite =&gt; true</span><br><span class=line>    &#125;</span><br></pre></table></figure><p>配置模板:<p>logstash-template.json:<figure class="highlight json"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br></pre><td class=code><pre><span class=line>&#123;</span><br><span class=line>    <span class=attr>"template"</span>:<span class=string>"logstash-*"</span>,</span><br><span class=line>    <span class=attr>"settings"</span>:&#123;</span><br><span class=line>        <span class=attr>"index.number_of_shards"</span>:<span class=number>5</span>,</span><br><span class=line>        <span class=attr>"number_of_replicas"</span>:<span class=number>0</span></span><br><span class=line>    &#125;,</span><br><span class=line>    <span class=attr>"mappings"</span>:&#123;</span><br><span class=line>        <span class=attr>"dynamic_templates"</span>:[</span><br><span class=line>            &#123;</span><br><span class=line>                <span class=attr>"message_field"</span>:&#123;</span><br><span class=line>                    <span class=attr>"match"</span>:<span class=string>"content"</span>,</span><br><span class=line>                    <span class=attr>"match_mapping_type"</span>:<span class=string>"string"</span>,</span><br><span class=line>                    <span class=attr>"mapping"</span>:&#123;</span><br><span class=line>                        <span class=attr>"type"</span>:<span class=string>"text"</span></span><br><span class=line>                    &#125;</span><br><span class=line>                &#125;</span><br><span class=line>            &#125;,</span><br><span class=line>            &#123;</span><br><span class=line>                <span class=attr>"string_fields"</span>:&#123;</span><br><span class=line>                    <span class=attr>"match"</span>:<span class=string>"*"</span>,</span><br><span class=line>                    <span class=attr>"match_mapping_type"</span>:<span class=string>"string"</span>,</span><br><span class=line>                    <span class=attr>"mapping"</span>:&#123;</span><br><span class=line>                        <span class=attr>"type"</span>:<span class=string>"keyword"</span></span><br><span class=line>                    &#125;</span><br><span class=line>                &#125;</span><br><span class=line>            &#125;</span><br><span class=line>        ],</span><br><span class=line>        <span class=attr>"properties"</span>:&#123;</span><br><span class=line>            <span class=attr>"@timestamp"</span>:&#123;</span><br><span class=line>                <span class=attr>"type"</span>:<span class=string>"date"</span></span><br><span class=line>            &#125;,</span><br><span class=line>            <span class=attr>"@version"</span>:&#123;</span><br><span class=line>                <span class=attr>"type"</span>:<span class=string>"keyword"</span></span><br><span class=line>            &#125;,</span><br><span class=line>            <span class=attr>"geoip"</span>:&#123;</span><br><span class=line>                <span class=attr>"dynamic"</span>:<span class=literal>true</span>,</span><br><span class=line>                <span class=attr>"properties"</span>:&#123;</span><br><span class=line>                    <span class=attr>"ip"</span>:&#123;</span><br><span class=line>                        <span class=attr>"type"</span>:<span class=string>"ip"</span></span><br><span class=line>                    &#125;,</span><br><span class=line>                    <span class=attr>"location"</span>:&#123;</span><br><span class=line>                        <span class=attr>"type"</span>:<span class=string>"geo_point"</span></span><br><span class=line>                    &#125;,</span><br><span class=line>                    <span class=attr>"latitude"</span>:&#123;</span><br><span class=line>                        <span class=attr>"type"</span>:<span class=string>"float"</span></span><br><span class=line>                    &#125;,</span><br><span class=line>                    <span class=attr>"longitude"</span>:&#123;</span><br><span class=line>                        <span class=attr>"type"</span>:<span class=string>"float"</span></span><br><span class=line>                    &#125;</span><br><span class=line>                &#125;</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>docker-compose.yml 中添加配置文件的映射:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>logstash:</span><br><span class=line>  image: docker.elastic.co/logstash/logstash:7.1.1</span><br><span class=line>  #    ports:</span><br><span class=line>  #      - &quot;4560:4560&quot;</span><br><span class=line>  restart: always</span><br><span class=line>  environment:</span><br><span class=line>    - LS_JAVA_OPTS=-Xmx512m -Xms512m</span><br><span class=line>  volumes:</span><br><span class=line>    - ./logstash/logstash.conf:/etc/logstash.conf</span><br><span class=line>    - ./logstash/logstash.yml:/usr/share/logstash/config/logstash.yml</span><br><span class=line>    - ./elasticsearch/logstash-template.json:/usr/share/logstash/config/logstash-template.json</span><br></pre></table></figure><h2 id=Kibana相关设置><a href=#Kibana相关设置 class=headerlink title=Kibana相关设置></a>Kibana相关设置</h2><h3 id=显示所有插件><a href=#显示所有插件 class=headerlink title=显示所有插件></a>显示所有插件</h3><p>在Kibana首页最下面找到:<p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-full-plugin-button.png alt><h3 id=Discover每页显示行数><a href=#Discover每页显示行数 class=headerlink title=Discover每页显示行数></a>Discover每页显示行数</h3><p>找到Advanced Setting<img src=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-admin-setting.png alt><p>点进去找到 <code>discover:sampleSize</code>再点击Edit修改:<p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-page-size.png alt><h3 id=时区><a href=#时区 class=headerlink title=时区></a>时区</h3><p>Kibana默认读取浏览器时区, 可通过<code>dateFormat:tz</code>进行修改:<p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/kibana-timezone.png alt><h2 id=ElasticSearch-UI><a href=#ElasticSearch-UI class=headerlink title="ElasticSearch UI"></a>ElasticSearch UI</h2><ul><li><strong><em><a href=https://github.com/360EntSecGroup-Skylar/ElasticHD rel="external nofollow noopener noreferrer" target=_blank>ElasticHD</a></em></strong><li><strong><em><a href=https://github.com/appbaseio/dejavu/ rel="external nofollow noopener noreferrer" target=_blank>Dejavu</a></em></strong></ul><h1 id=Spring-Boot-集成-Elastic-APM><a href=#Spring-Boot-集成-Elastic-APM class=headerlink title="Spring Boot 集成 Elastic APM"></a>Spring Boot 集成 Elastic APM</h1><h2 id=运行APM-Server><a href=#运行APM-Server class=headerlink title="运行APM Server"></a>运行APM Server</h2><p><code>docker-compose</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre><td class=code><pre><span class=line><span class=attr>version:</span> <span class=string>'3'</span></span><br><span class=line><span class=attr>services:</span></span><br><span class=line>  <span class=attr>apm-server:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>docker.elastic.co/apm/apm-server:6.4.0</span></span><br><span class=line>    <span class=attr>ports:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"8200:8200"</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>    <span class=bullet>-</span> <span class=string>./config/apm-server.yml:/usr/share/apm-server/apm-server.yml</span></span><br><span class=line>    <span class=attr>deploy:</span></span><br><span class=line>      <span class=attr>placement:</span></span><br><span class=line>        <span class=attr>constraints:</span></span><br><span class=line>        <span class=bullet>-</span> <span class=string>node.role</span> <span class=string>==</span> <span class=string>manager</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=attr>backend-swarm:</span></span><br><span class=line>        <span class=attr>aliases:</span></span><br><span class=line>          <span class=bullet>-</span> <span class=string>apm-server</span></span><br><span class=line></span><br><span class=line><span class=comment># docker network create -d=overlay --attachable backend-swarm</span></span><br><span class=line><span class=comment># docker network create --opt encrypted -d=overlay --attachable --subnet 10.10.0.0/16 backend-swarm</span></span><br><span class=line><span class=attr>networks:</span></span><br><span class=line>  <span class=attr>backend-swarm:</span></span><br><span class=line>    <span class=attr>external:</span></span><br><span class=line>      <span class=attr>name:</span> <span class=string>backend-swarm</span></span><br></pre></table></figure><p><code>apm-server.yml</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br></pre><td class=code><pre><span class=line>apm-server:</span><br><span class=line>  host: &quot;0.0.0.0:8200&quot;</span><br><span class=line></span><br><span class=line>setup.template.settings:</span><br><span class=line></span><br><span class=line>  index:</span><br><span class=line>    number_of_shards: 1</span><br><span class=line>    codec: best_compression</span><br><span class=line>    </span><br><span class=line>output.elasticsearch:</span><br><span class=line>  hosts: [&quot;elk-elasticsearch:9200&quot;]</span><br><span class=line></span><br><span class=line>  indices:</span><br><span class=line>  - index: &quot;apm-%&#123;[beat.version]&#125;-sourcemap&quot;</span><br><span class=line>    when.contains:</span><br><span class=line>      processor.event: &quot;sourcemap&quot;</span><br><span class=line></span><br><span class=line>  - index: &quot;apm-%&#123;[beat.version]&#125;-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class=line>    when.contains:</span><br><span class=line>      processor.event: &quot;error&quot;</span><br><span class=line></span><br><span class=line>  - index: &quot;apm-%&#123;[beat.version]&#125;-transaction-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class=line>    when.contains:</span><br><span class=line>      processor.event: &quot;transaction&quot;</span><br><span class=line></span><br><span class=line>  - index: &quot;apm-%&#123;[beat.version]&#125;-span-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class=line>    when.contains:</span><br><span class=line>      processor.event: &quot;span&quot;</span><br><span class=line></span><br><span class=line>  - index: &quot;apm-%&#123;[beat.version]&#125;-metric-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class=line>    when.contains:</span><br><span class=line>      processor.event: &quot;metric&quot;</span><br><span class=line></span><br><span class=line>  - index: &quot;apm-%&#123;[beat.version]&#125;-onboarding-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class=line>    when.contains:</span><br><span class=line>      processor.event: &quot;onboarding&quot;</span><br><span class=line></span><br><span class=line>logging.level: warning</span><br><span class=line></span><br><span class=line>logging.metrics.enabled: false</span><br></pre></table></figure><p>这个配置文件从容器中<code>/usr/share/apm-server/apm-server.yml</code>复制出来稍微改了一下Elasticsearch的Url.<p>若开启了X-Pack, 则需要在yml中配置帐号密码:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>output.elasticsearch:</span><br><span class=line>    hosts: [&quot;&lt;es_url&gt;&quot;]</span><br><span class=line>    username: &lt;username&gt;</span><br><span class=line>    password: &lt;password&gt;</span><br></pre></table></figure><h2 id=集成到Spring-Boot><a href=#集成到Spring-Boot class=headerlink title="集成到Spring Boot"></a>集成到Spring Boot</h2><p>下载 <strong><em><a href=http://search.maven.org/#search%7Cga%7C1%7Ca%3Aelastic-apm-agent rel="external nofollow noopener noreferrer" target=_blank>APM代理依赖</a></em></strong><p>在启动参数中添加:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>java -javaagent:/path/to/elastic-apm-agent-&lt;version&gt;.jar \</span><br><span class=line>     -Delastic.apm.service_name=my-application \</span><br><span class=line>     -Delastic.apm.server_url=http://localhost:8200 \ </span><br><span class=line>     -Delastic.apm.application_packages=org.example \ </span><br><span class=line>     -jar my-application.jar</span><br></pre></table></figure><p>启动后在Kibana的APM模块中更新一下索引, 效果图大概是这样的:<p><img src=https://cdn.yangbingdong.com/img/docker-logs-collect/apm.png alt><h1 id=log-pilot><a href=#log-pilot class=headerlink title=log-pilot></a>log-pilot</h1><p>Github: <strong><em><a href=https://github.com/AliyunContainerService/log-pilot rel="external nofollow noopener noreferrer" target=_blank>https://github.com/AliyunContainerService/log-pilot</a></em></strong><p>更多说明: <strong><em><a href=https://yq.aliyun.com/articles/69382 rel="external nofollow noopener noreferrer" target=_blank>https://yq.aliyun.com/articles/69382</a></em></strong><p>这个是Ali开源的日志收集组件, 通过中间件的方式部署, 自动监听其他容器的日志, 非常方便:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock -v /etc/localtime:/etc/localtime -v /:/host -e PILOT_TYPE=fluentd -e FLUENTD_OUTPUT=elasticsearch -e ELASTICSEARCH_HOST=192.168.6.113 -e ELASTICSEARCH_PORT=9200 -e TZ=Asia/Chongqing --privileged registry.cn-hangzhou.aliyuncs.com/acs-sample/log-pilot:latest</span><br></pre></table></figure><p>需要手机日志的容器:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker run --rm --label aliyun.logs.demo=stdout -p 8080:8080 192.168.0.202:8080/dev-images/demo:latest</span><br></pre></table></figure><ul><li>通过<code>--label aliyun.logs.demo=stdout</code>告诉<code>log-pilot</code>需要收集日志, 索引为<code>demo</code></ul><p>然后打开Kibana就可以看到日志了.<p>问题:<ul><li>日志稍微延迟<li>日志顺序混乱<li>异常堆栈不集中</ul><h1 id=Finally><a href=#Finally class=headerlink title=Finally></a>Finally</h1><blockquote><p>参考:<p><strong><em><a href=https://www.yinchengli.com/2016/09/16/logstash/ rel="external nofollow noopener noreferrer" target=_blank>https://www.yinchengli.com/2016/09/16/logstash/</a></em></strong><p><strong><em><a href=https://www.jianshu.com/p/ba1aa0c52942 rel="external nofollow noopener noreferrer" target=_blank>https://www.jianshu.com/p/ba1aa0c52942</a></em></strong><p><strong><em><a href=https://www.jianshu.com/p/eb10c414a93f rel="external nofollow noopener noreferrer" target=_blank>https://www.jianshu.com/p/eb10c414a93f</a></em></strong><p><strong><em><a href=https://my.oschina.net/kkrgwbj/blog/734530 rel="external nofollow noopener noreferrer" target=_blank>https://my.oschina.net/kkrgwbj/blog/734530</a></em></strong></blockquote></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2018/spring-boot-docker-elk/ title="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志">http://yangbingdong.com/2018/spring-boot-docker-elk/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a>
<a href=/tags/Spring/ rel=tag><i class="fa fa-tag"></i>Spring</a>
<a href=/tags/Docker/ rel=tag><i class="fa fa-tag"></i>Docker</a>
<a href=/tags/Elasticsearch/ rel=tag><i class="fa fa-tag"></i>Elasticsearch</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2018/write-your-own-blockchain/ rel=next title=转载—自己动手写区块链><i class="fa fa-chevron-left"></i>转载—自己动手写区块链</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2018/spring-cloud-stack-learning/ rel=prev title="Spring Cloud Stack Learning">Spring Cloud Stack Learning <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2018/spring-boot-docker-elk/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2018/spring-boot-docker-elk/';this.page.identifier='2018/spring-boot-docker-elk/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>50</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>19</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>48</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Log4j2-Related><span class=nav-number>2.</span> <span class=nav-text>Log4j2 Related</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#使用Log4j2><span class=nav-number>2.1.</span> <span class=nav-text>使用Log4j2</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Maven配置><span class=nav-number>2.1.1.</span> <span class=nav-text>Maven配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#开启全局异步以及Disruptor参数设置><span class=nav-number>2.1.2.</span> <span class=nav-text>开启全局异步以及Disruptor参数设置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#系统时钟参数><span class=nav-number>2.1.3.</span> <span class=nav-text>系统时钟参数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Log4j-环境变量配置文件><span class=nav-number>2.1.4.</span> <span class=nav-text>Log4j 环境变量配置文件</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#application-yml简单配置><span class=nav-number>2.1.5.</span> <span class=nav-text>application.yml简单配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#log4j2-xml-详细配置><span class=nav-number>2.1.6.</span> <span class=nav-text>log4j2.xml 详细配置</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#输出到-Kafka><span class=nav-number>2.1.6.1.</span> <span class=nav-text>输出到 Kafka</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#输出到文件><span class=nav-number>2.1.6.2.</span> <span class=nav-text>输出到文件</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#也可以使用log4j2-yml><span class=nav-number>2.1.7.</span> <span class=nav-text>也可以使用log4j2.yml</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#日志配置文件中获取Application配置><span class=nav-number>2.2.</span> <span class=nav-text>日志配置文件中获取Application配置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Logback><span class=nav-number>2.2.1.</span> <span class=nav-text>Logback</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Log4j2><span class=nav-number>2.2.2.</span> <span class=nav-text>Log4j2</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#自定义字段><span class=nav-number>2.3.</span> <span class=nav-text>自定义字段</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Boot-Docker-Integration><span class=nav-number>3.</span> <span class=nav-text>Spring Boot Docker Integration</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#准备工作><span class=nav-number>3.1.</span> <span class=nav-text>准备工作</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#安全认证配置><span class=nav-number>3.2.</span> <span class=nav-text>安全认证配置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#普通配置><span class=nav-number>3.2.1.</span> <span class=nav-text>普通配置</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Maven-密码加密配置><span class=nav-number>3.2.2.</span> <span class=nav-text>Maven 密码加密配置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#构建基础镜像><span class=nav-number>3.3.</span> <span class=nav-text>构建基础镜像</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#开始集成><span class=nav-number>3.4.</span> <span class=nav-text>开始集成</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#编写Dockerfile><span class=nav-number>3.4.1.</span> <span class=nav-text>编写Dockerfile</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#注意PID><span class=nav-number>3.4.1.1.</span> <span class=nav-text>注意PID</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#pom文件添加构建Docker镜像的相关插件><span class=nav-number>3.4.2.</span> <span class=nav-text>pom文件添加构建Docker镜像的相关插件</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#spring-boot-maven-plugin><span class=nav-number>3.4.2.1.</span> <span class=nav-text>spring-boot-maven-plugin</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#maven-resources-plugin><span class=nav-number>3.4.2.2.</span> <span class=nav-text>maven-resources-plugin</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#build-helper-maven-plugin><span class=nav-number>3.4.2.3.</span> <span class=nav-text>build-helper-maven-plugin</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#docker-maven-plugin><span class=nav-number>3.4.2.4.</span> <span class=nav-text>docker-maven-plugin</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#命令构建><span class=nav-number>3.4.3.</span> <span class=nav-text>命令构建</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#运行Docker><span class=nav-number>3.4.4.</span> <span class=nav-text>运行Docker</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#普通运行><span class=nav-number>3.4.4.1.</span> <span class=nav-text>普通运行</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Docker-Swarm-运行><span class=nav-number>3.4.4.2.</span> <span class=nav-text>Docker Swarm 运行</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#添加运行时JVM参数><span class=nav-number>3.4.5.</span> <span class=nav-text>添加运行时JVM参数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#其他的Docker构建工具><span class=nav-number>3.4.6.</span> <span class=nav-text>其他的Docker构建工具</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Jib><span class=nav-number>3.4.6.1.</span> <span class=nav-text>Jib</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Dockerfile-Maven><span class=nav-number>3.4.6.2.</span> <span class=nav-text>Dockerfile Maven</span></a></ol></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Docker-Swarm环境下获取ClientIp><span class=nav-number>3.5.</span> <span class=nav-text>Docker Swarm环境下获取ClientIp</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#服务注册IP问题><span class=nav-number>3.6.</span> <span class=nav-text>服务注册IP问题</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Demo地址><span class=nav-number>3.7.</span> <span class=nav-text>Demo地址</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Kafka、ELK-collect-logs><span class=nav-number>4.</span> <span class=nav-text>Kafka、ELK collect logs</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#镜像准备><span class=nav-number>4.1.</span> <span class=nav-text>镜像准备</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#启动Kafka与Zookeeper><span class=nav-number>4.2.</span> <span class=nav-text>启动Kafka与Zookeeper</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#ELK配置以及启动><span class=nav-number>4.3.</span> <span class=nav-text>ELK配置以及启动</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#X-Pack-破解><span class=nav-number>4.3.1.</span> <span class=nav-text>X-Pack 破解</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#复制Jar包><span class=nav-number>4.3.1.1.</span> <span class=nav-text>复制Jar包</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#反编译并修改源码><span class=nav-number>4.3.1.2.</span> <span class=nav-text>反编译并修改源码</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#配置文件><span class=nav-number>4.3.2.</span> <span class=nav-text>配置文件</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#Elasticsearch><span class=nav-number>4.3.2.1.</span> <span class=nav-text>Elasticsearch</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Logstash><span class=nav-number>4.3.2.2.</span> <span class=nav-text>Logstash</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Kafka-Input><span class=nav-number>4.3.2.2.1.</span> <span class=nav-text>Kafka Input</span></a><li class="nav-item nav-level-5"><a class=nav-link href=#Filebeat-Input><span class=nav-number>4.3.2.2.2.</span> <span class=nav-text>Filebeat Input</span></a></ol><li class="nav-item nav-level-4"><a class=nav-link href=#Kibana><span class=nav-number>4.3.2.3.</span> <span class=nav-text>Kibana</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#Filebeat><span class=nav-number>4.3.2.4.</span> <span class=nav-text>Filebeat</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#申请License><span class=nav-number>4.3.3.</span> <span class=nav-text>申请License</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#启动ELK><span class=nav-number>4.3.4.</span> <span class=nav-text>启动ELK</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#动态模板><span class=nav-number>4.3.5.</span> <span class=nav-text>动态模板</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Kibana相关设置><span class=nav-number>4.4.</span> <span class=nav-text>Kibana相关设置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#显示所有插件><span class=nav-number>4.4.1.</span> <span class=nav-text>显示所有插件</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Discover每页显示行数><span class=nav-number>4.4.2.</span> <span class=nav-text>Discover每页显示行数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#时区><span class=nav-number>4.4.3.</span> <span class=nav-text>时区</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#ElasticSearch-UI><span class=nav-number>4.5.</span> <span class=nav-text>ElasticSearch UI</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Boot-集成-Elastic-APM><span class=nav-number>5.</span> <span class=nav-text>Spring Boot 集成 Elastic APM</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#运行APM-Server><span class=nav-number>5.1.</span> <span class=nav-text>运行APM Server</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#集成到Spring-Boot><span class=nav-number>5.2.</span> <span class=nav-text>集成到Spring Boot</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#log-pilot><span class=nav-number>6.</span> <span class=nav-text>log-pilot</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Finally><span class=nav-number>7.</span> <span class=nav-text>Finally</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共290.0k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2018/spring-boot-docker-elk/';var disqus_title="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>