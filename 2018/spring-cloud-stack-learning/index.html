<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Spring Cloud,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface Spring Cloud 是一系列框架的有序集合. 它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发, 如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等, 都可以用 Spring Boot 的开发风格做到一键启动和部署. Spring 并没有重复制造轮子, 它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来, 通过"><meta name=keywords content="Java,Spring Cloud"><meta property=og:type content=article><meta property=og:title content="Spring Cloud Stack Learning"><meta property=og:url content=http://yangbingdong.com/2018/spring-cloud-stack-learning/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface Spring Cloud 是一系列框架的有序集合. 它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发, 如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等, 都可以用 Spring Boot 的开发风格做到一键启动和部署. Spring 并没有重复制造轮子, 它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来, 通过"><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-cloud-stack.jpg><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/portainer-eureka.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/compose-up03.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/cnm-demo.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/docker-pid1.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/eureka-ui.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/eureka-custom.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/micro-rpc.jpg><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-cloud-gateway-flow.jpg><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-boot-admin.png><meta property=og:updated_time content=2020-04-07T10:15:47.014Z><meta name=twitter:card content=summary><meta name=twitter:title content="Spring Cloud Stack Learning"><meta name=twitter:description content="Preface Spring Cloud 是一系列框架的有序集合. 它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发, 如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等, 都可以用 Spring Boot 的开发风格做到一键启动和部署. Spring 并没有重复制造轮子, 它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来, 通过"><meta name=twitter:image content=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-cloud-stack.jpg><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2018/spring-cloud-stack-learning/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Spring Cloud Stack Learning | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2018/spring-cloud-stack-learning/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Spring Cloud Stack Learning</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2018-06-09T16:55:08+08:00>2018-06-09</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/Spring-Cloud/ itemprop=url rel=index><span itemprop=name>Spring Cloud</span></a></span></span>
<span id=/2018/spring-cloud-stack-learning/ class=leancloud_visitors data-flag-title="Spring Cloud Stack Learning"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>3,583字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>18分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-cloud-stack.jpg alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>Spring Cloud 是一系列框架的有序集合. 它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发, 如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等, 都可以用 Spring Boot 的开发风格做到一键启动和部署. Spring 并没有重复制造轮子, 它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来, 通过 Spring Boot 风格进行再封装屏蔽掉了复杂的配置和实现原理, 最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包.<p>至于各种框架组件的相关概念以及入门教程网上一大把, 此篇博文主要记录个人在使用Spring Cloud构建微服务的一些配置以及踩坑…<p>集成Docker部分请看 <strong><em><a href=/2018/spring-boot-docker-elk/>Spring Boot Docker Integration</a></em></strong></blockquote><a id=more></a><h1 id=Eureka><a href=#Eureka class=headerlink title=Eureka></a>Eureka</h1><blockquote><p>Eureka是Netflix开发的服务发现组件, 本身是一个基于REST的服务. Spring Cloud将它集成在其子项目<code>spring-cloud-netflix</code>中, 以实现Spring Cloud的服务发现功能.</blockquote><h2 id=单节点><a href=#单节点 class=headerlink title=单节点></a>单节点</h2><h3 id=核心依赖><a href=#核心依赖 class=headerlink title=核心依赖></a>核心依赖</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>&lt;!-- Base认证需要, 前端账户密码登陆 --&gt;</span><br><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br></pre></table></figure><h3 id=application-yml><a href=#application-yml class=headerlink title=application.yml></a><code>application.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br></pre><td class=code><pre><span class=line>spring:</span><br><span class=line>  application:</span><br><span class=line>    name: discovery</span><br><span class=line>  profiles:</span><br><span class=line>    active: single</span><br><span class=line>  security:  ## http base security 帐号密码</span><br><span class=line>    user:</span><br><span class=line>      name: ybd</span><br><span class=line>      password: ybd</span><br><span class=line>eureka:</span><br><span class=line>  client: # 以下两项默认为true</span><br><span class=line>    fetch-registry: true</span><br><span class=line>    register-with-eureka: true</span><br><span class=line>  instance:</span><br><span class=line>    prefer-ip-address: true</span><br><span class=line>    ip-address: $&#123;eureka.instance.hostname&#125;</span><br><span class=line>    instance-id: $&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;</span><br><span class=line></span><br><span class=line>management: # 暴露所有端点, Spring Boot Admin监控使用</span><br><span class=line>  endpoints:</span><br><span class=line>    web:</span><br><span class=line>      exposure:</span><br><span class=line>        include: &quot;*&quot;</span><br><span class=line>  endpoint:</span><br><span class=line>    health:</span><br><span class=line>      show-details: ALWAYS</span><br></pre></table></figure><ul><li><code>eureka.client.register-with-eureka</code>: 表示是否将自己注册到 Eureka Server, 默认为 true.<li><code>eureka.client.fetch-registry</code>: 表示是否从 Eureka Server 获取注册信息, 默认为 true.<li><code>eureka.client.service-url.defaultZone</code>: 设置与 Eureka Server 交互的地址, 查询服务和注册服务都需要依赖这个地址. 默认是 <a href=http://localhost:8761/eureka rel="external nofollow noopener noreferrer" target=_blank>http://localhost:8761/eureka</a> ；多个地址可使用英文逗号（,）分隔.</ul><h3 id=application-single-yml><a href=#application-single-yml class=headerlink title=application-single.yml></a><code>application-single.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>server:</span><br><span class=line>  port: 8761</span><br><span class=line>eureka:</span><br><span class=line>  environment: dev</span><br><span class=line>  instance:</span><br><span class=line>    hostname: localhost</span><br><span class=line>    prefer-ip-address: false</span><br><span class=line>    metadata-map:  # 由于配置了安全认证, Spring Boot Admin 通过拿到此信息获取Eureka的端点信息</span><br><span class=line>      user.name: ybd</span><br><span class=line>      user.password: ybd</span><br><span class=line>  client: </span><br><span class=line>    fetch-registry: false</span><br><span class=line>    register-with-eureka: true</span><br><span class=line>    service-url:</span><br><span class=line>      defaultZone: http://ybd:ybd@$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br><span class=line>  server:</span><br><span class=line>    enable-self-preservation: false  # 禁用保护模式</span><br><span class=line>    eviction-interval-timer-in-ms: 15000</span><br></pre></table></figure><h3 id=Security配置><a href=#Security配置 class=headerlink title=Security配置></a>Security配置</h3><p>开启<code>basic</code>的认证需要添加依赖:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>&lt;dependency&gt;</span><br><span class=line>  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br></pre></table></figure><p>配置类:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>@EnableWebSecurity</span><br><span class=line>class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class=line></span><br><span class=line>	private static final String EUREKA = &quot;/eureka/**&quot;;</span><br><span class=line></span><br><span class=line>	@Override</span><br><span class=line>	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class=line>		http.csrf().ignoringAntMatchers(EUREKA);</span><br><span class=line>		super.configure(http);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=Docker构建HA-Eureka-Server><a href=#Docker构建HA-Eureka-Server class=headerlink title="Docker构建HA Eureka Server"></a>Docker构建HA Eureka Server</h2><p><strong>基于Compose运行高可用的Eureka</strong><h3 id=application-yml-1><a href=#application-yml-1 class=headerlink title=application.yml></a><code>application.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br></pre><td class=code><pre><span class=line>spring:</span><br><span class=line>  application:</span><br><span class=line>    name: discovery</span><br><span class=line>  profiles:</span><br><span class=line>    active: single</span><br><span class=line>  security:  # 安全认证帐号密码</span><br><span class=line>    user:</span><br><span class=line>      name: ybd </span><br><span class=line>      password: ybd</span><br><span class=line>  cloud:  # 忽略以下网卡</span><br><span class=line>    inetutils:</span><br><span class=line>      ignored-interfaces:</span><br><span class=line>      - eth0</span><br><span class=line>      - eth1</span><br><span class=line>      - eth2</span><br><span class=line>      - eth3</span><br><span class=line>      - lo</span><br><span class=line>eureka:</span><br><span class=line>  environment: prod # 在Eureka控制面板中显示prod环境</span><br><span class=line>  client:  # 以下两项默认为true</span><br><span class=line>    fetch-registry: true</span><br><span class=line>    register-with-eureka: true # 注册自己</span><br><span class=line>  instance:</span><br><span class=line>    prefer-ip-address: true</span><br><span class=line>    ip-address: $&#123;eureka.instance.hostname&#125;</span><br><span class=line>    instance-id: $&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;</span><br><span class=line></span><br><span class=line>management:  # Spring Boot Admin 使用的端点</span><br><span class=line>  endpoints:</span><br><span class=line>    web:</span><br><span class=line>      exposure:</span><br><span class=line>        include: &quot;*&quot;</span><br><span class=line>  endpoint:</span><br><span class=line>    health:</span><br><span class=line>      show-details: ALWAYS</span><br></pre></table></figure><h3 id=application-cluster1-yml><a href=#application-cluster1-yml class=headerlink title=application-cluster1.yml></a><code>application-cluster1.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>server:</span><br><span class=line>  port: 8761</span><br><span class=line>eureka:</span><br><span class=line>  instance:</span><br><span class=line>    prefer-ip-address: true  # 优先使用ip</span><br><span class=line>    ip-address: eureka-cluster1 # ip地址, 这里对应的是docker compose文件中的网络别名aliases</span><br><span class=line>    instance-id: $&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;</span><br><span class=line>    metadata-map:  # spring boot admin 会通过eureka读取该信息从而通过认证拿到相关服务发现信息</span><br><span class=line>      user.name: ybd</span><br><span class=line>      user.password: ybd</span><br><span class=line>  client:</span><br><span class=line>    service-url:</span><br><span class=line>      defaultZone: http://ybd:ybd@eureka-cluster2:8762/eureka/,http://ybd:ybd@eureka-cluster3:8763/eureka/</span><br><span class=line>  server:</span><br><span class=line>    enable-self-preservation: false # 关闭自我保护模式</span><br></pre></table></figure><h3 id=application-cluster2-yml><a href=#application-cluster2-yml class=headerlink title=application-cluster2.yml></a><code>application-cluster2.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>server:</span><br><span class=line>  port: 8762</span><br><span class=line>eureka:</span><br><span class=line>  instance:</span><br><span class=line>    prefer-ip-address: true  # 优先使用ip</span><br><span class=line>    ip-address: eureka-cluster2 # ip地址, 这里对应的是docker compose文件中的网络alias</span><br><span class=line>    metadata-map:</span><br><span class=line>      user.name: ybd</span><br><span class=line>      user.password: ybd</span><br><span class=line>  client:</span><br><span class=line>    service-url:</span><br><span class=line>      defaultZone: http://ybd:ybd@eureka-cluster1:8761/eureka/,http://ybd:ybd@eureka-cluster3:8763/eureka/</span><br><span class=line>  server:</span><br><span class=line>    enable-self-preservation: false</span><br></pre></table></figure><h3 id=application-cluster3-yml><a href=#application-cluster3-yml class=headerlink title=application-cluster3.yml></a><code>application-cluster3.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre><td class=code><pre><span class=line>server:</span><br><span class=line>  port: 8763</span><br><span class=line>eureka:</span><br><span class=line>  instance:</span><br><span class=line>    prefer-ip-address: true  # 优先使用ip</span><br><span class=line>    ip-address: eureka-cluster3 # ip地址, 这里对应的是docker compose文件中的网络alias</span><br><span class=line>    metadata-map:</span><br><span class=line>      user.name: ybd</span><br><span class=line>      user.password: ybd</span><br><span class=line>  client:</span><br><span class=line>    service-url:</span><br><span class=line>      defaultZone: http://ybd:ybd@eureka-cluster1:8761/eureka/,http://ybd:ybd@eureka-cluster2:8762/eureka/</span><br><span class=line>  server:</span><br><span class=line>    enable-self-preservation: false</span><br></pre></table></figure><h3 id=docker-compose-yml><a href=#docker-compose-yml class=headerlink title=docker-compose.yml></a><code>docker-compose.yml</code></h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br></pre><td class=code><pre><span class=line>version: &apos;3.4&apos;</span><br><span class=line>services:</span><br><span class=line>  eureka-cluster1:</span><br><span class=line>    image: eureka-cluster:latest</span><br><span class=line>    environment:</span><br><span class=line>      - ACTIVE=cluster1</span><br><span class=line>      - JAVA_OPTS=-Xms512m -Xmx512m</span><br><span class=line>    ports:</span><br><span class=line>      - 8761:8761</span><br><span class=line>    restart: always</span><br><span class=line>    healthcheck:</span><br><span class=line>      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://ybd:ybd@localhost:8761/actuator/health&quot;]</span><br><span class=line>      interval: 30s</span><br><span class=line>      timeout: 10s</span><br><span class=line>      retries: 3</span><br><span class=line>      start_period: 15s</span><br><span class=line>    deploy:</span><br><span class=line>      placement:</span><br><span class=line>        constraints:</span><br><span class=line>        - node.hostname == node1</span><br><span class=line>    networks:</span><br><span class=line>      backend:</span><br><span class=line>        aliases:</span><br><span class=line>          - eureka-cluster1</span><br><span class=line>          </span><br><span class=line>  eureka-cluster2:</span><br><span class=line>    image: eureka-cluster:latest</span><br><span class=line>    environment:</span><br><span class=line>      - ACTIVE=cluster2</span><br><span class=line>      - JAVA_OPTS=-Xms512m -Xmx512m</span><br><span class=line>    ports:</span><br><span class=line>      - 8762:8762</span><br><span class=line>    restart: always</span><br><span class=line>    healthcheck:</span><br><span class=line>      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://ybd:ybd@localhost:8762/actuator/health&quot;]</span><br><span class=line>      interval: 30s</span><br><span class=line>      timeout: 10s</span><br><span class=line>      retries: 3</span><br><span class=line>      start_period: 15s</span><br><span class=line>    deploy:</span><br><span class=line>      placement:</span><br><span class=line>        constraints:</span><br><span class=line>        - node.hostname == node2</span><br><span class=line>    networks:</span><br><span class=line>      backend:</span><br><span class=line>        aliases:</span><br><span class=line>          - eureka-cluster2</span><br><span class=line>          </span><br><span class=line>  eureka-cluster3:</span><br><span class=line>    image: eureka-cluster:latest</span><br><span class=line>    environment:</span><br><span class=line>      - ACTIVE=cluster3</span><br><span class=line>      - JAVA_OPTS=-Xms512m -Xmx512m</span><br><span class=line>    ports:</span><br><span class=line>      - 8763:8763</span><br><span class=line>    restart: always</span><br><span class=line>    healthcheck:</span><br><span class=line>      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://ybd:ybd@localhost:8763/actuator/health&quot;]</span><br><span class=line>      interval: 30s</span><br><span class=line>      timeout: 10s</span><br><span class=line>      retries: 3</span><br><span class=line>      start_period: 15s</span><br><span class=line>    deploy:</span><br><span class=line>      placement:</span><br><span class=line>        constraints:</span><br><span class=line>        - node.hostname == node3</span><br><span class=line>    networks:</span><br><span class=line>      backend:</span><br><span class=line>        aliases:</span><br><span class=line>          - eureka-cluster3</span><br><span class=line></span><br><span class=line>networks:</span><br><span class=line>  backend:</span><br><span class=line>    external:</span><br><span class=line>      name: backend</span><br></pre></table></figure><h3 id=Docker-Compose启动><a href=#Docker-Compose启动 class=headerlink title="Docker Compose启动"></a>Docker Compose启动</h3><p>启动前确保创建好了网络:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>docker network create -d=overlay --attachable --subnet 10.10.0.0/16 backend</span><br><span class=line>docker-compse up -d</span><br></pre></table></figure><p>此时在<code>Portainer</code>中可以看到三个容器已经启动:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/portainer-eureka.png alt><p>随意一个eureka端口都能看到另外两个服务:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/compose-up03.png alt><h3 id=Docker-Swarm启动><a href=#Docker-Swarm启动 class=headerlink title="Docker Swarm启动"></a>Docker Swarm启动</h3><p>由于目前使用stack方式启动是无法加载<code>env_file</code>的, 所以需要预先加载一下:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>export $(cat .env) &amp;&amp; docker stack deploy --compose-file=docker-compose.yml eureka-stack</span><br></pre></table></figure><p>我们的app通过合适的<code>network</code>交互应该是这样的:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/cnm-demo.png alt><h4 id=注意事项（ip与hostname混乱）><a href=#注意事项（ip与hostname混乱） class=headerlink title=注意事项（ip与hostname混乱）></a>注意事项（ip与hostname混乱）</h4><p>之前使用Docker Compose方式启动服务没什么问题, 后来换成Docker Swarm方式启动, 在Eureka的面板中发现有些服务是ip, 有些是hostname, 但都注册成功, 不过某些服务相互之间又访问不了. Google一番后的解决方案:<p>Server端跟Client端都使用以下配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line>spring:</span><br><span class=line>  cloud:  </span><br><span class=line>    inetutils:</span><br><span class=line>      ignored-interfaces:</span><br><span class=line>      - eth0</span><br><span class=line>      - eth1</span><br><span class=line>      - eth2</span><br><span class=line>      - eth3</span><br><span class=line>      - lo</span><br><span class=line>      </span><br><span class=line>eureka:</span><br><span class=line>  instance:</span><br><span class=line>    prefer-ip-address: true</span><br><span class=line>    ip-address: eureka-cluster1 # 这里对应上面compose文件中的aliases</span><br><span class=line>    instance-id: $&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;</span><br></pre></table></figure><h3 id=踩坑-容器中服务下线无法向注册中心注销服务><a href=#踩坑-容器中服务下线无法向注册中心注销服务 class=headerlink title=踩坑(容器中服务下线无法向注册中心注销服务)></a>踩坑(容器中服务下线无法向注册中心注销服务)</h3><p>在Docker中程序, 如果PID不是1, 是接收不到<code>docker-compose down</code>发出的<code>sigterm</code>信号从而导致只能等待被Kill, 不能向注册中心注销.<p>解决方法是在<code>Dockerfile</code>中的入口使用<code>ENTRYPOINT exec java -jar ...</code>这种方式<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/docker-pid1.png alt><h3 id=Eureka-Edgware-RELEASE版本注册优化><a href=#Eureka-Edgware-RELEASE版本注册优化 class=headerlink title="Eureka Edgware.RELEASE版本注册优化"></a>Eureka Edgware.RELEASE版本注册优化</h3><p>在<code>Edgware.RELEASE</code>版本中相比之前的步骤, 省略了在主函数上添加<code>@EnableDiscoveryClient</code>注解这一过程. Spring Cloud默认认为客户端是要完成向注册中心进行注册的.<ul><li>添加对应的<code>pom</code>依赖.<li><code>properties</code>文件进行配置</ul><p><strong>添加pom依赖</strong><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>&lt;dependency&gt;</span><br><span class=line>   &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=line>   &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br></pre></table></figure><p><strong>properties文件进行配置</strong><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>spring.application.name=EUREKA-CLIENT</span><br><span class=line>eureka.client.service-url.defaultZone=http://localhost:8761/eureka</span><br></pre></table></figure><p>启动Eureka Client客户端, 访问<a href=http://localhost:8761/eureka rel="external nofollow noopener noreferrer" target=_blank>http://localhost:8761/eureka</a><br>可以看到EUEREKA-CLIENT已经注册到Eureka Server服务上了.<h3 id=关闭自动注册功能><a href=#关闭自动注册功能 class=headerlink title=关闭自动注册功能></a><strong>关闭自动注册功能</strong></h3><p>Spring Cloud提供了一个参数, 该参数的作用是控制是否要向Eureka Server发起注册. 具体参数为:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>//默认为true,如果控制不需要向Eureka Server发起注册将该值设置为false.</span><br><span class=line>spring.cloud.service-registry.auto-registration.enabled = xxx</span><br></pre></table></figure><p>可以在<strong>JUnit测试</strong>中通过该变量关闭服务发现:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>@BeforeClass</span><br><span class=line>public static void beforeClass() &#123;</span><br><span class=line>	System.setProperty(&quot;spring.cloud.service-registry.auto-registration.enabled&quot;, &quot;false&quot;);</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=Eureka的自我保护模式><a href=#Eureka的自我保护模式 class=headerlink title=Eureka的自我保护模式></a>Eureka的自我保护模式</h3><p>当Eureka提示下面一段话的时候, 就表示它已经进入保护模式:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY&apos;RE NOT.</span><br><span class=line>RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</span><br></pre></table></figure><p>保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景下的保护. 一旦进入保护模式, Eureka Server将会尝试保护其服务注册表中的信息, 不再删除服务注册表中的数据（也就是不会注销任何微服务）.<p>解决方法如下:<p>服务器端配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>eureka:</span><br><span class=line>  server:</span><br><span class=line>    enable-self-preservation: false</span><br><span class=line>    eviction-interval-timer-in-ms: 15000</span><br></pre></table></figure><p>客户端配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>eureka:</span><br><span class=line>  instance:</span><br><span class=line>    lease-expiration-duration-in-seconds: 30 </span><br><span class=line>    lease-renewal-interval-in-seconds: 10</span><br></pre></table></figure><p><strong>注意:</strong><br><strong>更改Eureka更新频率将打破服务器的自我保护功能, 生产环境下不建议自定义这些配置.</strong><h2 id=修改Eureka界面UI><a href=#修改Eureka界面UI class=headerlink title=修改Eureka界面UI></a>修改Eureka界面UI</h2><p>覆盖对应源码中的界面文件即可:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/eureka-ui.png alt><p>效果图:<br><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/eureka-custom.png alt><p><strong>注意事项</strong>:<p>如果<code>pom.xml</code>中的<code>parent</code>不是<code>spring-boot-starter-parent</code>, 这些样式文件需要新建一个项目另外打包成jar包再引入方可生效.<h1 id=RPC-Remote-Procedure-Call><a href=#RPC-Remote-Procedure-Call class=headerlink title="RPC(Remote Procedure Call)"></a>RPC(Remote Procedure Call)</h1><blockquote><p>这里指针对Http协议调用</blockquote><p>通过注册中心, 服务间的基本调用如下:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/micro-rpc.jpg alt><p>调用方式主要有三种（基本上在实际应用中都使用Feign）<p><strong>前置条件: 集成服务注册中心</strong><p>服务提供者（<code>service-a</code>）:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre><td class=code><pre><span class=line>@RestController</span><br><span class=line>@RequestMapping(&quot;/service-a&quot;)</span><br><span class=line>public class HelloController &#123;</span><br><span class=line></span><br><span class=line>	@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>	public String sayHello(@PathVariable String name) throws UnknownHostException &#123;</span><br><span class=line>		InetAddress localHost = InetAddress.getLocalHost();</span><br><span class=line>		return localHost + &quot;:  Hello 『&quot; + name + &quot;』  , Date: &quot; + new Date();</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=LoadBalancerClient><a href=#LoadBalancerClient class=headerlink title=LoadBalancerClient></a>LoadBalancerClient</h2><p>初始化<code>RestTemplate</code>, 用来发起 REST 请求.<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>@Bean</span><br><span class=line>public RestTemplate restTemplate() &#123;</span><br><span class=line>	return new RestTemplate();</span><br><span class=line>&#125;</span><br></pre></table></figure><p>消费者（<code>service-b</code>）:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line>@RestController</span><br><span class=line>@RequestMapping(&quot;/service-b&quot;)</span><br><span class=line>public class HelloController &#123;</span><br><span class=line>	@Resource</span><br><span class=line>	private LoadBalancerClient client;</span><br><span class=line></span><br><span class=line>	@Resource</span><br><span class=line>	private RestTemplate restTemplate;</span><br><span class=line></span><br><span class=line>	@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>	public String hello(@PathVariable String name) &#123;</span><br><span class=line>		name += &quot;!&quot;;</span><br><span class=line>		ServiceInstance instance = client.choose(&quot;service-a&quot;);</span><br><span class=line>		String url = &quot;http://&quot; + instance.getHost() + &quot;:&quot; + instance.getPort() + &quot;/service-a/&quot; + name;</span><br><span class=line>		return restTemplate.getForObject(url, String.class);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>访问<code>http://127.0.0.1:8082/service-b/ybd</code>, 返回:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>ybd-PC/127.0.1.1: Hello 『ybd!』 , Date: Wed Aug 08 18:30:48 CST 2018</span><br></pre></table></figure><h2 id=Spring-Cloud-Ribbon><a href=#Spring-Cloud-Ribbon class=headerlink title="Spring Cloud Ribbon"></a>Spring Cloud Ribbon</h2><blockquote><p>它是一个基于 HTTP 和 TCP 的客户端负载均衡器. 它可以通过在客户端中配置 ribbonServerList 来设置服务端列表去轮询访问以达到均衡负载的作用. 当 Ribbon 与 Eureka 联合使用时, ribbonServerList 会被 DiscoveryEnabledNIWSServerList 重写, 扩展成从 Eureka 注册中心中获取服务实例列表. 同时它也会用 NIWSDiscoveryPing 来取代 IPing, 它将职责委托给 Eureka 来确定服务端是否已经启动.</blockquote><p>为<code>RestTemplate</code>添加<code>@LoadBalanced</code>注解:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>@LoadBalanced</span><br><span class=line>@Bean</span><br><span class=line>public RestTemplate restTemplate() &#123;</span><br><span class=line>	return new RestTemplate();</span><br><span class=line>&#125;</span><br></pre></table></figure><p>Controller:<p>修改 controller, 去掉<code>LoadBalancerClient</code>, 并修改相应的方法, 直接用 <code>RestTemplate</code>发起请求<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>@RestController</span><br><span class=line>@RequestMapping(&quot;/service-b&quot;)</span><br><span class=line>public class HelloController &#123;</span><br><span class=line>	@Resource</span><br><span class=line>	private RestTemplate restTemplate;</span><br><span class=line></span><br><span class=line>	@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>	public String hello(@PathVariable String name) &#123;</span><br><span class=line>		name += &quot;!&quot;;</span><br><span class=line>		String url = &quot;http://service-a/service-a/&quot; + name;</span><br><span class=line>		return restTemplate.getForObject(url, String.class);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=Spring-Cloud-Feign><a href=#Spring-Cloud-Feign class=headerlink title="Spring Cloud Feign"></a>Spring Cloud Feign</h2><p>依赖（使用OkHttp组件）:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br></pre></table></figure><p>配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>feign:</span><br><span class=line>  httpclient:</span><br><span class=line>    enabled: false</span><br><span class=line>  okhttp:</span><br><span class=line>    enabled: true</span><br></pre></table></figure><p>在启动类上加上<code>@EnableFeignClients</code><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>@EnableFeignClients</span><br><span class=line>@SpringBootApplication</span><br><span class=line>public class ServiceBApplication &#123;</span><br><span class=line></span><br><span class=line>	public static void main(String[] args) &#123;</span><br><span class=line>		SpringApplication.run(ServiceBApplication.class, args);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>Feign:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>@FeignClient(value = &quot;service-a&quot;, path = &quot;/service-a&quot;)</span><br><span class=line>public interface HelloRemoteClient &#123;</span><br><span class=line></span><br><span class=line>	@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>	String sayHello(@PathVariable(&quot;name&quot;) String name);</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li><code>value</code>指被调用方的服务名<li><code>path</code>请求指定前缀, 例如上面的<code>sayHello</code>会请求<code>/service-a/{name}</code>这个url</ul><p>调用:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre><td class=code><pre><span class=line>@RestController</span><br><span class=line>@RequestMapping(&quot;/service-b&quot;)</span><br><span class=line>public class HelloController &#123;</span><br><span class=line></span><br><span class=line>	@Resource</span><br><span class=line>	private HelloRemoteClient helloClient;</span><br><span class=line></span><br><span class=line>	@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>	public String hello(@PathVariable String name) &#123;</span><br><span class=line>		name += &quot;!&quot;;</span><br><span class=line>		return helloClient.sayHello(name);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=踩坑><a href=#踩坑 class=headerlink title=踩坑></a>踩坑</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>Caused by: java.lang.IllegalStateException: PathVariable annotation was empty on param 0.</span><br></pre></table></figure><p>这个大概的意思就是<code>@PathVariable</code>的第一个参数为空. . .<p>因为之前的写法是这样的:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>String sayHello(@PathVariable String name);</span><br></pre></table></figure><p><strong>正确姿势</strong>是这样的:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>@GetMapping(&quot;/&#123;name&#125;&quot;)</span><br><span class=line>String sayHello(@PathVariable(&quot;name&quot;) String name);</span><br></pre></table></figure><p><code>@PathVariable</code>需要指定占位符的名字<code>(&quot;name&quot;)</code><h1 id=Spring-Cloud-Gateway><a href=#Spring-Cloud-Gateway class=headerlink title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h1><p>Spring Cloud Gateway 是 Spring Cloud 的一个全新项目, 该项目是基于 Spring 5.0, Spring Boot 2.0 和 Project Reactor 等技术开发的网关, 它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式.<p>Spring Cloud Gateway 作为 Spring Cloud 生态系统中的网关, 目标是替代 Netflix Zuul, 其不仅提供统一的路由方式, 并且基于 Filter 链的方式提供了网关基本的功能, 例如: 安全、监控、埋点和限流等.<p>Spring Cloud Gateway 的特征:<ul><li>基于 Spring Framework 5, Project Reactor 和 Spring Boot 2.0<li>动态路由<li>Predicates 和 Filters 作用于特定路由<li>集成 Hystrix 断路器<li>集成 Spring Cloud DiscoveryClient<li>易于编写的 Predicates 和 Filters<li>限流<li>路径重写</ul><p><strong>流程图</strong>:<p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-cloud-gateway-flow.jpg alt><h1 id=Spring-Boot-Admin><a href=#Spring-Boot-Admin class=headerlink title="Spring Boot Admin"></a>Spring Boot Admin</h1><p><img src=https://cdn.yangbingdong.com/img/spring-cloud-docker-integration/spring-boot-admin.png alt><h2 id=依赖><a href=#依赖 class=headerlink title=依赖></a>依赖</h2><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>&lt;dependencies&gt;</span><br><span class=line>    &lt;dependency&gt;</span><br><span class=line>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class=line>    &lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>    &lt;dependency&gt;</span><br><span class=line>        &lt;groupId&gt;de.codecentric&lt;/groupId&gt;</span><br><span class=line>        &lt;artifactId&gt;spring-boot-admin-starter-server&lt;/artifactId&gt;</span><br><span class=line>        &lt;version&gt;2.0.2&lt;/version&gt;</span><br><span class=line>    &lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>    &lt;dependency&gt;</span><br><span class=line>        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=line>        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class=line>    &lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>    &lt;dependency&gt;</span><br><span class=line>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=line>    &lt;/dependency&gt;</span><br><span class=line>&lt;/dependencies&gt;</span><br></pre></table></figure><h2 id=主类添加注解><a href=#主类添加注解 class=headerlink title=主类添加注解></a>主类添加注解</h2><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>@EnableAdminServer</span><br><span class=line>@SpringBootApplication</span><br><span class=line>public class AdminApplication &#123;</span><br><span class=line></span><br><span class=line>	public static void main(String[] args) &#123;</span><br><span class=line>		SpringApplication.run(AdminApplication.class, args);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=配置><a href=#配置 class=headerlink title=配置></a>配置</h2><p><code>application.yml</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>server:</span><br><span class=line>  port: 6010</span><br><span class=line>spring:</span><br><span class=line>  application:</span><br><span class=line>    name: admin</span><br><span class=line>  profiles:</span><br><span class=line>    active: dev</span><br><span class=line>  security:</span><br><span class=line>    user:</span><br><span class=line>      name: ybd</span><br><span class=line>      password: ybd</span><br><span class=line>management:</span><br><span class=line>  endpoints:</span><br><span class=line>    web:</span><br><span class=line>      exposure:</span><br><span class=line>        include: &quot;*&quot;</span><br><span class=line>  endpoint:</span><br><span class=line>    health:</span><br><span class=line>      show-details: ALWAYS</span><br></pre></table></figure><p><code>application-dev.yml</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>eureka:</span><br><span class=line>  client:</span><br><span class=line>    service-url:</span><br><span class=line>      defaultZone: http://ybd:ybd@127.0.0.1:8761/eureka/</span><br><span class=line>  instance:</span><br><span class=line>    metadata-map:</span><br><span class=line>      user.name: ybd</span><br><span class=line>      user.password: ybd</span><br></pre></table></figure><p><code>SecuritySecureConfig</code>:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br></pre><td class=code><pre><span class=line>@Configuration</span><br><span class=line>public class SecuritySecureConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class=line></span><br><span class=line>	private final String adminContextPath;</span><br><span class=line></span><br><span class=line>	public SecuritySecureConfig(AdminServerProperties adminServerProperties) &#123;</span><br><span class=line>		this.adminContextPath = adminServerProperties.getContextPath();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	@Override</span><br><span class=line>	protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class=line>		SavedRequestAwareAuthenticationSuccessHandler successHandler = new SavedRequestAwareAuthenticationSuccessHandler();</span><br><span class=line>		successHandler.setTargetUrlParameter(&quot;redirectTo&quot;);</span><br><span class=line>		http.authorizeRequests()</span><br><span class=line>//			.antMatchers(&quot;/actuator&quot;, &quot;/actuator/health&quot;, &quot;/actuator/info&quot;).permitAll()</span><br><span class=line>			.antMatchers(adminContextPath + &quot;/assets/**&quot;).permitAll()</span><br><span class=line>			.antMatchers(adminContextPath + &quot;/login&quot;).permitAll()</span><br><span class=line>			.anyRequest().authenticated()</span><br><span class=line>			.and()</span><br><span class=line>			.formLogin().loginPage(adminContextPath + &quot;/login&quot;).successHandler(successHandler).and()</span><br><span class=line>			.logout().logoutUrl(adminContextPath + &quot;/logout&quot;).and()</span><br><span class=line>			.httpBasic()</span><br><span class=line>			.and()</span><br><span class=line>			.csrf().disable();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><h1 id=Finally><a href=#Finally class=headerlink title=Finally></a>Finally</h1><blockquote><p>代码: <strong><em><a href=https://github.com/masteranthoneyd/spring-cloud-learning rel="external nofollow noopener noreferrer" target=_blank>https://github.com/masteranthoneyd/spring-cloud-learning</a></em></strong></blockquote></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2018/spring-cloud-stack-learning/ title="Spring Cloud Stack Learning">http://yangbingdong.com/2018/spring-cloud-stack-learning/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Spring-Cloud/ rel=tag><i class="fa fa-tag"></i>Spring Cloud</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2018/spring-boot-docker-elk/ rel=next title="Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志"><i class="fa fa-chevron-left"></i>Spring Boot应用集成Docker并结合Log4j2、Kafka、ELK管理Docker日志</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2018/design-pattern-creational/ rel=prev title=设计模式之创建型(Creational)>设计模式之创建型(Creational) <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2018/spring-cloud-stack-learning/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2018/spring-cloud-stack-learning/';this.page.identifier='2018/spring-cloud-stack-learning/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>47</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>18</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>44</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Eureka><span class=nav-number>2.</span> <span class=nav-text>Eureka</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#单节点><span class=nav-number>2.1.</span> <span class=nav-text>单节点</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#核心依赖><span class=nav-number>2.1.1.</span> <span class=nav-text>核心依赖</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#application-yml><span class=nav-number>2.1.2.</span> <span class=nav-text>application.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#application-single-yml><span class=nav-number>2.1.3.</span> <span class=nav-text>application-single.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Security配置><span class=nav-number>2.1.4.</span> <span class=nav-text>Security配置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Docker构建HA-Eureka-Server><span class=nav-number>2.2.</span> <span class=nav-text>Docker构建HA Eureka Server</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#application-yml-1><span class=nav-number>2.2.1.</span> <span class=nav-text>application.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#application-cluster1-yml><span class=nav-number>2.2.2.</span> <span class=nav-text>application-cluster1.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#application-cluster2-yml><span class=nav-number>2.2.3.</span> <span class=nav-text>application-cluster2.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#application-cluster3-yml><span class=nav-number>2.2.4.</span> <span class=nav-text>application-cluster3.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#docker-compose-yml><span class=nav-number>2.2.5.</span> <span class=nav-text>docker-compose.yml</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Docker-Compose启动><span class=nav-number>2.2.6.</span> <span class=nav-text>Docker Compose启动</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Docker-Swarm启动><span class=nav-number>2.2.7.</span> <span class=nav-text>Docker Swarm启动</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#注意事项（ip与hostname混乱）><span class=nav-number>2.2.7.1.</span> <span class=nav-text>注意事项（ip与hostname混乱）</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#踩坑-容器中服务下线无法向注册中心注销服务><span class=nav-number>2.2.8.</span> <span class=nav-text>踩坑(容器中服务下线无法向注册中心注销服务)</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Eureka-Edgware-RELEASE版本注册优化><span class=nav-number>2.2.9.</span> <span class=nav-text>Eureka Edgware.RELEASE版本注册优化</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#关闭自动注册功能><span class=nav-number>2.2.10.</span> <span class=nav-text>关闭自动注册功能</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Eureka的自我保护模式><span class=nav-number>2.2.11.</span> <span class=nav-text>Eureka的自我保护模式</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#修改Eureka界面UI><span class=nav-number>2.3.</span> <span class=nav-text>修改Eureka界面UI</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#RPC-Remote-Procedure-Call><span class=nav-number>3.</span> <span class=nav-text>RPC(Remote Procedure Call)</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#LoadBalancerClient><span class=nav-number>3.1.</span> <span class=nav-text>LoadBalancerClient</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-Cloud-Ribbon><span class=nav-number>3.2.</span> <span class=nav-text>Spring Cloud Ribbon</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-Cloud-Feign><span class=nav-number>3.3.</span> <span class=nav-text>Spring Cloud Feign</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#踩坑><span class=nav-number>3.3.1.</span> <span class=nav-text>踩坑</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Cloud-Gateway><span class=nav-number>4.</span> <span class=nav-text>Spring Cloud Gateway</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Boot-Admin><span class=nav-number>5.</span> <span class=nav-text>Spring Boot Admin</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#依赖><span class=nav-number>5.1.</span> <span class=nav-text>依赖</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#主类添加注解><span class=nav-number>5.2.</span> <span class=nav-text>主类添加注解</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#配置><span class=nav-number>5.3.</span> <span class=nav-text>配置</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Finally><span class=nav-number>6.</span> <span class=nav-text>Finally</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共280.0k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2018/spring-cloud-stack-learning/';var disqus_title="Spring Cloud Stack Learning";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>