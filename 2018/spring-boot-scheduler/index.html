<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Spring Boot,Scheduler,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface 本篇主要记录任务调度相关框架知识.  任务调度这个在日常开发中非常经典, 比如每天固定时刻同步用户信息、或者是动态的活动开始与结束时间, 亦或者每天早上8点发条短信鼓励一下自己今天努力填坑之类的. . ."><meta name=keywords content="Java,Spring Boot,Scheduler"><meta property=og:type content=article><meta property=og:title content=Spring与任务调度><meta property=og:url content=http://yangbingdong.com/2018/spring-boot-scheduler/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface 本篇主要记录任务调度相关框架知识.  任务调度这个在日常开发中非常经典, 比如每天固定时刻同步用户信息、或者是动态的活动开始与结束时间, 亦或者每天早上8点发条短信鼓励一下自己今天努力填坑之类的. . ."><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/scheduler/scheduler-banner.jpg><meta property=og:image content=https://cdn.yangbingdong.com/img/scheduler/quartz-logo.jpg><meta property=og:image content=http://www.javarticles.com/wp-content/uploads/2016/03/MainComponents.png><meta property=og:image content=http://www.javarticles.com/wp-content/uploads/2016/03/QuartzSchedulerModel.png><meta property=og:image content=https://cdn.yangbingdong.com/img/scheduler/o_timewheel.png><meta property=og:updated_time content=2020-04-07T10:15:47.014Z><meta name=twitter:card content=summary><meta name=twitter:title content=Spring与任务调度><meta name=twitter:description content="Preface 本篇主要记录任务调度相关框架知识.  任务调度这个在日常开发中非常经典, 比如每天固定时刻同步用户信息、或者是动态的活动开始与结束时间, 亦或者每天早上8点发条短信鼓励一下自己今天努力填坑之类的. . ."><meta name=twitter:image content=https://cdn.yangbingdong.com/img/scheduler/scheduler-banner.jpg><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2018/spring-boot-scheduler/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Spring与任务调度 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2018/spring-boot-scheduler/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Spring与任务调度</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2018-12-02T14:23:13+08:00>2018-12-02</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/Spring-Boot/ itemprop=url rel=index><span itemprop=name>Spring Boot</span></a></span></span>
<span id=/2018/spring-boot-scheduler/ class=leancloud_visitors data-flag-title=Spring与任务调度><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>5,210字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>26分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/scheduler/scheduler-banner.jpg alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>本篇主要记录<strong>任务调度</strong>相关框架知识.<p>任务调度这个在日常开发中非常经典, 比如每天固定时刻同步用户信息、或者是动态的活动开始与结束时间, 亦或者每天早上8点发条短信鼓励一下自己今天努力填坑之类的. . .</blockquote><a id=more></a><h1 id=Quartz><a href=#Quartz class=headerlink title=Quartz></a>Quartz</h1><p><img src=https://cdn.yangbingdong.com/img/scheduler/quartz-logo.jpg alt><blockquote><p><strong><em><a href=http://www.quartz-scheduler.org/documentation/ rel="external nofollow noopener noreferrer" target=_blank>官方文档</a></em></strong><p>Quartz是一个功能丰富的开源作业调度库, 几乎可以集成在任何Java应用程序中 - 从最小的独立应用程序到最大的电子商务系统. Quartz可用于创建简单或复杂的计划, 以执行数十, 数百甚至数万个作业;将任务定义为标准Java组件的作业, 这些组件可以执行几乎任何可以编程的程序. Quartz Scheduler包含许多企业级功能, 例如支持JTA事务和集群.</blockquote><h2 id=主要成员><a href=#主要成员 class=headerlink title=主要成员></a>主要成员</h2><ul><li><code>Scheduler</code> - 与调度器交互的主要API.<li><code>Job</code> - 需要被调度器调度的任务必须实现的接口.<li><code>JobDetail</code> - 用于定义任务的实例.<li><code>Trigger</code> - 用于定义调度器何时调度任务执行的组件.<li><code>JobBuilder</code> - 用于定义或创建<code>JobDetail</code>的实例 .<li><code>TriggerBuilder</code> - 用于定义或创建触发器实例.</ul><h2 id=构建流程><a href=#构建流程 class=headerlink title=构建流程></a>构建流程</h2><ul><li><p>定义<code>ScheduleFactory</code>, <code>Schedule</code>实例对象通过该工厂接口的实现类获取.<li><p>定义<code>JobDetail</code>实例对象, 该对象需要指定名称、组和<code>Job</code>接口的<code>Class</code>信息.<li><p>定义<code>Trigger</code>实例对象, 通过该对象设置触发任务的相关信息, 如起始时间、重复次数等.<li><p>向<code>Schedule</code>中注册<code>JobDetail</code>和<code>Trigger</code>, 有两种方式:<li><ul><li>通过<code>Schedule</code>的schedule方法注册, 此时它自动让<code>Trigger</code>和<code>JobDetail</code>绑定.<li>通过<code>addJob</code>和<code>scheduleJob</code>方法注册, 此时需要手动设置 <code>Trigger</code>的关联的<code>Job</code>组名和<code>Job</code>名称, 让<code>Trigger</code>和<code>JobDetail</code>绑定.</ul><li><p>启动调度器（调用<code>Schedule</code>对象的<code>start</code>方法）.</ul><h2 id=运行模式><a href=#运行模式 class=headerlink title=运行模式></a>运行模式</h2><p><img src=http://www.javarticles.com/wp-content/uploads/2016/03/MainComponents.png alt><p>内部运行图:<p><img src=http://www.javarticles.com/wp-content/uploads/2016/03/QuartzSchedulerModel.png alt><h2 id=与Spring集成><a href=#与Spring集成 class=headerlink title=与Spring集成></a>与Spring集成</h2><p>在<code>Spring</code>中使用<code>Quartz</code>有两种方式实现: <code>MethodInvokingJobDetailFactoryBean</code>和<code>QuartzJobBean</code>. 其中<code>MethodInvokingJobDetailFactoryBean</code>不支持存储到数据库, 会报<code>java.io.NotSerializableException</code>.<h3 id=xml方式声明Job><a href=#xml方式声明Job class=headerlink title=xml方式声明Job></a>xml方式声明Job</h3><h4 id=MethodInvokingJobDetailFactoryBean><a href=#MethodInvokingJobDetailFactoryBean class=headerlink title=MethodInvokingJobDetailFactoryBean></a>MethodInvokingJobDetailFactoryBean</h4><p>先来看一下<code>MethodInvokingJobDetailFactoryBean</code>的方式（指定<code>targetObject</code>与<code>targetMethod</code>再通过反射调用）:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=comment>&lt;!-- 使用MethodInvokingJobDetailFactoryBean, 任务类可以不实现Job接口, 通过targetMethod指定调用方法--&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"taskJob"</span> <span class=attr>class</span>=<span class=string>"com.xxx.DataConversionTask"</span>/&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"jobDetail"</span> <span class=attr>class</span>=<span class=string>"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"group"</span> <span class=attr>value</span>=<span class=string>"job_work"</span>/&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"name"</span> <span class=attr>value</span>=<span class=string>"job_work_name"</span>/&gt;</span></span><br><span class=line>    <span class=comment>&lt;!--false表示等上一个任务执行完后再开启新的任务--&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"concurrent"</span> <span class=attr>value</span>=<span class=string>"false"</span>/&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- 指定bean --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"targetObject"</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>ref</span> <span class=attr>bean</span>=<span class=string>"taskJob"</span>/&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- 指定执行方法 --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"targetMethod"</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>value</span>&gt;</span>run<span class=tag>&lt;/<span class=name>value</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>bean</span>&gt;</span></span><br></pre></table></figure><h4 id=QuartzJobBean><a href=#QuartzJobBean class=headerlink title=QuartzJobBean></a>QuartzJobBean</h4><p>一般很少会使用上述方式, 一般是使用<code>QuartzJobBean</code>:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>bean</span> <span class=attr>name</span>=<span class=string>"redisKeySpaceMetricReportJob"</span> <span class=attr>class</span>=<span class=string>"org.springframework.scheduling.quartz.JobDetailFactoryBean"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"jobClass"</span> <span class=attr>value</span>=<span class=string>"com.iba.boss.schedule.RedisKeySpaceMetricReportScheduleJob"</span>/&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"durability"</span> <span class=attr>value</span>=<span class=string>"true"</span> /&gt;</span></span><br><span class=line>    <span class=comment>&lt;!-- 向jobDataMap中注入依赖, Spring会通过反射将这些属性注入到RedisKeySpaceMetricReportScheduleJob中 --&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"jobDataMap"</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>map</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>entry</span> <span class=attr>key</span>=<span class=string>"contextUtil"</span> <span class=attr>value-ref</span>=<span class=string>"applicationContextUtil"</span> /&gt;</span></span><br><span class=line>            <span class=comment>&lt;!-- 定时任务执行开关 --&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>entry</span> <span class=attr>key</span>=<span class=string>"isOpen"</span> <span class=attr>value</span>=<span class=string>"true"</span>&gt;</span><span class=tag>&lt;/<span class=name>entry</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>map</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>bean</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"redisMetricReportTrigger"</span> <span class=attr>class</span>=<span class=string>"org.springframework.scheduling.quartz.CronTriggerFactoryBean"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"jobDetail"</span> <span class=attr>ref</span>=<span class=string>"redisKeySpaceMetricReportJob"</span> /&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"cronExpression"</span> <span class=attr>value</span>=<span class=string>"0 30 9 * * ?"</span> /&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>bean</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>bean</span> <span class=attr>id</span>=<span class=string>"schedulerFactoryBean"</span></span></span><br><span class=line><span class=tag>    <span class=attr>class</span>=<span class=string>"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>property</span> <span class=attr>name</span>=<span class=string>"triggers"</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>list</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>ref</span> <span class=attr>bean</span>=<span class=string>"redisMetricReportTrigger"</span>/&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>list</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>property</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>bean</span>&gt;</span></span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisKeySpaceMetricReportScheduleJob</span> <span class=keyword>extends</span> <span class=title>QuartzJobBean</span> </span>&#123;</span><br><span class=line>    <span class=keyword>private</span> Boolean isOpen;</span><br><span class=line>    <span class=keyword>private</span> ApplicationContext context;</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>protected</span> <span class=keyword>void</span> <span class=title>executeInternal</span><span class=params>(JobExecutionContext ctx)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>if</span> (!isOpen) &#123;</span><br><span class=line>            <span class=keyword>return</span>;</span><br><span class=line>        &#125;</span><br><span class=line>		<span class=comment>// Do something</span></span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>setIsOpen</span><span class=params>(Boolean isOpen)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.isOpen = isOpen;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>setContextUtil</span><span class=params>(ApplicationContextUtil contextUtil)</span></span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.context = contextUtil.getContext();</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=JobFactory><a href=#JobFactory class=headerlink title=JobFactory></a>JobFactory</h3><p>Quartz是通过<code>JobFactory#newJob()</code>接口返回<code>Job</code>实例的, 默认实现<code>SimpleJobFactory</code>是通过<code>jobClass.newInstance()</code>反射构建实例的.<p>在Spring中, 也是类似地通过反射构建<code>Job</code>实例, 不同的是在此实例上做了扩展（注入Spring Bean）.<p><code>AdaptableJobFactory</code>只是简单地通过反射构建<code>Job</code>, <code>SpringBeanJobFactory</code>继承<code>AdaptableJobFactory</code>并重写<code>createJobInstance</code>方法, 把<code>jobDataMap</code>跟<code>triggerDataMap</code>中的<code>bean</code>注入到<code>Job</code>实例当中:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=meta>@Override</span></span><br><span class=line><span class=function><span class=keyword>protected</span> Object <span class=title>createJobInstance</span><span class=params>(TriggerFiredBundle bundle)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>	Object job = <span class=keyword>super</span>.createJobInstance(bundle);</span><br><span class=line>	BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(job);</span><br><span class=line>	<span class=keyword>if</span> (isEligibleForPropertyPopulation(bw.getWrappedInstance())) &#123;</span><br><span class=line>		MutablePropertyValues pvs = <span class=keyword>new</span> MutablePropertyValues();</span><br><span class=line>		<span class=keyword>if</span> (<span class=keyword>this</span>.schedulerContext != <span class=keyword>null</span>) &#123;</span><br><span class=line>			pvs.addPropertyValues(<span class=keyword>this</span>.schedulerContext);</span><br><span class=line>		&#125;</span><br><span class=line>		pvs.addPropertyValues(getJobDetailDataMap(bundle));</span><br><span class=line>		pvs.addPropertyValues(getTriggerDataMap(bundle));</span><br><span class=line>		<span class=keyword>if</span> (<span class=keyword>this</span>.ignoredUnknownProperties != <span class=keyword>null</span>) &#123;</span><br><span class=line>			<span class=keyword>for</span> (String propName : <span class=keyword>this</span>.ignoredUnknownProperties) &#123;</span><br><span class=line>				<span class=keyword>if</span> (pvs.contains(propName) &amp;&amp; !bw.isWritableProperty(propName)) &#123;</span><br><span class=line>					pvs.removePropertyValue(propName);</span><br><span class=line>				&#125;</span><br><span class=line>			&#125;</span><br><span class=line>			bw.setPropertyValues(pvs);</span><br><span class=line>		&#125;</span><br><span class=line>		<span class=keyword>else</span> &#123;</span><br><span class=line>			bw.setPropertyValues(pvs, <span class=keyword>true</span>);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>	<span class=keyword>return</span> job;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>其中<code>isEligibleForPropertyPopulation()</code>:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=function><span class=keyword>protected</span> <span class=keyword>boolean</span> <span class=title>isEligibleForPropertyPopulation</span><span class=params>(Object jobObject)</span> </span>&#123;</span><br><span class=line>	<span class=keyword>return</span> (!(jobObject <span class=keyword>instanceof</span> QuartzJobBean));</span><br><span class=line>&#125;</span><br></pre></table></figure><p>所以要获得注入<code>bean</code>的支持, 有两步, 第一继承<code>QuartzJobBean</code>, 在构建<code>JobDetail</code>时在<code>jobDataMap</code>中注入Spring Bean.<p>不过这种方法也有缺点, 理论上我们是不应该关注<code>Job</code>中依赖了哪些Spring Bean, 这样耦合度太大. 所以在Spring Boot中已经优化掉了这一点.<h2 id=Spring-Boot自动配置><a href=#Spring-Boot自动配置 class=headerlink title="Spring Boot自动配置"></a>Spring Boot自动配置</h2><p>在Spring Boot 中通过<code>QuartzAutoConfiguration</code>自动配置Quartz相关类并对<code>SpringBeanJobFactory</code>进行了扩展:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=class><span class=keyword>class</span> <span class=title>AutowireCapableBeanJobFactory</span> <span class=keyword>extends</span> <span class=title>SpringBeanJobFactory</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>final</span> AutowireCapableBeanFactory beanFactory;</span><br><span class=line></span><br><span class=line>	AutowireCapableBeanJobFactory(AutowireCapableBeanFactory beanFactory) &#123;</span><br><span class=line>		Assert.notNull(beanFactory, <span class=string>"Bean factory must not be null"</span>);</span><br><span class=line>		<span class=keyword>this</span>.beanFactory = beanFactory;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>protected</span> Object <span class=title>createJobInstance</span><span class=params>(TriggerFiredBundle bundle)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>		Object jobInstance = <span class=keyword>super</span>.createJobInstance(bundle);</span><br><span class=line>		<span class=keyword>this</span>.beanFactory.autowireBean(jobInstance);</span><br><span class=line>		<span class=keyword>this</span>.beanFactory.initializeBean(jobInstance, <span class=keyword>null</span>);</span><br><span class=line>		<span class=keyword>return</span> jobInstance;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><p>这样我们只需要在<code>Job</code>实现类中用<code>@Autowired</code>或<code>@Resource</code>注解声明需要注入的Spring Bean即可.<p>Spring Boot提供<code>SchedulerFactoryBeanCustomizer</code>定制<code>SchedulerFactoryBean</code>, 比如换一个<code>JobFactory</code>（从Spring IoC容器中获取无状态<code>Job</code>）:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>QuartzScheduleFactoryBeanCustomizer</span> <span class=keyword>implements</span> <span class=title>SchedulerFactoryBeanCustomizer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Resource</span></span><br><span class=line>	<span class=keyword>private</span> CustomizedActivitySchedulerFactory customizedSchedulerFactory;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>customize</span><span class=params>(SchedulerFactoryBean schedulerFactoryBean)</span> </span>&#123;</span><br><span class=line>		schedulerFactoryBean.setJobFactory(customizedSchedulerFactory);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>CustomizedActivitySchedulerFactory</span> <span class=keyword>implements</span> <span class=title>JobFactory</span>, <span class=title>ApplicationContextAware</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> ApplicationContext applicationContext;</span><br><span class=line></span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> Job <span class=title>newJob</span><span class=params>(TriggerFiredBundle bundle, Scheduler scheduler)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> applicationContext.getBean(bundle.getJobDetail().getJobClass());</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>setApplicationContext</span><span class=params>(ApplicationContext applicationContext)</span> <span class=keyword>throws</span> BeansException </span>&#123;</span><br><span class=line>		<span class=keyword>this</span>.applicationContext = applicationContext;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=Job的增删改><a href=#Job的增删改 class=headerlink title=Job的增删改></a>Job的增删改</h2><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br></pre><td class=code><pre><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-11-22</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SpringQuartzJobTemplate</span> <span class=keyword>implements</span> <span class=title>ScheduleJobOperations</span>, <span class=title>InitializingBean</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> Logger log = LoggerFactory.getLogger(SpringQuartzJobTemplate<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Autowired</span>(required = <span class=keyword>false</span>)</span><br><span class=line>    <span class=meta>@Qualifier</span>(<span class=string>"customizedSchedulerFactoryBean"</span>)</span><br><span class=line>	<span class=keyword>private</span> SchedulerFactoryBean schedulerFactoryBean;</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> Scheduler scheduler;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>addOrUpdateScheduleJob</span><span class=params>(BaseJobDetail baseJobDetail)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            TriggerKey triggerKey = parseTriggerKey(baseJobDetail);</span><br><span class=line>            JobKey jobKey = parseJobKey(baseJobDetail);</span><br><span class=line>            <span class=keyword>boolean</span> jobExists = scheduler.checkExists(jobKey);</span><br><span class=line>            <span class=keyword>boolean</span> triggerExists = scheduler.checkExists(triggerKey);</span><br><span class=line>            CronScheduleBuilder cronScheduleBuilder = CronScheduleBuilder.cronSchedule(baseJobDetail.getCron());</span><br><span class=line>            CronTrigger cronTrigger = TriggerBuilder.newTrigger()</span><br><span class=line>                                                    .withIdentity(triggerKey)</span><br><span class=line>                                                    .withSchedule(cronScheduleBuilder)</span><br><span class=line>                                                    .build();</span><br><span class=line>            <span class=keyword>if</span> (!jobExists &amp;&amp; !triggerExists) &#123;</span><br><span class=line>                JobDetail jobDetail = buildJobDetail(baseJobDetail, jobKey);</span><br><span class=line>                scheduler.scheduleJob(jobDetail, cronTrigger);</span><br><span class=line>            &#125; <span class=keyword>else</span> <span class=keyword>if</span> (jobExists &amp;&amp; triggerExists) &#123;</span><br><span class=line>                <span class=keyword>if</span> (baseJobDetail.getJobDataMap() != <span class=keyword>null</span>) &#123;</span><br><span class=line>                    JobDetail jobDetail = buildJobDetail(baseJobDetail, jobKey);</span><br><span class=line>                    scheduler.addJob(jobDetail, <span class=keyword>true</span>, <span class=keyword>true</span>);</span><br><span class=line>                &#125;</span><br><span class=line>                scheduler.rescheduleJob(triggerKey, cronTrigger);</span><br><span class=line>            &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>                <span class=keyword>throw</span> <span class=keyword>new</span> ScheduleJobException(<span class=string>"Illegal state -&gt; jobExists: "</span> + jobExists + <span class=string>", triggerExists: "</span> + triggerExists);</span><br><span class=line>            &#125;</span><br><span class=line>        &#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> ScheduleJobException(e);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> JobDetail <span class=title>buildJobDetail</span><span class=params>(BaseJobDetail baseJobDetail, JobKey jobKey)</span> <span class=keyword>throws</span> ClassNotFoundException </span>&#123;</span><br><span class=line>        Class&lt;? extends Job&gt; jobClass = Class.forName(baseJobDetail.getJobClass()).asSubclass(Job<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line>        JobDetail jobDetail = JobBuilder.newJob(jobClass)</span><br><span class=line>                                        .withIdentity(jobKey)</span><br><span class=line>                                        .build();</span><br><span class=line>        <span class=keyword>if</span> (baseJobDetail.getId() != <span class=keyword>null</span>) &#123;</span><br><span class=line>            jobDetail.getJobDataMap().put(JOB_DETAIL_ID_KEY, baseJobDetail.getId());</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=keyword>if</span> (baseJobDetail.getJobDataMap() != <span class=keyword>null</span>) &#123;</span><br><span class=line>            jobDetail.getJobDataMap().putAll(baseJobDetail.getJobDataMap());</span><br><span class=line>        &#125;</span><br><span class=line>        <span class=keyword>return</span> jobDetail;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>deleteScheduleJob</span><span class=params>(BaseJobDetail baseJobDetail)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>            TriggerKey triggerKey = parseTriggerKey(baseJobDetail);</span><br><span class=line>            <span class=keyword>if</span> (scheduler.checkExists(triggerKey)) &#123;</span><br><span class=line>                scheduler.pauseTrigger(triggerKey);</span><br><span class=line>                scheduler.unscheduleJob(triggerKey);</span><br><span class=line>                JobKey jobKey = parseJobKey(baseJobDetail);</span><br><span class=line>                <span class=keyword>if</span> (scheduler.checkExists(jobKey)) &#123;</span><br><span class=line>                    scheduler.deleteJob(parseJobKey(baseJobDetail));</span><br><span class=line>                &#125;</span><br><span class=line>                log.info(<span class=string>"Success [CREATE] quartz job: "</span> + triggerKey.toString());</span><br><span class=line>            &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>                log.info(<span class=string>"Fail to [DELETE] schedule job, job not exist: "</span> + triggerKey);</span><br><span class=line>            &#125;</span><br><span class=line>        &#125; <span class=keyword>catch</span> (SchedulerException e) &#123;</span><br><span class=line>            <span class=keyword>throw</span> <span class=keyword>new</span> ScheduleJobException(e);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>trigger</span><span class=params>(BaseJobDetail baseJobDetail)</span> </span>&#123;</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>            JobKey jobKey = parseJobKey(baseJobDetail);</span><br><span class=line>            <span class=keyword>if</span> (scheduler.checkExists(jobKey)) &#123;</span><br><span class=line>                scheduler.triggerJob(jobKey);</span><br><span class=line>            &#125; <span class=keyword>else</span> &#123;</span><br><span class=line>                JobDetail jobDetail = buildJobDetail(baseJobDetail, jobKey);</span><br><span class=line>                scheduler.addJob(jobDetail, <span class=keyword>false</span>, <span class=keyword>true</span>);</span><br><span class=line>                scheduler.triggerJob(jobKey);</span><br><span class=line>            &#125;</span><br><span class=line>		&#125; <span class=keyword>catch</span> (Exception e) &#123;</span><br><span class=line>			<span class=keyword>throw</span> <span class=keyword>new</span> ScheduleJobException(e);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterPropertiesSet</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>this</span>.scheduler = schedulerFactoryBean.getScheduler();</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> TriggerKey <span class=title>parseTriggerKey</span><span class=params>(BaseJobDetail baseJobDetail)</span> </span>&#123;</span><br><span class=line>        requireNameAndGroupNonNull(baseJobDetail);</span><br><span class=line>        <span class=keyword>return</span> TriggerKey.triggerKey(baseJobDetail.getJobName(), baseJobDetail.getJobGroup());</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> JobKey <span class=title>parseJobKey</span><span class=params>(BaseJobDetail baseJobDetail)</span> </span>&#123;</span><br><span class=line>        requireNameAndGroupNonNull(baseJobDetail);</span><br><span class=line>        <span class=keyword>return</span> JobKey.jobKey(baseJobDetail.getJobName(), baseJobDetail.getJobGroup());</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>requireNameAndGroupNonNull</span><span class=params>(BaseJobDetail baseJobDetail)</span> </span>&#123;</span><br><span class=line>        requireNonNull(baseJobDetail.getJobName());</span><br><span class=line>        requireNonNull(baseJobDetail.getJobGroup());</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>信息类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br></pre><td class=code><pre><span class=line><span class=meta>@Data</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>BaseJobDetail</span> </span>&#123;</span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 主键</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Long id;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 任务组</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> String jobGroup;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 任务名</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> String jobName;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 任务类</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> String jobClass;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: cron表达式</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> String cron;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 冗余, cron表达式对应执行时间</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Date cronTime;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 触发次数</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Integer fireTimes;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 最后一次触发时间</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Date lastFireTime;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 最后一次触发的任务耗时, 单位: 毫秒</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Long lastFireConsume;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 状态, 0:待执行 1:已执行 2:已取消 3:执行异常</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Byte status;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 作业数据</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> String jobData;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 创建时间</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Date createTime;</span><br><span class=line></span><br><span class=line>    <span class=comment>/**</span></span><br><span class=line><span class=comment>     * field comment: 更新时间</span></span><br><span class=line><span class=comment>     */</span></span><br><span class=line>    <span class=keyword>private</span> Date updateTime;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>transient</span> Map&lt;String, ?&gt; jobDataMap;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> BaseJobDetail <span class=title>incrFireTimes</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        fireTimes++;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>this</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> BaseJobDetail <span class=title>withJobData</span><span class=params>(Object jobData)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> setJobData(BaseJobData.of(jobData).toJsonString());</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>static</span> BaseJobDetail <span class=title>of</span><span class=params>(String jobGroup, String jobName, Class&lt;? extends Job&gt; jobClass, Date cronTime)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> BaseJobDetail().setCron(DateUtil.parseToCron(cronTime))</span><br><span class=line>                                  .setCronTime(cronTime)</span><br><span class=line>                                  .setJobGroup(jobGroup)</span><br><span class=line>                                  .setJobName(jobName)</span><br><span class=line>                                  .setJobClass(jobClass.getName());</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Data</span></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>static</span> <span class=class><span class=keyword>class</span> <span class=title>BaseJobData</span> </span>&#123;</span><br><span class=line>        <span class=keyword>private</span> Class dataClass;</span><br><span class=line>        <span class=keyword>private</span> JSON jsonData;</span><br><span class=line></span><br><span class=line>        <span class=function><span class=keyword>public</span> <span class=keyword>static</span> BaseJobData <span class=title>resolve</span><span class=params>(String jsonData)</span> </span>&#123;</span><br><span class=line>            <span class=keyword>return</span> parseObject(jsonData, BaseJobData<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=function><span class=keyword>public</span> <span class=keyword>static</span> BaseJobData <span class=title>of</span><span class=params>(Object data)</span> </span>&#123;</span><br><span class=line>            <span class=keyword>return</span> <span class=keyword>new</span> BaseJobData().setDataClass(data.getClass())</span><br><span class=line>                                    .setJsonData((JSON) toJSON(data));</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=meta>@SuppressWarnings</span>(<span class=string>"unchecked"</span>)</span><br><span class=line>        <span class=keyword>public</span> &lt;T&gt; <span class=function>T <span class=title>parseData</span><span class=params>()</span> </span>&#123;</span><br><span class=line>            <span class=keyword>return</span> (T) parseObject(<span class=keyword>this</span>.jsonData.toJSONString(), <span class=keyword>this</span>.dataClass);</span><br><span class=line>        &#125;</span><br><span class=line></span><br><span class=line>        <span class=function><span class=keyword>public</span> String <span class=title>toJsonString</span><span class=params>()</span> </span>&#123;</span><br><span class=line>            <span class=keyword>return</span> toJSONString(<span class=keyword>this</span>);</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=其他问题><a href=#其他问题 class=headerlink title=其他问题></a>其他问题</h2><h3 id=Durability><a href=#Durability class=headerlink title=Durability></a>Durability</h3><p>当设置了<code>JobDetail.setDurability(true)</code>, 当<code>job</code>不再有<code>trigger</code>引用它的时候, <code>Quartz</code>也不要删除<code>job</code>.<h3 id=Misfire><a href=#Misfire class=headerlink title=Misfire></a>Misfire</h3><p>由于某些原因（比如Worker线程池满了）导致任务没有及时执行, 此时扫描Misfire的线程就会把它们找出来并按照Misfire指令处理这个任务. 比如<code>CronTrigger</code>的默认策略是<code>CronTrigger.MISFIRE_INSTRUCTION_FIRE_ONCE_NOW</code>,也可以自己指定:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>CronScheduleBuilder cronScheduleBuilder = CronScheduleBuilder.cronSchedule(scheduleJobInfo.getCron()).withMisfireHandlingInstructionDoNothing();</span><br><span class=line>TriggerKey oldTriggerKey = parseTriggerKey(scheduleJobInfo);</span><br><span class=line>CronTrigger newTrigger = TriggerBuilder.newTrigger()</span><br><span class=line>										.withIdentity(oldTriggerKey)</span><br><span class=line>										.withSchedule(cronScheduleBuilder)</span><br><span class=line>										.build();</span><br><span class=line>scheduler.rescheduleJob(oldTriggerKey, newTrigger);</span><br></pre></table></figure><h3 id=maxBatchSize><a href=#maxBatchSize class=headerlink title=maxBatchSize></a>maxBatchSize</h3><p>一次拉取trigger的最大数量, 默认是1, 可通过<code>org.quartz.scheduler.batchTriggerAcquisitionMaxCount</code>改写. 但是在集群环境下, 不建议设置为很大值. 如果值 &gt; 1, 并且使用了 JDBC JobStore的话, <code>org.quartz.jobStore.acquireTriggersWithinLock</code>属性必须设置为<code>true</code>, 以避免”弄脏”数据.<blockquote><p>更多参数配置: <strong><em><a href=https://blog.csdn.net/zixiao217/article/details/53091812 rel="external nofollow noopener noreferrer" target=_blank>https://blog.csdn.net/zixiao217/article/details/53091812</a></em></strong></blockquote><h3 id=性能问题><a href=#性能问题 class=headerlink title=性能问题></a>性能问题</h3><p>由于Quartz的集群是通过底层调度依赖数据库的悲观锁, 谁先抢到谁调度, 这样会导致节点负载不均衡, 并且影响性能.<h1 id=Spring-Scheduler><a href=#Spring-Scheduler class=headerlink title="Spring Scheduler"></a>Spring Scheduler</h1><blockquote><p>Spring Scheduler相对Quartz来说比较轻量级, 通过简单的配置就可以使用了, 但灵活度不如Quartz</blockquote><h2 id=开启配置><a href=#开启配置 class=headerlink title=开启配置></a>开启配置</h2><h3 id=Xml方式><a href=#Xml方式 class=headerlink title=Xml方式></a>Xml方式</h3><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>task:scheduler</span> <span class=attr>id</span>=<span class=string>"scheduler"</span> <span class=attr>pool-size</span>=<span class=string>"50"</span>/&gt;</span></span><br></pre></table></figure><ul><li>如果不设置<code>pool-size</code>, 默认是1, 会导致任务单线程执行.</ul><h3 id=Java配置方式><a href=#Java配置方式 class=headerlink title=Java配置方式></a>Java配置方式</h3><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=meta>@EnableScheduling</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>SpringScheduleConfig</span> <span class=keyword>implements</span> <span class=title>SchedulingConfigurer</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>configureTasks</span><span class=params>(ScheduledTaskRegistrar taskRegistrar)</span> </span>&#123;</span><br><span class=line>		taskRegistrar.setScheduler(taskExecutor());</span><br><span class=line>	&#125;</span><br><span class=line>	</span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> Executor <span class=title>taskExecutor</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>new</span> ScheduledThreadPoolExecutor(<span class=number>4</span>,</span><br><span class=line>				<span class=keyword>new</span> BasicThreadFactory</span><br><span class=line>						.Builder()</span><br><span class=line>						.namingPattern(<span class=string>"schedule-pool-thread-%d"</span>)</span><br><span class=line>						.build());</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li><code>@EnableScheduling</code>表示告诉Spring开启Scheduler<li>实现<code>SchedulingConfigurer</code>是为了配置线程池</ul><h2 id=使用><a href=#使用 class=headerlink title=使用></a>使用</h2><h3 id=Xml方式-1><a href=#Xml方式-1 class=headerlink title=Xml方式></a>Xml方式</h3><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>task:scheduled-tasks</span> <span class=attr>scheduler</span>=<span class=string>"myScheduler"</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>task:scheduled</span> <span class=attr>ref</span>=<span class=string>"doSomethingTask"</span> <span class=attr>method</span>=<span class=string>"doSomething"</span> <span class=attr>cron</span>=<span class=string>"0 * * * * *"</span>/&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>task:scheduled-tasks</span>&gt;</span></span><br></pre></table></figure><figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>DoSomethingTask</span> </span>&#123;</span><br><span class=line>    <span class=meta>@Scheduled</span>(cron=<span class=string>"0 * * * * *"</span>)</span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>doSomething</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        System.out.println(<span class=string>"do something"</span>);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h3 id=注解声明方式><a href=#注解声明方式 class=headerlink title=注解声明方式></a>注解声明方式</h3><p>使用<code>@Scheduled</code>可以非常简单地就声明一个任务:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>DoSomethingTask</span> </span>&#123;</span><br><span class=line>    <span class=meta>@Scheduled</span>(cron=<span class=string>"0 * * * * *"</span>)</span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>doSomething</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        System.out.println(<span class=string>"do something"</span>);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><code>@Scheduled</code>有几个参数:<ul><li><p><code>cron</code>: cron表达式, 指定任务在特定时间执行；<li><p><code>fixedDelay</code>: 表示上一次任务执行完成后多久再次执行, 参数类型为long, 单位ms；<li><p><code>fixedDelayString</code>: 与<code>fixedDelay</code>含义一样, 只是参数类型变为String；<li><p><code>fixedRate</code>: 表示按一定的频率执行任务, 参数类型为long, 单位ms；<li><p><code>fixedRateString</code>: 与<code>fixedRate</code>的含义一样, 只是将参数类型变为String；<li><p><code>initialDelay</code>: 表示延迟多久再第一次执行任务, 参数类型为long, 单位ms；<li><p><code>initialDelayString</code>: 与<code>initialDelay</code>的含义一样, 只是将参数类型变为String；<li><p><code>zone</code>: 时区, 默认为当前时区, 一般没有用到.</ul><h1 id=Cron表达式><a href=#Cron表达式 class=headerlink title=Cron表达式></a>Cron表达式</h1><p>想了解Cron最好的方法是看<strong><em><a href=http://www.quartz-scheduler.org/documentation/quartz-2.2.x/tutorials/crontrigger rel="external nofollow noopener noreferrer" target=_blank>Quartz的官方文档</a></em></strong>. 本节也会大致介绍一下.<p>Cron表达式由6~7项组成, 中间用空格分开. 从左到右依次是: 秒、分、时、日、月、周几、年（可省略）. 值可以是数字, 也可以是以下符号:<br><code>*</code>: 所有值都匹配<br><code>?</code>: 无所谓, 不关心, 通常放在“周几”里<br><code>,</code>: 或者<br><code>/</code>: 增量值<br><code>-</code>: 区间<p>下面举几个例子, 看了就知道了:<br><code>0 * * * * *</code>: 每分钟（当秒为0的时候）<br><code>0 0 * * * *</code>: 每小时（当秒和分都为0的时候）<br><code>*/10 * * * * *</code>: 每10秒<br><code>0 5/15 * * * *</code>: 每小时的5分、20分、35分、50分<br><code>0 0 9,13 * * *</code>: 每天的9点和13点<br><code>0 0 8-10 * * *</code>: 每天的8点、9点、10点<br><code>0 0/30 8-10 * * *</code>: 每天的8点、8点半、9点、9点半、10点<br><code>0 0 9-17 * * MON-FRI</code>: 每周一到周五的9点、10点…直到17点（含）<br><code>0 0 0 25 12 ?</code>: 每年12约25日圣诞节的0点0分0秒（午夜）<br><code>0 30 10 * * ? 2016</code>: 2016年每天的10点半<p>其中的<code>?</code>在用法上其实和<code>*</code>是相同的. 但是<code>*</code>语义上表示全匹配, 而<code>?</code>并不代表全匹配, 而是不关心. 比如对于<code>0 0 0 5 8 ? 2016</code>来说, 2016年8月5日是周五, <code>?</code>表示我不关心它是周几. 而<code>0 0 0 5 8 * 2016</code>中的<code>*</code>表示周一也行, 周二也行……语义上和2016年8月5日冲突了, 你说谁优先生效呢.<p>不记得也没关系, 记住<strong><em><a href=http://www.cronmaker.com/ rel="external nofollow noopener noreferrer" target=_blank>Cron Maker</a></em></strong>也可以, 它可以在线生成cron表达式.<h1 id=时间轮><a href=#时间轮 class=headerlink title=时间轮></a>时间轮</h1><blockquote><p><strong><em><a href=https://github.com/ifesdjeen/hashed-wheel-timer rel="external nofollow noopener noreferrer" target=_blank>https://github.com/ifesdjeen/hashed-wheel-timer</a></em></strong></blockquote><p><img src=https://cdn.yangbingdong.com/img/scheduler/o_timewheel.png alt><blockquote><p>时间轮算法可以类比于时钟，如上图箭头（指针）按某一个方向按固定频率轮动，每一次跳动称为一个 tick。这样可以看出定时轮由个3个重要的属性参数，ticksPerWheel（一轮的tick数），tickDuration（一个tick的持续时间）以及 timeUnit（时间单位），例如当ticksPerWheel=60，tickDuration=1，timeUnit=秒，这就和现实中的始终的秒针走动完全类似了。</blockquote><p>例子, 使用Netty中的时间轮实现:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> io.netty.util.HashedWheelTimer;</span><br><span class=line><span class=keyword>import</span> io.netty.util.Timeout;</span><br><span class=line><span class=keyword>import</span> io.netty.util.Timer;</span><br><span class=line><span class=keyword>import</span> io.netty.util.TimerTask;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.util.concurrent.TimeUnit;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>HashedWheelTimerTest</span> </span>&#123;</span><br><span class=line>	<span class=keyword>static</span> <span class=class><span class=keyword>class</span> <span class=title>MyTimerTask</span> <span class=keyword>implements</span> <span class=title>TimerTask</span> </span>&#123;</span><br><span class=line>		<span class=keyword>boolean</span> flag;</span><br><span class=line></span><br><span class=line>		<span class=function><span class=keyword>public</span> <span class=title>MyTimerTask</span><span class=params>(<span class=keyword>boolean</span> flag)</span> </span>&#123;</span><br><span class=line>			<span class=keyword>this</span>.flag = flag;</span><br><span class=line>		&#125;</span><br><span class=line></span><br><span class=line>		<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>run</span><span class=params>(Timeout timeout)</span> <span class=keyword>throws</span> Exception </span>&#123;</span><br><span class=line>			System.out.println(<span class=string>"执行延迟任务..."</span>);</span><br><span class=line>			<span class=keyword>this</span>.flag = <span class=keyword>false</span>;</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class=title>main</span><span class=params>(String[] argv)</span> <span class=keyword>throws</span> InterruptedException </span>&#123;</span><br><span class=line>		MyTimerTask timerTask = <span class=keyword>new</span> MyTimerTask(<span class=keyword>true</span>);</span><br><span class=line>		Timer timer = <span class=keyword>new</span> HashedWheelTimer();</span><br><span class=line>		timer.newTimeout(timerTask, <span class=number>5</span>, TimeUnit.SECONDS);</span><br><span class=line>		<span class=keyword>int</span> i = <span class=number>1</span>;</span><br><span class=line>		<span class=keyword>while</span> (timerTask.flag) &#123;</span><br><span class=line>			Thread.sleep(<span class=number>1000</span>);</span><br><span class=line>			System.out.println(i + <span class=string>"秒过去了"</span>);</span><br><span class=line>			i++;</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h1 id=Elastic-Job><a href=#Elastic-Job class=headerlink title="Elastic Job"></a>Elastic Job</h1><blockquote><p>官网: <strong><em><a href=http://elasticjob.io/ rel="external nofollow noopener noreferrer" target=_blank>Elastic Job</a></em></strong></blockquote><h2 id=Elastic-Job-与-Sping-Cloud-集成解决依赖冲突问题><a href=#Elastic-Job-与-Sping-Cloud-集成解决依赖冲突问题 class=headerlink title="Elastic Job 与 Sping Cloud 集成解决依赖冲突问题"></a>Elastic Job 与 Sping Cloud 集成解决依赖冲突问题</h2><p>由于Elastic Job自身的 <code>curator-client</code>,<code>curator-framework</code>,<code>curator-recipes</code>与Spring Cloud组件中的<code>curator-client</code>,<code>curator-framework</code>,<code>curator-recipes</code>有版本冲突，在启动过程会报如下错误：<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>2018-07-06 18:19:34.403 | epms |  WARN | IP: |            main | AnnotationConfigServletWebServerApplicationContext |   558 | refresh | Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;reqAspect&apos; defined in file [/home/ybd/data/git-repo/bitbucket/epms/epms-core/target/classes/com/yanglaoban/epms/core/aop/ReqAspect.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;disruptorConfig&apos;: Injection of resource dependencies failed; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;delayHandler&apos; defined in file [/home/ybd/data/git-repo/bitbucket/epms/epms-core/target/classes/com/yanglaoban/epms/core/pubsub/disruptor/handler/DelayHandler.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;delayService&apos; defined in file [/home/ybd/data/git-repo/bitbucket/epms/epms-core/target/classes/com/yanglaoban/epms/core/domain/service/DelayService.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name &apos;elasticJobService&apos; defined in file [/home/ybd/data/git-repo/bitbucket/epms/epms-core/target/classes/com/yanglaoban/epms/core/elasticjob/ElasticJobService.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;regCenter&apos; defined in class path resource [com/yanglaoban/epms/core/elasticjob/config/ElasticJobConfig.class]: Invocation of init method failed; nested exception is java.lang.NoClassDefFoundError: org/apache/curator/connection/StandardConnectionHandlingPolicy</span><br></pre></table></figure><p>解决方式是排除Elastic Job中<code>curator</code>相关依赖，重新导入：<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>properties</span>&gt;</span></span><br><span class=line>   <span class=tag>&lt;<span class=name>elastic-job.version</span>&gt;</span>2.1.5<span class=tag>&lt;/<span class=name>elastic-job.version</span>&gt;</span></span><br><span class=line>   <span class=tag>&lt;<span class=name>curator.version</span>&gt;</span>2.10.0<span class=tag>&lt;/<span class=name>curator.version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>properties</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=tag>&lt;<span class=name>dependencies</span>&gt;</span></span><br><span class=line>     <span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.dangdang<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>elastic-job-lite-core<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;elastic-job.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>exclusions</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-client<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-framework<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-recipes<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>                    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>                <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;/<span class=name>exclusions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-framework<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;curator.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-client<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;curator.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-recipes<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;curator.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependencies</span>&gt;</span></span><br></pre></table></figure><h2 id=Spting-Boot-集成><a href=#Spting-Boot-集成 class=headerlink title="Spting Boot 集成"></a>Spting Boot 集成</h2><blockquote><p>Github: <strong><em><a href=https://github.com/yinjihuan/elastic-job-spring-boot-starter rel="external nofollow noopener noreferrer" target=_blank>https://github.com/yinjihuan/elastic-job-spring-boot-starter</a></em></strong></blockquote><p>pom.xml:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>com.github.yinjihuan<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>elastic-job-spring-boot-starter<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>1.0.4<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>exclusions</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-client<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-framework<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;<span class=name>exclusion</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-recipes<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>            <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>        <span class=tag>&lt;/<span class=name>exclusion</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;/<span class=name>exclusions</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-framework<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;curator.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-client<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;curator.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.curator<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>curator-recipes<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>$&#123;curator.version&#125;<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>还需要加上repository配置:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>repository</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>id</span>&gt;</span>jitpack.io<span class=tag>&lt;/<span class=name>id</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>url</span>&gt;</span>https://jitpack.io<span class=tag>&lt;/<span class=name>url</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>repository</span>&gt;</span></span><br></pre></table></figure><p>yml配置:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=attr>elastic:</span></span><br><span class=line>  <span class=attr>job:</span></span><br><span class=line>    <span class=attr>zk:</span></span><br><span class=line>      <span class=attr>serverLists:</span> <span class=number>192.168</span><span class=number>.6</span><span class=number>.113</span><span class=string>:2181</span></span><br><span class=line>      <span class=attr>namespace:</span> <span class=string>test</span></span><br></pre></table></figure><p>只需一个注解即可开启任务:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line><span class=meta>@ElasticJobConf</span>(name = JobName, cron = <span class=string>"0 0 0 * * ?"</span>, failover = <span class=keyword>true</span>, misfire = <span class=keyword>true</span>, overwrite = <span class=keyword>true</span>,</span><br><span class=line>		eventTraceRdbDataSource = <span class=string>"dataSource"</span>)</span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>MySimpleJob</span> <span class=keyword>implements</span> <span class=title>SimpleJob</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>static</span> <span class=keyword>final</span> String JobName = <span class=string>"MySimpleJob"</span>;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>execute</span><span class=params>(ShardingContext shardingContext)</span> </span>&#123;</span><br><span class=line>		log.info(<span class=string>"执行定时任务: "</span> + shardingContext);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p><code>eventTraceRdbDataSource = &quot;dataSource&quot;</code> 是启用事件追踪, 但在最新版的Spring Boot 中并不会创建 <code>JOB_EXECUTION_LOG</code> 与 <code>JOB_STATUS_TRACE_LOG</code> 这两个记录表, 最好是手动创建, 下面是建表语句:<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> <span class=string>`JOB_EXECUTION_LOG`</span> (</span><br><span class=line>  <span class=string>`id`</span> <span class=built_in>varchar</span>(<span class=number>40</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`job_name`</span> <span class=built_in>varchar</span>(<span class=number>100</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`task_id`</span> <span class=built_in>varchar</span>(<span class=number>255</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`hostname`</span> <span class=built_in>varchar</span>(<span class=number>255</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`ip`</span> <span class=built_in>varchar</span>(<span class=number>50</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`sharding_item`</span> <span class=built_in>int</span>(<span class=number>11</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`execution_source`</span> <span class=built_in>varchar</span>(<span class=number>20</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`failure_cause`</span> <span class=built_in>varchar</span>(<span class=number>4000</span>) <span class=keyword>DEFAULT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`is_success`</span> <span class=built_in>int</span>(<span class=number>11</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`start_time`</span> <span class=built_in>timestamp</span> <span class=literal>NULL</span> <span class=keyword>DEFAULT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`complete_time`</span> <span class=built_in>timestamp</span> <span class=literal>NULL</span> <span class=keyword>DEFAULT</span> <span class=literal>NULL</span>,</span><br><span class=line>  PRIMARY <span class=keyword>KEY</span> (<span class=string>`id`</span>) <span class=keyword>USING</span> BTREE</span><br><span class=line>) <span class=keyword>ENGINE</span>=<span class=keyword>InnoDB</span> <span class=keyword>DEFAULT</span> <span class=keyword>CHARSET</span>=utf8mb4 ROW_FORMAT=DYNAMIC;</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=keyword>CREATE</span> <span class=keyword>TABLE</span> <span class=string>`JOB_STATUS_TRACE_LOG`</span> (</span><br><span class=line>  <span class=string>`id`</span> <span class=built_in>varchar</span>(<span class=number>40</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`job_name`</span> <span class=built_in>varchar</span>(<span class=number>100</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`original_task_id`</span> <span class=built_in>varchar</span>(<span class=number>255</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`task_id`</span> <span class=built_in>varchar</span>(<span class=number>255</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`slave_id`</span> <span class=built_in>varchar</span>(<span class=number>50</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`source`</span> <span class=built_in>varchar</span>(<span class=number>50</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`execution_type`</span> <span class=built_in>varchar</span>(<span class=number>20</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`sharding_item`</span> <span class=built_in>varchar</span>(<span class=number>100</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`state`</span> <span class=built_in>varchar</span>(<span class=number>20</span>) <span class=keyword>NOT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`message`</span> <span class=built_in>varchar</span>(<span class=number>4000</span>) <span class=keyword>DEFAULT</span> <span class=literal>NULL</span>,</span><br><span class=line>  <span class=string>`creation_time`</span> <span class=built_in>timestamp</span> <span class=literal>NULL</span> <span class=keyword>DEFAULT</span> <span class=literal>NULL</span>,</span><br><span class=line>  PRIMARY <span class=keyword>KEY</span> (<span class=string>`id`</span>) <span class=keyword>USING</span> BTREE,</span><br><span class=line>  <span class=keyword>KEY</span> <span class=string>`TASK_ID_STATE_INDEX`</span> (<span class=string>`task_id`</span>,<span class=string>`state`</span>) <span class=keyword>USING</span> BTREE</span><br><span class=line>) <span class=keyword>ENGINE</span>=<span class=keyword>InnoDB</span> <span class=keyword>DEFAULT</span> <span class=keyword>CHARSET</span>=utf8mb4 ROW_FORMAT=DYNAMIC;</span><br></pre></table></figure><h2 id=运维平台><a href=#运维平台 class=headerlink title=运维平台></a>运维平台</h2><p>ElasticJob提供了一个运维平台拱查看任务执行详情.<p>需要clone ElasticJob源码并install, 会生成运维平台的压缩包, 解压后通过脚本可一键启动运维平台.<p>根据启动脚本的内容, 可做成Docker镜像, 只需将lib包中的jar包copy进去再按照脚本的启动方式配置entrypoint即可.<p>Dockerfile:<figure class="highlight dockerfile"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=keyword>FROM</span> frolvlad/alpine-oraclejre8:slim</span><br><span class=line><span class=keyword>MAINTAINER</span> ybd &lt;yangbingdong1994@gmail.com&gt;</span><br><span class=line><span class=keyword>ADD</span><span class=bash> elastic-job-lite-console.tar.gz /</span></span><br><span class=line><span class=keyword>WORKDIR</span><span class=bash> elastic-job-lite-console</span></span><br><span class=line><span class=keyword>ENTRYPOINT</span><span class=bash> <span class=built_in>exec</span> java -classpath ./lib/*:. io.elasticjob.lite.console.ConsoleBootstrap 8080</span></span><br></pre></table></figure><p>docker-compose.yml:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>version: &apos;3.7&apos;</span><br><span class=line></span><br><span class=line>services:</span><br><span class=line>  job-console:</span><br><span class=line>    image: yangbingdong/elastic-job-console:latest</span><br><span class=line>    restart: always</span><br><span class=line>    ports:</span><br><span class=line>      - &quot;8090:8080&quot;</span><br><span class=line>    networks:</span><br><span class=line>      - backend</span><br><span class=line>    volumes:</span><br><span class=line>      - ./auth.properties:/elastic-job-lite-console/conf/auth.propertise</span><br><span class=line></span><br><span class=line>networks:</span><br><span class=line>  backend:</span><br><span class=line>    external: true</span><br></pre></table></figure><p>auth.properties:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>root.username=admin</span><br><span class=line>root.password=admin</span><br><span class=line>guest.username=guest</span><br><span class=line>guest.password=guest</span><br></pre></table></figure><h1 id=Redis-Keyspace-Notifications><a href=#Redis-Keyspace-Notifications class=headerlink title="Redis Keyspace Notifications"></a>Redis Keyspace Notifications</h1><p>通过设置一个过期键, 并在过期的时候回调监听者实现延迟任务.<p>可参考: <strong><em><a href=/2018/spring-boot-learning-redis/#Spring%E7%9B%91%E5%90%ACRedis-Keyspace-Event>Spring监听Redis Keyspace Event</a></em></strong><blockquote><p>Redis的<strong>pub/sub</strong>机制存在一个硬伤，官网内容如下<br><strong>原</strong>:Because Redis Pub/Sub is fire and forget currently there is no way to use this feature if your application demands reliable notification of events, that is, if your Pub/Sub client disconnects, and reconnects later, all the events delivered during the time the client was disconnected are lost.<p>就是说Redis的发布/订阅目前是即发即弃(fire and forget)模式的，因此无法实现事件的可靠通知。也就是说，如果发布/订阅的客户端断链之后又重连，则在客户端断链期间的所有事件都丢失了。</blockquote><h1 id=RabbitMQ-延迟队列><a href=#RabbitMQ-延迟队列 class=headerlink title="RabbitMQ 延迟队列"></a>RabbitMQ 延迟队列</h1><p>这是一个不错的方案, 结合 <code>rabbitmq_delayed_message_exchange</code> 插件可以很优雅地做到延迟任务.<p>可参考: <strong><em><a href=/2019/rabbitmq-and-spring-amqp-learning/#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97>延迟队列</a></em></strong><h1 id=基于-Redis-Sorted-Set-轮训的延迟任务><a href=#基于-Redis-Sorted-Set-轮训的延迟任务 class=headerlink title="基于 Redis Sorted Set 轮训的延迟任务"></a>基于 Redis Sorted Set 轮训的延迟任务</h1><ol><li>将关键数据以及<strong>执行时间戳</strong>分别作为 <code>Sorted Set</code> 的 <code>member</code> 和 <code>score</code> 添加到 <code>Sorted Set</code> 中.<li>通过周期任务使用 <code>ZRANGEBYSCORE</code> 命令读取指定数量的数据并删除 <code>Sorted Set</code> 中对应的数据.</ol><p>对于第二部需要使用 lua 保证原子性:<figure class="highlight lua"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line><span class=keyword>local</span> zset_key = KEYS[<span class=number>1</span>]</span><br><span class=line><span class=keyword>local</span> min_score = ARGV[<span class=number>1</span>]</span><br><span class=line><span class=keyword>local</span> max_score = ARGV[<span class=number>2</span>]</span><br><span class=line><span class=keyword>local</span> offset = ARGV[<span class=number>3</span>]</span><br><span class=line><span class=keyword>local</span> limit = ARGV[<span class=number>4</span>]</span><br><span class=line><span class=comment>-- TYPE命令的返回结果是&#123;'ok':'zset'&#125;这样子,这里利用next做一轮迭代</span></span><br><span class=line><span class=keyword>local</span> <span class=built_in>status</span>, <span class=built_in>type</span> = <span class=built_in>next</span>(redis.call(<span class=string>'TYPE'</span>, zset_key))</span><br><span class=line><span class=keyword>if</span> <span class=built_in>status</span> ~= <span class=literal>nil</span> <span class=keyword>and</span> <span class=built_in>status</span> == <span class=string>'ok'</span> <span class=keyword>then</span></span><br><span class=line>    <span class=keyword>if</span> <span class=built_in>type</span> == <span class=string>'zset'</span> <span class=keyword>then</span></span><br><span class=line>        <span class=keyword>local</span> list = redis.call(<span class=string>'ZRANGEBYSCORE'</span>, zset_key, max_score, min_score, <span class=string>'LIMIT'</span>, offset, limit)</span><br><span class=line>        <span class=keyword>if</span> list ~= <span class=literal>nil</span> <span class=keyword>and</span> #list &gt; <span class=number>0</span> <span class=keyword>then</span></span><br><span class=line>            <span class=comment>-- unpack函数能把table转化为可变参数</span></span><br><span class=line>            redis.call(<span class=string>'ZREM'</span>, zset_key, <span class=built_in>unpack</span>(list))</span><br><span class=line>            <span class=keyword>return</span> list</span><br><span class=line>        <span class=keyword>end</span></span><br><span class=line>    <span class=keyword>end</span></span><br><span class=line><span class=keyword>end</span></span><br><span class=line><span class=keyword>return</span> <span class=literal>nil</span></span><br></pre></table></figure><p><code>ZRANGEBYSCORE</code> 的时间复杂度为 <code>O(log(N)+M)</code>, 为了避免带来性能问题, 我们可以对key取模进行哈希处理.<h1 id=其他><a href=#其他 class=headerlink title=其他></a>其他</h1><h2 id=XXL-Job><a href=#XXL-Job class=headerlink title="XXL Job"></a>XXL Job</h2><p>由个人开源的中心化分布式调度平台:<p><strong><em><a href=http://www.xuxueli.com/xxl-job/#/ rel="external nofollow noopener noreferrer" target=_blank>http://www.xuxueli.com/xxl-job/#/</a></em></strong><h2 id=Saturn><a href=#Saturn class=headerlink title=Saturn></a>Saturn</h2><p>唯品会基于 Elastic Job 开发的分布式任务调度平台:<p><strong><em><a href=https://vipshop.github.io/Saturn/# rel="external nofollow noopener noreferrer" target=_blank>https://vipshop.github.io/Saturn/#</a></em></strong></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2018/spring-boot-scheduler/ title=Spring与任务调度>http://yangbingdong.com/2018/spring-boot-scheduler/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a>
<a href=/tags/Scheduler/ rel=tag><i class="fa fa-tag"></i>Scheduler</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2018/spring-boot-learning-redis/ rel=next title="Redis拾遗与Spring Boot整合"><i class="fa fa-chevron-left"></i>Redis拾遗与Spring Boot整合</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2019/nexus3-by-docker/ rel=prev title=Nexus搭建与Maven配置>Nexus搭建与Maven配置 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2018/spring-boot-scheduler/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2018/spring-boot-scheduler/';this.page.identifier='2018/spring-boot-scheduler/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>46</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>17</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>43</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Quartz><span class=nav-number>2.</span> <span class=nav-text>Quartz</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#主要成员><span class=nav-number>2.1.</span> <span class=nav-text>主要成员</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#构建流程><span class=nav-number>2.2.</span> <span class=nav-text>构建流程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#运行模式><span class=nav-number>2.3.</span> <span class=nav-text>运行模式</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#与Spring集成><span class=nav-number>2.4.</span> <span class=nav-text>与Spring集成</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#xml方式声明Job><span class=nav-number>2.4.1.</span> <span class=nav-text>xml方式声明Job</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#MethodInvokingJobDetailFactoryBean><span class=nav-number>2.4.1.1.</span> <span class=nav-text>MethodInvokingJobDetailFactoryBean</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#QuartzJobBean><span class=nav-number>2.4.1.2.</span> <span class=nav-text>QuartzJobBean</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#JobFactory><span class=nav-number>2.4.2.</span> <span class=nav-text>JobFactory</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Spring-Boot自动配置><span class=nav-number>2.5.</span> <span class=nav-text>Spring Boot自动配置</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Job的增删改><span class=nav-number>2.6.</span> <span class=nav-text>Job的增删改</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#其他问题><span class=nav-number>2.7.</span> <span class=nav-text>其他问题</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Durability><span class=nav-number>2.7.1.</span> <span class=nav-text>Durability</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Misfire><span class=nav-number>2.7.2.</span> <span class=nav-text>Misfire</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#maxBatchSize><span class=nav-number>2.7.3.</span> <span class=nav-text>maxBatchSize</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#性能问题><span class=nav-number>2.7.4.</span> <span class=nav-text>性能问题</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Scheduler><span class=nav-number>3.</span> <span class=nav-text>Spring Scheduler</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#开启配置><span class=nav-number>3.1.</span> <span class=nav-text>开启配置</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Xml方式><span class=nav-number>3.1.1.</span> <span class=nav-text>Xml方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Java配置方式><span class=nav-number>3.1.2.</span> <span class=nav-text>Java配置方式</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#使用><span class=nav-number>3.2.</span> <span class=nav-text>使用</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#Xml方式-1><span class=nav-number>3.2.1.</span> <span class=nav-text>Xml方式</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#注解声明方式><span class=nav-number>3.2.2.</span> <span class=nav-text>注解声明方式</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Cron表达式><span class=nav-number>4.</span> <span class=nav-text>Cron表达式</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#时间轮><span class=nav-number>5.</span> <span class=nav-text>时间轮</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Elastic-Job><span class=nav-number>6.</span> <span class=nav-text>Elastic Job</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Elastic-Job-与-Sping-Cloud-集成解决依赖冲突问题><span class=nav-number>6.1.</span> <span class=nav-text>Elastic Job 与 Sping Cloud 集成解决依赖冲突问题</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Spting-Boot-集成><span class=nav-number>6.2.</span> <span class=nav-text>Spting Boot 集成</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#运维平台><span class=nav-number>6.3.</span> <span class=nav-text>运维平台</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Redis-Keyspace-Notifications><span class=nav-number>7.</span> <span class=nav-text>Redis Keyspace Notifications</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#RabbitMQ-延迟队列><span class=nav-number>8.</span> <span class=nav-text>RabbitMQ 延迟队列</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#基于-Redis-Sorted-Set-轮训的延迟任务><span class=nav-number>9.</span> <span class=nav-text>基于 Redis Sorted Set 轮训的延迟任务</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#其他><span class=nav-number>10.</span> <span class=nav-text>其他</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#XXL-Job><span class=nav-number>10.1.</span> <span class=nav-text>XXL Job</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Saturn><span class=nav-number>10.2.</span> <span class=nav-text>Saturn</span></a></ol></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共277.3k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2018/spring-boot-scheduler/';var disqus_title="Spring与任务调度";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>