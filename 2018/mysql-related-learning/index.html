<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content=MySQL,><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface MySQL 是一款开源的关系型数据库, 也是使用最广泛的数据库之一, 作为开发人员, 很有必要理解以及学习 MySQL 的一些相关知识."><meta name=keywords content=MySQL><meta property=og:type content=article><meta property=og:title content="MySQL 杂谈"><meta property=og:url content=http://yangbingdong.com/2018/mysql-related-learning/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface MySQL 是一款开源的关系型数据库, 也是使用最广泛的数据库之一, 作为开发人员, 很有必要理解以及学习 MySQL 的一些相关知识."><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/MySQL.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-warning.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/mycli.gif><meta property=og:image content=https://cdn.yangbingdong.com/img/javaDevEnv/navicat12.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/MySQL%20Workbench_001.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-sql-execute-arch.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-update-processing.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-b-plus-tree.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain01.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain02.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain03.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain04.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain05.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain07.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain06.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain08.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain09.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain10.png><meta property=og:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain11.png><meta property=og:updated_time content=2020-08-27T12:58:13.319Z><meta name=twitter:card content=summary><meta name=twitter:title content="MySQL 杂谈"><meta name=twitter:description content="Preface MySQL 是一款开源的关系型数据库, 也是使用最广泛的数据库之一, 作为开发人员, 很有必要理解以及学习 MySQL 的一些相关知识."><meta name=twitter:image content=https://cdn.yangbingdong.com/img/mysql-related-learning/MySQL.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2018/mysql-related-learning/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>MySQL 杂谈 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2018/mysql-related-learning/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">MySQL 杂谈</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2018-02-16T15:16:18+08:00>2018-02-16</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/MySQL/ itemprop=url rel=index><span itemprop=name>MySQL</span></a></span></span>
<span id=/2018/mysql-related-learning/ class=leancloud_visitors data-flag-title="MySQL 杂谈"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>4,388字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>18分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/MySQL.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>MySQL 是一款开源的关系型数据库, 也是使用最广泛的数据库之一, 作为开发人员, 很有必要理解以及学习 MySQL 的一些相关知识.</blockquote><a id=more></a><h1 id=安装><a href=#安装 class=headerlink title=安装></a>安装</h1><h2 id=传统安装><a href=#传统安装 class=headerlink title=传统安装></a>传统安装</h2><p>请见<a href=/2017/ubuntu-dev-environment-to-build/#%E5%AE%89%E8%A3%85MySQL%E4%BB%A5%E5%8F%8AGUI%E5%B7%A5%E5%85%B7><em>之前写的的一篇开发环境配置</em></a><h2 id=Docker版安装><a href=#Docker版安装 class=headerlink title=Docker版安装></a>Docker版安装</h2><p>直接贴出<code>docker-compose.yml</code>:<figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line><span class=attr>version:</span> <span class=string>'3.5'</span></span><br><span class=line></span><br><span class=line><span class=attr>services:</span></span><br><span class=line>  <span class=attr>mysql:</span></span><br><span class=line>    <span class=attr>image:</span> <span class=string>mysql:latest</span></span><br><span class=line>    <span class=attr>container_name:</span> <span class=string>mysql</span></span><br><span class=line>    <span class=attr>ports:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>"3306:3306"</span></span><br><span class=line>    <span class=attr>volumes:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>../data:/var/lib/mysql</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>../conf:/etc/mysql/conf.d</span></span><br><span class=line>    <span class=attr>environment:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>MYSQL_ROOT_PASSWORD=root</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>TZ=Asia/Shanghai</span></span><br><span class=line>    <span class=attr>restart:</span> <span class=string>always</span></span><br><span class=line>    <span class=attr>networks:</span></span><br><span class=line>      <span class=bullet>-</span> <span class=string>backend</span></span><br><span class=line></span><br><span class=line><span class=attr>networks:</span></span><br><span class=line>  <span class=attr>backend:</span></span><br><span class=line>    <span class=attr>external:</span> <span class=literal>true</span></span><br></pre></table></figure><p>配置文件（<code>config-file.cnf</code>, 放在上面<code>volumes</code>中提到的<code>../conf</code>里）:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>[mysqld]</span><br><span class=line></span><br><span class=line>sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION</span><br><span class=line>lower_case_table_names = 1</span><br><span class=line>character-set-server = utf8mb4</span><br><span class=line>collation-server = utf8mb4_unicode_ci</span><br></pre></table></figure><h2 id=遇到问题><a href=#遇到问题 class=headerlink title=遇到问题></a>遇到问题</h2><h3 id=配置文件权限><a href=#配置文件权限 class=headerlink title=配置文件权限></a>配置文件权限</h3><p>虽然启动成功, 但发现MySQL实例是关闭的, 在启动日志中发现这一条信息<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-warning.png alt><p>大概意思是<strong>权限全局可写</strong>, 任何一个用户都可以写. MySQL担心这种文件<strong>被其他用户恶意修改</strong>, 所以<strong>忽略</strong>掉这个配置文件.<p>结论: <strong>配置文件权限过大, 会影响实例不能启动, 或者不能关闭, 需要修改为 644</strong><p>问题得以解决~！<h3 id=Docker时区><a href=#Docker时区 class=headerlink title=Docker时区></a>Docker时区</h3><p>通过Docker启动的MySql, 默认读取的是Docker中的时区UTC, 只要在docker compose文件中指定时区就行了:<figure class="highlight diff"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>    environment:</span><br><span class=line>      - MYSQL_ROOT_PASSWORD=root</span><br><span class=line><span class=addition>+     - TZ=Asia/Shanghai</span></span><br></pre></table></figure><p>或者在MySql配置文件中加入:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>[mysqld]</span><br><span class=line>...</span><br><span class=line>default-time-zone=&apos;+8:00&apos;</span><br></pre></table></figure><h3 id=连接不上><a href=#连接不上 class=headerlink title=连接不上></a>连接不上</h3><p>若抛出酱紫的错误:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>ERROR 2002 (HY000): Can&apos;t connect to local MySQL server through socket &apos;/var/run/mysqld/mysqld.sock&apos; (2)</span><br></pre></table></figure><p>那么你可能使用了 <code>localhost</code> 链接, 改为 <code>127.0.0.1</code> 或内网地址则OK.<h1 id=客户端以及GUI><a href=#客户端以及GUI class=headerlink title=客户端以及GUI></a>客户端以及GUI</h1><h2 id=传统终端客户端><a href=#传统终端客户端 class=headerlink title=传统终端客户端></a>传统终端客户端</h2><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>sudo apt-get install mysql-client</span><br><span class=line></span><br><span class=line>// 链接</span><br><span class=line>mysql -h 127.0.0.1 -P 3306 -u root -p</span><br></pre></table></figure><h2 id=智能补全命令客户端><a href=#智能补全命令客户端 class=headerlink title=智能补全命令客户端></a>智能补全命令客户端</h2><p>这个一个智能补全并且高亮语法的终端客户端 <strong><em><a href=https://github.com/dbcli/mycli rel="external nofollow noopener noreferrer" target=_blank>mycli</a></em></strong><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/mycli.gif alt><p>安装:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>sudo apt install mycli</span><br></pre></table></figure><p><code>mycli --help</code> 查看使用方法.<h2 id=Navicat-Premium><a href=#Navicat-Premium class=headerlink title="Navicat Premium"></a>Navicat Premium</h2><p>安装以及破解在<strong><em><a href=/2017/ubuntu-dev-environment-to-build/#Navicat-Premium>另一篇博文</a></em></strong>里面.<p><img src=https://cdn.yangbingdong.com/img/javaDevEnv/navicat12.png alt><h2 id=Workbench><a href=#Workbench class=headerlink title=Workbench></a>Workbench</h2><p>MySQL官方开源GUI<p>下载地址: <strong><em><a href=https://dev.mysql.com/downloads/workbench/ rel="external nofollow noopener noreferrer" target=_blank>https://dev.mysql.com/downloads/workbench/</a></em></strong><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/MySQL%20Workbench_001.png alt><h1 id=基础篇><a href=#基础篇 class=headerlink title=基础篇></a>基础篇</h1><h2 id=SQL-执行过程><a href=#SQL-执行过程 class=headerlink title="SQL 执行过程"></a>SQL 执行过程</h2><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-sql-execute-arch.png alt><p><strong>MySQL 8.0 以后已经缓存模块删除了</strong>.<h2 id=日志系统><a href=#日志系统 class=headerlink title=日志系统></a>日志系统</h2><p>日志作用:<ul><li>降低 IO 成本(WAL, 也就是 Write-Ahead Logging)<li>crash-safe, 崩溃恢复<li>数据恢复</ul><p>两种日志:<ul><li>redo log(range 结构), <strong>物理日志</strong>, 属于 <strong>InnoDb 特有</strong><li>binlog, <strong>逻辑日志</strong>, MySQL Server 层实现</ul><p>redo log 与 binlog 的一致性通过<strong>二阶段提交</strong>来保证(比如 redo log 写 prepare 成功, binlog 写入失败, 则会滚)<p>update 执行图:<blockquote><p><code>update T set c=c+1 where ID=2;</code></blockquote><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-update-processing.png alt><h2 id=事务隔离><a href=#事务隔离 class=headerlink title=事务隔离></a>事务隔离</h2><p>多事务并行会有以下问题:<ul><li>脏读(dirty read)<li>不可重复读(non-repeatable read)<li>幻读(phantom read)</ul><p>SQL 标准的事务隔离级别包括:<ul><li>读未提交(read uncommitted)<li>读提交(read committed)<li>可重复读(repeatable read)<li>串行化(serializable)</ul><p>事务隔离通过 MVCC 实现(undoLog + read-view), 使用到的三个字段: <strong>isDelete</strong>(是否删除字段) / <strong>DB_TRX_ID</strong>(事务字段) / <strong>DB_ROLL_PTR</strong>(回滚指针字段).<p>应该尽量避免长事务, 因为 undoLog 会占用大量空间.<p>MVCC 两种读形式:<ul><li>快照读: 读取的只是当前事务的可见版本, 不用加锁.<li>当前读: 读取的是当前版本, 比如 <strong>特殊的读操作, 更新/插入/删除操作</strong>.</ul><h2 id=索引><a href=#索引 class=headerlink title=索引></a>索引</h2><p>索引一般有<strong>Hash 索引</strong>以及<strong>B-Tree索引</strong>, 前者适合KV场景(等值查询), 后者适合范围查找.<p>B-Tree索引又分为两种类型:<ul><li><strong>主键索引</strong>, 又称<strong>聚簇索引</strong>, 因为叶子节点存放着整行数据<li>非主键索引, 又称<strong>非聚簇索引</strong>, 叶子节点存放的是主键</ul><h1 id=索引相关><a href=#索引相关 class=headerlink title=索引相关></a>索引相关</h1><h2 id=科普><a href=#科普 class=headerlink title=科普></a>科普</h2><h3 id=B-Tree><a href=#B-Tree class=headerlink title="B+ Tree"></a>B+ Tree</h3><p>Innodb 采用 B+ Tree 结构, 索引也是.<p>B+ Tree 的几个特征:<ul><li>最底层的节点叫作叶子节点, 用来存放数据<li>其他上层节点叫作非叶子节点, 仅用来存放目录项, 作为索引<li>非叶子节点分为不同层次, 通过分层来降低每一层的搜索量<li>所有节点<strong>按照索引键大小排序</strong>, 构成一个双向链表, 加速范围查找</ul><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/mysql-b-plus-tree.png alt><p>B+ 树, 既可以保存实际数据, 也可以加速数据搜索, 这就是聚簇索引.由于数据在物理上只会保存一份, <strong>所以包含实际数据的聚簇索引只能有一个</strong>.<h3 id=回表><a href=#回表 class=headerlink title=回表></a>回表</h3><p>为了实现非主键字段的快速搜索, 就引出了二级索引, 也叫作<strong>非聚簇索引</strong>或者辅助索引. 二级索引的叶子节点中保存的不是实际数据, 而是主键, 获得主键值后去聚簇索引中获得数据行, 这个过程就叫作<strong>回表</strong>.<h3 id=索引覆盖><a href=#索引覆盖 class=headerlink title=索引覆盖></a>索引覆盖</h3><p>如果我们需要查询的是索引列索引或联合索引能覆盖的数据, 那么查询索引本身已经 “覆盖” 了需要的数据不再需要回表查询.<h3 id=索引下推><a href=#索引下推 class=headerlink title=索引下推></a>索引下推</h3><p>索引下推优化(index condition pushdown)是在 MySQL 5.6 引入的: 可以在索引遍历过程中, 对索引中包含的字段先做判断, 直接过滤掉不满足条件的记录, 减少回表次数.<h2 id=如何判断数据库索引是否生效><a href=#如何判断数据库索引是否生效 class=headerlink title=如何判断数据库索引是否生效></a>如何判断数据库索引是否生效</h2><p>使用<code>explain ... \G</code>分析语句 (使用<code>\G</code>可格式化结果)<p>表结构:<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain01.png alt><p>不使用索引:<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain02.png alt><p>使用索引:<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain03.png alt><p>可以看到, 使用<code>explain</code>显示了很多列, 各个关键字的含义如下:<ul><li><p><code>table</code>: 顾名思义, 显示这一行的数据是关于哪张表的；<li><p><code>type</code>: 这是重要的列, 显示连接使用了何种类型. 从<strong>最好到最差</strong>的连接类型为: <code>const</code>、<code>eq_reg</code>、<code>ref</code>、<code>range</code>、<code>indexhe</code>和<code>ALL</code>（详情: <a href=https://dev.mysql.com/doc/refman/5.7/en/explain-output.html#explain-join-types rel="external nofollow noopener noreferrer" target=_blank><em>https://dev.mysql.com/doc/refman/5.7/en/explain-output.html#explain-join-types</em></a>）；<li><p><code>possible_keys</code>: 显示可能应用在这张表中的索引. 如果为空, 没有可能的索引. 可以为相关的域从<code>where</code>语句中选择一个合适的语句；<li><p><code>key</code>: 实际使用的索引. 如果为<code>NULL</code>, 则没有使用索引. 很少的情况下, MySQL会选择优化不足的索引. 这种情况下, 可以在<code>Select</code>语句中使用<code>USE INDEX（indexname）</code>来强制使用一个索引或者用<code>IGNORE INDEX（indexname）</code>来强制MySQL忽略索引；<li><p><code>key_len</code>: 使用的索引的长度. 在不损失精确性的情况下, 长度越短越好；<li><p><code>ref</code>: 显示索引的哪一列被使用了, 如果可能的话, 是一个常数；<li><p><code>rows</code>: MySQL认为必须检查的用来返回请求数据的行数；<li><p><code>Extra</code>: 关于MySQL如何解析查询的额外信息.<p>以下是<code>Extra</code>返回含义:<p><code>Distinct</code>:一旦MYSQL找到了与行相联合匹配的行, 就不再搜索了<p><code>Not exists</code>: MYSQL优化了<code>LEFT JOIN</code>, 一旦它找到了匹配<code>LEFT JOIN</code>标准的行, 就不再搜索了<p><code>Range checked for each Record（index map:#）</code>:没有找到理想的索引, 因此对于从前面表中来的每一个行组合, MYSQL检查使用哪个索引, 并用它来从表中返回行. 这是使用索引的最慢的连接之一<p><code>Using filesort</code>: 看到这个的时候, 查询就需要优化了. MYSQL需要进行额外的步骤来发现如何对返回的行排序. 它根据连接类型以及存储排序键值和匹配条件的全部行的行指针来排序全部行<p><code>Using index</code>: 列数据是从仅仅使用了索引中的信息而没有读取实际的行动的表返回的, 这发生在对表的全部的请求列都是同一个索引的部分的时候<p><code>Using temporary</code> 看到这个的时候, 查询需要优化了. 这里, MYSQL需要创建一个临时表来存储结果, 这通常发生在对不同的列集进行<code>ORDER BY</code>上, 而不是<code>GROUP BY</code>上<p><code>Where used</code> 使用了<code>WHERE</code>从句来限制哪些行将与下一张表匹配或者是返回给用户. 如果不想返回表中的全部行, 并且连接类型<code>ALL</code>或<code>index</code>, 这就会发生, 或者是查询有问题不同连接类型的解释（按照效率高低的顺序排序）<p><code>system</code> 表只有一行: <code>system</code>表. 这是<code>const</code>连接类型的特殊情况<p><code>const</code>:表中的一个记录的最大值能够匹配这个查询（索引可以是主键或惟一索引）. 因为只有一行, 这个值实际就是常数, 因为MYSQL先读这个值然后把它当做常数来对待<p><code>eq_ref</code>:在连接中, MYSQL在查询时, 从前面的表中, 对每一个记录的联合都从表中读取一个记录, 它在查询使用了索引为主键或惟一键的全部时使用<p><code>ref</code>:这个连接类型只有在查询使用了不是惟一或主键的键或者是这些类型的部分（比如, 利用最左边前缀）时发生. 对于之前的表的每一个行联合, 全部记录都将从表中读出. 这个类型严重依赖于根据索引匹配的记录多少—越少越好<p><code>range</code>:这个连接类型使用索引返回一个范围中的行, 比如使用&gt;或&lt;查找东西时发生的情况<p><code>index</code>: 这个连接类型对前面的表中的每一个记录联合进行完全扫描（比ALL更好, 因为索引一般小于表数据）<p><code>ALL</code>:这个连接类型对于前面的每一个记录联合进行完全扫描, 这一般比较糟糕, 应该尽量避免</ul><p>具体的各个列所能表示的值以及含义可以参考MySQL官方文档介绍, 地址: <a href=https://dev.mysql.com/doc/refman/5.7/en/explain-output.html rel="external nofollow noopener noreferrer" target=_blank><em>https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</em></a><h2 id=哪些场景会造成索引失效><a href=#哪些场景会造成索引失效 class=headerlink title=哪些场景会造成索引失效></a>哪些场景会造成索引失效</h2><ol><li><p>应尽量避免在 <code>where</code> 子句中使用 <code>!=</code> 或 <code>&lt;&gt;</code> 操作符, 否则引擎将放弃使用索引而进行全表扫描<li><p>尽量避免在 <code>where</code> 子句中使用 <code>or</code> 来连接条件, 否则将<strong>导致引擎放弃使用索引而进行全表扫描</strong>, 即使其中有条件带索引也不会使用, 这也是为什么尽量少用 <code>or</code> 的原因<li><p>对于<strong>多列索引</strong>, <strong>不是使用的第一部分</strong>, 则不会使用索引<li><p>隐式转换, 比如列类型是<strong>字符串</strong>, 那一定要在条件中将数据使用<strong>引号</strong>引用起来, 否则不会使用索引<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain04.png alt><li><p>可能由于字符集导致的索引失败, 连表查询中, 两个关联字段的字符集不一样会导致索引失效, 因为字符集不一样 MySQL 或使用函数将字符集改成一样的<li><p><code>like</code>的模糊查询以 <code>%</code> 开头, 索引失效, 索引 B+ 树中行数据<strong>按照索引值排序</strong>, 只能根据前缀进行比较.<li><p>应尽量<strong>避免</strong>在 <code>where</code> 子句中对字段进行<strong>表达式操作</strong>, 这将导致引擎放弃使用索引而进行全表扫描<p>如:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>select id from t where num/2 = 100 1</span><br></pre></table></figure><p>应改为:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>select id from t where num = 100*2；1</span><br></pre></table></figure><li><p>应尽量<strong>避免</strong>在 where 子句中对字段进行<strong>函数操作</strong>, 这将导致引擎放弃使用索引而进行全表扫描, 同样的原因, 索引保存的是索引列的原始值, 而不是经过函数计算后的值<p>例如:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>select id from t where substring(name,1,3) = &apos;abc&apos; – name;1</span><br></pre></table></figure><p>以abc开头的, 应改成:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>select id from t where name like ‘abc%’ 1</span><br></pre></table></figure><p>例如:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>select id from t where datediff(day, createdate, &apos;2005-11-30&apos;) = 0 – &apos;2005-11-30&apos;;1</span><br></pre></table></figure><p>应改为:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>select id from t where createdate &gt;= &apos;2005-11-30&apos; and createdate &lt; &apos;2005-12-1&apos;;</span><br></pre></table></figure><li><p>不要在 <code>where</code> 子句中的 <code>=</code> 左边进行函数、算术运算或其他表达式运算, 否则系统将可能无法正确使用索引<li><p>如果MySQL估计使用全表扫描要比使用索引快, 则不使用索引<li><p>不适合键值较少的列（重复数据较多的列）<blockquote><p>假如索引列TYPE有5个键值, 如果有1万条数据, 那么 WHERE TYPE = 1将访问表中的2000个数据块. 再加上访问索引块, 一共要访问大于2000个的数据块. 如果全表扫描, 假设10条数据一个数据块, 那么只需访问1000个数据块, 既然全表扫描访问的数据块少一些, 肯定就不会利用索引了.</blockquote></ol><blockquote><p>参考: <em><a href=http://blog.csdn.net/xlgen157387/article/details/79572598 rel="external nofollow noopener noreferrer" target=_blank>http://blog.csdn.net/xlgen157387/article/details/79572598</a></em></blockquote><h1 id=其他><a href=#其他 class=headerlink title=其他></a>其他</h1><h2 id=JSON相关><a href=#JSON相关 class=headerlink title=JSON相关></a>JSON相关</h2><h3 id=JSON支持><a href=#JSON支持 class=headerlink title=JSON支持></a>JSON支持</h3><ul><li>在MySQL 5.7.8中, MySQL支持由RFC 7159定义的本地JSON数据类型, 它支持对JSON(JavaScript对象标记)文档中的数据进行有效访问.<li>MySQL会对DML JSON数据自动验证. 无效的DML JSON数据操作会产生错误.<li>优化的存储格式. 存储在JSON列中的JSON文档转换为一种内部格式, 允许对Json元素进行快速读取访问.<li>MySQL Json类型支持通过虚拟列方式建立索引, 从而增加查询性能提升.</ul><h4 id=函数语法><a href=#函数语法 class=headerlink title=函数语法></a>函数语法</h4><p>mysql在json类型中增加了一些json相关的函数 可以参考如下<table><thead><tr><th>Name<th>Description<tbody><tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-append rel="external nofollow noopener noreferrer" target=_blank><code>JSON_APPEND()</code></a> (deprecated 5.7.9)<td>Append data to JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-creation-functions.html#function_json-array rel="external nofollow noopener noreferrer" target=_blank><code>JSON_ARRAY()</code></a><td>Create JSON array<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-array-append rel="external nofollow noopener noreferrer" target=_blank><code>JSON_ARRAY_APPEND()</code></a><td>Append data to JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-array-insert rel="external nofollow noopener noreferrer" target=_blank><code>JSON_ARRAY_INSERT()</code></a><td>Insert into JSON array<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#operator_json-column-path rel="external nofollow noopener noreferrer" target=_blank><code>-&gt;</code></a><td>Return value from JSON column after evaluating path; equivalent to JSON_EXTRACT().<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#function_json-contains rel="external nofollow noopener noreferrer" target=_blank><code>JSON_CONTAINS()</code></a><td>Whether JSON document contains specific object at path<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#function_json-contains-path rel="external nofollow noopener noreferrer" target=_blank><code>JSON_CONTAINS_PATH()</code></a><td>Whether JSON document contains any data at path<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-attribute-functions.html#function_json-depth rel="external nofollow noopener noreferrer" target=_blank><code>JSON_DEPTH()</code></a><td>Maximum depth of JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#function_json-extract rel="external nofollow noopener noreferrer" target=_blank><code>JSON_EXTRACT()</code></a><td>Return data from JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#operator_json-inline-path rel="external nofollow noopener noreferrer" target=_blank><code>-&gt;&gt;</code></a><td>Return value from JSON column after evaluating path and unquoting the result; equivalent to JSON_UNQUOTE(JSON_EXTRACT()).<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-insert rel="external nofollow noopener noreferrer" target=_blank><code>JSON_INSERT()</code></a><td>Insert data into JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#function_json-keys rel="external nofollow noopener noreferrer" target=_blank><code>JSON_KEYS()</code></a><td>Array of keys from JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-attribute-functions.html#function_json-length rel="external nofollow noopener noreferrer" target=_blank><code>JSON_LENGTH()</code></a><td>Number of elements in JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-merge rel="external nofollow noopener noreferrer" target=_blank><code>JSON_MERGE()</code></a> (deprecated 5.7.22)<td>Merge JSON documents, preserving duplicate keys. Deprecated synonym for JSON_MERGE_PRESERVE()<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-merge-patch rel="external nofollow noopener noreferrer" target=_blank><code>JSON_MERGE_PATCH()</code></a><td>Merge JSON documents, replacing values of duplicate keys<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-merge-preserve rel="external nofollow noopener noreferrer" target=_blank><code>JSON_MERGE_PRESERVE()</code></a><td>Merge JSON documents, preserving duplicate keys<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-creation-functions.html#function_json-object rel="external nofollow noopener noreferrer" target=_blank><code>JSON_OBJECT()</code></a><td>Create JSON object<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-utility-functions.html#function_json-pretty rel="external nofollow noopener noreferrer" target=_blank><code>JSON_PRETTY()</code></a><td>Prints a JSON document in human-readable format, with each array element or object member printed on a new line, indented two spaces with respect to its parent.<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-creation-functions.html#function_json-quote rel="external nofollow noopener noreferrer" target=_blank><code>JSON_QUOTE()</code></a><td>Quote JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-remove rel="external nofollow noopener noreferrer" target=_blank><code>JSON_REMOVE()</code></a><td>Remove data from JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-replace rel="external nofollow noopener noreferrer" target=_blank><code>JSON_REPLACE()</code></a><td>Replace values in JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html#function_json-search rel="external nofollow noopener noreferrer" target=_blank><code>JSON_SEARCH()</code></a><td>Path to value within JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-set rel="external nofollow noopener noreferrer" target=_blank><code>JSON_SET()</code></a><td>Insert data into JSON document<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-utility-functions.html#function_json-storage-size rel="external nofollow noopener noreferrer" target=_blank><code>JSON_STORAGE_SIZE()</code></a><td>Space used for storage of binary representation of a JSON document; for a JSON column, the space used when the document was inserted, prior to any partial updates<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-attribute-functions.html#function_json-type rel="external nofollow noopener noreferrer" target=_blank><code>JSON_TYPE()</code></a><td>Type of JSON value<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-modification-functions.html#function_json-unquote rel="external nofollow noopener noreferrer" target=_blank><code>JSON_UNQUOTE()</code></a><td>Unquote JSON value<tr><td><a href=https://dev.mysql.com/doc/refman/5.7/en/json-attribute-functions.html#function_json-valid rel="external nofollow noopener noreferrer" target=_blank><code>JSON_VALID()</code></a><td>Whether JSON value is valid</table><p>常见的就是<code>JSON_EXTRACT()等</code><h4 id=表结构><a href=#表结构 class=headerlink title=表结构></a>表结构</h4><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain05.png alt><h4 id=插入数据><a href=#插入数据 class=headerlink title=插入数据></a>插入数据</h4><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>INSERT INTO `user_json` VALUES (1, &apos;&#123;\&quot;name\&quot;: \&quot;yang\&quot;, \&quot;address\&quot;: \&quot;shenyang\&quot;&#125;&apos;);</span><br><span class=line>...</span><br></pre></table></figure><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain07.png alt><p><strong>JSON校验</strong>:<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain06.png alt><h4 id=查询><a href=#查询 class=headerlink title=查询></a>查询</h4><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>select * from user_json where json_extract(data,&apos;$.name&apos;)=&apos;yang&apos;;</span><br><span class=line>select json_extract(data,&apos;$.name&apos;) from user_json where json_extract(data,&apos;$.name&apos;)=&apos;yang&apos;;</span><br><span class=line>select data-&gt;&apos;$.name&apos; from user_json where data-&gt;&apos;$.name&apos;=&apos;yang&apos;;</span><br></pre></table></figure><p>发现结果集是带有双引号的:<p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain08.png alt><p>如果想要去除双引号一般来说我们这样:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>select JSON_UNQUOTE(json_extract(data,&apos;$.name&apos;))from user_json where json_extract(data,&apos;$.name&apos;)=&apos;yang&apos;;</span><br><span class=line>select  data-&gt;&gt;&apos;$.name&apos; from user_json where data-&gt;&apos;$.name&apos;=&apos;yang&apos;;</span><br></pre></table></figure><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain09.png alt><h3 id=JSON如何建立索引><a href=#JSON如何建立索引 class=headerlink title=JSON如何建立索引></a>JSON如何建立索引</h3><p>json类型并不能建立索引, 但我们可以通过<strong>虚拟列</strong>来建立索引<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>ALTER TABLE user_json ADD COLUMN `virtual_name` varchar(20) GENERATED ALWAYS AS (data-&gt;&gt;&apos;$.name&apos;) VIRTUAL NULL AFTER `data`;</span><br><span class=line></span><br><span class=line>ALTER TABLE user_json ADD KEY (virtual_name);</span><br></pre></table></figure><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain10.png alt><p><img src=https://cdn.yangbingdong.com/img/mysql-related-learning/idx-explain11.png alt><p>可以看到索引起作用了~<p>像时间这些要把周一到周日建索引也是可以的:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>`dayofweek` tinyint(4) GENERATED ALWAYS AS (dayofweek(SomeDate)) VIRTUAL,</span><br></pre></table></figure><p>或者某些很麻烦的条件:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>alter table ApiLog add verb_url_hash varbinary(16) GENERATED ALWAYS AS (unhex(md5(CONCAT(verb, &apos; - &apos;, replace(url,&apos;.xml&apos;,&apos;&apos;))))) VIRTUAL;</span><br><span class=line>alter table ApiLog add key (verb_url_hash);</span><br></pre></table></figure><h3 id=其他区别><a href=#其他区别 class=headerlink title=其他区别></a>其他区别</h3><p>1、对于AUTO_INCREMENT类型的字段, InnoDB中必须包含只有该字段的索引, 但是在MyISAM表中, 可以和其他字段一起建立联合索引.<p>2、DELETE FROM table时, InnoDB不会重新建立表, 而是一行一行的删除.<p>3、LOAD TABLE FROMMASTER操作对InnoDB是不起作用的, 解决方法是首先把InnoDB表改成MyISAM表, 导入数据后再改成InnoDB表, 但是对于使用的额外的InnoDB特性(例如外键)的表不适用.<p>4、 InnoDB存储引擎被完全与MySQL服务器整合, InnoDB存储引擎为在主内存中缓存数据和索引而维持它自己的缓冲池.<p>5、对于自增长的字段, InnoDB中必须包含只有该字段的索引, 但是在MyISAM表中可以和其他字段一起建立联合索引.<p>6、清空整个表时, InnoDB是一行一行的删除, 效率非常慢. MyISAM则会重建表.<h2 id=SQL-查看表信息><a href=#SQL-查看表信息 class=headerlink title="SQL 查看表信息"></a>SQL 查看表信息</h2><p><strong>查看创建表</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SHOW</span> <span class=keyword>CREATE</span> <span class=keyword>TABLE</span> test_table;</span><br></pre></table></figure><p><strong>查看表信息</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SHOW</span> <span class=keyword>TABLE</span> <span class=keyword>STATUS</span> <span class=keyword>WHERE</span> <span class=keyword>NAME</span> <span class=keyword>IN</span>(<span class=string>'test_table'</span>, <span class=string>'person'</span>);</span><br></pre></table></figure><p>更详细信息:<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SELECT</span> * <span class=keyword>FROM</span> information_schema.tables <span class=keyword>WHERE</span> table_schema=<span class=string>'test_db'</span> <span class=keyword>AND</span> table_name=<span class=string>'test_table'</span>;</span><br></pre></table></figure><p><strong>查看字段信息</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SHOW</span> <span class=keyword>FULL</span> <span class=keyword>FIELDS</span> <span class=keyword>FROM</span> <span class=string>`test_table`</span>;</span><br></pre></table></figure><p>更详细信息:<figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>SELECT</span> * <span class=keyword>FROM</span> information_schema.COLUMNS <span class=keyword>WHERE</span> table_schema=<span class=string>'test_db'</span> <span class=keyword>AND</span> table_name=<span class=string>'test_table'</span>;</span><br></pre></table></figure><p><strong>查看表索引</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line><span class=keyword>SHOW</span> <span class=keyword>INDEX</span> <span class=keyword>FROM</span> test_table;</span><br><span class=line><span class=comment>-- 或者</span></span><br><span class=line><span class=keyword>SHOW</span> <span class=keyword>KEYS</span> <span class=keyword>from</span> test_table;</span><br></pre></table></figure><h2 id=实用语句><a href=#实用语句 class=headerlink title=实用语句></a>实用语句</h2><p><strong>查看事务隔离级别:</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>show</span> <span class=keyword>variables</span> <span class=keyword>like</span> <span class=string>'transaction_isolation'</span></span><br></pre></table></figure><p><strong>查看长事务:</strong><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line><span class=keyword>select</span> * <span class=keyword>from</span> information_schema.innodb_trx <span class=keyword>where</span> TIME_TO_SEC(<span class=keyword>timediff</span>(<span class=keyword>now</span>(),trx_started))&gt;<span class=number>60</span></span><br></pre></table></figure><h2 id=备份数据与恢复><a href=#备份数据与恢复 class=headerlink title=备份数据与恢复></a>备份数据与恢复</h2><p>从Navicat中导入导出数据是比较慢的, 我们可以通过 <code>mysqldump</code> (安装 <code>mysql-client</code> 后自带)备份.<h3 id=mysqldump-备份><a href=#mysqldump-备份 class=headerlink title="mysqldump 备份"></a>mysqldump 备份</h3><p>备份一个数据库:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump -u [uname] -p[pass] db_name &gt; db_backup.sql</span><br></pre></table></figure><p>备份所有数据库:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump -u [uname] -p[pass] --all-databases &gt; all_db_backup.sql</span><br></pre></table></figure><p>备份特定的表:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump -u [uname] -p[pass] db_name table1 table2 &gt; table_backup.sql</span><br></pre></table></figure><p>导出压缩一步到位:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump -u [uname] -p[pass] db_name | gzip &gt; db_backup.sql.gz</span><br></pre></table></figure><p>远程数据库:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump -P 3306 -h [ip_address] -u [uname] -p[pass] db_name &gt; db_backup.sql</span><br></pre></table></figure><p>遇到 <code>mysqldump: Got error: 1044: Access denied for user</code> 解决办法:<p>加上 <code>--single-transaction</code> 即可, 网上有人说使用 <code>--skip-lock-tables</code>, 这个会影响数据的一致性(可能比丢数据还要遭糕)，故不推荐使用这个方法:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysqldump --single-transaction -P 3306 -h [ip_address] -u [uname] -p[pass] db_name &gt; db_backup.sql</span><br></pre></table></figure><h3 id=恢复><a href=#恢复 class=headerlink title=恢复></a>恢复</h3><p>恢复一个数据库:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysql -h [host] -P [port] -u [uname] -p[pass] db_name &lt; db_backup.sql</span><br></pre></table></figure><p>恢复全部数据库:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>mysql -h [host] -P [port] -u [uname] -p[pass] &lt; db_backup_all.sql</span><br></pre></table></figure><h2 id=死锁排查><a href=#死锁排查 class=headerlink title=死锁排查></a>死锁排查</h2><p><strong><em><a href=https://mp.weixin.qq.com/s/HT1tWfEPnigBO9fhML6y0w rel="external nofollow noopener noreferrer" target=_blank>解决死锁之路（终结篇）- 再见死锁</a></em></strong></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2018/mysql-related-learning/ title="MySQL 杂谈">http://yangbingdong.com/2018/mysql-related-learning/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/MySQL/ rel=tag><i class="fa fa-tag"></i>MySQL</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2018/disruptor-learning/ rel=next title="极致的追求, 高性能并发框架 Disruptor"><i class="fa fa-chevron-left"></i>极致的追求, 高性能并发框架 Disruptor</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2018/spring-boot-learning-hodgepodge/ rel=prev title="Spring Boot学习之杂记篇">Spring Boot学习之杂记篇 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2018/mysql-related-learning/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2018/mysql-related-learning/';this.page.identifier='2018/mysql-related-learning/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>50</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>19</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>48</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#安装><span class=nav-number>2.</span> <span class=nav-text>安装</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#传统安装><span class=nav-number>2.1.</span> <span class=nav-text>传统安装</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Docker版安装><span class=nav-number>2.2.</span> <span class=nav-text>Docker版安装</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#遇到问题><span class=nav-number>2.3.</span> <span class=nav-text>遇到问题</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#配置文件权限><span class=nav-number>2.3.1.</span> <span class=nav-text>配置文件权限</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Docker时区><span class=nav-number>2.3.2.</span> <span class=nav-text>Docker时区</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#连接不上><span class=nav-number>2.3.3.</span> <span class=nav-text>连接不上</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#客户端以及GUI><span class=nav-number>3.</span> <span class=nav-text>客户端以及GUI</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#传统终端客户端><span class=nav-number>3.1.</span> <span class=nav-text>传统终端客户端</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#智能补全命令客户端><span class=nav-number>3.2.</span> <span class=nav-text>智能补全命令客户端</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Navicat-Premium><span class=nav-number>3.3.</span> <span class=nav-text>Navicat Premium</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Workbench><span class=nav-number>3.4.</span> <span class=nav-text>Workbench</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#基础篇><span class=nav-number>4.</span> <span class=nav-text>基础篇</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#SQL-执行过程><span class=nav-number>4.1.</span> <span class=nav-text>SQL 执行过程</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#日志系统><span class=nav-number>4.2.</span> <span class=nav-text>日志系统</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#事务隔离><span class=nav-number>4.3.</span> <span class=nav-text>事务隔离</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#索引><span class=nav-number>4.4.</span> <span class=nav-text>索引</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#索引相关><span class=nav-number>5.</span> <span class=nav-text>索引相关</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#科普><span class=nav-number>5.1.</span> <span class=nav-text>科普</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#B-Tree><span class=nav-number>5.1.1.</span> <span class=nav-text>B+ Tree</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#回表><span class=nav-number>5.1.2.</span> <span class=nav-text>回表</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#索引覆盖><span class=nav-number>5.1.3.</span> <span class=nav-text>索引覆盖</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#索引下推><span class=nav-number>5.1.4.</span> <span class=nav-text>索引下推</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#如何判断数据库索引是否生效><span class=nav-number>5.2.</span> <span class=nav-text>如何判断数据库索引是否生效</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#哪些场景会造成索引失效><span class=nav-number>5.3.</span> <span class=nav-text>哪些场景会造成索引失效</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#其他><span class=nav-number>6.</span> <span class=nav-text>其他</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#JSON相关><span class=nav-number>6.1.</span> <span class=nav-text>JSON相关</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#JSON支持><span class=nav-number>6.1.1.</span> <span class=nav-text>JSON支持</span></a><ol class=nav-child><li class="nav-item nav-level-4"><a class=nav-link href=#函数语法><span class=nav-number>6.1.1.1.</span> <span class=nav-text>函数语法</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#表结构><span class=nav-number>6.1.1.2.</span> <span class=nav-text>表结构</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#插入数据><span class=nav-number>6.1.1.3.</span> <span class=nav-text>插入数据</span></a><li class="nav-item nav-level-4"><a class=nav-link href=#查询><span class=nav-number>6.1.1.4.</span> <span class=nav-text>查询</span></a></ol><li class="nav-item nav-level-3"><a class=nav-link href=#JSON如何建立索引><span class=nav-number>6.1.2.</span> <span class=nav-text>JSON如何建立索引</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#其他区别><span class=nav-number>6.1.3.</span> <span class=nav-text>其他区别</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#SQL-查看表信息><span class=nav-number>6.2.</span> <span class=nav-text>SQL 查看表信息</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#实用语句><span class=nav-number>6.3.</span> <span class=nav-text>实用语句</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#备份数据与恢复><span class=nav-number>6.4.</span> <span class=nav-text>备份数据与恢复</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#mysqldump-备份><span class=nav-number>6.4.1.</span> <span class=nav-text>mysqldump 备份</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#恢复><span class=nav-number>6.4.2.</span> <span class=nav-text>恢复</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#死锁排查><span class=nav-number>6.5.</span> <span class=nav-text>死锁排查</span></a></ol></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共290.0k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2018/mysql-related-learning/';var disqus_title="MySQL 杂谈";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>