<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Redis,Spring Boot,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库, 并提供多种语言的API. 相比Memcached它支持存储的类型相对更多（字符、哈希、集合、有序集合、列表、GEO）, 同时Redis是线程安全的. 2010年3月15日起, Redis的开发工作由VMware主持, 2013年5月开始, Redis的开发由Pivo"><meta name=keywords content="Redis,Spring Boot"><meta property=og:type content=article><meta property=og:title content="Redis拾遗与Spring Boot整合"><meta property=og:url content=http://yangbingdong.com/2018/spring-boot-learning-redis/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库, 并提供多种语言的API. 相比Memcached它支持存储的类型相对更多（字符、哈希、集合、有序集合、列表、GEO）, 同时Redis是线程安全的. 2010年3月15日起, Redis的开发工作由VMware主持, 2013年5月开始, Redis的开发由Pivo"><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-redis/redis-logo.png><meta property=og:image content=https://cdn.yangbingdong.com/img/javaDevEnv/rdr.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-redis/serialize-performance.png><meta property=og:image content=https://cdn.yangbingdong.com/img/spring-boot-redis/redis-key-expire-disruptor.png><meta property=og:updated_time content=2020-07-15T11:05:06.641Z><meta name=twitter:card content=summary><meta name=twitter:title content="Redis拾遗与Spring Boot整合"><meta name=twitter:description content="Preface Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库, 并提供多种语言的API. 相比Memcached它支持存储的类型相对更多（字符、哈希、集合、有序集合、列表、GEO）, 同时Redis是线程安全的. 2010年3月15日起, Redis的开发工作由VMware主持, 2013年5月开始, Redis的开发由Pivo"><meta name=twitter:image content=https://cdn.yangbingdong.com/img/spring-boot-redis/redis-logo.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2018/spring-boot-learning-redis/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>Redis拾遗与Spring Boot整合 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2018/spring-boot-learning-redis/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">Redis拾遗与Spring Boot整合</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2018-10-06T16:15:04+08:00>2018-10-06</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/Spring-Boot/ itemprop=url rel=index><span itemprop=name>Spring Boot</span></a></span></span>
<span id=/2018/spring-boot-learning-redis/ class=leancloud_visitors data-flag-title="Redis拾遗与Spring Boot整合"><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>6,047字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>28分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/spring-boot-redis/redis-logo.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库, 并提供多种语言的API. 相比<code>Memcached</code>它支持存储的类型相对更多<strong>（字符、哈希、集合、有序集合、列表、GEO）</strong>, <strong>同时Redis是线程安全的</strong>. 2010年3月15日起, Redis的开发工作由VMware主持, 2013年5月开始, Redis的开发由<code>Pivotal</code>赞助.</blockquote><a id=more></a><h1 id=安装与配置><a href=#安装与配置 class=headerlink title=安装与配置></a>安装与配置</h1><h2 id=安装><a href=#安装 class=headerlink title=安装></a>安装</h2><h3 id=基于Docker安装><a href=#基于Docker安装 class=headerlink title=基于Docker安装></a>基于Docker安装</h3><p>拉取镜像:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>docker pull redis:latest</span><br></pre></table></figure><p>运行实例:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>REDIS=/home/ybd/data/docker/redis &amp;&amp; \</span><br><span class=line>docker run -p 6379:6379 --restart=always \</span><br><span class=line>-v $REDIS/redis.conf:/usr/local/etc/redis/redis.conf \</span><br><span class=line>-v $REDIS/data:/data \</span><br><span class=line>--name redis -d redis \</span><br><span class=line>redis-server /usr/local/etc/redis/redis.conf --appendonly yes</span><br></pre></table></figure><p>安装链接工具:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>sudo apt install redis-tools</span><br><span class=line></span><br><span class=line>// 连接</span><br><span class=line>redis-cli -h 127.0.0.1 -p 6379</span><br></pre></table></figure><p>或者docker-compose启动:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre><td class=code><pre><span class=line>version: &apos;3&apos;</span><br><span class=line>services:</span><br><span class=line>  redis:</span><br><span class=line>    image: redis:latest</span><br><span class=line>#    command: [&quot;redis-server&quot;, &quot;--appendonly&quot;, &quot;yes&quot;]</span><br><span class=line>    command: [&quot;redis-server&quot;, &quot;/usr/local/etc/redis/redis.conf&quot;]</span><br><span class=line>    restart: always</span><br><span class=line>    ports:</span><br><span class=line>      - &quot;6379:6379&quot;</span><br><span class=line>    networks:</span><br><span class=line>      backend-swarm:</span><br><span class=line>        aliases:</span><br><span class=line>         - redis</span><br><span class=line>    volumes:</span><br><span class=line>      - ./data:/data</span><br><span class=line>      - ./config/redis.conf:/usr/local/etc/redis/redis.conf</span><br><span class=line></span><br><span class=line># docker network create -d=overlay --attachable backend</span><br><span class=line>networks:</span><br><span class=line>  backend-swarm:</span><br><span class=line>    external:</span><br><span class=line>      name: backend-swarm</span><br></pre></table></figure><h3 id=Ubuntu-Apt安装><a href=#Ubuntu-Apt安装 class=headerlink title="Ubuntu Apt安装"></a>Ubuntu Apt安装</h3><p>终端执行:<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line>sudo apt update &amp;&amp; sudo apt install redis-server</span><br><span class=line></span><br><span class=line># 启动</span><br><span class=line>redis-server</span><br><span class=line></span><br><span class=line># 连接</span><br><span class=line>redis-cli -h 127.0.0.1 -p 6379</span><br></pre></table></figure><h2 id=配置相关><a href=#配置相关 class=headerlink title=配置相关></a>配置相关</h2><blockquote><p>稳定版本配置文件: <strong><em><a href=http://download.redis.io/redis-stable/redis.conf rel="external nofollow noopener noreferrer" target=_blank>http://download.redis.io/redis-stable/redis.conf</a></em></strong></blockquote><p><code>/etc/redis</code>: 存放redis配置文件<br><code>/var/redis/端口号</code>: 存放redis的持久化文件<p>通过下面的命令停止/启动/重启redis:<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>/etc/init.d/redis-server stop</span><br><span class=line>/etc/init.d/redis-server start</span><br><span class=line>/etc/init.d/redis-server restart</span><br></pre></table></figure><p>如果是通过源码安装的redis, 则可以通过redis的客户端程序<code>redis-cli</code>的<code>shutdown</code>命令来重启redis<br><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>redis-cli -h 127.0.0.1 -p 6379 shutdown</span><br></pre></table></figure><p>如果上述方式都没有成功停止redis, 则可以使用终极武器 <code>kill -9</code><h2 id=开启远程访问><a href=#开启远程访问 class=headerlink title=开启远程访问></a>开启远程访问</h2><p>找到<code>redis.conf</code>文件, 一般在<code>/etc</code>下面:<p>找到<code>bind 127.0.0.1</code>注释掉<br>注释掉本机,局域网内的所有计算机都能访问.<br><code>band localhost</code> 只能本机访问,局域网内计算机不能访问.<br><code>bind 局域网IP</code> 只能局域网内IP的机器访问, 本地localhost都无法访问.<p>博主选择将<code>bind 127.0.0.1</code> 改成了<code>bind 0.0.0.0</code><h2 id=开启发布订阅监听><a href=#开启发布订阅监听 class=headerlink title=开启发布订阅监听></a>开启发布订阅监听</h2><blockquote><p>Redis自2.8.0之后版本提供<a href=https://redis.io/topics/notifications rel="external nofollow noopener noreferrer" target=_blank>Keyspace Notifications</a>功能, 允许客户订阅Pub / Sub频道, 以便以某种方式接收影响Redis数据集的事件.<p>Redis默认关闭, 键空间通知通常是不启用的, 因为这个过程会产生额外消耗</blockquote><p>还是修改<code>redis.conf</code>文件, 找到<code>notify-keyspace-events &quot;&quot;</code>, 修改为<code>notify-keyspace-events Ex</code>或者<code>notify-keyspace-events AKE</code>, 然后重启.<table><thead><tr><th>字符<th>发送通知<tbody><tr><td>K<td>键空间通知, 所有通知以 <strong>keyspace@</strong> 为前缀, 针对Key<tr><td>E<td>键事件通知, 所有通知以 <strong>keyevent@</strong> 为前缀, 针对event<tr><td><em>g</em><td><em>DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知</em><tr><td><strong>$</strong><td><strong>字符串命令的通知</strong><tr><td><strong>l</strong><td><strong>列表命令的通知</strong><tr><td><strong>s</strong><td><strong>集合命令的通知</strong><tr><td><strong>h</strong><td><strong>哈希命令的通知</strong><tr><td><strong>z</strong><td><strong>有序集合命令的通知</strong><tr><td><em>x</em><td><em>过期事件: 每当有过期键被删除时发送</em><tr><td><em>e</em><td><em>驱逐(evict)事件: 每当有键因为 maxmemory 政策而被删除时发送</em><tr><td>A<td>参数 g$lshzxe 的别名, 相当于是All</table><p><code>SUBSCRIBE</code>与<code>PSUBSCRIBE</code>都可以订阅事件, 后者可以通过正则表达匹配对应的Channel, 比如<code>__keyevent*__:expired</code>订阅所有数据库的过期事件<p>打开一个终端订阅key过期事件:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>192.168.6.113:6379&gt; PSUBSCRIBE __keyevent*__:expired</span><br><span class=line>Reading messages... (press Ctrl-C to quit)</span><br><span class=line>1) &quot;psubscribe&quot;</span><br><span class=line>2) &quot;__keyevent*__:expired&quot;</span><br><span class=line>3) (integer) 1</span><br></pre></table></figure><p>再开一个终端设置一个会过期的kv:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line>192.168.6.113:6379&gt; set test ybd EX 10</span><br><span class=line>OK</span><br></pre></table></figure><p>10秒后在第一个终端将会受到如下信息:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre><td class=code><pre><span class=line>1) &quot;pmessage&quot;</span><br><span class=line>2) &quot;__keyevent*__:expired&quot;</span><br><span class=line>3) &quot;__keyevent@0__:expired&quot;</span><br><span class=line>4) &quot;test&quot;</span><br></pre></table></figure><h1 id=GUI><a href=#GUI class=headerlink title=GUI></a>GUI</h1><p><strong><em><a href=https://github.com/uglide/RedisDesktopManager rel="external nofollow noopener noreferrer" target=_blank>https://github.com/uglide/RedisDesktopManager</a></em></strong><p><strong><em><a href=https://redislabs.com/redisinsight/ rel="external nofollow noopener noreferrer" target=_blank>https://redislabs.com/redisinsight/</a></em></strong><p><strong><em><a href=https://github.com/diego3g/rocketredis rel="external nofollow noopener noreferrer" target=_blank>https://github.com/diego3g/rocketredis</a></em></strong><h1 id=Redis常用命令><a href=#Redis常用命令 class=headerlink title=Redis常用命令></a>Redis常用命令</h1><blockquote><p>最新命令参考: <strong><em><a href=http://redisdoc.com rel="external nofollow noopener noreferrer" target=_blank>http://redisdoc.com</a></em></strong></blockquote><h2 id=连接操作命令><a href=#连接操作命令 class=headerlink title=连接操作命令></a>连接操作命令</h2><ul><li><code>quit</code>: 关闭连接（connection）<li><code>auth</code>: 简单密码认证<li><code>help cmd</code>: 查看cmd帮助, 例如: help quit</ul><h2 id=持久化><a href=#持久化 class=headerlink title=持久化></a>持久化</h2><ul><li><code>save</code>: 将数据同步保存到磁盘<li><code>bgsave</code>: 将数据异步保存到磁盘<li><code>lastsave</code>: 返回上次成功将数据保存到磁盘的Unix时戳<li><code>shutdown</code>: 将数据同步保存到磁盘, 然后关闭服务</ul><h2 id=远程服务控制><a href=#远程服务控制 class=headerlink title=远程服务控制></a>远程服务控制</h2><ul><li><code>info</code>: 提供服务器的信息和统计<li><code>monitor</code>: 实时转储收到的请求<li><code>slaveof</code>: 改变复制策略设置<li><code>config</code>: 在运行时配置Redis服务器</ul><h2 id=对key操作的命令><a href=#对key操作的命令 class=headerlink title=对key操作的命令></a>对key操作的命令</h2><ul><li><code>exists(key)</code>: 确认一个key是否存在<li><code>del(key)</code>: 删除一个key<li><code>type(key)</code>: 返回值的类型<li><code>keys(pattern)</code>: 返回满足给定pattern的所有key<li><code>randomkey</code>: 随机返回key空间的一个<li><code>keyrename(oldname, newname)</code>: 重命名key<li><code>dbsize</code>: 返回当前数据库中key的数目<li><code>expire</code>: 设定一个key的活动时间（s）<li><code>ttl</code>: 获得一个key的活动时间<li><code>select(index)</code>: 按索引查询<li><code>move(key, dbindex)</code>: 移动当前数据库中的key到dbindex数据库<li><code>flushdb</code>: 删除当前选择数据库中的所有key<li><code>flushall</code>: 删除所有数据库中的所有key</ul><h2 id=String><a href=#String class=headerlink title=String></a>String</h2><ul><li><code>set(key, value [EX seconds] [PX milliseconds] [NX|XX])</code>: 给数据库中名称为key的string赋予值value, EX与PX都是过期时间, 前者是秒为单位, 后者是毫秒, NX表示当key不存在时赋值, XX表示当key存在时赋值<li><code>get(key)</code>: 返回数据库中名称为key的string的value<li><code>getset(key, value)</code>: 给名称为key的string赋予上一次的value<li><code>mget(key1, key2,…, key N)</code>: 返回库中多个string的value<li><code>setnx(key, value)</code>: 添加string, 名称为key, 值为value<li><code>setex(key, time, value)</code>: 向库中添加string, 设定过期时间time<li><code>mset(key N, value N)</code>: 批量设置多个string的值<li><code>msetnx(key N, value N)</code>: 如果所有名称为key i的string都不存在<li><code>incr(key)</code>: 名称为key的string增1操作<li><code>incrby(key, integer)</code>: 名称为key的string增加integer<li><code>decr(key)</code>: 名称为key的string减1操作<li><code>decrby(key, integer)</code>: 名称为key的string减少integer<li><code>append(key, value)</code>: 名称为key的string的值附加value<li><code>substr(key, start, end)</code>: 返回名称为key的string的value的子串</ul><h2 id=List><a href=#List class=headerlink title=List></a>List</h2><ul><li><code>rpush(key, value)</code>: 在名称为key的list尾添加一个值为value的元素<li><code>lpush(key, value)</code>: 在名称为key的list头添加一个值为value的 元素<li><code>llen(key)</code>: 返回名称为key的list的长度<li><code>lrange(key, start, end)</code>: 返回名称为key的list中start至end之间的元素<li><code>ltrim(key, start, end)</code>: 截取名称为key的list<li><code>lindex(key, index)</code>: 返回名称为key的list中index位置的元素<li><code>lset(key, index, value)</code>: 给名称为key的list中index位置的元素赋值<li><code>lrem(key, count, value)</code>: 删除count个key的list中值为value的元素<li><code>lpop(key)</code>: 返回并删除名称为key的list中的首元素<li><code>rpop(key)</code>: 返回并删除名称为key的list中的尾元素<li><code>blpop(key1, key2,… key N, timeout)</code>: lpop命令的block版本.<li><code>brpop(key1, key2,… key N, timeout)</code>: rpop的block版本.<li><code>rpoplpush(srckey, dstkey)</code>: 返回并删除名称为srckey的list的尾元素, 并将该元素添加到名称为dstkey的list的头部</ul><h2 id=Set><a href=#Set class=headerlink title=Set></a>Set</h2><ul><li><code>sadd(key, member)</code>: 向名称为key的set中添加元素member<li><code>srem(key, member)</code> : 删除名称为key的set中的元素member<li><code>spop(key)</code> : 随机返回并删除名称为key的set中一个元素<li><code>smove(srckey, dstkey, member)</code> : 移到集合元素<li><code>scard(key)</code> : 返回名称为key的set的基数<li><code>sismember(key, member)</code> : member是否是名称为key的set的元素<li><code>sinter(key1, key2,…key N)</code> : 求交集<li><code>sinterstore(dstkey, (keys))</code> : 求交集并将交集保存到dstkey的集合<li><code>sunion(key1, (keys))</code> : 求并集<li><code>sunionstore(dstkey, (keys))</code> : 求并集并将并集保存到dstkey的集合<li><code>sdiff(key1, (keys))</code> : 求差集<li><code>sdiffstore(dstkey, (keys))</code> : 求差集并将差集保存到dstkey的集合<li><code>smembers(key)</code> : 返回名称为key的set的所有元素<li><code>srandmember(key)</code> : 随机返回名称为key的set的一个元素</ul><h2 id=Hash><a href=#Hash class=headerlink title=Hash></a>Hash</h2><ul><li><code>hset(key, field, value)</code>: 向名称为key的hash中添加元素field<li><code>hget(key, field)</code>: 返回名称为key的hash中field对应的value<li><code>hmget(key, (fields))</code>: 返回名称为key的hash中field i对应的value<li><code>hmset(key, (fields))</code>: 向名称为key的hash中添加元素field<li><code>hincrby(key, field, integer)</code>: 将名称为key的hash中field的value增加integer<li><code>hexists(key, field)</code>: 名称为key的hash中是否存在键为field的域<li><code>hdel(key, field)</code>: 删除名称为key的hash中键为field的域<li><code>hlen(key)</code>: 返回名称为key的hash中元素个数<li><code>hkeys(key)</code>: 返回名称为key的hash中所有键<li><code>hvals(key)</code>: 返回名称为key的hash中所有键对应的value<li><code>hgetall(key)</code>: 返回名称为key的hash中所有的键（field）及其对应的value</ul><h1 id=不同数据类型的常见应用场景><a href=#不同数据类型的常见应用场景 class=headerlink title=不同数据类型的常见应用场景></a>不同数据类型的常见应用场景</h1><blockquote><p>为缓存而生的Redis, 其所有数据都在内存中, 固其最大的应用场景就是缓存了, 但这只是个大的概念, 其不同的数据类型都有对应的应用场景.</blockquote><h2 id=String-1><a href=#String-1 class=headerlink title=String></a>String</h2><h3 id=对象存储><a href=#对象存储 class=headerlink title=对象存储></a>对象存储</h3><p>这应该是最最最常用的场景了, 将对象序列化后再<code>set</code>进去, 所以选择一个好的序列化方案很重要, 需要从时间复杂度以及空间复杂度这两个维度综合考虑. 个人觉得<code>Protostuff</code>选当不错, 基于Google的Protobuff. 详情请看下面的<strong>序列化</strong>一节.<h3 id=计数><a href=#计数 class=headerlink title=计数></a>计数</h3><p><code>INCRBY</code>可以原子性地递增, 通常用作分布式计数器, 也可以用作生成ID.<h3 id=分布式锁><a href=#分布式锁 class=headerlink title=分布式锁></a>分布式锁</h3><p>正由于Redis是单线程客户端, 这不单单是一个特性, 更是一个应用场景, 最常用的就是分布式锁了.<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>SET key value [EX seconds] [PX milliseconds] [NX|XX]</span><br></pre></table></figure><p>利用上面命令, 可以做到加锁与过期的原子性.<p>释放锁可以利用LUA脚本完成:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre><td class=code><pre><span class=line>if redis.call(&quot;get&quot;,KEYS[1]) == ARGV[1]</span><br><span class=line>then</span><br><span class=line>    return redis.call(&quot;del&quot;,KEYS[1])</span><br><span class=line>else</span><br><span class=line>    return 0</span><br><span class=line>end</span><br></pre></table></figure><h3 id=超大数量的布尔统计><a href=#超大数量的布尔统计 class=headerlink title=超大数量的布尔统计></a>超大数量的布尔统计</h3><p>比如要统计几亿人的在线情况、数十亿的布尔存储（布尔标识符）都可以使用<code>GETBIT</code>、<code>SETBIT</code>、<code>BITCOUNT</code>来完成.<h2 id=List-1><a href=#List-1 class=headerlink title=List></a>List</h2><h3 id=显示最新的分页列表><a href=#显示最新的分页列表 class=headerlink title=显示最新的分页列表></a>显示最新的分页列表</h3><p>一种很常见的需求, 分页, 比如列出最新的5页评论、列出最新的某活动5页商品, 在QPS高的时候, 采用传统的RDBS查询往往会有性能问题. BUT, 结合Redis的<code>LPUSH</code>与<code>LTRIM</code>可以优雅地缓存最新的数据并做到分页, 一般大部分用户只关注前几页数据, 那么后面的数据可以用数据库补上. 这时候前5页的数据是走缓存的, QPS可以提高几个数量级<h3 id=消息队列><a href=#消息队列 class=headerlink title=消息队列></a>消息队列</h3><p>Redis 的 list 数据类型对于大部分使用者来说, 是实现队列服务的最经济, 最简单的方式.<h2 id=Set-1><a href=#Set-1 class=headerlink title=Set></a>Set</h2><h3 id=共同好友列表（求交集系列）><a href=#共同好友列表（求交集系列） class=headerlink title=共同好友列表（求交集系列）></a>共同好友列表（求交集系列）</h3><p>社交类应用中, 获取两个人或多个人的共同好友, 两个人或多个人共同关注的微博这样类似的功能, 用 MySQL 的话操作很复杂, 可以把每个人的好友 id 存到集合中, 获取共同好友的操作就可以简单到一个取交集的命令就搞定.<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre><td class=code><pre><span class=line>sadd user:wade james melo paul kobe</span><br><span class=line>sadd user:james wade melo paul kobe</span><br><span class=line>sadd user:paul wade james melo kobe</span><br><span class=line>sadd user:melo wade james paul kobe</span><br><span class=line></span><br><span class=line>// 获取 wade 和 james 的共同好友</span><br><span class=line>sinter user:wade user:james</span><br><span class=line>/* 输出: </span><br><span class=line> *      1) &quot;kobe&quot;</span><br><span class=line> *      2) &quot;paul&quot;</span><br><span class=line> *      3) &quot;melo&quot;</span><br><span class=line> */</span><br><span class=line> </span><br><span class=line> // 获取香蕉四兄弟的共同好友</span><br><span class=line> sinter user:wade user:james user:paul user:melo</span><br><span class=line> /* 输出: </span><br><span class=line> *      1) &quot;kobe&quot;</span><br><span class=line> */</span><br></pre></table></figure><p>类似的需求还有很多 , 必须把每个标签下的文章 id 存到集合中, 可以很容易的求出几个不同标签下的共同文章；<br>把每个人的爱好存到集合中, 可以很容易的求出几个人的共同爱好.<h2 id=SortedSet><a href=#SortedSet class=headerlink title=SortedSet></a>SortedSet</h2><h3 id=排行榜><a href=#排行榜 class=headerlink title=排行榜></a>排行榜</h3><p>SortedSet 是在 Set 的基础上给集合中每个元素关联了一个分数, 往有序集合中插入数据时会自动根据这个分数排序, 很适合排行榜之类的需求:<p>– 列出前100名高分选手<p>– 列出某用户当前的全球排名<h1 id=慢查询查看><a href=#慢查询查看 class=headerlink title=慢查询查看></a>慢查询查看</h1><blockquote><p>Redis 通过 <code>slowlog-log-slower-than</code> 和 <code>slowlog-max-len</code> 分别配置慢查询的阈值, 以及慢查询记录的日志长度. <code>slowlog-log-slower-than</code> 默认值 10*1000 <strong>微秒</strong>, 当命令执行时间查过设定时, 那么将会被记录在慢查询日志中. 如果<code>slowlog-log-slower-than=0</code>会记录所有的命令, <code>slowlog-log-slower-than&lt;0</code> 对于任何命令都不会进行记录.</blockquote><p>参数设定:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>config set slowlog-log-slower-than 20000</span><br><span class=line>config set slowlog-max-len 1000</span><br><span class=line>config rewrite</span><br></pre></table></figure><blockquote><p>如果要 Redis 将配置<strong>持久化</strong>到本地配置文件, 需要执行 <code>config rewrite</code> 命令.</blockquote><p><strong>获取慢查询日志:</strong><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>slowlog get [n] // n 表示返回的日志记录条数</span><br></pre></table></figure><p>每个慢查询日志有 4 个属性组成, 分别是慢查询日志的标识 id、发生时间戳、命令耗时、执行命令和参数, 慢查询列表如下:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>127.0.0.1:6378&gt; slowlog get</span><br><span class=line>1) 1) (integer) 0                       //标识 id</span><br><span class=line>   2) (integer) 1501750261      //时间戳</span><br><span class=line>   3) (integer) 19                      // 命令耗时</span><br><span class=line>   4) 1) &quot;config&quot;                        // 执行命令</span><br><span class=line>      2) &quot;set&quot;</span><br><span class=line>      3) &quot;slowlog-log-slower-than&quot;</span><br><span class=line>      4) &quot;0&quot;</span><br><span class=line>127.0.0.1:6378&gt;</span><br></pre></table></figure><p><strong>获取慢查询日志列表当前的长度:</strong><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre><td class=code><pre><span class=line>127.0.0.1:6378&gt; slowlog len</span><br><span class=line>(integer) 2</span><br><span class=line>127.0.0.1:6378&gt;</span><br></pre></table></figure><p><strong>慢查询最佳实践</strong><ul><li><code>slowlog-max-len</code> 配置建议: 线上建议调大慢查询列表, 记录慢查询时 Redis 会对长命令做截断操作, 并不会占用大量内存. 增大慢查询列表可以减缓慢查询被剔除的可能, 例如线上可设置为 1000 以上.<li><code>slowlog-log-slower-than</code> 配置建议: 默认值超过 10 毫秒判定为慢查询, 需要根据 Redis 并发量调整该值. 由于 Redis 采用单线程响应命令, 对于高流量的场景, 如果命令执行时间在 1 毫秒以上, 那么 Redis 最多可支撑 OPS 不到 1000. 因此对于高 OPS （operation per second）场景的 Redis 建议设置为 1 毫秒.<li>慢查询只记录命令执行时间, 并不包括命令排队和网络传输时间. 因此客户端执行命<br>令的时间会大于命令实际执行时间. 因为命令执行排队机制, 慢查询会导致其他命令级联阻塞, 因此当客户端出现请求超时, 需要检查该时间点是否有对应的慢查询, 从<br>而分析出是否为慢查询导致的命令级联阻塞.<li>由于慢查询日志是一个先进先出的队列, 也就是说如果慢查询比较多的情况下, 可能<br>会丢失部分慢查询命令, 为了防止这种情况发生, 可以定期执行 slow get 命令将慢查询日志持久化到其他存储中（例如 MySQL）, 然后可以制作可视化界面进行查询.</ul><h1 id=rdb文件分析><a href=#rdb文件分析 class=headerlink title=rdb文件分析></a>rdb文件分析</h1><h2 id=RCT-Redis-Computed-Tomography><a href=#RCT-Redis-Computed-Tomography class=headerlink title="RCT(Redis Computed Tomography)"></a>RCT(Redis Computed Tomography)</h2><p><strong><em><a href=https://github.com/xaecbd/RCT rel="external nofollow noopener noreferrer" target=_blank>https://github.com/xaecbd/RCT</a></em></strong><h2 id=redis-rdb-tools><a href=#redis-rdb-tools class=headerlink title=redis-rdb-tools></a>redis-rdb-tools</h2><p><strong><em><a href=https://github.com/sripathikrishnan/redis-rdb-tools rel="external nofollow noopener noreferrer" target=_blank>https://github.com/sripathikrishnan/redis-rdb-tools</a></em></strong><h2 id=rdr><a href=#rdr class=headerlink title=rdr></a>rdr</h2><blockquote><p><strong><em><a href=https://github.com/xueqiu/rdr rel="external nofollow noopener noreferrer" target=_blank>https://github.com/xueqiu/rdr</a></em></strong><p>下载链接失效了, 可以在这里下载: <strong><em><a href=https://github.com/gohouse/rdr/releases rel="external nofollow noopener noreferrer" target=_blank>https://github.com/gohouse/rdr/releases</a></em></strong></blockquote><p>首先查看Redis的dump目录设置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>CONFIG GET dir</span><br></pre></table></figure><p>再使用<code>bgsave</code>命令导出<code>dump.rdb</code>, 将<code>dump.rdb</code>复制出来, 再使用 <strong><em><a href=https://github.com/xueqiu/rdr rel="external nofollow noopener noreferrer" target=_blank>rdr</a></em></strong> 分析:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>./rdr show -p 8080 *.rdb</span><br></pre></table></figure><p>效果图:<p><img src=https://cdn.yangbingdong.com/img/javaDevEnv/rdr.png alt><h1 id=Spring-Boot整合><a href=#Spring-Boot整合 class=headerlink title="Spring Boot整合"></a>Spring Boot整合</h1><h2 id=Lettuce><a href=#Lettuce class=headerlink title=Lettuce></a>Lettuce</h2><h3 id=核心依赖><a href=#核心依赖 class=headerlink title=核心依赖></a>核心依赖</h3><figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.commons<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>commons-pool2<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><ul><li>使用连接池需要用到<code>commons-pool2</code></ul><h3 id=配置><a href=#配置 class=headerlink title=配置></a>配置</h3><figure class="highlight yaml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=attr>spring:</span></span><br><span class=line>  <span class=attr>redis:</span></span><br><span class=line>    <span class=attr>host:</span> <span class=number>127.0</span><span class=number>.0</span><span class=number>.1</span></span><br><span class=line>    <span class=attr>port:</span> <span class=number>6379</span></span><br><span class=line>    <span class=attr>lettuce:</span></span><br><span class=line>      <span class=attr>pool:</span></span><br><span class=line>        <span class=comment>#最大连接数</span></span><br><span class=line>        <span class=attr>max-active:</span> <span class=number>128</span></span><br><span class=line>        <span class=comment>#最大阻塞等待时间(负数表示没限制)</span></span><br><span class=line>        <span class=attr>max-wait:</span> <span class=string>5s</span></span><br><span class=line>        <span class=comment>#最大空闲</span></span><br><span class=line>        <span class=attr>max-idle:</span> <span class=number>16</span></span><br><span class=line>        <span class=comment>#最小空闲</span></span><br><span class=line>        <span class=attr>min-idle:</span> <span class=number>0</span></span><br><span class=line>    <span class=comment>#连接超时时间</span></span><br><span class=line>    <span class=attr>timeout:</span> <span class=string>10s</span></span><br></pre></table></figure><h2 id=Redisson><a href=#Redisson class=headerlink title=Redisson></a>Redisson</h2><p>Redisson 中已经实现了 Spring redis data, 可直接使用:<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.redisson<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>redisson-spring-boot-starter<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>version</span>&gt;</span>3.13.0<span class=tag>&lt;/<span class=name>version</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><p>可使用 Spring data redis 的配置, 或者自定义 redisson 配置:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre><td class=code><pre><span class=line>spring.redis.redisson.config=classpath:redisson.yaml</span><br></pre></table></figure><p>然后可正常 autowire <code>RedisTemplate</code> 或者 <code>RedissonClient</code>, 包括 redisson 中的一些常用功能比如分布式锁.<blockquote><p>文档: <em><a href=https://github.com/redisson/redisson/wiki/Redisson项目介绍 rel="external nofollow noopener noreferrer" target=_blank>https://github.com/redisson/redisson/wiki/Redisson%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D</a></em></blockquote><h1 id=客户端序列化选择><a href=#客户端序列化选择 class=headerlink title=客户端序列化选择></a>客户端序列化选择</h1><blockquote><p><strong><em><a href=https://github.com/masteranthoneyd/serializer rel="external nofollow noopener noreferrer" target=_blank>https://github.com/masteranthoneyd/serializer</a></em></strong></blockquote><p>以下是序列化框架性能对比（纳秒）<p>操作系统: Ubuntu 18.04 64位<p>CPU: I7-8700<p>内存: 32G<p><img src=https://cdn.yangbingdong.com/img/spring-boot-redis/serialize-performance.png alt><ul><li><code>Protostuff</code>不能直接序列化集合, 需要用包装类封装起来.<li><code>String</code>类型还是建议直接使用<code>StringRedisSerializer</code>, 速度最快.</ul><p>Kryo 序列化示例:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>Kryo5Serializer</span> <span class=keyword>implements</span> <span class=title>RedisSerializer</span>&lt;<span class=title>CacheWrapper</span>&gt; </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>final</span> Kryo5Serializer INSTANCE = <span class=keyword>new</span> Kryo5Serializer();</span><br><span class=line></span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>final</span> Pool&lt;Kryo&gt; kryoPool;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>final</span> Pool&lt;Input&gt; inputPool;</span><br><span class=line>	<span class=keyword>private</span> <span class=keyword>final</span> Pool&lt;Output&gt; outputPool;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>private</span> <span class=title>Kryo5Serializer</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>this</span>.kryoPool = <span class=keyword>new</span> Pool&lt;Kryo&gt;(<span class=keyword>true</span>, <span class=keyword>false</span>, <span class=number>1024</span>) &#123;</span><br><span class=line>			<span class=meta>@Override</span></span><br><span class=line>			<span class=function><span class=keyword>protected</span> Kryo <span class=title>create</span><span class=params>()</span> </span>&#123;</span><br><span class=line>				<span class=keyword>return</span> createKryo();</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;;</span><br><span class=line></span><br><span class=line>		<span class=keyword>this</span>.inputPool = <span class=keyword>new</span> Pool&lt;Input&gt;(<span class=keyword>true</span>, <span class=keyword>false</span>, <span class=number>512</span>) &#123;</span><br><span class=line>			<span class=meta>@Override</span></span><br><span class=line>			<span class=function><span class=keyword>protected</span> Input <span class=title>create</span><span class=params>()</span> </span>&#123;</span><br><span class=line>				<span class=keyword>return</span> <span class=keyword>new</span> Input(<span class=number>8192</span>);</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;;</span><br><span class=line></span><br><span class=line>		<span class=keyword>this</span>.outputPool = <span class=keyword>new</span> Pool&lt;Output&gt;(<span class=keyword>true</span>, <span class=keyword>false</span>, <span class=number>512</span>) &#123;</span><br><span class=line>			<span class=meta>@Override</span></span><br><span class=line>			<span class=function><span class=keyword>protected</span> Output <span class=title>create</span><span class=params>()</span> </span>&#123;</span><br><span class=line>				<span class=keyword>return</span> <span class=keyword>new</span> Output(<span class=number>8192</span>, -<span class=number>1</span>);</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=function><span class=keyword>protected</span> Kryo <span class=title>createKryo</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		Kryo kryo = <span class=keyword>new</span> Kryo();</span><br><span class=line>		kryo.setRegistrationRequired(<span class=keyword>false</span>);</span><br><span class=line>		kryo.setReferences(<span class=keyword>false</span>);</span><br><span class=line>		kryo.addDefaultSerializer(Throwable<span class=class>.<span class=keyword>class</span>, <span class=title>new</span> <span class=title>JavaSerializer</span>())</span>;</span><br><span class=line>		kryo.register(CacheWrapper<span class=class>.<span class=keyword>class</span>)</span>;</span><br><span class=line>		<span class=keyword>return</span> kryo;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=keyword>public</span> <span class=keyword>byte</span>[] serialize(CacheWrapper cacheWrapper) <span class=keyword>throws</span> SerializationException &#123;</span><br><span class=line>		Kryo kryo = kryoPool.obtain();</span><br><span class=line>		Output output = outputPool.obtain();</span><br><span class=line>		ByteArrayOutputStream stream = <span class=keyword>new</span> ByteArrayOutputStream();</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>			output.setOutputStream(stream);</span><br><span class=line>			kryo.writeClassAndObject(output, cacheWrapper);</span><br><span class=line>			output.flush();</span><br><span class=line>			<span class=keyword>return</span> stream.toByteArray();</span><br><span class=line>		&#125; <span class=keyword>finally</span> &#123;</span><br><span class=line>			output.setOutputStream(<span class=keyword>null</span>);</span><br><span class=line>			kryoPool.free(kryo);</span><br><span class=line>			outputPool.free(output);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> CacheWrapper <span class=title>deserialize</span><span class=params>(<span class=keyword>byte</span>[] bytes)</span> <span class=keyword>throws</span> SerializationException </span>&#123;</span><br><span class=line>		Kryo kryo = kryoPool.obtain();</span><br><span class=line>		Input input = inputPool.obtain();</span><br><span class=line>		<span class=keyword>try</span> &#123;</span><br><span class=line>			input.setInputStream(<span class=keyword>new</span> ByteArrayInputStream(bytes));</span><br><span class=line>			<span class=keyword>return</span> (CacheWrapper) kryo.readClassAndObject(input);</span><br><span class=line>		&#125; <span class=keyword>finally</span> &#123;</span><br><span class=line>			input.setInputStream(<span class=keyword>null</span>);</span><br><span class=line>			kryoPool.free(kryo);</span><br><span class=line>			inputPool.free(input);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h1 id=Spring监听Redis-Keyspace-Event><a href=#Spring监听Redis-Keyspace-Event class=headerlink title="Spring监听Redis Keyspace Event"></a>Spring监听Redis Keyspace Event</h1><p>在Spring Boot应用中, 可使用方式一和二, 集成非常快.<figure class="highlight xml"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre><td class=code><pre><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-web<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.apache.commons<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>commons-pool2<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br><span class=line><span class=tag>&lt;<span class=name>dependency</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>groupId</span>&gt;</span>org.springframework.boot<span class=tag>&lt;/<span class=name>groupId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>artifactId</span>&gt;</span>spring-boot-starter-test<span class=tag>&lt;/<span class=name>artifactId</span>&gt;</span></span><br><span class=line>    <span class=tag>&lt;<span class=name>scope</span>&gt;</span>test<span class=tag>&lt;/<span class=name>scope</span>&gt;</span></span><br><span class=line><span class=tag>&lt;/<span class=name>dependency</span>&gt;</span></span><br></pre></table></figure><h2 id=方式一、通过RedisMessageListenerContainer><a href=#方式一、通过RedisMessageListenerContainer class=headerlink title=方式一、通过RedisMessageListenerContainer></a>方式一、通过<code>RedisMessageListenerContainer</code></h2><p>这个类是使用线程池监听并执行后续动作的, 可以添加多个监听者.<p>配置类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisConfig</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Resource</span></span><br><span class=line>	<span class=keyword>private</span> LettuceConnectionFactory lettuceConnectionFactory</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> RedisMessageListenerContainer <span class=title>redisMessageListenerContainer</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		RedisMessageListenerContainer redisMessageListenerContainer = <span class=keyword>new</span> RedisMessageListenerContainer();</span><br><span class=line>		redisMessageListenerContainer.setConnectionFactory(lettuceConnectionFactory);</span><br><span class=line>		redisMessageListenerContainer.addMessageListener(<span class=keyword>new</span> KeyExpireListener(), <span class=keyword>new</span> PatternTopic(<span class=string>"__keyevent@*__:expired"</span>));</span><br><span class=line>		<span class=keyword>return</span> redisMessageListenerContainer;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><p>监听类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>KeyExpireListener</span> <span class=keyword>implements</span> <span class=title>MessageListener</span> </span>&#123;</span><br><span class=line>	<span class=keyword>private</span> RedisSerializer&lt;String&gt; stringRedisSerializer = <span class=keyword>new</span> StringRedisSerializer();</span><br><span class=line></span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onMessage</span><span class=params>(Message message, <span class=keyword>byte</span>[] pattern)</span> </span>&#123;</span><br><span class=line>		Thread thread = Thread.currentThread();</span><br><span class=line>		System.out.println(thread.getId() + <span class=string>" "</span> + thread.getName() + <span class=string>" -&gt; "</span> + stringRedisSerializer.deserialize(pattern) + <span class=string>": "</span> + message);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>如此简单的几行代码就可以监听Redis Key过期事件, 但<code>RedisMessageListenerContainer</code>默认使用<code>SimpleAsyncTaskExecutor</code>作为线程池, 这个线程池比较坑的地方在于每次都是用新的线程去执行任务, 不重用线程, 不是真正意义上的线程池.<h2 id=方式二、监听RedisKeyspaceEvent><a href=#方式二、监听RedisKeyspaceEvent class=headerlink title=方式二、监听RedisKeyspaceEvent></a>方式二、监听RedisKeyspaceEvent</h2><p>通过创建并注册<code>KeyExpirationEventMessageListener</code>, 监听到过期事件后, 会发布一个<code>RedisKeyExpiredEvent</code>.<p><code>KeyExpirationEventMessageListener</code>继承<code>KeyspaceEventMessageListener</code>, <code>KeyspaceEventMessageListener</code>实现<code>MessageListener</code>, 在<code>onMessage(...)</code>方法中提供了<code>doHandleMessage(message)</code>抽象方法, 最终由<code>KeyExpirationEventMessageListener</code>实现.<p>配之类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line><span class=meta>@Configuration</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisConfig</span> </span>&#123;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Resource</span></span><br><span class=line>	<span class=keyword>private</span> LettuceConnectionFactory lettuceConnectionFactory;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> KeyExpirationEventMessageListener <span class=title>keyExpirationEventMessageListener</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		<span class=keyword>return</span> <span class=keyword>new</span> KeyExpirationEventMessageListener(redisMessageListenerContainer());</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	<span class=meta>@Bean</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> RedisMessageListenerContainer <span class=title>redisMessageListenerContainer</span><span class=params>()</span> </span>&#123;</span><br><span class=line>		RedisMessageListenerContainer redisMessageListenerContainer = <span class=keyword>new</span> RedisMessageListenerContainer();</span><br><span class=line>		redisMessageListenerContainer.setConnectionFactory(lettuceConnectionFactory);</span><br><span class=line>		<span class=keyword>return</span> redisMessageListenerContainer;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></table></figure><p>事件监听类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre><td class=code><pre><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>KeyExpireApplicationEventListener</span> <span class=keyword>implements</span> <span class=title>ApplicationListener</span>&lt;<span class=title>RedisKeyExpiredEvent</span>&gt; </span>&#123;</span><br><span class=line>	<span class=meta>@Override</span></span><br><span class=line>	<span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onApplicationEvent</span><span class=params>(RedisKeyExpiredEvent event)</span> </span>&#123;</span><br><span class=line>		System.out.println(event);</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>实际上<code>KeyExpirationEventMessageListener</code>也是<code>MessageListener</code>的实现, 最终还是由<code>RedisMessageListenerContainer</code>管理, 没有设置线程池的话, 还是使用<code>SimpleAsyncTaskExecutor</code>. . .<p>两种方式最终都是<code>RedisPubSubCommands.pSubscribe(MessageListener listener, byte[]... patterns);</code><h2 id=方式三、结合Disruptor><a href=#方式三、结合Disruptor class=headerlink title=方式三、结合Disruptor></a>方式三、结合Disruptor</h2><p>上面两种方式操作简单, 但是如果每天有上千万的过期通知, 在一个链接的情况下可能会影响吞吐量, 某些业务处理比较慢, 阻塞后面的通知, 这种情况下我们可以结合高性能队列框架<code>Disruptor</code>异步处理.<p>先定义Event:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> org.springframework.data.redis.connection.Message;</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-10-19</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisKeyExpireEvent</span> <span class=keyword>implements</span> <span class=title>CleanEvent</span> </span>&#123;</span><br><span class=line>    <span class=keyword>private</span> Message message;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>byte</span>[] pattern;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> Message <span class=title>getMessage</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> message;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> RedisKeyExpireEvent <span class=title>setMessage</span><span class=params>(Message message)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.message = message;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>this</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>public</span> <span class=keyword>byte</span>[] getPattern() &#123;</span><br><span class=line>        <span class=keyword>return</span> pattern;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> RedisKeyExpireEvent <span class=title>setPattern</span><span class=params>(<span class=keyword>byte</span>[] pattern)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.pattern = pattern;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>this</span>;</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>clean</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        <span class=keyword>this</span>.message = <span class=keyword>null</span>;</span><br><span class=line>        <span class=keyword>this</span>.pattern = <span class=keyword>null</span>;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>interface</span> <span class=title>CleanEvent</span> </span>&#123;</span><br><span class=line>    <span class=function><span class=keyword>void</span> <span class=title>clean</span><span class=params>()</span></span>;</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li>这个Event是由用户自己定义的.</ul><p>定义Event处理类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> com.lmax.disruptor.WorkHandler;</span><br><span class=line><span class=keyword>import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=line><span class=keyword>import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class=line><span class=keyword>import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class=line><span class=keyword>import</span> org.springframework.stereotype.Component;</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-10-19</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisKeyExpireEventHandler</span> <span class=keyword>implements</span> <span class=title>WorkHandler</span>&lt;<span class=title>RedisKeyExpireEvent</span>&gt; </span>&#123;</span><br><span class=line>	<span class=keyword>private</span> RedisSerializer&lt;String&gt; stringRedisSerializer = <span class=keyword>new</span> StringRedisSerializer();</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onEvent</span><span class=params>(RedisKeyExpireEvent event)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>try</span> &#123;</span><br><span class=line>			Thread thread = Thread.currentThread();</span><br><span class=line>			log.info(thread.getId() + <span class=string>" "</span> + thread.getName() + <span class=string>" -&gt; "</span> + stringRedisSerializer.deserialize(event.getPattern()) + <span class=string>": "</span> + event.getMessage());</span><br><span class=line>        &#125; <span class=keyword>finally</span> &#123;</span><br><span class=line>            event.clean();</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li>实现的是<code>WorkHandler</code>而不是<code>EventHandler</code>, 因为我们调用的是<code>disruptor.handleEventsWithWorkerPool</code>, 区别是<code>WorkerPool</code>可以达到Sharding的效果.</ul><p>异常处理类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> com.lmax.disruptor.ExceptionHandler;</span><br><span class=line><span class=keyword>import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=line><span class=keyword>import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-10-19</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisKeyExpireEventExceptionHandler</span> <span class=keyword>implements</span> <span class=title>ExceptionHandler</span>&lt;<span class=title>RedisKeyExpireEvent</span>&gt; </span>&#123;</span><br><span class=line>    <span class=keyword>private</span> StringRedisSerializer strSerial = <span class=keyword>new</span> StringRedisSerializer();</span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>handleEventException</span><span class=params>(Throwable ex, <span class=keyword>long</span> sequence, RedisKeyExpireEvent event)</span> </span>&#123;</span><br><span class=line>        String msgBody = strSerial.deserialize(event.getMessage().getBody());</span><br><span class=line>        log.error(<span class=string>"处理Redis Key过期事件失败: "</span> + msgBody, ex);</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>handleOnStartException</span><span class=params>(Throwable ex)</span> </span>&#123;</span><br><span class=line>		log.error(<span class=string>"Disruptor&lt;RedisKeyExpireEvent&gt; handleOnStartException:"</span>, ex);</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>handleOnShutdownException</span><span class=params>(Throwable ex)</span> </span>&#123;</span><br><span class=line>		log.error(<span class=string>"Disruptor&lt;RedisKeyExpireEvent&gt; handleOnShutdownException:"</span>, ex);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>用于发布事件的Disruptor:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> com.lmax.disruptor.BlockingWaitStrategy;</span><br><span class=line><span class=keyword>import</span> com.lmax.disruptor.EventTranslatorTwoArg;</span><br><span class=line><span class=keyword>import</span> com.lmax.disruptor.RingBuffer;</span><br><span class=line><span class=keyword>import</span> com.lmax.disruptor.dsl.Disruptor;</span><br><span class=line><span class=keyword>import</span> com.lmax.disruptor.dsl.ProducerType;</span><br><span class=line><span class=keyword>import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=line><span class=keyword>import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class=line><span class=keyword>import</span> org.springframework.context.ApplicationListener;</span><br><span class=line><span class=keyword>import</span> org.springframework.context.event.ContextClosedEvent;</span><br><span class=line><span class=keyword>import</span> org.springframework.data.redis.connection.Message;</span><br><span class=line><span class=keyword>import</span> org.springframework.stereotype.Component;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> javax.annotation.Resource;</span><br><span class=line><span class=keyword>import</span> java.util.stream.IntStream;</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-10-19</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=meta>@Component</span></span><br><span class=line><span class=keyword>public</span> <span class=class><span class=keyword>class</span> <span class=title>RedisKeyExpireDisruptor</span> <span class=keyword>implements</span> <span class=title>InitializingBean</span>, <span class=title>ApplicationListener</span>&lt;<span class=title>ContextClosedEvent</span>&gt; </span>&#123;</span><br><span class=line>    <span class=keyword>private</span> <span class=keyword>static</span> <span class=keyword>final</span> <span class=keyword>int</span> TOTAL_SHARDING = <span class=number>1</span> &lt;&lt; <span class=number>2</span>;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> Disruptor&lt;RedisKeyExpireEvent&gt; disruptor;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> EventTranslatorTwoArg&lt;RedisKeyExpireEvent, Message, <span class=keyword>byte</span>[]&gt; translatorTwoArg;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> RingBuffer&lt;RedisKeyExpireEvent&gt; ringBuffer;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Resource</span></span><br><span class=line>	<span class=keyword>private</span> RedisKeyExpireEventHandler redisKeyExpireEventHandler;</span><br><span class=line></span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>afterPropertiesSet</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        initDisruptor();</span><br><span class=line>		RedisKeyExpireEventHandler[] handlers = buildHandler();</span><br><span class=line>        disruptor.handleEventsWithWorkerPool(handlers);</span><br><span class=line>        disruptor.start();</span><br><span class=line>        ringBuffer = disruptor.getRingBuffer();</span><br><span class=line>        translatorTwoArg = (event, sequence, message, pattern) -&gt; event.setMessage(message).setPattern(pattern);</span><br><span class=line>        log.info(<span class=string>"RedisKeyExpireDisruptor initialized"</span>);</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=keyword>private</span> RedisKeyExpireEventHandler[] buildHandler() &#123;</span><br><span class=line>        <span class=keyword>return</span> IntStream.range(<span class=number>0</span>, TOTAL_SHARDING)</span><br><span class=line>                        .mapToObj(i -&gt; redisKeyExpireEventHandler)</span><br><span class=line>                        .toArray(RedisKeyExpireEventHandler[]::<span class=keyword>new</span>);</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>private</span> <span class=keyword>void</span> <span class=title>initDisruptor</span><span class=params>()</span> </span>&#123;</span><br><span class=line>        disruptor = <span class=keyword>new</span> Disruptor&lt;&gt;(RedisKeyExpireEvent::<span class=keyword>new</span>, <span class=number>1</span> &lt;&lt; <span class=number>10</span>, DisruptorUtil.getThreadFactory(<span class=string>"keyspace-disruptor-%d"</span>), ProducerType.SINGLE, <span class=keyword>new</span> BlockingWaitStrategy());</span><br><span class=line>        disruptor.setDefaultExceptionHandler(<span class=keyword>new</span> RedisKeyExpireEventExceptionHandler());</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=meta>@Override</span></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>onApplicationEvent</span><span class=params>(ContextClosedEvent event)</span> </span>&#123;</span><br><span class=line>        DisruptorUtil.shutDownDisruptor(disruptor);</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>void</span> <span class=title>publish</span><span class=params>(Message message, <span class=keyword>byte</span>[] pattern)</span> </span>&#123;</span><br><span class=line>        ringBuffer.publishEvent(translatorTwoArg, message, pattern);</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>工具类:<figure class="highlight java"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre><td class=code><pre><span class=line><span class=keyword>import</span> com.lmax.disruptor.TimeoutException;</span><br><span class=line><span class=keyword>import</span> com.lmax.disruptor.dsl.Disruptor;</span><br><span class=line><span class=keyword>import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=line><span class=keyword>import</span> org.apache.commons.lang3.concurrent.BasicThreadFactory;</span><br><span class=line></span><br><span class=line><span class=keyword>import</span> java.util.concurrent.TimeUnit;</span><br><span class=line></span><br><span class=line><span class=comment>/**</span></span><br><span class=line><span class=comment> * <span class=doctag>@author</span> ybd</span></span><br><span class=line><span class=comment> * <span class=doctag>@date</span> 18-9-29</span></span><br><span class=line><span class=comment> * <span class=doctag>@contact</span> yangbingdong1994@gmail.com</span></span><br><span class=line><span class=comment> */</span></span><br><span class=line><span class=meta>@Slf</span>4j</span><br><span class=line><span class=keyword>public</span> <span class=keyword>final</span> <span class=class><span class=keyword>class</span> <span class=title>DisruptorUtil</span> </span>&#123;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>static</span> BasicThreadFactory <span class=title>getThreadFactory</span><span class=params>(String pattern)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>return</span> <span class=keyword>new</span> BasicThreadFactory.Builder().namingPattern(pattern)</span><br><span class=line>                                               .daemon(<span class=keyword>true</span>)</span><br><span class=line>                                               .build();</span><br><span class=line>    &#125;</span><br><span class=line></span><br><span class=line>    <span class=function><span class=keyword>public</span> <span class=keyword>static</span> <span class=keyword>void</span> <span class=title>shutDownDisruptor</span><span class=params>(Disruptor disruptor)</span> </span>&#123;</span><br><span class=line>        <span class=keyword>if</span> (disruptor != <span class=keyword>null</span>) &#123;</span><br><span class=line>            <span class=keyword>try</span> &#123;</span><br><span class=line>                disruptor.shutdown(<span class=number>5</span>, TimeUnit.SECONDS);</span><br><span class=line>            &#125; <span class=keyword>catch</span> (TimeoutException e) &#123;</span><br><span class=line>                log.error(<span class=string>"Disruptor shutdown error!"</span>, e);</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;</span><br><span class=line>    &#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>效果图:<p><img src=https://cdn.yangbingdong.com/img/spring-boot-redis/redis-key-expire-disruptor.png alt><h2 id=缺点><a href=#缺点 class=headerlink title=缺点></a>缺点</h2><blockquote><h2 id=Timing-of-expired-events><a href=#Timing-of-expired-events class=headerlink title="Timing of expired events"></a>Timing of expired events</h2><p>Keys with a time to live associated are expired by Redis in two ways:<ul><li>When the key is accessed by a command and is found to be expired.<li>Via a background system that looks for expired keys in background, incrementally, in order to be able to also collect keys that are never accessed.</ul><p>The <code>expired</code> events are generated when a key is accessed and is found to be expired by one of the above systems, as a result there are no guarantees that the Redis server will be able to generate the <code>expired</code> event at the time the key time to live reaches the value of zero.<p>If no command targets the key constantly, and there are many keys with a TTL associated, there can be a significant delay between the time the key time to live drops to zero, and the time the <code>expired</code> event is generated.<p>Basically <code>expired</code> events <strong>are generated when the Redis server deletes the key</strong> and not when the time to live theoretically reaches the value of zero.</blockquote><p>上面是官方文档的原文, 在删除key的时候发送事件, 而删除key不是实时的, 而是后台逐步删除的, 所有可能会与TTL时间存在误差. 在客户端链接丢失期间（比如项目迭代发布版本）, 也是会丢失消息的.<h1 id=分布式ID><a href=#分布式ID class=headerlink title=分布式ID></a>分布式ID</h1><p>虽然 Redis 的 incr 命令可以做 分布式 id, 但是过于地依赖 Redis.<br>其他方案:<ul><li>百度 Uid: <strong><em><a href=https://github.com/baidu/uid-generator rel="external nofollow noopener noreferrer" target=_blank>https://github.com/baidu/uid-generator</a></em></strong><li>美团 Leaf: <strong><em><a href=https://github.com/Meituan-Dianping/Leaf rel="external nofollow noopener noreferrer" target=_blank>https://github.com/Meituan-Dianping/Leaf</a></em></strong><li>滴滴 Tinyid: <strong><em><a href=https://github.com/didi/tinyid rel="external nofollow noopener noreferrer" target=_blank>https://github.com/didi/tinyid</a></em></strong></ul></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2018/spring-boot-learning-redis/ title="Redis拾遗与Spring Boot整合">http://yangbingdong.com/2018/spring-boot-learning-redis/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Redis/ rel=tag><i class="fa fa-tag"></i>Redis</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2018/distribution-lock/ rel=next title=分布式锁的几种实现方式><i class="fa fa-chevron-left"></i>分布式锁的几种实现方式</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2018/spring-boot-scheduler/ rel=prev title=Spring与任务调度>Spring与任务调度 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2018/spring-boot-learning-redis/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2018/spring-boot-learning-redis/';this.page.identifier='2018/spring-boot-learning-redis/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>46</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>17</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>43</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#安装与配置><span class=nav-number>2.</span> <span class=nav-text>安装与配置</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#安装><span class=nav-number>2.1.</span> <span class=nav-text>安装</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#基于Docker安装><span class=nav-number>2.1.1.</span> <span class=nav-text>基于Docker安装</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#Ubuntu-Apt安装><span class=nav-number>2.1.2.</span> <span class=nav-text>Ubuntu Apt安装</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#配置相关><span class=nav-number>2.2.</span> <span class=nav-text>配置相关</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#开启远程访问><span class=nav-number>2.3.</span> <span class=nav-text>开启远程访问</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#开启发布订阅监听><span class=nav-number>2.4.</span> <span class=nav-text>开启发布订阅监听</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#GUI><span class=nav-number>3.</span> <span class=nav-text>GUI</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Redis常用命令><span class=nav-number>4.</span> <span class=nav-text>Redis常用命令</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#连接操作命令><span class=nav-number>4.1.</span> <span class=nav-text>连接操作命令</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#持久化><span class=nav-number>4.2.</span> <span class=nav-text>持久化</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#远程服务控制><span class=nav-number>4.3.</span> <span class=nav-text>远程服务控制</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#对key操作的命令><span class=nav-number>4.4.</span> <span class=nav-text>对key操作的命令</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#String><span class=nav-number>4.5.</span> <span class=nav-text>String</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#List><span class=nav-number>4.6.</span> <span class=nav-text>List</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Set><span class=nav-number>4.7.</span> <span class=nav-text>Set</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Hash><span class=nav-number>4.8.</span> <span class=nav-text>Hash</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#不同数据类型的常见应用场景><span class=nav-number>5.</span> <span class=nav-text>不同数据类型的常见应用场景</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#String-1><span class=nav-number>5.1.</span> <span class=nav-text>String</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#对象存储><span class=nav-number>5.1.1.</span> <span class=nav-text>对象存储</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#计数><span class=nav-number>5.1.2.</span> <span class=nav-text>计数</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#分布式锁><span class=nav-number>5.1.3.</span> <span class=nav-text>分布式锁</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#超大数量的布尔统计><span class=nav-number>5.1.4.</span> <span class=nav-text>超大数量的布尔统计</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#List-1><span class=nav-number>5.2.</span> <span class=nav-text>List</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#显示最新的分页列表><span class=nav-number>5.2.1.</span> <span class=nav-text>显示最新的分页列表</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#消息队列><span class=nav-number>5.2.2.</span> <span class=nav-text>消息队列</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Set-1><span class=nav-number>5.3.</span> <span class=nav-text>Set</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#共同好友列表（求交集系列）><span class=nav-number>5.3.1.</span> <span class=nav-text>共同好友列表（求交集系列）</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#SortedSet><span class=nav-number>5.4.</span> <span class=nav-text>SortedSet</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#排行榜><span class=nav-number>5.4.1.</span> <span class=nav-text>排行榜</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#慢查询查看><span class=nav-number>6.</span> <span class=nav-text>慢查询查看</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#rdb文件分析><span class=nav-number>7.</span> <span class=nav-text>rdb文件分析</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#RCT-Redis-Computed-Tomography><span class=nav-number>7.1.</span> <span class=nav-text>RCT(Redis Computed Tomography)</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#redis-rdb-tools><span class=nav-number>7.2.</span> <span class=nav-text>redis-rdb-tools</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#rdr><span class=nav-number>7.3.</span> <span class=nav-text>rdr</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Spring-Boot整合><span class=nav-number>8.</span> <span class=nav-text>Spring Boot整合</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#Lettuce><span class=nav-number>8.1.</span> <span class=nav-text>Lettuce</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#核心依赖><span class=nav-number>8.1.1.</span> <span class=nav-text>核心依赖</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#配置><span class=nav-number>8.1.2.</span> <span class=nav-text>配置</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#Redisson><span class=nav-number>8.2.</span> <span class=nav-text>Redisson</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#客户端序列化选择><span class=nav-number>9.</span> <span class=nav-text>客户端序列化选择</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#Spring监听Redis-Keyspace-Event><span class=nav-number>10.</span> <span class=nav-text>Spring监听Redis Keyspace Event</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#方式一、通过RedisMessageListenerContainer><span class=nav-number>10.1.</span> <span class=nav-text>方式一、通过RedisMessageListenerContainer</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#方式二、监听RedisKeyspaceEvent><span class=nav-number>10.2.</span> <span class=nav-text>方式二、监听RedisKeyspaceEvent</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#方式三、结合Disruptor><span class=nav-number>10.3.</span> <span class=nav-text>方式三、结合Disruptor</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#缺点><span class=nav-number>10.4.</span> <span class=nav-text>缺点</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#Timing-of-expired-events><span class=nav-number>10.5.</span> <span class=nav-text>Timing of expired events</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#分布式ID><span class=nav-number>11.</span> <span class=nav-text>分布式ID</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共277.3k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2018/spring-boot-learning-redis/';var disqus_title="Redis拾遗与Spring Boot整合";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>