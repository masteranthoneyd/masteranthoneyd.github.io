<!doctype html><html class="theme-next muse use-motion" lang=en><meta name=generator content="Hexo 3.9.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta http-equiv=content-language content=zh-cn><script src=//cdn.bootcss.com/pace/1.0.2/pace.min.js></script><link href=//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css rel=stylesheet><style>.pace .pace-progress{background:#ff009e;height:2px}.pace .pace-progress-inner{box-shadow:0 0 10px #e6006b,0 0 5px #ff009e}.pace .pace-activity{border-top-color:#ff009e;border-left-color:#ff009e}</style><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel=stylesheet><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel=stylesheet><link href="/css/main.css?v=5.1.0" rel=stylesheet><meta name=keywords content="Java,Redis,Zookeeper,Spring Boot,Spring,"><link rel=alternate href=/atom.xml title="ookamiAntD's Blog" type=application/atom+xml><link rel="shortcut icon" type=image/x-icon href="/favicon.png?v=5.1.0"><meta name=description content="Preface 在现代互联网, 通常都是伴随着分布式、高并发等, 在某些业务中例如下订单扣减库存, 如果不对库存资源做临界处理, 在并发量大的时候会出现库存不准确的情况. 在单个服务的情况下可以通过Java自带的一些锁对临界资源进行处理, 例如synchronized、Reentrantlock, 甚至是通过无锁技术（比如RangeBuffer）都可以实现同一个JVM内的锁. But, 在能够弹"><meta name=keywords content="Java,Redis,Zookeeper,Spring Boot,Spring"><meta property=og:type content=article><meta property=og:title content=分布式锁的几种实现方式><meta property=og:url content=http://yangbingdong.com/2018/distribution-lock/index.html><meta property=og:site_name content="ookamiAntD's Blog"><meta property=og:description content="Preface 在现代互联网, 通常都是伴随着分布式、高并发等, 在某些业务中例如下订单扣减库存, 如果不对库存资源做临界处理, 在并发量大的时候会出现库存不准确的情况. 在单个服务的情况下可以通过Java自带的一些锁对临界资源进行处理, 例如synchronized、Reentrantlock, 甚至是通过无锁技术（比如RangeBuffer）都可以实现同一个JVM内的锁. But, 在能够弹"><meta property=og:locale content=en><meta property=og:image content=https://cdn.yangbingdong.com/img/distribute-lock/distribute-lock-banner.png><meta property=og:updated_time content=2020-04-07T10:15:47.010Z><meta name=twitter:card content=summary><meta name=twitter:title content=分布式锁的几种实现方式><meta name=twitter:description content="Preface 在现代互联网, 通常都是伴随着分布式、高并发等, 在某些业务中例如下订单扣减库存, 如果不对库存资源做临界处理, 在并发量大的时候会出现库存不准确的情况. 在单个服务的情况下可以通过Java自带的一些锁对临界资源进行处理, 例如synchronized、Reentrantlock, 甚至是通过无锁技术（比如RangeBuffer）都可以实现同一个JVM内的锁. But, 在能够弹"><meta name=twitter:image content=https://cdn.yangbingdong.com/img/distribute-lock/distribute-lock-banner.png><script id=hexo.configurations>var NexT=window.NexT||{};var CONFIG={root:'/',scheme:'Muse',sidebar:{"position":"right","display":"always"},fancybox:true,motion:true,duoshuo:{userId:'undefined',author:'Author'},algolia:{applicationID:'RI3NF6GUI0',apiKey:'3d33fa60ba30d3b17f37220bb1a36749',indexName:'blogIndex',hits:{"per_page":10},labels:{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}}};</script><link rel=canonical href=http://yangbingdong.com/2018/distribution-lock/><script>(function(){if(''){if(prompt('请输入文章密码')!==''){alert('密码错误！');history.back();}}})();</script><title>分布式锁的几种实现方式 | ookamiAntD's Blog</title><body itemscope itemtype=http://schema.org/WebPage lang=en><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?e9505ac4e11d464329d615553a72b526";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="container one-collumn sidebar-position-right page-post-detail"><div class=headband></div><a href=https://github.com/masteranthoneyd/blog rel="external nofollow noopener noreferrer" target=_blank><img style=position:absolute;top:0;left:0;border:0 src=https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67 alt="Fork me on GitHub" data-canonical-src=https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png></a><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span><span class=site-title>ookamiAntD's Blog</span>
<span class=logo-line-after><i></i></span></a></div><h1 class=site-subtitle itemprop=description>Easy coding,easy life.</h1></div><div class=site-nav-toggle><button>
<span class=btn-bar></span><span class=btn-bar></span><span class=btn-bar></span></button></div><nav class=site-nav><ul id=menu class=menu><li class="menu-item menu-item-home"><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a><li class="menu-item menu-item-archives"><a href=/archives rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a><li class="menu-item menu-item-categories"><a href=/categories rel=section><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a><li class="menu-item menu-item-tags"><a href=/tags rel=section><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a><li class="menu-item menu-item-about"><a href=/about rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a><li class="menu-item menu-item-guestbook"><a href=/guestbook rel=section><i class="menu-item-icon fa fa-fw fa-commenting"></i><br>Message</a><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></ul><div class=site-search><div class=popup><span class="search-icon fa fa-search"></span><input id=local-search-input><div id=local-search-result></div><span class=popup-btn-close>close</span></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><div id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><link itemprop=mainEntityOfPage href=http://yangbingdong.com/2018/distribution-lock/><span style=display:none itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=name content=ookamiAntD><meta itemprop=description content><meta itemprop=image content=/images/avatar/avatar-admin.jpg></span><span style=display:none itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ookamiAntD's Blog"><span style=display:none itemprop=logo itemscope itemtype=http://schema.org/ImageObject><img style=display:none itemprop="url image" alt="ookamiAntD's Blog" src></span></span><header class=post-header><h2 class=post-title itemprop="name headline">分布式锁的几种实现方式</h2><div class=post-meta><span class=post-time><span class=post-meta-item-icon><i class="fa fa-calendar-o"></i></span><span class=post-meta-item-text>Posted on</span>
<time title="Post created" itemprop="dateCreated datePublished" datetime=2018-09-15T17:19:33+08:00>2018-09-15</time></span>
<span class=post-category><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-folder-o"></i></span><span class=post-meta-item-text>In</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/ itemprop=url rel=index><span itemprop=name>Programming</span></a></span>
,
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/Programming/Java/ itemprop=url rel=index><span itemprop=name>Java</span></a></span></span>
<span id=/2018/distribution-lock/ class=leancloud_visitors data-flag-title=分布式锁的几种实现方式><span class=post-meta-divider>|</span>
<span class=post-meta-item-icon><i class="fa fa-eye"></i></span><span class=post-meta-item-text>Visitors</span>
<span class=leancloud-visitors-count></span></span><br><span class=post-time><span class=post-meta-item-icon><i class="fa fa-edit"></i></span><span class=post-meta-item-text>WordCount:</span>
<span class=post-count>4,457字</span>
<span class=post-meta-divider>|</span>
<span class=post-meta-item-text>min2read:</span>
<span class=post-count>19分钟</span></span></div></header><div class=post-body itemprop=articleBody><link rel=stylesheet href=https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css><p><img src=https://cdn.yangbingdong.com/img/distribute-lock/distribute-lock-banner.png alt><h1 id=Preface><a href=#Preface class=headerlink title=Preface></a>Preface</h1><blockquote><p>在现代互联网, 通常都是伴随着分布式、高并发等, 在某些业务中例如下订单扣减库存, 如果不对库存资源做临界处理, 在并发量大的时候会出现库存不准确的情况. 在单个服务的情况下可以通过Java自带的一些锁对临界资源进行处理, 例如<code>synchronized</code>、<code>Reentrantlock</code>, 甚至是通过无锁技术（比如<code>RangeBuffer</code>）都可以实现同一个JVM内的锁. But, 在<strong>能够弹性伸缩的分布式环境</strong>下, Java内置的锁显然不能够满足需求, 需要借助外部进程实现分布式锁.</blockquote><a id=more></a><h1 id=几种实现方式><a href=#几种实现方式 class=headerlink title=几种实现方式></a>几种实现方式</h1><p>分布式环境下, 数据一致性问题一直是一个比较重要的话题, 而又不同于单进程的情况. 分布式与单机情况下最大的不同在于其不是多线程而是多进程. 多线程由于可以共享堆内存, 因此可以简单的采取内存作为标记存储位置. 而进程之间甚至可能都不在同一台物理机上, 因此需要将标记存储在一个所有进程都能看到的地方.<p>常见的是秒杀场景, 订单服务部署了多个实例. 如秒杀商品有4个, 第一个用户购买3个, 第二个用户购买2个, 理想状态下第一个用户能购买成功, 第二个用户提示购买失败, 反之亦可. 而实际可能出现的情况是, 两个用户都得到库存为4, 第一个用户买到了3个, 更新库存之前, 第二个用户下了2个商品的订单, 更新库存为2, 导致出错.<p>在上面的场景中, 商品的库存是共享变量, 面对高并发情形, 需要保证对资源的访问互斥. 在单机环境中, Java中其实提供了很多并发处理相关的API, 但是这些API在分布式场景中就无能为力了. 也就是说单纯的Java API并不能提供分布式锁的能力. 分布式系统中, 由于分布式系统的分布性, 即多线程和多进程并且分布在不同机器中, <code>synchronized</code>和<code>lock</code>这两种锁将<strong>失去原有锁的效果</strong>, 需要我们自己实现分布式锁.<p>常见的锁方案如下:<ul><li>基于数据库实现分布式锁（基本用来玩的）<li>基于缓存, 实现分布式锁, 如<code>Redis</code>（业界常用方式）<li>基于<code>Zookeeper</code>实现分布式锁（性能低）</ul><p>下面我们简单介绍下这几种锁的实现.<h2 id=基于数据库><a href=#基于数据库 class=headerlink title=基于数据库></a>基于数据库</h2><blockquote><p>虽然这种方式基本上<strong>不会被用于生产环境</strong></blockquote><p>基于数据库的锁实现也有两种方式, 一是基于数据库表, 另一种是基于数据库排他锁.<h3 id=基于数据库表的增删><a href=#基于数据库表的增删 class=headerlink title=基于数据库表的增删></a>基于数据库表的增删</h3><p>基于数据库表增删是最简单的方式, 首先创建一张锁的表主要包含下列字段: 方法名, 时间戳等字段.<p>具体使用的方法, 当需要锁住某个方法时, 往该表中插入一条相关的记录. 这边需要注意, 方法名是有唯一性约束的, 如果有多个请求同时提交到数据库的话, 数据库会保证只有一个操作可以成功, 那么我们就可以认为操作成功的那个线程获得了该方法的锁, 可以执行方法体内容.<p>执行完毕, 需要<code>delete</code>该记录.<p>当然, 这边只是简单介绍一下. 对于上述方案可以进行优化, 如应用主从数据库, 数据之间双向同步. 一旦挂掉快速切换到备库上；做一个定时任务, 每隔一定时间把数据库中的超时数据清理一遍；使用<code>while</code>循环, 直到<code>insert</code>成功再返回成功, 虽然并不推荐这样做；还可以记录当前获得锁的机器的主机信息和线程信息, 那么下次再获取锁的时候先查询数据库, 如果当前机器的主机信息和线程信息在数据库可以查到的话, 直接把锁分配给他就可以了, 实现<strong>可重入锁</strong>.<blockquote><ul><li><strong>可重入锁</strong>: 可以再次进入方法A, 就是说在释放锁前此线程可以再次进入方法A（方法A递归）.<li><strong>不可重入锁（自旋锁）</strong>: 不可以再次进入方法A, 也就是说获得锁进入方法A是此线程在释放锁钱唯一的一次进入方法A.</ul></blockquote><h3 id=基于数据库排他锁><a href=#基于数据库排他锁 class=headerlink title=基于数据库排他锁></a>基于数据库排他锁</h3><p>我们还可以通过数据库的排他锁来实现分布式锁. 基于MySql的InnoDB引擎, 可以使用以下方法来实现加锁操作:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br></pre><td class=code><pre><span class=line>public void lock()&#123;</span><br><span class=line>    connection.setAutoCommit(false)</span><br><span class=line>    int count = 0;</span><br><span class=line>    while(count &lt; 4)&#123;</span><br><span class=line>        try&#123;</span><br><span class=line>            select * from lock where lock_name=xxx for update;</span><br><span class=line>            if(结果不为空)&#123;</span><br><span class=line>                //代表获取到锁</span><br><span class=line>                return;</span><br><span class=line>            &#125;</span><br><span class=line>        &#125;catch(Exception e)&#123;</span><br><span class=line></span><br><span class=line>        &#125;</span><br><span class=line>        //为空或者抛异常的话都表示没有获取到锁</span><br><span class=line>        sleep(1000);</span><br><span class=line>        count++;</span><br><span class=line>    &#125;</span><br><span class=line>    throw new LockException();</span><br><span class=line>&#125;</span><br></pre></table></figure><p>在查询语句后面增加<code>for update</code>, 数据库会在查询过程中给数据库表增加排他锁. 当某条记录被加上排他锁之后, 其他线程无法再在该行记录上增加排他锁. 其他没有获取到锁的就会阻塞在上述<code>select</code>语句上, 可能的结果有2种, 在超时之前获取到了锁, 在超时之前仍未获取到锁.<p>获得排它锁的线程即可获得分布式锁, 当获取到锁之后, 可以执行方法的业务逻辑, 执行完方法之后, 释放锁<code>connection.commit()</code>.<p>存在的问题主要是性能不高和sql超时的异常.<h3 id=基于数据库锁的优缺点><a href=#基于数据库锁的优缺点 class=headerlink title=基于数据库锁的优缺点></a>基于数据库锁的优缺点</h3><p>上面两种方式都是依赖数据库的一张表, 一种是通过表中的记录的存在情况确定当前是否有锁存在, 另外一种是通过数据库的排他锁来实现分布式锁.<ul><li>优点是直接借助数据库, 简单容易理解.<li>缺点是操作数据库需要一定的开销, 性能问题需要考虑.</ul><h2 id=基于Zookeeper><a href=#基于Zookeeper class=headerlink title=基于Zookeeper></a>基于Zookeeper</h2><p>基于Zookeeper<strong>临时有序节点</strong>可以实现的分布式锁. 每个客户端对某个方法加锁时, 在Zookeeper上的与该方法对应的指定节点的目录下, 生成一个唯一的瞬时有序节点. 判断是否获取锁的方式很简单, 只需要判断有序节点中序号最小的一个. 当释放锁的时候, 只需将这个瞬时节点删除即可. 同时, 其可以避免服务宕机导致的锁无法释放, 而产生的死锁问题.<p>提供的第三方库有<a href=https://curator.apache.org/ rel="external nofollow noopener noreferrer" target=_blank>curator</a>, 具体使用读者可以自行去看一下. Curator提供的<code>InterProcessMutex</code>是分布式锁的实现. <code>acquire</code>方法获取锁, release方法释放锁. 另外, 锁释放、阻塞锁、可重入锁等问题都可以有有效解决. 讲下阻塞锁的实现, 客户端可以通过在ZK中创建顺序节点, 并且在节点上绑定监听器, 一旦节点有变化, Zookeeper会通知客户端, 客户端可以检查自己创建的节点是不是当前所有节点中序号最小的, 如果是就获取到锁, 便可以执行业务逻辑.<p>根据Zookeeper的这些特性, 我们来看看如何利用这些特性来实现分布式锁:<ul><li>创建一个锁目录<code>lock</code><li>线程A获取锁会在<code>lock</code>目录下, 创建临时顺序节点<li>获取锁目录下所有的子节点, 然后获取比自己小的兄弟节点, 如果不存在, 则说明当前线程顺序号最小, 获得锁<li>线程B创建临时节点并获取所有兄弟节点, 判断自己不是最小节点, <strong>设置监听(<code>watcher</code>)比自己次小的节点</strong><li>线程A处理完, 删除自己的节点, 线程B监听到变更事件, 判断自己是最小的节点, 获得锁</ul><p>最后, Zookeeper实现的分布式锁其实存在一个缺点, 那就是<strong>性能上可能并没有缓存服务那么高</strong>. 因为每次在创建锁和释放锁的过程中, 都要动态创建、销毁瞬时节点来实现锁功能. ZK中创建和删除节点只能通过Leader服务器来执行, 然后将数据同不到所有的Follower机器上. 并发问题, 可能存在网络抖动, 客户端和ZK集群的session连接断了, zk集群以为客户端挂了, 就会删除临时节点, 这时候其他客户端就可以获取到分布式锁了.<p>下面是简单例子:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br></pre><td class=code><pre><span class=line>public class CuratorTest &#123;</span><br><span class=line>	private static String address = &quot;127.0.0.1:2181&quot;;</span><br><span class=line></span><br><span class=line></span><br><span class=line>	public static void main(String[] args) &#123;</span><br><span class=line>		RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);</span><br><span class=line>		CuratorFramework client = CuratorFrameworkFactory.newClient(address, retryPolicy);</span><br><span class=line>		client.start();</span><br><span class=line>		//创建分布式锁, 锁空间的根节点路径为/curator/lock</span><br><span class=line>		InterProcessMutex mutex = new InterProcessMutex(client, &quot;/curator/lock&quot;);</span><br><span class=line>		ExecutorService fixedThreadPool = Executors.newFixedThreadPool(5);</span><br><span class=line>		CompletionService&lt;Object&gt; completionService = new ExecutorCompletionService&lt;&gt;(fixedThreadPool);</span><br><span class=line>		for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class=line>			completionService.submit(() -&gt; &#123;</span><br><span class=line>				boolean flag = false;</span><br><span class=line>				try &#123;</span><br><span class=line>					//尝试获取锁, 最多等待5秒</span><br><span class=line>					flag = mutex.acquire(5, TimeUnit.SECONDS);</span><br><span class=line>					Thread currentThread = Thread.currentThread();</span><br><span class=line>					if (flag) &#123;</span><br><span class=line>						System.out.println(&quot;线程&quot; + currentThread.getId() + &quot;获取锁成功&quot;);</span><br><span class=line>					&#125; else &#123;</span><br><span class=line>						System.out.println(&quot;线程&quot; + currentThread.getId() + &quot;获取锁失败&quot;);</span><br><span class=line>					&#125;</span><br><span class=line>					//模拟业务逻辑, 延时4秒</span><br><span class=line>					Thread.sleep(4000);</span><br><span class=line>				&#125; catch (Exception e) &#123;</span><br><span class=line>					e.printStackTrace();</span><br><span class=line>				&#125; finally &#123;</span><br><span class=line>					if (flag) &#123;</span><br><span class=line>						try &#123;</span><br><span class=line>							mutex.release();</span><br><span class=line>						&#125; catch (Exception e) &#123;</span><br><span class=line>							e.printStackTrace();</span><br><span class=line>						&#125;</span><br><span class=line>					&#125;</span><br><span class=line>				&#125;</span><br><span class=line>				return null;</span><br><span class=line>			&#125;);</span><br><span class=line>		&#125;</span><br><span class=line>		// 等待线程跑完</span><br><span class=line>		int count = 0;</span><br><span class=line>		while (count &lt; 5) &#123;</span><br><span class=line>			if (completionService.poll() != null) &#123;</span><br><span class=line>				count++;</span><br><span class=line>			&#125;</span><br><span class=line>		&#125;</span><br><span class=line>		System.out.println(&quot;=========  Complete!&quot;);</span><br><span class=line>		client.close();</span><br><span class=line>		fixedThreadPool.shutdown();</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><h2 id=基于缓存><a href=#基于缓存 class=headerlink title=基于缓存></a>基于缓存</h2><p>相对于基于数据库实现分布式锁的方案来说, 基于缓存来实现在性能方面会表现的更好一点, 存取速度快很多. 而且很多缓存是可以集群部署的, 可以解决单点问题. 基于缓存的锁有好几种, 如Memcached、Redis, 下面主要讲解基于Redis的分布式实现.<h1 id=基于Redis的分布式锁实现><a href=#基于Redis的分布式锁实现 class=headerlink title=基于Redis的分布式锁实现></a>基于Redis的分布式锁实现</h1><blockquote><p>首先, 为了确保分布式锁可用, 我们至少要确保锁的实现同时满足以下四个条件:<ol><li><strong>互斥性. </strong>在任意时刻, 只有一个客户端能持有锁.<li><strong>不会发生死锁. </strong>即使有一个客户端在持有锁的期间崩溃而没有主动解锁, 也能保证后续其他客户端能加锁.<li><strong>具有容错性. </strong>只要大部分的Redis节点正常运行, 客户端就可以加锁和解锁.<li><strong>解铃还须系铃人. </strong>加锁和解锁必须是同一个客户端, 客户端自己不能把别人加的锁给解了.</ol></blockquote><h2 id=基于Spring-Data-Redis><a href=#基于Spring-Data-Redis class=headerlink title="基于Spring Data Redis"></a>基于Spring Data Redis</h2><p>下面是正确的实现姿势. （使用Spring Data Redis）<h3 id=依赖><a href=#依赖 class=headerlink title=依赖></a>依赖</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br></pre></table></figure><h3 id=加锁姿势><a href=#加锁姿势 class=headerlink title=加锁姿势></a>加锁姿势</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>@Autowired</span><br><span class=line>private StringRedisTemplate stringRedisTemplate;</span><br><span class=line></span><br><span class=line>private Boolean setNxEx(String key, String value) &#123;</span><br><span class=line>	return stringRedisTemplate.execute((RedisCallback&lt;Boolean&gt;) connection -&gt; &#123;</span><br><span class=line>		StringRedisConnection stringRedisConn = (StringRedisConnection) connection;</span><br><span class=line>		return stringRedisConn.set(key, value, Expiration.from(1L, TimeUnit.MINUTES), SET_IF_ABSENT);</span><br><span class=line>	&#125;);</span><br><span class=line>&#125;</span><br></pre></table></figure><p>执行上面的<code>setNxEx()</code>方法就只会导致两种结果:<ol><li>当前没有锁（key不存在）, 那么就进行加锁操作, 并对锁设置个有效期, 同时value表示加锁的客户端.<li>已有锁存在, 不做任何操作.</ol><p>网上有许多教程在加锁的步骤都<strong>不是原子性</strong>的, 有些是先加锁, 成功后再设置过期时间；有些将过期时间设置为value, 获取锁失败会判断value是否小于当前时间, 是则删除在设置新的值. 这些方法由于不是原子性, 在极端情况（比如多线程, 或者代码执行到某一行就宕机了等等）必然会导致锁失效或死锁等情况…<p>在上面<code>stringRedisConn.set(...)</code>方法中, 确保了上锁与设置过期时间的原子性.<h3 id=解锁姿势><a href=#解锁姿势 class=headerlink title=解锁姿势></a>解锁姿势</h3><p>配置类:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre><td class=code><pre><span class=line>@Bean</span><br><span class=line>public RedisScript&lt;Boolean&gt; releaseLockScript(DLockConfigProperty dLockConfigProperty) &#123;</span><br><span class=line>	DefaultRedisScript&lt;Boolean&gt; redisScript = new DefaultRedisScript&lt;&gt;();</span><br><span class=line>	String scriptLocation = &quot;scripts/release_lock.lua&quot;;</span><br><span class=line>	redisScript.setScriptSource(new ResourceScriptSource(new ClassPathResource(scriptLocation)));</span><br><span class=line>	redisScript.setResultType(Boolean.class);</span><br><span class=line>	return redisScript;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>Lua脚本:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>if redis.call(&apos;GET&apos;, KEYS[1]) == ARGV[1] then</span><br><span class=line>    return 1 == redis.call(&apos;DEL&apos;, KEYS[1])</span><br><span class=line>else</span><br><span class=line>    return false</span><br><span class=line>end</span><br></pre></table></figure><p>核心代码:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line>@Resource</span><br><span class=line>private StringRedisTemplate stringRedisTemplate;</span><br><span class=line></span><br><span class=line>@Resource</span><br><span class=line>private RedisScript&lt;Boolean&gt; script;</span><br><span class=line></span><br><span class=line>public void release(String key, String value) &#123;</span><br><span class=line>    stringRedisTemplate.execute(script, singletonList(key), value)</span><br><span class=line>&#125;</span><br></pre></table></figure><p>除了配置, 解锁就一行代码搞定, 虽然简洁, 里面也是有很多学问滴. . .<p>为什么要用Lua脚本？确保原子性, 如何保证, 请看官网对<code>eval</code>命令的相关解释. 上面脚本表达的意思很简单, 对比传进来的value是否相等, 是则删除锁. value可使用UUID作为当前线程的标识符, <strong>只有但前线程才能解锁</strong>.<p>网上的错误姿势一般都是执行完业务代码直接删除锁, 这样会导致删除了其他线程获的锁.<p>上面实现的分布式锁是不支持可重入的, 需要额外的编码, 业界当然早就开源了类似的框架, 比如下面介绍的Redisson.<h2 id=基于Redisson><a href=#基于Redisson class=headerlink title=基于Redisson></a>基于Redisson</h2><blockquote><p><strong><em><a href=https://github.com/redisson/redisson rel="external nofollow noopener noreferrer" target=_blank>Redisson</a></em></strong> 是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）. 它不仅提供了一系列的分布式的Java常用对象, 还提供了许多分布式服务. 其中包括(<code>BitSet</code>, <code>Set</code>, <code>Multimap</code>, <code>SortedSet</code>, <code>Map</code>, <code>List</code>, <code>Queue</code>, <code>BlockingQueue</code>, <code>Deque</code>, <code>BlockingDeque</code>, <code>Semaphore</code>, <code>Lock</code>, <code>AtomicLong</code>, <code>CountDownLatch</code>, <code>Publish / Subscribe</code>, <code>Bloom filter</code>, <code>Remote service</code>, <code>Spring cache</code>, <code>Executor service</code>, <code>Live Object service</code>, <code>Scheduler service</code>) Redisson提供了使用Redis的最简单和最便捷的方法. Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern）, 从而让使用者能够将精力更集中地放在处理业务逻辑上.</blockquote><p>Redisson提供的众多功能中有一项就是可重入锁（Reentrant Lock）, 具体用法可参考 <strong><em><a href=https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8 rel="external nofollow noopener noreferrer" target=_blank>文档</a></em></strong><h3 id=依赖-1><a href=#依赖-1 class=headerlink title=依赖></a>依赖</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;io.netty&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;netty-transport-native-epoll&lt;/artifactId&gt;</span><br><span class=line>    &lt;classifier&gt;linux-x86_64&lt;/classifier&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br><span class=line></span><br><span class=line>&lt;dependency&gt;</span><br><span class=line>    &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class=line>    &lt;artifactId&gt;redisson&lt;/artifactId&gt;</span><br><span class=line>    &lt;version&gt;3.7.5&lt;/version&gt;</span><br><span class=line>&lt;/dependency&gt;</span><br></pre></table></figure><h3 id=核心代码><a href=#核心代码 class=headerlink title=核心代码></a>核心代码</h3><figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br></pre><td class=code><pre><span class=line>@Data</span><br><span class=line>@Slf4j</span><br><span class=line>public class RedissonDLock implements DLock &#123;</span><br><span class=line></span><br><span class=line>	private final Long waitTime;</span><br><span class=line>	private final Long leaseTime;</span><br><span class=line>	private final TimeUnit timeUnit;</span><br><span class=line>	private final RedissonClient redisson;</span><br><span class=line></span><br><span class=line>	public RedissonDLock(DLockConfigProperty property) &#123;</span><br><span class=line>		// 设置一些基本属性</span><br><span class=line>		this.waitTime = property.getWaitTime();</span><br><span class=line>		this.leaseTime = property.getLeaseTime();</span><br><span class=line>		this.timeUnit = property.getTimeUnit();</span><br><span class=line></span><br><span class=line>		Config config = new Config();</span><br><span class=line>		SingleServerConfig singleServerConfig = config.useSingleServer();</span><br><span class=line>		singleServerConfig.setAddress(&quot;redis://&quot; + property.getHost() + &quot;:&quot; + property.getPort());</span><br><span class=line>		if (property.getPassword() != null &amp;&amp; property.getPassword().trim().length() &gt; 0) &#123;</span><br><span class=line>			singleServerConfig.setPassword(property.getPassword());</span><br><span class=line>		&#125;</span><br><span class=line>		try &#123;</span><br><span class=line>			Class.forName(&quot;io.netty.channel.epoll.Epoll&quot;);</span><br><span class=line>			// 如果是Linux系统可采用Epoll算法, 需要引入 netty-transport-native-epoll</span><br><span class=line>			if (Epoll.isAvailable()) &#123;</span><br><span class=line>				config.setTransportMode(TransportMode.EPOLL);</span><br><span class=line>				log.info(&quot;Starting with optional epoll library&quot;);</span><br><span class=line>			&#125; else &#123;</span><br><span class=line>				log.info(&quot;Starting without optional epoll library&quot;);</span><br><span class=line>			&#125;</span><br><span class=line>		&#125; catch (ClassNotFoundException e) &#123;</span><br><span class=line>			e.printStackTrace();</span><br><span class=line>		&#125;</span><br><span class=line>		redisson = Redisson.create(config);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	@Override</span><br><span class=line>	public void tryLockAndAction(LockKeyGenerator lockKeyGenerator, AfterAcquireAction acquireAction) &#123;</span><br><span class=line>		tryLockAndAction(lockKeyGenerator, acquireAction, waitTime, leaseTime, timeUnit);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	@Override</span><br><span class=line>	public void tryLockAndAction(LockKeyGenerator lockKeyGenerator, AfterAcquireAction acquireAction, Long waitTime, Long leaseTime, TimeUnit timeUnit) &#123;</span><br><span class=line>		tryLockAndAction(lockKeyGenerator, acquireAction, DEFAULT_FAIL_ACQUIRE_ACTION, waitTime, leaseTime, timeUnit);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	@Override</span><br><span class=line>	public void tryLockAndAction(LockKeyGenerator lockKeyGenerator, AfterAcquireAction acquireAction, FailAcquireAction failAcquireAction, Long waitTime, Long leaseTime, TimeUnit timeUnit) &#123;</span><br><span class=line>		try (LockHolder holder = new LockHolder(redisson.getLock(lockKeyGenerator.getLockKey()))) &#123;</span><br><span class=line>			boolean acquire = holder.getLock().tryLock(waitTime, leaseTime, timeUnit);</span><br><span class=line>			if (acquire) &#123;</span><br><span class=line>				acquireAction.doAction();</span><br><span class=line>			&#125; else &#123;</span><br><span class=line>				failAcquireAction.doOnFail();</span><br><span class=line>			&#125;</span><br><span class=line>		&#125; catch (InterruptedException e) &#123;</span><br><span class=line>			throw new RuntimeException(e);</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	@Override</span><br><span class=line>	public &lt;T&gt; T tryLockAndExecuteCommand(LockKeyGenerator lockKeyGenerator, AfterAcquireCommand&lt;T&gt; command, FailAcquireAction failAcquireAction, Long waitTime, Long leaseTime, TimeUnit timeUnit) throws Throwable &#123;</span><br><span class=line>		try (LockHolder holder = new LockHolder(redisson.getLock(lockKeyGenerator.getLockKey()))) &#123;</span><br><span class=line>			boolean acquire = holder.getLock().tryLock(waitTime, leaseTime, timeUnit);</span><br><span class=line>			if (acquire) &#123;</span><br><span class=line>				return command.executeCommand();</span><br><span class=line>			&#125;</span><br><span class=line>			failAcquireAction.doOnFail();</span><br><span class=line>		&#125;</span><br><span class=line>		return null;</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	@Data</span><br><span class=line>	@Accessors(chain = true)</span><br><span class=line>	@AllArgsConstructor</span><br><span class=line>	private static class LockHolder implements AutoCloseable &#123;</span><br><span class=line>		private RLock lock;</span><br><span class=line></span><br><span class=line>		@Override</span><br><span class=line>		public void close() &#123;</span><br><span class=line>			lock.unlockAsync();</span><br><span class=line>		&#125;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><ul><li>一般服务器都是Linux系统, 引入<code>io.netty.channel.epoll.Epoll</code>采用Epoll方式有助于提升性能<li>使用<code>try-with-resource</code>方式提高代码优雅性…</ul><h3 id=注解驱动><a href=#注解驱动 class=headerlink title=注解驱动></a>注解驱动</h3><p>Lock注解:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br></pre><td class=code><pre><span class=line>@Target(ElementType.METHOD)</span><br><span class=line>@Retention(RetentionPolicy.RUNTIME)</span><br><span class=line>@Documented</span><br><span class=line>@Inherited</span><br><span class=line>public @interface Lock &#123;</span><br><span class=line></span><br><span class=line>	String namespace() default &quot;default&quot;;</span><br><span class=line></span><br><span class=line>	String key();</span><br><span class=line></span><br><span class=line>	Class&lt;?&gt; prefixClass();</span><br><span class=line></span><br><span class=line>	String separator() default &quot;:&quot;;</span><br><span class=line></span><br><span class=line>	long waitTime() default 2L;</span><br><span class=line></span><br><span class=line>	long leaseTime() default 5L;</span><br><span class=line></span><br><span class=line>	TimeUnit timeUnit() default TimeUnit.SECONDS;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>切面类:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br></pre><td class=code><pre><span class=line>@Slf4j</span><br><span class=line>@Component</span><br><span class=line>@Aspect</span><br><span class=line>@Order(1)</span><br><span class=line>public class DLockAspect &#123;</span><br><span class=line>	@Resource</span><br><span class=line>	private DLock dLock;</span><br><span class=line></span><br><span class=line>	@Value(&quot;$&#123;spring.application.name&#125;&quot;)</span><br><span class=line>	private String namespace;</span><br><span class=line></span><br><span class=line>	@Around(value = &quot;@annotation(lock)&quot;)</span><br><span class=line>	public Object doAround(ProceedingJoinPoint pjp, Lock lock) throws Throwable &#123;</span><br><span class=line>		Method method = ((MethodSignature) pjp.getSignature()).getMethod();</span><br><span class=line></span><br><span class=line>		Object[] args = pjp.getArgs();</span><br><span class=line>		String keySpEL = lock.key();</span><br><span class=line>		String resourceKey = parseSpel(method, args, keySpEL, String.class);</span><br><span class=line></span><br><span class=line>		String finalKey = buildFinalKey(lock, resourceKey);</span><br><span class=line>		return dLock.tryLockAndExecuteCommand(() -&gt; finalKey, () -&gt; pjp.proceed(pjp.getArgs()), DEFAULT_FAIL_ACQUIRE_ACTION,</span><br><span class=line>				lock.waitTime(), lock.leaseTime(), lock.timeUnit());</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	private String buildFinalKey(Lock lock, String key) &#123;</span><br><span class=line>		return namespace == null || namespace.length() == 0 ? lock.namespace() : namespace +</span><br><span class=line>				lock.separator() +</span><br><span class=line>				lock.prefixClass().getSimpleName() +</span><br><span class=line>				lock.separator() +</span><br><span class=line>				key;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>使用了 <strong><em><a href=https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#expressions rel="external nofollow noopener noreferrer" target=_blank>SpEL</a></em></strong> 解析锁的Key:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre><td class=code><pre><span class=line>public final class SpelHelper &#123;</span><br><span class=line>	private static final ExpressionParser PARSER = new SpelExpressionParser();</span><br><span class=line>	private static final LocalVariableTableParameterNameDiscoverer DISCOVERER = new LocalVariableTableParameterNameDiscoverer();</span><br><span class=line></span><br><span class=line>	public static &lt;T&gt; T parseSpel(Method method, Object[] args, String spel, Class&lt;T&gt; clazz) &#123;</span><br><span class=line>		String[] parameterNames = DISCOVERER.getParameterNames(method);</span><br><span class=line>		requireNonNull(parameterNames);</span><br><span class=line>		EvaluationContext context = buildSpelContext(parameterNames, args);</span><br><span class=line>		Expression expression = PARSER.parseExpression(spel);</span><br><span class=line>		return expression.getValue(context, clazz);</span><br><span class=line>	&#125;</span><br><span class=line></span><br><span class=line>	private static EvaluationContext buildSpelContext(String[] parameterNames, Object[] args) &#123;</span><br><span class=line>		EvaluationContext context = new StandardEvaluationContext();</span><br><span class=line>		for (int len = 0; len &lt; parameterNames.length; len++) &#123;</span><br><span class=line>			context.setVariable(parameterNames[len], args[len]);</span><br><span class=line>		&#125;</span><br><span class=line>		context.setVariable(&quot;args&quot;, args);</span><br><span class=line>		return context;</span><br><span class=line>	&#125;</span><br><span class=line>&#125;</span><br></pre></table></figure><p>使用:<figure class="highlight plain"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre><td class=code><pre><span class=line>// @Lock(prefixClass = TestService.class, key = &quot;#id&quot;)</span><br><span class=line>@Lock(prefixClass = TestService.class, key = &quot;#args[0]&quot;)</span><br><span class=line>public void lockTest(Long id) &#123;</span><br><span class=line>	doSomething();</span><br><span class=line>&#125;</span><br></pre></table></figure><blockquote><p>如果锁被早被别的线程使用, 一般我们使用线程Sleep的方式等待锁释放, 但Redisson的底层采用了更优雅的等待策略, 通过发布订阅通知其他线程, 所以性能也会有所提高.</blockquote><h1 id=Finally><a href=#Finally class=headerlink title=Finally></a>Finally</h1><blockquote><p>Redisson官方文档: <strong><em><a href=https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95 rel="external nofollow noopener noreferrer" target=_blank>https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95</a></em></strong><p>示例代码: <strong><em><a href=https://github.com/masteranthoneyd/starter/tree/master/dlock rel="external nofollow noopener noreferrer" target=_blank>https://github.com/masteranthoneyd/starter/tree/master/dlock</a></em></strong></blockquote></div><div style=text-align:center;color:#ccc;font-size:14px>---------------- The End ----------------</div><div><div id=wechat_subscriber style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id=wechat_subscriber_qcode src=/images/wechat/gongzhonghao.jpg alt="ookamiAntD wechat" style=width:200px;max-width:100%><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>谢谢大爷～</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');if(qr.style.display==='none'){qr.style.display='block';}else{qr.style.display='none'}">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/images/donate/wechat.png alt="ookamiAntD WeChat Pay"><p>微信打赏</div><div id=alipay style=display:inline-block><img id=alipay_qr src=/images/donate/alipay.jpg alt="ookamiAntD Alipay"><p>支付宝打赏</div></div></div></div><div><p id=div-border-left-red>Author：<b>ookamiAntD Yang</b><br>Link：<a href=/2018/distribution-lock/ title=分布式锁的几种实现方式>http://yangbingdong.com/2018/distribution-lock/</a><br>Contact：<a>yangbingdong1994@gmail.com</a><br><b>本文基于<a target=_blank title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href=http://creativecommons.org/licenses/by-sa/4.0/ rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br><b>转载请注明出处，谢谢！</b></div><footer class=post-footer><div class=post-tags><a href=/tags/Java/ rel=tag><i class="fa fa-tag"></i>Java</a>
<a href=/tags/Redis/ rel=tag><i class="fa fa-tag"></i>Redis</a>
<a href=/tags/Zookeeper/ rel=tag><i class="fa fa-tag"></i>Zookeeper</a>
<a href=/tags/Spring-Boot/ rel=tag><i class="fa fa-tag"></i>Spring Boot</a>
<a href=/tags/Spring/ rel=tag><i class="fa fa-tag"></i>Spring</a></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/2018/spring-boot-learning-testing/ rel=next title="Spring Boot学习之测试篇"><i class="fa fa-chevron-left"></i>Spring Boot学习之测试篇</a></div><span class=post-nav-divider></span><div class="post-nav-prev post-nav-item"><a href=/2018/spring-boot-learning-redis/ rel=prev title="Redis拾遗与Spring Boot整合">Redis拾遗与Spring Boot整合 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class=post-spread><div class=-hoofoo-share-title>分享到：</div><div class=-hoofoo-share-buttons><div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden=true></i></div><div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden=true></i></div><div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden=true></i></div><div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden=true></i></div><div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden=true></i></div></div><div class=-mob-share-ui style=display:none><ul class=-mob-share-list><li class=-mob-share-weibo><p>新浪微博<li class=-mob-share-weixin><p>微信<li class=-mob-share-qzone><p>QQ空间<li class=-mob-share-qq><p>QQ好友<li class=-mob-share-tencentweibo><p>腾讯微博<li class=-mob-share-renren><p>人人网<li class=-mob-share-kaixin><p>开心网<li class=-mob-share-douban><p>豆瓣<li class=-mob-share-youdao><p>有道云笔记<li class=-mob-share-mingdao><p>明道<li class=-mob-share-pengyou><p>朋友网<li class=-mob-share-facebook><p>Facebook<li class=-mob-share-twitter><p>Twitter<li class=-mob-share-pocket><p>Pocket<li class=-mob-share-google><p>Google+<li class=-mob-share-tumblr><p>Tumblr<li class=-mob-share-instapaper><p>Instapaper<li class=-mob-share-linkedin><p>Linkedin</ul><div class=-mob-share-close>取消</div></div><div class=-mob-share-ui-bg></div><script id=-mob-share src="https://f1.webshare.mob.com/code/mob-share.js?appkey=21aa3b13ad233"></script></div></div></div><div class=comments id=comments><div style=text-align:center></div><div id=disqus_proxy_thread></div><div id=disqus_thread></div><script>window.disqusProxy={username:'ookamiantd',server:'disqus-proxy.yangbingdong.com',port:'',defaultAvatar:'/images/avatar/avatar-default.jpg',adminAvatar:'/images/avatar/avatar-admin.jpg',identifier:'2018/distribution-lock/'};window.disqus_config=function(){this.page.url='http://yangbingdong.com/2018/distribution-lock/';this.page.identifier='2018/distribution-lock/';};window.onload=function(){var s=document.createElement('script');s.src="/static/js/main.0d0338ae.js";s.async=true;document.body.appendChild(s);}</script><link rel=stylesheet href=/static/css/main.0603c539.css></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>Table of Contents<li class=sidebar-nav-overview data-target=site-overview>Overview</ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/images/avatar/avatar-admin.jpg alt=ookamiAntD><p class=site-author-name itemprop=name>ookamiAntD<p class="site-description motion-element" itemprop=description>码渣 | rocker | 二次元 | 美剧 | 宅</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/archives><span class=site-state-item-count>46</span>
<span class=site-state-item-name>posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories><span class=site-state-item-count>17</span>
<span class=site-state-item-name>categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags><span class=site-state-item-count>43</span>
<span class=site-state-item-name>tags</span></a></div></nav><div class="feed-link motion-element"><a href=/atom.xml rel=alternate><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/masteranthoneyd target=_blank rel="external nofollow noopener noreferrer" title=GitHub><i class="fa fa-fw fa-github"></i>GitHub</a></span>
<span class=links-of-author-item><a href="https://www.facebook.com/profile.php?id=100014869064462" target=_blank rel="external nofollow noopener noreferrer" title=Facebook><i class="fa fa-fw fa-facebook"></i>Facebook</a></span>
<span class=links-of-author-item><a href=https://twitter.com/ookamiAntD target=_blank rel="external nofollow noopener noreferrer" title=Twitter><i class="fa fa-fw fa-twitter"></i>Twitter</a></span></div><div class="cc-license motion-element" itemprop=license><a href=https://creativecommons.org/licenses/by-sa/4.0/ class=cc-opacity target=_blank rel="external nofollow noopener noreferrer"><img src=/images/cc-by-sa.svg alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class=links-of-blogroll-title><i class="fa  fa-fw fa-globe"></i>大神们的博客</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://mercyblitz.github.io/ title=mercyblitz(Java劝退师) target=_blank rel="external nofollow noopener noreferrer">mercyblitz(Java劝退师)</a><li class=links-of-blogroll-item><a href=https://muyinchen.github.io/ title=知秋大神(真·大神) target=_blank rel="external nofollow noopener noreferrer">知秋大神(真·大神)</a><li class=links-of-blogroll-item><a href=http://crossoverjie.top/ title="crossoverJie's Blog" target=_blank rel="external nofollow noopener noreferrer">crossoverJie's Blog</a><li class=links-of-blogroll-item><a href=http://yemengying.com/ title="Giraffe's Home" target=_blank rel="external nofollow noopener noreferrer">Giraffe's Home</a></ul></div><div id=days></div><script>function show_date_time(){window.setTimeout("show_date_time()",1000);BirthDay=new Date("01/10/2017 12:34:56");today=new Date();timeold=(today.getTime()-BirthDay.getTime());sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);e_hrsold=(e_daysold-daysold)*24;hrsold=setzero(Math.floor(e_hrsold));e_minsold=(e_hrsold-hrsold)*60;minsold=setzero(Math.floor((e_hrsold-hrsold)*60));seconds=setzero(Math.floor((e_minsold-minsold)*60));document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";}
function setzero(i){if(i<10)
{i="0"+i};return i;}
show_date_time();</script></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><ol class=nav><li class="nav-item nav-level-1"><a class=nav-link href=#Preface><span class=nav-number>1.</span> <span class=nav-text>Preface</span></a><li class="nav-item nav-level-1"><a class=nav-link href=#几种实现方式><span class=nav-number>2.</span> <span class=nav-text>几种实现方式</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#基于数据库><span class=nav-number>2.1.</span> <span class=nav-text>基于数据库</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#基于数据库表的增删><span class=nav-number>2.1.1.</span> <span class=nav-text>基于数据库表的增删</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#基于数据库排他锁><span class=nav-number>2.1.2.</span> <span class=nav-text>基于数据库排他锁</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#基于数据库锁的优缺点><span class=nav-number>2.1.3.</span> <span class=nav-text>基于数据库锁的优缺点</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#基于Zookeeper><span class=nav-number>2.2.</span> <span class=nav-text>基于Zookeeper</span></a><li class="nav-item nav-level-2"><a class=nav-link href=#基于缓存><span class=nav-number>2.3.</span> <span class=nav-text>基于缓存</span></a></ol><li class="nav-item nav-level-1"><a class=nav-link href=#基于Redis的分布式锁实现><span class=nav-number>3.</span> <span class=nav-text>基于Redis的分布式锁实现</span></a><ol class=nav-child><li class="nav-item nav-level-2"><a class=nav-link href=#基于Spring-Data-Redis><span class=nav-number>3.1.</span> <span class=nav-text>基于Spring Data Redis</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#依赖><span class=nav-number>3.1.1.</span> <span class=nav-text>依赖</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#加锁姿势><span class=nav-number>3.1.2.</span> <span class=nav-text>加锁姿势</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#解锁姿势><span class=nav-number>3.1.3.</span> <span class=nav-text>解锁姿势</span></a></ol><li class="nav-item nav-level-2"><a class=nav-link href=#基于Redisson><span class=nav-number>3.2.</span> <span class=nav-text>基于Redisson</span></a><ol class=nav-child><li class="nav-item nav-level-3"><a class=nav-link href=#依赖-1><span class=nav-number>3.2.1.</span> <span class=nav-text>依赖</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#核心代码><span class=nav-number>3.2.2.</span> <span class=nav-text>核心代码</span></a><li class="nav-item nav-level-3"><a class=nav-link href=#注解驱动><span class=nav-number>3.2.3.</span> <span class=nav-text>注解驱动</span></a></ol></ol><li class="nav-item nav-level-1"><a class=nav-link href=#Finally><span class=nav-number>4.</span> <span class=nav-text>Finally</span></a></ol></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=busuanzi-count><script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user">本站访客数</i><span class=busuanzi-value id=busuanzi_value_site_uv></span>人次</span>
<span class=site-pv><i class="fa fa-eye">本站总访问量</i><span class=busuanzi-value id=busuanzi_value_site_pv></span>次</span></div><div class=copyright>&copy; 2016 -
<span itemprop=copyrightYear>2020</span>
<span class=with-love><i class="fa fa-flash"></i></span><span class=author itemprop=copyrightHolder>Hosted by <a href=https://pages.coding.me style=font-weight:700 rel="external nofollow noopener noreferrer" target=_blank>Coding Pages</a></span> | <span class=post-count>共279.3k字</span></div><div class=theme-info><a target=_blank href=http://www.miibeian.gov.cn/ rel=nofollow style=color:#555>粤ICP备18135202号-1</a></div><div style="width:300px;margin:0 auto"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010602005896" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=https://cdn.yangbingdong.com/img/beian/beian.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#555">粤公网安备 44010602005896号</p></a></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i></div></div><script>if(Object.prototype.toString.call(window.Promise)!=='[object Function]'){window.Promise=null;}</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname='ookamiantd';var disqus_identifier='2018/distribution-lock/';var disqus_title="分布式锁的几种实现方式";function run_disqus_script(disqus_script){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}
var disqus={load:function disqus(){if(typeof DISQUS!=='object'){(function(){var s=document.createElement('script');s.async=true;s.type='text/javascript';s.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('HEAD')[0]||document.getElementsByTagName('BODY')[0]).appendChild(s);}());$('#load-disqus').html("评论加载中，请确保你有梯子，若评论长时间未加载则你可能翻墙失败...").fadeOut(9000);}}}</script><script>var isfetched=false;var search_path="search.xml";if(search_path.length==0){search_path="search.xml";}
var path="/"+search_path;function proceedsearch(){$("body").append('<div class="popoverlay">').css('overflow','hidden');$('.popup').toggle();}
var searchFunc=function(path,search_id,content_id){'use strict';$.ajax({url:path,dataType:"xml",async:true,success:function(xmlResponse){isfetched=true;$('.popup').detach().appendTo('.header-inner');var datas=$("entry",xmlResponse).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()};}).get();var $input=document.getElementById(search_id);var $resultContent=document.getElementById(content_id);$input.addEventListener('input',function(){var matchcounts=0;var str='<ul class=\"search-result-list\">';var keywords=this.value.trim().toLowerCase().split(/[\s\-]+/);$resultContent.innerHTML="";if(this.value.trim().length>1){datas.forEach(function(data){var isMatch=false;var content_index=[];var data_title=data.title.trim().toLowerCase();var data_content=data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();var data_url=decodeURIComponent(data.url);var index_title=-1;var index_content=-1;var first_occur=-1;if(data_title!=''){keywords.forEach(function(keyword,i){index_title=data_title.indexOf(keyword);index_content=data_content.indexOf(keyword);if(index_title>=0||index_content>=0){isMatch=true;if(i==0){first_occur=index_content;}}});}
if(isMatch){matchcounts+=1;str+="<li><a href='"+data_url+"' class='search-result-title'>"+data_title+"</a>";var content=data.content.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20;var end=first_occur+80;if(start<0){start=0;}
if(start==0){end=50;}
if(end>content.length){end=content.length;}
var match_content=content.substring(start,end);keywords.forEach(function(keyword){var regS=new RegExp(keyword,"gi");match_content=match_content.replace(regS,"<b class=\"search-keyword\">"+keyword+"</b>");});str+="<p class=\"search-result\">"+match_content+"...</p>"}
str+="</li>";}})};str+="</ul>";if(matchcounts==0){str='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}
if(keywords==""){str='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}
$resultContent.innerHTML=str;});proceedsearch();}});}
$('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched==false){searchFunc(path,'local-search-input','local-search-result');}else{proceedsearch();};});$('.popup-btn-close').click(function(e){$('.popup').hide();$(".popoverlay").remove();$('body').css('overflow','');});$('.popup').click(function(e){e.stopPropagation();});</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script>AV.initialize("usE0s6JGUeOiMcsVoRuHuv2B-gzGzoHsz","ewm6NEF07r83HbnOr63ptuKH");</script><script>function showTime(Counter){var query=new AV.Query(Counter);var entries=[];var $visitors=$(".leancloud_visitors");$visitors.each(function(){entries.push($(this).attr("id").trim());});query.containedIn('url',entries);query.find().done(function(results){var COUNT_CONTAINER_REF='.leancloud-visitors-count';if(results.length===0){$visitors.find(COUNT_CONTAINER_REF).text(0);return;}
for(var i=0;i<results.length;i++){var item=results[i];var url=item.get('url');var time=item.get('time');var element=document.getElementById(url);$(element).find(COUNT_CONTAINER_REF).text(time);}
for(var i=0;i<entries.length;i++){var url=entries[i];var element=document.getElementById(url);var countSpan=$(element).find(COUNT_CONTAINER_REF);if(countSpan.text()==''){countSpan.text(0);}}}).fail(function(object,error){console.log("Error: "+error.code+" "+error.message);});}
function addCount(Counter){var $visitors=$(".leancloud_visitors");var url=$visitors.attr('id').trim();var title=$visitors.attr('data-flag-title').trim();var query=new AV.Query(Counter);query.equalTo("url",url);query.find({success:function(results){if(results.length>0){var counter=results[0];counter.fetchWhenSave(true);counter.increment("time");counter.save(null,{success:function(counter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(counter.get('time'));},error:function(counter,error){console.log('Failed to save Visitor num, with error message: '+error.message);}});}else{var newcounter=new Counter();var acl=new AV.ACL();acl.setPublicReadAccess(true);acl.setPublicWriteAccess(true);newcounter.setACL(acl);newcounter.set("title",title);newcounter.set("url",url);newcounter.set("time",1);newcounter.save(null,{success:function(newcounter){var $element=$(document.getElementById(url));$element.find('.leancloud-visitors-count').text(newcounter.get('time'));},error:function(newcounter,error){console.log('Failed to create');}});}},error:function(error){console.log('Error:'+error.code+" "+error.message);}});}
$(function(){var Counter=AV.Object.extend("Counter");if($('.leancloud_visitors').length==1){addCount(Counter);}else if($('.post-title-link').length>1){showTime(Counter);}});</script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script color=255,0,204 opacity=0.5 zindex=-2 count=40 src=//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js></script><script>$('body').delegate('.-mob-share-weixin-qrcode-bg','click',function(){$(".-mob-share-weixin-qrcode-close").trigger("click");});</script><canvas class=fireworks style=position:fixed;left:0;top:0;z-index:1;pointer-events:none></canvas>
<script src=//cdn.bootcss.com/animejs/2.2.0/anime.min.js></script><script src=/js/src/fireworks.js></script><script src=/js/src/dytitle.js></script></div></footer></div><script src=/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":88,"height":88,"position":"left"},"mobile":{"show":false},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script>